"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[729],{4075:function(e,t,l){l.d(t,{Z:function(){return c}});var i=l(6252);function a(e,t,l,a,n,o){const s=(0,i.up)("ion-icon"),r=(0,i.up)("ion-button"),u=(0,i.up)("ion-buttons"),d=(0,i.up)("ion-label"),c=(0,i.up)("ion-toolbar"),m=(0,i.up)("ion-searchbar"),p=(0,i.up)("ion-header"),g=(0,i.up)("ymap-marker"),h=(0,i.up)("yandex-map"),_=(0,i.up)("ion-content");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i.Wm)(p,null,{default:(0,i.w5)((()=>[(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(u,{slot:"start"},{default:(0,i.w5)((()=>[(0,i.Wm)(r,{onClick:t[0]||(t[0]=e=>a.closeModal()),color:"primary"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,{icon:a.closeOutline,slot:"start"},null,8,["icon"]),(0,i.Uk)(" Закрыть ")])),_:1})])),_:1}),(0,i.Wm)(d,{size:"large"},{default:(0,i.w5)((()=>[(0,i.Uk)("Добавление адреса")])),_:1}),(0,i.Wm)(u,{slot:"end"},{default:(0,i.w5)((()=>[(0,i.Wm)(r,{strong:!0,onClick:t[1]||(t[1]=e=>o.pickAddress()),color:"primary"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,{src:a.checkmark,slot:"start"},null,8,["src"]),(0,i.Uk)(" Ок ")])),_:1})])),_:1})])),_:1}),(0,i.Wm)(m,{id:"suggest",placeholder:"название улицы, номер дома"})])),_:1}),(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Wm)(h,{coords:n.coords,zoom:16,onClick:t[2]||(t[2]=e=>o.onClick(e)),style:{height:"100%"},settings:n.settings},{default:(0,i.w5)((()=>[(0,i.Wm)(g,{coords:n.coords,"marker-id":"1",properties:n.placemarkProperties},null,8,["coords","properties"])])),_:1},8,["coords","settings"])])),_:1})],64)}l(3948),l(7658);var n=l(4929),o=l(5836),s=l(8903),r={components:{IonContent:n.W2,IonToolbar:n.sr,IonButton:n.YG,IonButtons:n.Sm,IonSearchbar:n.VI,IonHeader:n.Gu,IonIcon:n.gu,yandexMap:o.xR,ymapMarker:o.Jk},setup(){const e=function(){n.Fy.dismiss()};return{closeModal:e,locationOutline:s.Iv7,closeOutline:s.fID,checkmark:s.d29}},props:{location_group_name_low:String,location_group_id:Number},data(){let e=this.location_group_name_low+" адрес",t=this.$heap.state.settings.location,l=JSON.parse(t.mapCenter);return{settings:{apiKey:t.ymapApiKey,lang:"ru_RU",coordorder:"latlong",version:"2.1"},placemarkProperties:{iconCaption:e},locationType:e,locSettings:t,selectedPlacemark:0,selectedAddress:"",selectedCoords:[],coords:l}},methods:{async pickAddress(){try{var e;const t=await window.ymaps.geocode(this.coords);this.selectedAddress=null===(e=t.geoObjects.get(0))||void 0===e?void 0:e.getAddressLine()}catch(l){}var t={location_address:this.filterAddress(this.selectedAddress),location_latitude:this.coords[0],location_longitude:this.coords[1]};n.Fy.dismiss(t)},filterAddress(e){const t=this.locSettings.addressErase.split(", "),l=e.split(", ");let i=[];for(const a of l)t.find((e=>e==a))||i.push(a);return i.reverse().join(", ")},onClick(e){e&&e.get&&(this.coords=e.get("coords"))}},async mounted(){await(0,o.xk)();let e=window.ymaps;const t=JSON.parse("["+this.locSettings.mapBoundaries[0]+"]"),l=new e.SuggestView("suggest",{boundedBy:t});l.events.add("select",(t=>{this.selectedAddress=t.get("item").displayName,e.geocode(this.selectedAddress).then((e=>{this.coords=e.geoObjects.get(0).geometry.getCoordinates()}))})),this.$flash("Получаем местоположение устройства"),e.geolocation.get().then((e=>{this.coords=e.geoObjects.position,this.$flash("На карте отмечено ваше местоположение")}))}},u=l(3744);const d=(0,u.Z)(r,[["render",a]]);var c=d},729:function(e,t,l){l.r(t),l.d(t,{default:function(){return f}});var i=l(6252),a=l(3577);const n={class:"ion-padding",slot:"content"};function o(e,t,l,o,s,r){const u=(0,i.up)("ion-icon"),d=(0,i.up)("ion-label"),c=(0,i.up)("ion-item"),m=(0,i.up)("ion-list"),p=(0,i.up)("ion-title"),g=(0,i.up)("ion-button"),h=(0,i.up)("ion-buttons"),_=(0,i.up)("ion-toolbar"),f=(0,i.up)("ion-header"),w=(0,i.up)("ion-input"),k=(0,i.up)("ion-accordion"),W=(0,i.up)("ion-textarea"),M=(0,i.up)("image-tile-comp"),b=(0,i.up)("ion-select-option"),y=(0,i.up)("ion-select"),v=(0,i.up)("ion-col"),I=(0,i.up)("ion-row"),U=(0,i.up)("ion-grid"),C=(0,i.up)("ion-accordion-group"),O=(0,i.up)("ion-content"),V=(0,i.up)("ion-modal"),$=(0,i.up)("base-layout");return(0,i.wg)(),(0,i.j4)($,{pageDefaultBackLink:"/user","page-title":"Рассылка"},{default:(0,i.w5)((()=>{var e;return[(0,i.Wm)(m,null,{default:(0,i.w5)((()=>[(0,i.Wm)(c,{button:"",onClick:t[0]||(t[0]=e=>r.itemCreate())},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{slot:"start",src:o.addOutline},null,8,["src"]),(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Добавить Рассылку")])),_:1})])),_:1})])),_:1}),(null===(e=s.mailingList)||void 0===e?void 0:e.length)>0?((0,i.wg)(),(0,i.j4)(m,{key:0},{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(s.mailingList,(e=>((0,i.wg)(),(0,i.j4)(c,{key:e.mailing_id,onClick:t=>r.itemGet(e.mailing_id)},{default:(0,i.w5)((()=>[(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[(0,i.Uk)("#"+(0,a.zw)(e.mailing_id)+" "+(0,a.zw)(e.subject_template),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):(0,i.kq)("",!0),(0,i.Wm)(V,{ref:"modal",onWillDismiss:t[17]||(t[17]=e=>s.isMailingOpen=!1),"is-open":s.isMailingOpen,"initial-breakpoint":.75,breakpoints:[.75,1]},{default:(0,i.w5)((()=>[(0,i.Wm)(f,null,{default:(0,i.w5)((()=>[(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Wm)(p,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Рассылка #"+(0,a.zw)(s.currentMailing.mailing_id),1)])),_:1}),(0,i.Wm)(h,{slot:"end"},{default:(0,i.w5)((()=>[(0,i.Wm)(g,{onClick:t[1]||(t[1]=e=>s.isMailingOpen=!1)},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{src:o.closeOutline},null,8,["src"])])),_:1})])),_:1})])),_:1})])),_:1}),(0,i.Wm)(O,{class:"ion-padding"},{default:(0,i.w5)((()=>[(0,i.Wm)(C,{value:"recievers"},{default:(0,i.w5)((()=>[(0,i.Wm)(k,{value:"recievers"},{default:(0,i.w5)((()=>[(0,i.Wm)(c,{slot:"header"},{default:(0,i.w5)((()=>[(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Получатели")])),_:1})])),_:1}),(0,i._)("div",n,[(0,i.Wm)(m,null,{default:(0,i.w5)((()=>[(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(w,{modelValue:s.currentMailing.user_filter.phones,"onUpdate:modelValue":t[2]||(t[2]=e=>s.currentMailing.user_filter.phones=e),label:"Телефоны получателей","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.Wm)(c,{lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Локация клиентов")])),_:1})])),_:1}),s.currentMailing.user_filter.location?((0,i.wg)(),(0,i.j4)(c,{key:0,lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{slot:"start",src:o.locationOutline},null,8,["src"]),(0,i.Wm)(d,{style:{"white-space":"normal",cursor:"pointer"}},{default:(0,i.w5)((()=>[(0,i.Uk)((0,a.zw)(s.currentMailing.user_filter.location.location_address),1)])),_:1}),(0,i.Wm)(u,{slot:"end",icon:o.trash,onClick:t[3]||(t[3]=e=>r.locationDelete(`${s.currentMailing.user_filter.location.location_id}`))},null,8,["icon"])])),_:1})):((0,i.wg)(),(0,i.j4)(g,{key:1,onClick:t[4]||(t[4]=e=>r.modalLocationCreate()),color:"light",expand:"block"},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{src:o.locationOutline},null,8,["src"]),(0,i.Uk)(" Добавить адрес ")])),_:1})),s.currentMailing.user_filter.location?((0,i.wg)(),(0,i.j4)(c,{key:2},{default:(0,i.w5)((()=>[(0,i.Wm)(w,{modelValue:s.currentMailing.user_filter.radius,"onUpdate:modelValue":t[5]||(t[5]=e=>s.currentMailing.user_filter.radius=e),label:"Радиус вокруг локации км","label-placement":"stacked"},null,8,["modelValue"])])),_:1})):(0,i.kq)("",!0),(0,i.Wm)(g,{onClick:t[6]||(t[6]=e=>r.recieverListCreate()),expand:"block"},{default:(0,i.w5)((()=>[(0,i.Uk)(" Создать список получателей ")])),_:1})])),_:1})])])),_:1}),(0,i.Wm)(k,{value:"message"},{default:(0,i.w5)((()=>[(0,i.Wm)(c,{slot:"header"},{default:(0,i.w5)((()=>[(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Сообщение")])),_:1})])),_:1}),(0,i.Wm)(m,{slot:"content"},{default:(0,i.w5)((()=>{var e,l;return[(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(w,{modelValue:s.currentMailing.subject_template,"onUpdate:modelValue":t[7]||(t[7]=e=>s.currentMailing.subject_template=e),label:"Тема","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(W,{modelValue:s.currentMailing.text_template,"onUpdate:modelValue":t[8]||(t[8]=e=>s.currentMailing.text_template=e),label:"Сообщение","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.Wm)(M,{images:null===(e=s.currentMailing)||void 0===e?void 0:e.images,image_holder:"mailing",image_holder_id:null===(l=s.currentMailing)||void 0===l?void 0:l.mailing_id,hide_if_empty:"true",controller:"Admin/Mailing",ref:"mailingImgs"},null,8,["images","image_holder_id"]),(0,i.Wm)(c,{lines:"none",onClick:t[9]||(t[9]=e=>this.$refs.mailingImgs.take_photo())},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{src:o.addOutline,slot:"start"},null,8,["src"]),(0,i.Uk)(" Добавить фото ")])),_:1}),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(w,{modelValue:s.currentMailing.link,"onUpdate:modelValue":t[10]||(t[10]=e=>s.currentMailing.link=e),label:"Link","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(y,{label:"Транспорт","label-placement":"stacked",modelValue:s.currentMailing.transport,"onUpdate:modelValue":t[11]||(t[11]=e=>s.currentMailing.transport=e)},{default:(0,i.w5)((()=>[(0,i.Wm)(b,{value:"push"},{default:(0,i.w5)((()=>[(0,i.Uk)("Push")])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(y,{label:"Рингтон","label-placement":"stacked",modelValue:s.currentMailing.sound,"onUpdate:modelValue":t[12]||(t[12]=e=>s.currentMailing.sound=e),value:"default"},{default:(0,i.w5)((()=>[(0,i.Wm)(b,{value:""},{default:(0,i.w5)((()=>[(0,i.Uk)("-")])),_:1}),(0,i.Wm)(b,{value:"default"},{default:(0,i.w5)((()=>[(0,i.Uk)("стандарт")])),_:1}),(0,i.Wm)(b,{value:"short.wav"},{default:(0,i.w5)((()=>[(0,i.Uk)("Короткий")])),_:1}),(0,i.Wm)(b,{value:"medium.wav"},{default:(0,i.w5)((()=>[(0,i.Uk)("Средний")])),_:1}),(0,i.Wm)(b,{value:"long.wav"},{default:(0,i.w5)((()=>[(0,i.Uk)("Длинный")])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(w,{modelValue:s.currentMailing.start_at,"onUpdate:modelValue":t[13]||(t[13]=e=>s.currentMailing.start_at=e),type:"datetime-local",label:"Начало запуска","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.Wm)(U,null,{default:(0,i.w5)((()=>[(0,i.Wm)(I,null,{default:(0,i.w5)((()=>[(0,i.Wm)(v,null,{default:(0,i.w5)((()=>[(0,i.Wm)(g,{onClick:t[14]||(t[14]=e=>r.itemDelete()),color:"danger",fill:"clear",expand:"block"},{default:(0,i.w5)((()=>[(0,i.Uk)("Удалить")])),_:1})])),_:1}),(0,i.Wm)(v,null,{default:(0,i.w5)((()=>[(0,i.Wm)(g,{onClick:t[15]||(t[15]=e=>r.itemUpdate()),expand:"block"},{default:(0,i.w5)((()=>[(0,i.Uk)("Сохранить")])),_:1})])),_:1}),(0,i.Wm)(v,null,{default:(0,i.w5)((()=>[(0,i.Wm)(g,{onClick:t[16]||(t[16]=e=>r.itemStart()),expand:"block",color:"light"},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{slot:"start",src:o.playOutline},null,8,["src"]),(0,i.Uk)(" Запустить ")])),_:1})])),_:1})])),_:1})])),_:1})]})),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["is-open"])]})),_:1})}l(8862);var s=l(4929),r=l(8903),u=l(4405),d=l(9755),c=l.n(d),m=l(2639),p=l(4075),g={components:{ImageTileComp:m.Z,IonList:s.q_,IonItem:s.Ie,IonLabel:s.Q$,IonIcon:s.gu,IonModal:s.ki,IonHeader:s.Gu,IonToolbar:s.sr,IonButtons:s.Sm,IonTitle:s.wd,IonButton:s.YG,IonContent:s.W2,IonInput:s.pK,IonTextarea:s.g2,IonSelect:s.t9,IonSelectOption:s.n0,IonGrid:s.jY,IonRow:s.Nd,IonCol:s.wI,IonAccordionGroup:s.eh,IonAccordion:s.We,IonImg:s.Xz},setup(){return{addOutline:r.s6O,refreshOutline:r.D3P,imageOutline:r.Eu9,closeOutline:r.fID,playOutline:r.AO3,locationOutline:r.Iv7,trash:r._Ij}},data(){return{currentMailing:{},mailingList:null,isMailingOpen:!1}},computed:{},methods:{async itemCreate(){const e={subject_template:"new mailing"};try{const t=await c().post(`${this.$heap.state.hostname}Admin/Mailing/itemCreate`,e);this.itemGet(t)}catch(t){}},async itemGet(e){const t={mailing_id:e};try{var l;const e=await c().post(`${this.$heap.state.hostname}Admin/Mailing/itemGet`,t);null!==(l=e.user_filter)&&void 0!==l||(e.user_filter={}),this.currentMailing=e,this.isMailingOpen=!0}catch(i){}},async itemUpdate(){const e=this.currentMailing;try{await c().post(`${this.$heap.state.hostname}Admin/Mailing/itemUpdate`,JSON.stringify(e)),this.isMailingOpen=!1,this.listGet()}catch(t){}},async itemDelete(){if(!confirm("Вы уверенны?"))return;const e={mailing_id:this.currentMailing.mailing_id};try{await c().post(`${this.$heap.state.hostname}Admin/Mailing/itemDelete`,e),this.isMailingOpen=!1,this.listGet()}catch(t){}},itemValidate(){if(this.currentMailing.start_at)if(this.currentMailing.user_filter.phones)if(this.currentMailing.subject_template)if(this.currentMailing.text_template){if(this.currentMailing.transport)return!0;alert("Транспорт не заполнен")}else alert("Содержание не заполнено");else alert("Заголовок не заполнен");else alert("Получатели не заполнены");else alert("Начало рассылки не заполнено")},async itemStart(){if(!this.itemValidate()||!confirm(`Запустить рассылку в ${this.currentMailing.start_at}?`))return;const e={mailing_id:this.currentMailing.mailing_id};try{await c().post(`${this.$heap.state.hostname}Admin/Mailing/itemStart`,e),this.isMailingOpen=!1,this.listGet()}catch(t){}},async listGet(){this.mailingList=await u.Z.prePost(`${this.$heap.state.hostname}Admin/Mailing/listGet`,{});try{this.mailingList=await u.Z.post(`${this.$heap.state.hostname}Admin/Mailing/listGet`,{})}catch(e){console.log(e)}},async modalLocationCreate(){if(!this.$heap.state.user.user_id)return this.$flash("Чтобы добавленные адреса сохранились, пожалуйста войдите в систему"),void this.$go({name:"UserSignIn"});var e="рабочий";const t=await s.Fy.create({component:p.Z,showBackdrop:!0,backdropDismiss:!0,componentProps:{location_group_name_low:e}});await t.present();const l=await t.onDidDismiss();l&&(this.currentMailing.user_filter.location=l.data,this.itemUpdate())},async locationDelete(e){try{this.currentMailing.user_filter.location=null,this.itemUpdate()}catch(t){this.$flash("Удалить адрес не удалось")}},async recieverListCreate(){try{const e={mailing_id:this.currentMailing.mailing_id};await this.itemUpdate(),await c().post(this.$heap.state.hostname+"Admin/Mailing/recieverListCreate",e),this.$flash("Список получателей сформирован"),this.itemGet()}catch(e){this.$flash("Создать список получателей не удалось")}}},ionViewDidEnter(){this.listGet()},mounted(){this.listGet()}},h=l(3744);const _=(0,h.Z)(g,[["render",o],["__scopeId","data-v-0507cb9e"]]);var f=_}}]);
//# sourceMappingURL=729-legacy.67c9c852.js.map