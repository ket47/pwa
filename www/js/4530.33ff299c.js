"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[4530],{3917:function(e,t,i){i.r(t),i.d(t,{default:function(){return D}});var o=i(6252);const r={key:0,style:{display:"flex","align-items":"center","justify-content":"center",height:"100%"}},s={style:{width:"max-content","text-align":"center"}},a=(0,o._)("br",null,null,-1),n=(0,o._)("a",{href:"/order/order-list"},"список заказов",-1);function d(e,t,i,d,l,c){var h;const u=(0,o.up)("ion-icon"),p=(0,o.up)("ion-label"),m=(0,o.up)("ship-comp"),_=(0,o.up)("ion-item"),f=(0,o.up)("ion-list"),k=(0,o.up)("ion-content"),$=(0,o.up)("ion-popover"),g=(0,o.up)("base-layout");return(0,o.wg)(),(0,o.j4)(g,{pageTitle:`Вызов курьера #${l.order_id} ${null!==(h=l.order)&&void 0!==h&&h.deleted_at?"(Удален)":""}`,pageDefaultBackLink:"/order/order-list"},{default:(0,o.w5)((()=>["notfound"==l.order?((0,o.wg)(),(0,o.iD)("div",r,[(0,o._)("div",s,[(0,o.Wm)(u,{icon:d.sparklesOutline,size:"large"},null,8,["icon"]),(0,o.Wm)(p,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Заказ не найден")])),_:1}),a,n])])):(0,o.kq)("",!0),(0,o.Wm)(m,{order:l.order,onStageCreate:c.onStageCreate,onOrderRefresh:c.itemGet},null,8,["order","onStageCreate","onOrderRefresh"]),(0,o.Wm)($,{"is-open":l.isOpenDeliveryRejectionPopover,onDidDismiss:t[4]||(t[4]=e=>l.isOpenDeliveryRejectionPopover=!1)},{default:(0,o.w5)((()=>[(0,o.Wm)(k,null,{default:(0,o.w5)((()=>[(0,o.Wm)(f,null,{default:(0,o.w5)((()=>[(0,o.Wm)(_,{button:!0,detail:!1,onClick:t[0]||(t[0]=e=>c.action_rejected_reason("ОТКАЗ КУРЬЕРА: Отказ клиента"))},{default:(0,o.w5)((()=>[(0,o.Wm)(p,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Отказ клиента")])),_:1})])),_:1}),(0,o.Wm)(_,{button:!0,detail:!1,onClick:t[1]||(t[1]=e=>c.action_rejected_reason("ОТКАЗ КУРЬЕРА: Заказ не готов/не соответствует"))},{default:(0,o.w5)((()=>[(0,o.Wm)(p,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Заказ не готов/не соответствует")])),_:1})])),_:1}),(0,o.Wm)(_,{button:!0,detail:!1,onClick:t[2]||(t[2]=e=>c.action_rejected_reason("ОТКАЗ КУРЬЕРА: Поломка в пути"))},{default:(0,o.w5)((()=>[(0,o.Wm)(p,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Поломка в пути")])),_:1})])),_:1}),(0,o.Wm)(_,{button:!0,detail:!1,onClick:t[3]||(t[3]=e=>c.action_rejected_reason("ОТКАЗ КУРЬЕРА: Заказ испорчен"))},{default:(0,o.w5)((()=>[(0,o.Wm)(p,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Заказ испорчен")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["is-open"])])),_:1},8,["pageTitle"])}i(6699);var l=i(8903),c=i(4929),h=i(1039),u=i(2253),p=i(3419),m=i(9332),_=i(3462),f=i(9119),k=i(2639),$=i(6852),g=i(4405),w=i(9755),y=i.n(w),b={components:{ShipComp:h.Z,OrderHistoryComp:u.Z,OrderMetaComp:m.Z,OrderInfoComp:p.Z,OrderTrackingComp:_.Z,ImageTileComp:k.Z,IonLabel:c.Q$,IonIcon:c.gu,IonContent:c.W2,IonItem:c.Ie,IonList:c.q_,IonPopover:c.d8,IonItemDivider:c.rH},setup(){return{sparklesOutline:l.Fcs,chatboxOutline:l.DMF}},data(){return{order_id:this.$route.params.id,order:null,orderAutoloadClock:null,isOpenDeliveryRejectionPopover:!1}},methods:{async itemGet(){try{this.order=await g.Z.prePost(`${this.$heap.state.hostname}Shipment/itemGet`,{order_id:this.order_id}),this.order=await g.Z.post(`${this.$heap.state.hostname}Shipment/itemGet`,{order_id:this.order_id}),this.itemAutoReload()}catch(e){switch(e.status){case 404:this.$flash("Заказ не найден"),this.order="notfound",this.$go("/order/order-list");break}}},itemAutoReload(){clearTimeout(this.orderAutoloadClock),this.orderAutoloadClock=setTimeout((()=>{}),6e4)},async onStageCreate(e,t){if(t.includes("action")){t=t.split("_").splice(1).join("_");try{this[t](e)}catch(i){console.log("stage handler not found"+t)}}else try{const e={order_id:this.order_id,new_stage:t},i=await y().post(`${this.$heap.state.hostname}Shipment/itemStageCreate`,e);if("ok"==i)return"customer_purged"==t||"customer_deleted"==t?(this.$flash("Заказ удален"),this.order=null,void this.$go("/order/order-list")):(await this.itemGet(),!0)}catch(o){const e=o.responseJSON,t=e.messages.error;switch(t){case"wrong_courier_status":this.$flash("Смена курьера не открыта");break;case"order_is_empty":this.$alert("К сожалению, товара не осталось в наличии &#9785;","Заказ пуст");break;case"photos_must_be_made":this.$flash("Необходимо сфотографировать заказ"),this.action_take_photo();break;case"address_not_set":this.$flash("Необходимо добавить адрес доставки"),this.$go("/modal/user-addresses");break;case"order_sum_exceeded":this.$flash("Сумма заказа должна быть меньше предоплаты");break;case"order_sum_zero":this.$flash("Нельзя завершить пустой заказ, от него можно отказаться.");break;case"forbidden_bycustomer":this.$flash("Запрещено покупателем");break;case"already_payed":this.$flash("Заказ уже оплачен");break;default:this.$flash("Не удалось изменить статус заказа");break}return!1}},async action_checkout(){this.$go(`/modal/orderment-checkout-${this.order_id}`)},async action_objection(){const e=await c.Fy.create({component:f.Z,initialBreakpoint:.5,breakpoints:[.5,1],canDissmiss:!0});e.present();const t=await e.onDidDismiss();if(t.data){const e=`ВОЗРАЖЕНИЕ ПОКУПАТЕЛЯ: ${t.data}`,i={order_id:this.order_id,order_objection:e},o=await y().post(`${this.$heap.state.hostname}Shipment/itemUpdate`,i);if("ok"==o){const e=await this.onStageCreate(this.order_id,"customer_disputed");e&&(this.$flash("Ваше возражение принято и будет рассмотрено администратором."),alert("Необходимо сфотографировать заказ"),this.action_take_photo())}}},action_rejected(){this.isOpenDeliveryRejectionPopover=!0},async action_rejected_reason(e){this.isOpenDeliveryRejectionPopover=!1;const t={order_id:this.order_id,order_objection:e};try{await y().post(`${this.$heap.state.hostname}Shipment/itemUpdate`,t);await this.onStageCreate(this.order_id,"delivery_rejected"),this.$flash("Вы отказались от доставки")}catch(i){}},action_take_photo(){this.$refs.orderImgs.take_photo()},async action_courier_assign(){const e="courier",t={status:"ready||busy"},i=await c.Fy.create({component:$.Z,componentProps:{itemType:e,filter:t},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});i.present(),this.$topic.on("dismissModal",(()=>{i.dismiss()}));const o=await i.onDidDismiss();if(o.data)try{const e={order_id:this.order_id,courier_id:o.data.courier_id};await y().post(`${this.$heap.state.hostname}Courier/itemAssign`,e),await this.itemGet(),this.$flash("Курьер назначен")}catch(r){this.$flash("Не удалось назначить курьера")}}},ionViewDidEnter(){this.itemGet()},ionViewDidLeave(){clearTimeout(this.orderAutoloadClock)},created(){this.itemGet(),this.$topic.on("orderSumChanged",(()=>this.itemGet("skipCaching"))),this.$topic.on("pushStageChanged",(e=>{var t;(null===(t=this.order)||void 0===t?void 0:t.order_id)==(null===e||void 0===e?void 0:e.order_id)&&this.order.stage_current!=e.stage&&this.itemGet()}))}},v=i(3744);const C=(0,v.Z)(b,[["render",d]]);var D=C}}]);
//# sourceMappingURL=4530.33ff299c.js.map