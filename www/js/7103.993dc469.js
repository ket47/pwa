"use strict";(self["webpackChunktezkel"]=self["webpackChunktezkel"]||[]).push([[7103],{4405:function(t,e,i){i(4916),i(5306);var a=i(2008);const n={deliveryCalculate(t){if(!t.locations||!t.locations[0]||!t.locations[0].distance)return null;const e=t.locations[0].distance,i=t.store_time_preparation||0;return n.deliveryTimeCalculate(e,i)},deliveryTimeCalculate(t,e){var i;e=parseInt(null!==(i=e)&&void 0!==i?i:a.Z.getters.settings.delivery.timePreparationDefault);const n=parseInt(a.Z.getters.settings.delivery.timeDelta),r=parseInt(a.Z.getters.settings.delivery.speed),s=5*Math.round(t/r*60/5)+e,o=s>n?s-n:s,l=o+n;return{time:s,timeMin:o,timeMax:l}},render(t,e){for(let i in e)t=t.replace(`{{${i}}}`,e[i]);return t=t.replace(/{{\.}}/,"-"),t}};e["Z"]=n},6321:function(t,e,i){i.d(e,{Z:function(){return h}});var a=i(6252),n=i(3577);const r={class:"ion-page"},s=(0,a.Uk)(" Ничего не найдено ");function o(t,e,i,o,l,d){const u=(0,a.up)("ion-title"),c=(0,a.up)("ion-icon"),m=(0,a.up)("ion-toolbar"),p=(0,a.up)("ion-header"),_=(0,a.up)("ion-searchbar"),h=(0,a.up)("ion-skeleton-text"),g=(0,a.up)("ion-item"),f=(0,a.up)("ion-list"),y=(0,a.up)("ion-img"),w=(0,a.up)("ion-avatar"),v=(0,a.up)("ion-content");return(0,a.wg)(),(0,a.iD)("div",r,[(0,a.Wm)(p,null,{default:(0,a.w5)((()=>[(0,a.Wm)(m,{color:"secondary"},{default:(0,a.w5)((()=>[(0,a.Wm)(u,null,{default:(0,a.w5)((()=>[(0,a.Uk)("Выбрать "+(0,n.zw)(l.itemTypeName),1)])),_:1}),(0,a.Wm)(c,{icon:o.closeOutline,onClick:e[0]||(e[0]=t=>{d.closeModal()}),slot:"end",size:"large"},null,8,["icon"])])),_:1})])),_:1}),(0,a.Wm)(v,null,{default:(0,a.w5)((()=>{var i;return["acc"!=l.itemTypeLabel?((0,a.wg)(),(0,a.j4)(_,{key:0,modelValue:l.query,"onUpdate:modelValue":e[1]||(e[1]=t=>l.query=t),placeholder:"поиск",debounce:100,onIonChange:e[2]||(e[2]=t=>d.listGet())},null,8,["modelValue"])):(0,a.kq)("",!0),l.itemList?null!==(i=l.itemList)&&void 0!==i&&i.length?((0,a.wg)(),(0,a.j4)(f,{key:2},{default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(l.itemList,(e=>((0,a.wg)(),(0,a.j4)(g,{key:e.id,button:"",detail:"",onClick:t=>d.itemPick(e)},{default:(0,a.w5)((()=>[(0,a.Wm)(w,{slot:"start"},{default:(0,a.w5)((()=>[e.image_hash?((0,a.wg)(),(0,a.j4)(y,{key:0,src:`${t.$heap.state.hostname}image/get.php/${e.image_hash}.50.50.webp`},null,8,["src"])):(0,a.kq)("",!0)])),_:2},1024),(0,a.Uk)(" "+(0,n.zw)(e.name),1)])),_:2},1032,["onClick"])))),128))])),_:1})):((0,a.wg)(),(0,a.j4)(f,{key:3},{default:(0,a.w5)((()=>[(0,a.Wm)(g,null,{default:(0,a.w5)((()=>[s])),_:1})])),_:1})):((0,a.wg)(),(0,a.j4)(f,{key:1},{default:(0,a.w5)((()=>[((0,a.wg)(),(0,a.iD)(a.HY,null,(0,a.Ko)([0,1,2,3,4,5,6,7,8,9],(t=>(0,a.Wm)(g,{key:t,button:"",detail:""},{default:(0,a.w5)((()=>[(0,a.Wm)(h,{style:{height:"35px",width:"40px"},animated:""}),(0,a.Wm)(h,{style:{width:"100%"},animated:""})])),_:2},1024))),64))])),_:1}))]})),_:1})])}var l=i(8903),d=i(8292),u=i(9755),c=i.n(u),m={props:["itemType"],components:{IonContent:d.W2,IonHeader:d.Gu,IonToolbar:d.sr,IonTitle:d.wd,IonIcon:d.gu,IonImg:d.Xz,IonList:d.q_,IonItem:d.Ie,IonSearchbar:d.VI,IonSkeletonText:d.CK,IonAvatar:d.BJ},setup(){return{closeOutline:l.fID}},data(){const t=this.itemType?this.itemType:"order";return{query:null,itemList:null,itemTypeLabel:t,itemTypeName:""}},mounted(){this.listGet()},methods:{async listGet(){"order"==this.itemTypeLabel?(this.itemTypeName="Заказ",this.ordersGet()):"store"==this.itemTypeLabel?(this.itemTypeName="Продавец",this.storesGet()):"courier"==this.itemTypeLabel?(this.itemTypeName="Курьер",this.couriersGet()):"acc"==this.itemTypeLabel?(this.itemTypeName="Счет",this.accountsGet()):this.$flash("unknown item type "+this.itemTypeLabel)},async storesGet(){const t={name_query:this.query,name_query_fields:"store_name",limit:10};try{let e=await c().post(`${this.$heap.state.hostname}Store/listGet`,t);this.itemList=e.map((t=>(t.name=`продавец ${t.store_name}`,t.id=t.store_id,t)))}catch(e){}},async couriersGet(){const t={name_query:this.query,name_query_fields:"user_name,user_phone",limit:10};try{let e=await c().post(`${this.$heap.state.hostname}Courier/listGet`,t);this.itemList=e.map((t=>(t.name=`курьер ${t.user_name} ${t.user_phone}`,t.id=t.courier_id,t.image_hash=t.courier_photo_image_hash,t)))}catch(e){}},async ordersGet(){const t={name_query:this.query,name_query_fields:"store_name,order_id,user_name",limit:10};try{let e=await c().post(`${this.$heap.state.hostname}Order/listGet`,t);this.itemList=e.map((t=>(t.name=`заказ#${t.order_id} ${t.store_name} > ${t.user_name}`,t.id=t.order_id,t)))}catch(e){}},async accountsGet(){const t={group_table:"transaction_account_list"};try{let e=await c().post(`${this.$heap.state.hostname}Admin/GroupManager/listGet`,t);this.itemList=e.map((t=>(t.name=`${t.group_name}`,t.type=t.group_type,t)))}catch(e){}},itemPick(t){d.Fy.dismiss(t)},closeModal(){d.Fy.dismiss()}}},p=i(3744);const _=(0,p.Z)(m,[["render",o]]);var h=_},7103:function(t,e,i){i.r(e),i.d(e,{default:function(){return b}});var a=i(6252),n=i(3577);const r=(0,a.Uk)("Дата"),s=(0,a.Uk)("Тип проводки"),o=(0,a.Uk)("Родительские элементы"),l=(0,a.Uk)("Сумма"),d=(0,a.Uk)("Комментарий"),u=(0,a.Uk)("Отключена"),c=(0,a.Uk)("Удалить"),m=(0,a.Uk)("Сохранить");function p(t,e,i,p,_,h){const g=(0,a.up)("ion-label"),f=(0,a.up)("ion-input"),y=(0,a.up)("ion-item"),w=(0,a.up)("ion-select-option"),v=(0,a.up)("ion-select"),k=(0,a.up)("ion-icon"),$=(0,a.up)("ion-chip"),D=(0,a.up)("ion-text"),I=(0,a.up)("ion-textarea"),b=(0,a.up)("ion-toggle"),W=(0,a.up)("ion-note"),T=(0,a.up)("ion-list"),C=(0,a.up)("ion-button"),q=(0,a.up)("ion-col"),G=(0,a.up)("ion-row"),U=(0,a.up)("ion-grid"),N=(0,a.up)("base-layout");return(0,a.wg)(),(0,a.j4)(N,{pageDefaultBackLink:"/user","page-title":"Редактирование проводки"},{default:(0,a.w5)((()=>[_.transaction?((0,a.wg)(),(0,a.j4)(T,{key:0},{default:(0,a.w5)((()=>[(0,a.Wm)(y,null,{default:(0,a.w5)((()=>[(0,a.Wm)(g,{position:"floating"},{default:(0,a.w5)((()=>[r])),_:1}),(0,a.Wm)(f,{modelValue:_.transaction.trans_date,"onUpdate:modelValue":e[0]||(e[0]=t=>_.transaction.trans_date=t),placeholder:"дата",type:"date"},null,8,["modelValue"])])),_:1}),(0,a.Wm)(y,null,{default:(0,a.w5)((()=>[(0,a.Wm)(g,{position:"floating"},{default:(0,a.w5)((()=>[s])),_:1}),(0,a.Wm)(v,{interface:"popover",placeholder:"Выберите тип проводки",modelValue:_.transaction.trans_role,"onUpdate:modelValue":e[1]||(e[1]=t=>_.transaction.trans_role=t),required:"",onIonChange:e[2]||(e[2]=t=>h.itemUpdateRole(1))},{default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(_.transTypes,(t=>((0,a.wg)(),(0,a.j4)(w,{key:t.trans_role,value:t.trans_role},{default:(0,a.w5)((()=>[(0,a.Uk)((0,n.zw)(t.trans_name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,a.Wm)(y,{lines:"none"},{default:(0,a.w5)((()=>[(0,a.Wm)(g,{position:"stacked"},{default:(0,a.w5)((()=>[o])),_:1}),(0,a.Wm)(D,null,{default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(_.tagDict,((t,e)=>((0,a.wg)(),(0,a.j4)($,{key:e,color:"primary"},{default:(0,a.w5)((()=>[(0,a.Uk)("#"+(0,n.zw)(t)+" ",1),-1==e.indexOf("acc")?((0,a.wg)(),(0,a.j4)(k,{key:0,src:p.closeCircle,onClick:t=>h.tagDictRemove(e)},null,8,["src","onClick"])):(0,a.kq)("",!0)])),_:2},1024)))),128))])),_:1})])),_:1}),(0,a.Wm)(y,null,{default:(0,a.w5)((()=>[(0,a.Wm)(D,null,{default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(h.tagMissingNames,(t=>((0,a.wg)(),(0,a.j4)($,{key:t,onClick:e=>h.tagDictPick(t),color:"medium"},{default:(0,a.w5)((()=>[(0,a.Wm)(k,{src:p.addOutline},null,8,["src"]),(0,a.Wm)(g,null,{default:(0,a.w5)((()=>[(0,a.Uk)("Добавить #"+(0,n.zw)(_.tagHolderNames[t]),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}),(0,a.Wm)(y,null,{default:(0,a.w5)((()=>[(0,a.Wm)(g,{position:"floating"},{default:(0,a.w5)((()=>[l])),_:1}),(0,a.Wm)(f,{modelValue:_.transaction.trans_amount,"onUpdate:modelValue":e[3]||(e[3]=t=>_.transaction.trans_amount=t),placeholder:"сумма",inputmode:"decimal",autocomplete:"transaction-amount",min:"1"},null,8,["modelValue"])])),_:1}),(0,a.Wm)(y,null,{default:(0,a.w5)((()=>[(0,a.Wm)(g,{position:"floating"},{default:(0,a.w5)((()=>[d])),_:1}),(0,a.Wm)(I,{modelValue:_.transaction.trans_description,"onUpdate:modelValue":e[4]||(e[4]=t=>_.transaction.trans_description=t)},null,8,["modelValue"])])),_:1}),(0,a.Wm)(y,{lines:"full"},{default:(0,a.w5)((()=>[(0,a.Wm)(g,null,{default:(0,a.w5)((()=>[u])),_:1}),(0,a.Wm)(b,{modelValue:_.transaction.is_disabled,"onUpdate:modelValue":e[5]||(e[5]=t=>_.transaction.is_disabled=t)},null,8,["modelValue"])])),_:1}),(0,a.Wm)(y,{lines:"none"},{default:(0,a.w5)((()=>[_.transaction.created_at?((0,a.wg)(),(0,a.j4)(W,{key:0},{default:(0,a.w5)((()=>[(0,a.Uk)(" Создано "+(0,n.zw)(_.transaction.created_user_name)+" "+(0,n.zw)(_.transaction.created_at),1)])),_:1})):(0,a.kq)("",!0),_.transaction.created_at?((0,a.wg)(),(0,a.j4)(W,{key:1},{default:(0,a.w5)((()=>[(0,a.Uk)(" Изменено "+(0,n.zw)(_.transaction.updated_user_name)+" "+(0,n.zw)(_.transaction.updated_at),1)])),_:1})):(0,a.kq)("",!0)])),_:1})])),_:1})):(0,a.kq)("",!0),_.transaction?((0,a.wg)(),(0,a.j4)(U,{key:1},{default:(0,a.w5)((()=>[(0,a.Wm)(G,null,{default:(0,a.w5)((()=>[(0,a.Wm)(q,null,{default:(0,a.w5)((()=>[(0,a.Wm)(C,{color:"medium",onClick:e[6]||(e[6]=t=>h.itemDelete()),expand:"block"},{default:(0,a.w5)((()=>[c])),_:1})])),_:1}),(0,a.Wm)(q,null,{default:(0,a.w5)((()=>[(0,a.Wm)(C,{color:"primary",onClick:e[7]||(e[7]=t=>h.itemSave()),expand:"block"},{default:(0,a.w5)((()=>[m])),_:1})])),_:1})])),_:1})])),_:1})):(0,a.kq)("",!0)])),_:1})}i(6699),i(4916),i(5306),i(8862),i(3948);var _=i(8292),h=i(8903),g=i(9755),f=i.n(g),y=i(351),w=i(4405),v=i(6321);const k=[{trans_role:"profit->site",holder:["order","store","courier"],trans_name:"Сайт Доход от доставки",trans_description:"Доход от доставки. Заказ №{{order_id}}"},{trans_role:"site->profit",holder:["order"],trans_name:"Сайт Списание месячной прибыли",trans_description:"Списание месячной прибыли"},{trans_role:"site->supplier",holder:["store"],trans_name:"Продавец Выплата",trans_description:"Выплата по договору за выполненные заказы"},{trans_role:"site.->supplier",holder:["order","store"],trans_name:"Продавец Штраф",trans_description:"Средства взимаемые с Продавца для воврата оплаты Покупателю. Заказ №{{order_id}}"},{trans_role:"supplier->site",holder:["order","store"],trans_name:"Продавец Отгрузка заказа",trans_description:"Стоимость товара, отгруженного Покупателю. Заказ №{{order_id}}"},{trans_role:"profit->supplier",holder:["order","store"],trans_name:"Продавец Комиссия сайта",trans_description:"Комиссия сайта за предоставленные услуги. Заказ №{{order_id}}"},{trans_role:"supplier->site",holder:["store"],trans_name:"Продавец Получение аванса",trans_description:"Аванс за услуги сайта"},{trans_role:"supplier->profit",holder:["store"],trans_name:"Продавец Начисление бонуса при регистрации",trans_description:"Начисление бонуса на услуги при регистрации на сайте"},{trans_role:"site->courier",holder:["courier"],trans_name:"Курьер Выплата",trans_description:"Выплата по договору за оказанные услуги"},{trans_role:"courier->profit",holder:["order","courier"],trans_name:"Курьер Начисление бонуса",trans_description:"Начисление бонуса за Заказ №{{order_id}}"},{trans_role:"profit->courier",holder:["order","courier"],trans_name:"Курьер Штраф",trans_description:"Штраф за не выполнение Заказа №{{order_id}}"}];var $={components:{IonInput:_.pK,IonIcon:_.gu,IonList:_.q_,IonItem:_.Ie,IonToggle:_.ho,IonLabel:_.Q$,IonSelect:_.t9,IonSelectOption:_.n0,IonTextarea:_.g2,IonButton:_.YG,IonGrid:_.jY,IonRow:_.Nd,IonCol:_.wI,IonNote:_.uN,IonChip:_.hM,IonText:_.yW},setup(){return{trashOutline:h.gtu,searchOutline:h.W6I,addOutline:h.s6O,closeCircle:h.XZx}},data(){return{transactionId:this.$route.params.id,transaction:null,transTypes:k,tagDict:{},tagHolderNames:{order:"заказ",store:"продавец",courier:"курьер",acc:"счет"},tagOptionNames:{debit:"(+)",credit:"(-)"}}},computed:{tagRequired(){var t;return(null===(t=this.transTypeCurrent)||void 0===t?void 0:t.holder)||[]},tagMissingNames(){var t;return(null===(t=this.tagRequired)||void 0===t?void 0:t.filter((t=>!Object.keys(this.tagDict).join(":").includes(t))))||""},transTypeCurrent(){return this.transTypes.find((t=>t.trans_role==this.transaction.trans_role))||[]}},created(){const t=this;this.$topic.on("userGet",(()=>{t.init()})),y.Z.isAdmin()&&this.init()},methods:{init(){y.Z.isAdmin()||this.$router.replace("/"),this.itemGet()},async itemGet(){if(0==this.transactionId)return void(this.transaction={});let t={trans_id:this.transactionId};try{var e;this.transaction=await f().post(`${this.$heap.state.hostname}Transaction/itemGet`,t),this.transaction.trans_date=null===(e=this.transaction.trans_date)||void 0===e?void 0:e.substring(0,10),this.transaction.is_disabled=1*this.transaction.is_disabled,this.tagDictFill(this.transaction.tags)}catch(n){var i,a;const t=null===n||void 0===n||null===(i=n.responseJSON)||void 0===i||null===(a=i.messages)||void 0===a?void 0:a.error;switch(t){case"forbidden":this.$flash("Не достаточно прав");break;case"notfound":this.$flash("Проводка не найдена");break}return!1}},validate(){return this.tagMissingNames.length>0?(this.$flash("Не выбраны все родительские элементы"),!1):this.transaction.trans_role?this.transaction.trans_date?0!=this.transaction.trans_amount||(this.$flash("Сумма должна не равняться нулю"),!1):(this.$flash("Дата не выбрана"),!1):(this.$flash("Тип проводки не выбран"),!1)},async itemSave(){var t;if(!this.validate())return;const e=Object.keys(null!==(t=this.tagDict)&&void 0!==t?t:{}).join(" "),i={tags:e,trans_id:this.transaction.trans_id,trans_date:this.transaction.trans_date,trans_amount:this.transaction.trans_amount,trans_role:this.transaction.trans_role,trans_description:this.transaction.trans_description,is_disabled:this.transaction.is_disabled};try{const t=i.trans_id?"itemUpdate":"itemCreate";await f().post(`${this.$heap.state.hostname}Transaction/${t}`,JSON.stringify(i)),this.$flash("💾 сохранено"),this.$router.go(-1)}catch(r){var a,n;const t=null===r||void 0===r||null===(a=r.responseJSON)||void 0===a||null===(n=a.messages)||void 0===n?void 0:n.error;switch(t){case"forbidden":this.$flash("Не достаточно прав");break}return this.$flash("Не удалось сохранить проводку"),!1}},async itemUpdateRole(){this.transTypeCurrent?this.tagDictTruncate():this.$flash("Неверный тип проводки")},itemDescriptionRender(){if(!this.transTypeCurrent.trans_description)return;const t=this.transTypeCurrent.trans_description;let e=this.transaction;for(let i in this.tagDict){this.tagDict[i];const t=i.split(":"),a=t[0];e[`${a}_id`]=t[1]}this.transaction.trans_description=w.Z.render(t,e)},async itemDelete(){if(confirm("Вы уверенны?"))try{await f().post(`${this.$heap.state.hostname}Transaction/itemDelete`,{trans_id:this.transactionId}),this.$router.go(-1)}catch(t){}},async tagDictPick(t){var e,i,a,n;const r=await _.Fy.create({component:v.Z,componentProps:{itemType:t},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});r.present(),this.$topic.on("dismissModal",(()=>{r.dismiss()}));const s=await r.onDidDismiss();if(s.data){if(null!==(e=s.data.order_id)&&void 0!==e&&e){this.tagDictAdd([`order:${s.data.order_id}`,`заказ ${s.data.order_id}`]);const t=await f().post(`${this.$heap.state.hostname}Order/itemGet`,{order_id:s.data.order_id});var o;if(this.tagRequired.includes("store")&&t.order_store_id)this.tagDictNameRemove("store"),s.data.store_id=t.order_store_id,s.data.store_name=null===t||void 0===t||null===(o=t.store)||void 0===o?void 0:o.store_name;if(this.tagRequired.includes("courier")&&t.order_courier_id){const e=await f().post(`${this.$heap.state.hostname}Courier/itemGet`,{courier_id:t.order_courier_id});this.tagDictNameRemove("courier"),s.data.courier_id=e.courier_id,s.data.courier_name=e.courier_name}}var l,d,u;if(null!==(i=s.data.store_id)&&void 0!==i&&i)this.tagDictAdd([`store:${s.data.store_id}`,`продавец ${null!==(l=s.data.store_name)&&void 0!==l?l:"?"}`]);if(null!==(a=s.data.courier_id)&&void 0!==a&&a)this.tagDictAdd([`courier:${s.data.courier_id}`,`курьер ${null!==(d=s.data.courier_name)&&void 0!==d?d:"?"}`]);if(null!==(n=s.data.type)&&void 0!==n&&n)this.tagDictAdd([`acc::${s.data.type}`,`счет ${null!==(u=s.data.name)&&void 0!==u?u:"?"}`])}},tagDictAdd(t){var e;let i=null!==(e=this.tagDict)&&void 0!==e?e:{};i[t[0]]=t[1],this.tagDict=i,this.itemDescriptionRender()},tagDictRemove(t){var e;let i=null!==(e=this.tagDict)&&void 0!==e?e:{};i[t]&&delete i[t];const a=Object.keys(i).length;this.tagDict=a?i:{},this.itemDescriptionRender()},tagDictNameRemove(t){var e,i;let a=null!==(e=this.tagDict)&&void 0!==e?e:{};const n=null===(i=Object.keys(a))||void 0===i?void 0:i.find((e=>e.indexOf(t)>-1));this.tagDictRemove(n)},tagDictTruncate(){this.tagDict={},this.itemDescriptionRender()},tagDictFill(t){let e={};if(t)for(let n of t){var i,a;e[`${n.tag_name}:${n.tag_id}:${n.tag_type}:${n.tag_option}`]=`${this.tagHolderNames[n.tag_name]} ${null!==(i=this.tagOptionNames[n.tag_option])&&void 0!==i?i:""} ${null!==(a=n.tag_label)&&void 0!==a?a:"(?)"}`}this.tagDict=e,this.itemDescriptionRender()}}},D=i(3744);const I=(0,D.Z)($,[["render",p]]);var b=I}}]);
//# sourceMappingURL=7103.993dc469.js.map