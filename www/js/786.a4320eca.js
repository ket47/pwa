"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[786],{6932:function(e,t,o){o.d(t,{Z:function(){return D}});var i=o(6252),n=o(3577);const a=(0,i.Uk)("Фотографии"),r={key:0,class:"image_grid"},s=["onClick"],l={key:0},d={key:1},c={key:0,class:"image_controls"},u=["id"];function m(e,t,o,m,h,p){const _=(0,i.up)("ion-label"),g=(0,i.up)("ion-icon"),f=(0,i.up)("ion-item"),k=(0,i.up)("ion-img"),w=(0,i.up)("ion-avatar");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i._)("div",null,[(0,i.Wm)(f,{lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(_,{color:"imageList?.length?'':medium"},{default:(0,i.w5)((()=>[a])),_:1}),h.editMode?((0,i.wg)(),(0,i.j4)(g,{key:0,slot:"end",icon:m.settingsSharp,color:"primary",onClick:t[0]||(t[0]=e=>h.editMode=0)},null,8,["icon"])):((0,i.wg)(),(0,i.j4)(g,{key:1,slot:"end",icon:m.settingsOutline,onClick:t[1]||(t[1]=e=>{h.editMode=1,p.load()})},null,8,["icon"]))])),_:1}),p.imageList?.length?((0,i.wg)(),(0,i.iD)("div",r,[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(p.imageList,(t=>((0,i.wg)(),(0,i.iD)("div",{key:t.image_id,style:{position:"relative"}},[(0,i._)("div",{style:{position:"absolute",top:"0px","background-color":"#fffc","font-size":"0.75em"},onClick:e=>p.imagePreview(t.image_hash)},[t.deleted_at?((0,i.wg)(),(0,i.iD)("div",l,"будет удалено")):1==t.is_disabled?((0,i.wg)(),(0,i.iD)("div",d,"на модерации")):(0,i.kq)("",!0)],8,s),(0,i.Wm)(w,{onClick:e=>p.imagePreview(t.image_hash),class:(0,n.C_)(t.class)},{default:(0,i.w5)((()=>[(0,i.Wm)(k,{src:e.$heap.state.hostname+"image/get.php/"+t.image_hash+".100.100.webp"},null,8,["src"])])),_:2},1032,["onClick","class"]),h.editMode?((0,i.wg)(),(0,i.iD)("div",c,[(0,i.Wm)(g,{icon:m.chevronBackCircleOutline,onClick:e=>p.back(t)},null,8,["icon","onClick"]),p.isAdmin&&1==t.is_disabled?((0,i.wg)(),(0,i.j4)(g,{key:0,icon:m.checkmarkCircle,color:"success",onClick:e=>p.enable(t)},null,8,["icon","onClick"])):(0,i.kq)("",!0),t.deleted_at?((0,i.wg)(),(0,i.j4)(g,{key:1,icon:m.addCircle,color:"success",onClick:e=>p.restore(t)},null,8,["icon","onClick"])):((0,i.wg)(),(0,i.j4)(g,{key:2,icon:m.trash,color:"danger",onClick:e=>p.remove(t)},null,8,["icon","onClick"])),(0,i.Wm)(g,{icon:m.chevronForwardCircleOutline,onClick:e=>p.forward(t)},null,8,["icon","onClick"])])):(0,i.kq)("",!0)])))),128))])):(0,i.kq)("",!0)]),(0,i._)("input",{type:"file",id:h.fileUploaderId,accept:"image/*",onChange:t[2]||(t[2]=e=>p.uploadImage(e)),style:{display:"none"}},null,40,u)],64)}var h=o(8903),p=o(1716);const _=(0,i.Uk)("Просмотр фотографии");function g(e,t,o,n,a,r){const s=(0,i.up)("ion-title"),l=(0,i.up)("ion-icon"),d=(0,i.up)("ion-toolbar"),c=(0,i.up)("ion-header"),u=(0,i.up)("ion-img"),m=(0,i.up)("ion-content");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[(0,i.Wm)(s,null,{default:(0,i.w5)((()=>[_])),_:1}),(0,i.Wm)(l,{icon:n.closeOutline,onClick:t[0]||(t[0]=e=>{n.closeModal()}),slot:"end",size:"large"},null,8,["icon"])])),_:1})])),_:1}),(0,i.Wm)(m,null,{default:(0,i.w5)((()=>[(0,i.Wm)(u,{src:e.$heap.state.hostname+"image/get.php/"+o.image_hash+".1000.1000.webp"},null,8,["src"])])),_:1})],64)}var f={props:["image_hash"],components:{IonIcon:p.gu,IonToolbar:p.sr,IonHeader:p.Gu,IonImg:p.Xz,IonContent:p.W2,IonTitle:p.wd},setup(){const e=function(){p.Fy.dismiss()};return{closeModal:e,closeOutline:h.fID}}},k=o(3744);const w=(0,k.Z)(f,[["render",g]]);var I=w,y=o(9755),b=o.n(y),v=o(9042),W=o(351),C={props:["images","image_holder_id","controller"],components:{IonLabel:p.Q$,IonIcon:p.gu,IonItem:p.Ie,IonImg:p.Xz,IonAvatar:p.BJ},setup(){return{settingsOutline:h.C$N,settingsSharp:h.kiF,chevronBackCircleOutline:h.CK0,chevronForwardCircleOutline:h.esm,trash:h._Ij,addCircle:h.ZWo,checkmarkCircle:h.I1A}},data(){return{images_loaded:null,editMode:!1,fileUploaderId:this.controller+this.image_holder_id}},computed:{imageList(){let e=this.images_loaded||this.images,t=[];for(let o in e)e[o].deleted_at?(e[o].class=" deleted",this.editMode&&t.push(e[o])):1==e[o].is_disabled?(e[o].class=" disabled",this.editMode&&t.push(e[o])):t.push(e[o]);return t},isAdmin(){return W.Z.isAdmin()}},methods:{async back(e){try{await b().post(this.$heap.state.hostname+"Image/itemUpdateOrder",{image_id:e.image_id,dir:"up"}),this.load()}catch{}},async forward(e){try{await b().post(this.$heap.state.hostname+"Image/itemUpdateOrder",{image_id:e.image_id,dir:"down"}),this.load()}catch{}},async remove(e){try{await b().post(this.$heap.state.hostname+"Image/itemDelete",{image_id:e.image_id}),this.load(),this.$flash("Фото перемещено в корзину и будет удалено")}catch{}},async restore(e){try{await b().post(this.$heap.state.hostname+"Image/itemUnDelete",{image_id:e.image_id}),this.load(),this.$flash("Фото перемещено извлечено из корзины")}catch{}},async enable(e){try{await b().post(this.$heap.state.hostname+"Image/itemDisable",{image_id:e.image_id,is_disabled:0}),this.load()}catch{}},async load(){const e={image_holder_id:this.image_holder_id,image_holder:this.controller,is_disabled:1,is_deleted:1,is_active:1};this.images_loaded=await b().post(this.$heap.state.hostname+"Image/listGet",e)},async imagePreview(e){const t=await p.Fy.create({component:I,componentProps:{image_hash:e},initialBreakpoint:.5,breakpoints:[.5,1]}),o=function(){t.dismiss()};return v.Z.on("dismissModal",o),t.present()},async uploadImage(e){let t=new FormData;t.append("files[]",e.target.files[0]),t.set("image_holder_id",this.image_holder_id);const o={url:this.$heap.state.hostname+this.controller+"/fileUpload",type:"POST",data:t,processData:!1,contentType:!1};try{await b().ajax(o),this.load()}catch(i){if("limit_exeeded"==i?.responseJSON?.messages?.error)return void this.$flash("Уже загружено максимальное количество фото");this.$flash("Не удалось загрузить фото")}},take_photo(){b()(`#${this.fileUploaderId}`).trigger("click"),this.editMode=!0}}};const j=(0,k.Z)(C,[["render",m],["__scopeId","data-v-86616cc0"]]);var D=j},8786:function(e,t,o){o.r(t),o.d(t,{default:function(){return z}});var i=o(6252);const n={key:0,style:{display:"flex","align-items":"center","justify-content":"center",height:"100%"}},a={style:{width:"max-content","text-align":"center"}},r=(0,i.Uk)("Заказ не найден"),s=(0,i._)("br",null,null,-1),l=(0,i._)("a",{href:"/order-list"},"список заказов",-1);function d(e,t,o,d,c,u){const m=(0,i.up)("ion-icon"),h=(0,i.up)("ion-label"),p=(0,i.up)("order-comp"),_=(0,i.up)("order-tracking-comp"),g=(0,i.up)("order-history-comp"),f=(0,i.up)("image-tile-comp"),k=(0,i.up)("ion-content"),w=(0,i.up)("base-layout");return(0,i.wg)(),(0,i.j4)(w,{pageTitle:"Заказ",pageDefaultBackLink:"order-list"},{default:(0,i.w5)((()=>[c.order?((0,i.wg)(),(0,i.j4)(k,{key:0},{default:(0,i.w5)((()=>["notfound"==c.order?((0,i.wg)(),(0,i.iD)("div",n,[(0,i._)("div",a,[(0,i.Wm)(m,{icon:d.sparklesOutline,size:"large"},null,8,["icon"]),(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[r])),_:1}),s,l])])):(0,i.kq)("",!0),(0,i.Wm)(p,{orderData:c.order,onStageCreate:u.onStageCreate},null,8,["orderData","onStageCreate"]),(0,i.Wm)(_,{orderData:c.order},null,8,["orderData"]),(0,i.Wm)(g,{orderData:c.order},null,8,["orderData"]),(0,i.Wm)(f,{images:c.order?.images,image_holder_id:c.order?.order_id,controller:"Order",ref:"orderImgs"},null,8,["images","image_holder_id"])])),_:1})):(0,i.kq)("",!0)])),_:1})}var c=o(8903),u=o(1716),m=o(7782),h=o(5506),p=o(3577);const _=(0,i.Uk)("История заказа");function g(e,t,o,n,a,r){const s=(0,i.up)("ion-label"),l=(0,i.up)("ion-item"),d=(0,i.up)("ion-icon"),c=(0,i.up)("ion-text"),u=(0,i.up)("ion-note"),m=(0,i.up)("ion-list"),h=(0,i.up)("ion-accordion"),g=(0,i.up)("ion-accordion-group");return o.orderData?.stages?((0,i.wg)(),(0,i.j4)(g,{key:0},{default:(0,i.w5)((()=>[(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[(0,i.Wm)(l,{slot:"header"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,null,{default:(0,i.w5)((()=>[_])),_:1})])),_:1}),(0,i.Wm)(m,{slot:"content"},{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(o.orderData.stages,(e=>((0,i.wg)(),(0,i.j4)(l,{key:e.group_id},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{slot:"start",icon:n.checkmarkOutline,size:"small",color:"success"},null,8,["icon"]),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Uk)((0,p.zw)(e.group_name),1)])),_:2},1024),(0,i.Wm)(u,{slot:"end",style:{width:"80px"}},{default:(0,i.w5)((()=>[(0,i.Uk)((0,p.zw)(e.created_at),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1})):(0,i.kq)("",!0)}var f={props:["orderData"],components:{IonIcon:u.gu,IonText:u.yW,IonLabel:u.Q$,IonItem:u.Ie,IonList:u.q_,IonNote:u.uN,IonAccordion:u.We,IonAccordionGroup:u.eh},setup(){return{checkmarkOutline:c.TjA}}},k=o(3744);const w=(0,k.Z)(f,[["render",g]]);var I=w;const y=(0,i.Uk)("Отслеживание заказа");function b(e,t,o,n,a,r){const s=(0,i.up)("ion-label"),l=(0,i.up)("ion-item"),d=(0,i.up)("ion-icon"),c=(0,i.up)("ion-chip"),u=(0,i.up)("ion-progress-bar"),m=(0,i.up)("ion-list"),h=(0,i.up)("ion-accordion"),_=(0,i.up)("ion-accordion-group");return o.orderData&&"delivery_start"==a.job?.group_type?((0,i.wg)(),(0,i.j4)(_,{key:0,value:"tracking",color:"primary"},{default:(0,i.w5)((()=>[(0,i.Wm)(h,{value:"tracking"},{default:(0,i.w5)((()=>[(0,i.Wm)(l,{slot:"header"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,null,{default:(0,i.w5)((()=>[y])),_:1})])),_:1}),(0,i.Wm)(m,{slot:"content"},{default:(0,i.w5)((()=>[(0,i.Wm)(l,{lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{color:"primary",slot:"start",icon:n.locationOutline,style:{"font-size":"30px"}},null,8,["icon"]),(0,i.Wm)(s,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Курьер, "+(0,p.zw)(a.job.courier_name),1)])),_:1})])),_:1}),r.courier_finish_distance_km?((0,i.wg)(),(0,i.j4)(l,{key:0,lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(c,{slot:"start",color:"success"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,p.zw)(r.courier_finish_distance_km),1)])),_:1}),(0,i.Wm)(c,{slot:"end",color:"primary"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,p.zw)(r.courier_finish_time_min.timeMin)+"-"+(0,p.zw)(r.courier_finish_time_min.timeMax)+"мин ",1)])),_:1})])),_:1})):(0,i.kq)("",!0),r.courier_finish_distance_km?((0,i.wg)(),(0,i.j4)(l,{key:1,lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{color:"secondary",value:r.courier_progress,reversed:"true"},null,8,["value"])])),_:1})):(0,i.kq)("",!0),(0,i.Wm)(l,{lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,{style:{"text-align":"right"}},{default:(0,i.w5)((()=>[(0,i.Uk)("Клиент, "+(0,p.zw)(e.$heap.state.user.user_name),1)])),_:1}),(0,i.Wm)(d,{color:"primary",slot:"end",icon:n.flagOutline,style:{"font-size":"30px"}},null,8,["icon"])])),_:1})])),_:1})])),_:1})])),_:1})):(0,i.kq)("",!0)}var v=o(4405),W={props:["orderData"],components:{IonList:u.q_,IonItemGroup:u.Ub,IonTitle:u.wd,IonButton:u.YG,IonSkeletonText:u.CK,IonNote:u.uN,IonChip:u.hM,IonItem:u.Ie,IonLabel:u.Q$,IonText:u.yW,IonAvatar:u.BJ,IonIcon:u.gu,IonAccordionGroup:u.eh,IonAccordion:u.We,IonProgressBar:u.X7},setup(){return{storefrontOutline:c.qRG,locationOutline:c.Iv7,flagOutline:c.FMn}},data(){return{job:null,refreshInterval:6e4}},mounted(){this.jobGet()},computed:{courier_finish_distance_km(){return this.job?.courier_finish_distance?Math.round(this.job?.courier_finish_distance/100)/10+"км":"-"},courier_finish_time_min(){return v.Z.deliveryTimeCalculate(this.job?.courier_finish_distance,0)},courier_progress(){return this.job?.courier_finish_distance/this.job?.start_finish_distance}},methods:{async jobGet(){if(this.isDelivering())try{if(this.job=await m.Z.api.itemJobTrack(this.orderData.order_id),"delivery_start"==this.job.group_type){const e=this;setTimeout((()=>{e.jobGet()}),this.refreshInterval)}}catch(e){const t=e.responseJSON?.messages?.error;if("notfound"==t)return void this.$flash("Задание не найдено");if("notready"==t)return void this.$flash("Смена курьера не открыта")}},isDelivering(){for(let e of this.orderData.stages??[])if("delivery_start"==e?.group_type)return!0;return!1}}};const C=(0,k.Z)(W,[["render",b],["__scopeId","data-v-d42fab84"]]);var j=C;const D=(0,i.Uk)("Возражение"),$=(0,i.Uk)("Сохранить возражение"),O=(0,i.Uk)("Закрыть без возражения");function x(e,t,o,n,a,r){const s=(0,i.up)("ion-title"),l=(0,i.up)("ion-toolbar"),d=(0,i.up)("ion-header"),c=(0,i.up)("ion-label"),u=(0,i.up)("ion-textarea"),m=(0,i.up)("ion-item"),h=(0,i.up)("ion-list"),p=(0,i.up)("ion-button"),_=(0,i.up)("ion-content");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[(0,i.Wm)(l,{color:"secondary"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,null,{default:(0,i.w5)((()=>[D])),_:1})])),_:1})])),_:1}),(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[(0,i.Wm)(m,null,{default:(0,i.w5)((()=>[(0,i.Wm)(c,{position:"stacked"}),(0,i.Wm)(u,{rows:"6",modelValue:a.objection_text,"onUpdate:modelValue":t[0]||(t[0]=e=>a.objection_text=e),placeholder:"опишите суть возражения к исполнению заказа"},null,8,["modelValue"])])),_:1})])),_:1}),(0,i.Wm)(p,{onClick:t[1]||(t[1]=e=>r.save()),color:"primary",disabled:!a.objection_text||a.objection_text.length<10,expand:"full"},{default:(0,i.w5)((()=>[$])),_:1},8,["disabled"]),(0,i.Wm)(p,{onClick:t[2]||(t[2]=e=>r.close()),color:"light",expand:"full"},{default:(0,i.w5)((()=>[O])),_:1})])),_:1})],64)}var T={components:{IonTextarea:u.g2,IonButton:u.YG,IonHeader:u.Gu,IonToolbar:u.sr,IonTitle:u.wd,IonContent:u.W2,IonList:u.q_,IonItem:u.Ie,IonLabel:u.Q$},data(){return{objection_text:null}},methods:{close(){u.Fy.dismiss()},save(){u.Fy.dismiss(this.objection_text)}}};const U=(0,k.Z)(T,[["render",x]]);var Z=U,M=o(6932),G={components:{OrderComp:h.Z,OrderHistoryComp:I,OrderTrackingComp:j,ImageTileComp:M.Z,IonLabel:u.Q$,IonIcon:u.gu,IonContent:u.W2,IonAccordion:u.We,IonAccordionGroup:u.eh,IonItem:u.Ie,IonText:u.yW,IonNote:u.uN,IonList:u.q_},setup(){return{sparklesOutline:c.Fcs}},data(){return{order_id:0,order:null,orderIsLoading:!1}},methods:{async orderGet(){if(!this.orderIsLoading){try{this.orderIsLoading=!0,this.order=await m.Z.api.itemGet(this.order_id)}catch(e){switch(e.status){case 404:this.$flash("Заказ не найден"),this.order="notfound",this.$router.push("order-list");break}}this.orderIsLoading=!1}},async onStageCreate(e,t){if(t.includes("action")){t=t.split("_").splice(1).join("_");try{this[t](e)}catch{}}else try{const o=await m.Z.api.itemStageCreate(e,t);if("ok"==o)return"customer_purged"==t?(this.$flash("Заказ удален"),this.order=null,void this.$router.push("order-list")):(await this.orderGet(),!0)}catch(o){const e=o.responseJSON,t=e.messages.error;switch(t){case"order_is_empty":this.$flash("Заказ пуст");break;case"photos_must_be_made":this.$flash("Необходимо сфотографировать заказ"),this.action_take_photo();break}return!1}},async action_checkout(e){const t=await this.onStageCreate(e,"customer_confirmed");t&&(this.$heap.commit("setCurrentOrder",this.order),this.$router.push("order-checkout"))},async action_objection(){const e=await u.Fy.create({component:Z,initialBreakpoint:.5,breakpoints:[.5,1],canDissmiss:!0});e.present();const t=await e.onDidDismiss();if(t.data){const e=await m.Z.api.itemUpdate({order_id:this.order_id,order_objection:t.data});if("ok"==e){const e=await this.onStageCreate(this.order_id,"customer_disputed");e&&(this.$flash("Ваше возражение принято и будет рассмотрено администратором."),alert("Необходимо сделать фото заказа"),this.action_take_photo())}}},action_take_photo(){this.$refs.orderImgs.take_photo()},action_call_customer(){window.open(`tel:${this.order.customer.user_phone}`)}},ionViewDidEnter(){this.order_id=this.$route.params.id,this.orderGet()},mounted(){this.order_id=this.$route.params.id,this.orderGet()}};const L=(0,k.Z)(G,[["render",d]]);var z=L},4405:function(e,t,o){var i=o(2008);const n={deliveryCalculate(e){if(!e.locations||!e.locations[0]||!e.locations[0].distance)return null;const t=e.locations[0].distance,o=e.store_time_preparation||0;return n.deliveryTimeCalculate(t,o)},deliveryTimeCalculate(e,t){t=t??i.Z.state.deliverySettings.defaultPreparationTime;const o=i.Z.state.deliverySettings.deliveryTimeDelta,n=5*Math.round(e/i.Z.state.deliverySettings.courierVelocity*60/5)+parseInt(t),a=n>o?n-o:n,r=a+o;return{time:n,timeMin:a,timeMax:r}}};t["Z"]=n}}]);
//# sourceMappingURL=786.a4320eca.js.map