"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[8734],{5432:function(e,t,l){l.d(t,{A:function(){return h}});var i=l(641),a=l(33);const n={style:{position:"absolute",top:"30px",width:"100%","--ion-item-background":"#ffffffdd","border-radius":"10px"}},o={slot:"end",style:{color:"#666"}};function s(e,t,l,s,r,u){const c=(0,i.g2)("ymap-marker"),d=(0,i.g2)("yandex-map"),g=(0,i.g2)("ion-searchbar"),m=(0,i.g2)("ion-item"),p=(0,i.g2)("ion-content"),h=(0,i.g2)("ion-textarea"),_=(0,i.g2)("ion-icon"),k=(0,i.g2)("ion-button"),f=(0,i.g2)("ion-toolbar");return(0,i.uX)(),(0,i.CE)(i.FK,null,[(0,i.bF)(p,null,{default:(0,i.k6)((()=>[(0,i.bF)(d,{onClick:t[0]||(t[0]=e=>u.onClick(e)),style:{height:"100%"},coords:r.coords,zoom:16,settings:r.settings,controls:["zoomControl"]},{default:(0,i.k6)((()=>[(0,i.bF)(c,{coords:r.coords,"marker-id":"1",properties:r.placemarkProperties},null,8,["coords","properties"])])),_:1},8,["coords","settings"]),(0,i.Lk)("div",n,[(0,i.bF)(g,{debounce:"500",modelValue:r.addressSearchQuery,"onUpdate:modelValue":t[1]||(t[1]=e=>r.addressSearchQuery=e),onIonInput:t[2]||(t[2]=e=>u.suggestionsGet()),placeholder:"поиск по адресу",color:"light"},null,8,["modelValue"]),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(r.suggestions,((e,t)=>((0,i.uX)(),(0,i.Wv)(m,{key:t,onClick:t=>u.suggestionSelect(`${e.subtitle.text}, ${e.title.text}`,e.uri),style:{"margin-right":"10px","margin-left":"10px"}},{default:(0,i.k6)((()=>[(0,i.eW)((0,a.v_)(e.subtitle.text)+" "+(0,a.v_)(e.title.text)+" ",1),(0,i.Lk)("span",o,(0,a.v_)(e.distance.text),1)])),_:2},1032,["onClick"])))),128))])])),_:1}),(0,i.bF)(f,null,{default:(0,i.k6)((()=>[(0,i.bF)(h,{label:"комментарий к адресу","label-placement":"floating",modelValue:r.addressComment,"onUpdate:modelValue":t[3]||(t[3]=e=>r.addressComment=e)},null,8,["modelValue"]),(0,i.bF)(k,{strong:!0,onClick:t[4]||(t[4]=e=>u.pickAddress()),color:"primary",expand:"block"},{default:(0,i.k6)((()=>[(0,i.bF)(_,{src:s.checkmark,slot:"start"},null,8,["src"]),(0,i.eW)(" Ок ")])),_:1}),(0,i.bF)(k,{onClick:t[5]||(t[5]=e=>s.closeModal()),color:"light",expand:"block"},{default:(0,i.k6)((()=>[(0,i.eW)("Закрыть")])),_:1})])),_:1})],64)}l(4114);var r=l(972),u=l(5221),c=l(5480),d=l(8701),g={components:{IonContent:r.W9,IonToolbar:r.ai,IonButton:r.Jm,IonSearchbar:r.S1,IonIcon:r.iq,IonItem:r.uz,IonTextarea:r.nc,yandexMap:u.IK,ymapMarker:u.cT},setup(){const e=function(){r.OZ.dismiss()};return{closeModal:e,locationOutline:c.UN$,closeOutline:c.xfX,checkmark:c.AIp}},props:{location_group_name_low:String,location_group_id:Number},data(){let e=this.location_group_name_low+" адрес",t=this.$heap.state.settings.location,l=JSON.parse(t.mapCenter);return{settings:{apiKey:t.ymapApiKey,lang:"ru_RU",coordorder:"latlong",version:"2.1"},placemarkProperties:{iconCaption:e},suggestions:[],addressSearchQuery:null,markDeviceOnMap:!0,locationType:e,locSettings:t,selectedPlacemark:0,selectedAddress:"",selectedCoords:[],coords:l,addressComment:""}},methods:{async pickAddress(){try{if(!this.selectedAddress){var e;const t=await window.ymaps.geocode(this.coords);this.selectedAddress=null===(e=t.geoObjects.get(0))||void 0===e?void 0:e.getAddressLine()}}catch(l){}var t={location_address:this.filterAddress(this.selectedAddress),location_latitude:this.coords[0],location_longitude:this.coords[1],location_comment:this.addressComment};r.OZ.dismiss(t)},filterAddress(e){const t=this.locSettings.addressErase.split(", "),l=e.split(", ");let i=[];for(const a of l)t.find((e=>e==a))||i.push(a);return i.reverse().join(", ")},onClick(e){e&&e.get&&(this.markDeviceOnMap=!1,this.suggestions=[],this.selectedAddress=null,this.coords=e.get("coords"))},async suggestionsGet(){if(this.markDeviceOnMap=!1,this.addressSearchQuery)try{const e=this.$heap.state.settings.location.ymapSuggestionApiKey,t=this.coords.slice().reverse().join(","),l=await fetch(`https://suggest-maps.yandex.ru/v1/suggest?apikey=${e}&lang=ru_RU&ll=${t}&spn=1,1&attrs=uri&types=house&results=5&text=${this.addressSearchQuery}`),i=await l.json();this.suggestions=i.results||[]}catch{}else this.suggestions=[]},async suggestionSelect(e,t){this.selectedAddress=e,this.geocode(t)},async geocode(e){try{this.suggestions=[];const t=this.$heap.state.settings.location.ymapApiKey,l=await fetch(`https://geocode-maps.yandex.ru/1.x?apikey=${t}&format=json&results=1&uri=${e}`),i=await l.json(),a=i.response.GeoObjectCollection.featureMember[0].GeoObject;this.coords=a.Point.pos.split(" ").reverse()}catch(t){console.log(t)}}},async mounted(){await(0,u.wc)();const e=d.A.geo.lastStoredGet();null!==e&&void 0!==e&&e.location_latitude&&(this.coords=[e.location_latitude,e.location_longitude]);const t=await d.A.geo.get();if(this.markDeviceOnMap&&t){const{coords:e}=t;this.coords=[e.latitude,e.longitude],this.$flash("На карте отмечено ваше местоположение")}}},m=l(6262);const p=(0,m.A)(g,[["render",s]]);var h=p},8734:function(e,t,l){l.r(t),l.d(t,{default:function(){return k}});var i=l(641),a=l(33);const n={class:"ion-padding",slot:"content"};function o(e,t,l,o,s,r){const u=(0,i.g2)("ion-icon"),c=(0,i.g2)("ion-label"),d=(0,i.g2)("ion-item"),g=(0,i.g2)("ion-list"),m=(0,i.g2)("ion-title"),p=(0,i.g2)("ion-button"),h=(0,i.g2)("ion-buttons"),_=(0,i.g2)("ion-toolbar"),k=(0,i.g2)("ion-header"),f=(0,i.g2)("ion-input"),b=(0,i.g2)("ion-textarea"),v=(0,i.g2)("ion-select-option"),F=(0,i.g2)("ion-select"),y=(0,i.g2)("ion-accordion"),M=(0,i.g2)("ion-chip"),C=(0,i.g2)("image-tile-comp"),I=(0,i.g2)("ion-accordion-group"),$=(0,i.g2)("ion-col"),w=(0,i.g2)("ion-row"),W=(0,i.g2)("ion-grid"),A=(0,i.g2)("ion-content"),V=(0,i.g2)("ion-modal"),O=(0,i.g2)("base-layout");return(0,i.uX)(),(0,i.Wv)(O,{pageDefaultBackLink:"/user","page-title":"Рассылка"},{default:(0,i.k6)((()=>{var e;return[(0,i.bF)(g,null,{default:(0,i.k6)((()=>[(0,i.bF)(d,{button:"",onClick:t[0]||(t[0]=e=>r.itemCreate())},{default:(0,i.k6)((()=>[(0,i.bF)(u,{slot:"start",src:o.addOutline},null,8,["src"]),(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.eW)("Добавить Рассылку")])),_:1})])),_:1})])),_:1}),(null===(e=s.mailingList)||void 0===e?void 0:e.length)>0?((0,i.uX)(),(0,i.Wv)(g,{key:0},{default:(0,i.k6)((()=>[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(s.mailingList,(e=>((0,i.uX)(),(0,i.Wv)(d,{key:e.mailing_id,onClick:t=>r.itemGet(e.mailing_id)},{default:(0,i.k6)((()=>[(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.eW)("#"+(0,a.v_)(e.mailing_id)+" "+(0,a.v_)(e.subject_template),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):(0,i.Q3)("",!0),(0,i.bF)(V,{ref:"modal",onWillDismiss:t[18]||(t[18]=e=>s.isMailingOpen=!1),"is-open":s.isMailingOpen,"initial-breakpoint":.75,breakpoints:[.75,1]},{default:(0,i.k6)((()=>[(0,i.bF)(k,null,{default:(0,i.k6)((()=>[(0,i.bF)(_,null,{default:(0,i.k6)((()=>[(0,i.bF)(m,null,{default:(0,i.k6)((()=>[(0,i.eW)("Рассылка #"+(0,a.v_)(s.currentMailing.mailing_id),1)])),_:1}),(0,i.bF)(h,{slot:"end"},{default:(0,i.k6)((()=>[(0,i.bF)(p,{onClick:t[1]||(t[1]=e=>s.isMailingOpen=!1)},{default:(0,i.k6)((()=>[(0,i.bF)(u,{src:o.closeOutline},null,8,["src"])])),_:1})])),_:1})])),_:1})])),_:1}),(0,i.bF)(A,{class:"ion-padding",onChange:t[17]||(t[17]=e=>r.itemSave(e))},{default:(0,i.k6)((()=>[(0,i.bF)(I,{modelValue:s.openedAccordion,"onUpdate:modelValue":t[14]||(t[14]=e=>s.openedAccordion=e),style:{overflow:"hidden","border-radius":"10px"}},{default:(0,i.k6)((()=>[(0,i.bF)(y,{value:"message"},{default:(0,i.k6)((()=>[(0,i.bF)(d,{slot:"header",color:"light"},{default:(0,i.k6)((()=>[(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.eW)("Сообщение")])),_:1})])),_:1}),(0,i.bF)(g,{slot:"content"},{default:(0,i.k6)((()=>[(0,i.bF)(d,null,{default:(0,i.k6)((()=>[(0,i.bF)(f,{modelValue:s.currentMailing.subject_template,"onUpdate:modelValue":t[2]||(t[2]=e=>s.currentMailing.subject_template=e),label:"Тема","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.bF)(d,null,{default:(0,i.k6)((()=>[(0,i.bF)(b,{modelValue:s.currentMailing.text_template,"onUpdate:modelValue":t[3]||(t[3]=e=>s.currentMailing.text_template=e),label:"Сообщение","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.bF)(d,null,{default:(0,i.k6)((()=>[(0,i.bF)(f,{modelValue:s.currentMailing.start_at,"onUpdate:modelValue":t[4]||(t[4]=e=>s.currentMailing.start_at=e),type:"datetime-local",label:"Начало запуска","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.bF)(d,null,{default:(0,i.k6)((()=>[(0,i.bF)(F,{label:"Транспорт","label-placement":"stacked",modelValue:s.currentMailing.transport,"onUpdate:modelValue":t[5]||(t[5]=e=>s.currentMailing.transport=e)},{default:(0,i.k6)((()=>[(0,i.bF)(v,{value:"-"},{default:(0,i.k6)((()=>[(0,i.eW)("-")])),_:1}),(0,i.bF)(v,{value:"push"},{default:(0,i.k6)((()=>[(0,i.eW)("Push")])),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,i.bF)(y,{value:"recievers"},{default:(0,i.k6)((()=>[(0,i.bF)(d,{slot:"header",color:"light"},{default:(0,i.k6)((()=>[(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.eW)("Получатели ("+(0,a.v_)(s.currentMailing.recieverCount.sent)+"/"+(0,a.v_)(s.currentMailing.recieverCount.all)+")",1)])),_:1})])),_:1}),(0,i.Lk)("div",n,[(0,i.bF)(g,null,{default:(0,i.k6)((()=>[(0,i.bF)(d,null,{default:(0,i.k6)((()=>[(0,i.bF)(f,{modelValue:s.currentMailing.user_filter.phones,"onUpdate:modelValue":t[6]||(t[6]=e=>s.currentMailing.user_filter.phones=e),name:"user_filter.phones",label:"Телефоны получателей","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.bF)(d,{lines:"none"},{default:(0,i.k6)((()=>[(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.eW)("Локация клиентов")])),_:1})])),_:1}),s.currentMailing.user_filter.location?((0,i.uX)(),(0,i.Wv)(d,{key:0,lines:"none"},{default:(0,i.k6)((()=>[(0,i.bF)(u,{slot:"start",src:o.locationOutline},null,8,["src"]),(0,i.bF)(c,{style:{"white-space":"normal",cursor:"pointer"}},{default:(0,i.k6)((()=>[(0,i.eW)((0,a.v_)(s.currentMailing.user_filter.location.location_address),1)])),_:1}),(0,i.bF)(u,{slot:"end",icon:o.trash,onClick:t[7]||(t[7]=e=>r.locationDelete(`${s.currentMailing.user_filter.location.location_id}`))},null,8,["icon"])])),_:1})):((0,i.uX)(),(0,i.Wv)(p,{key:1,onClick:t[8]||(t[8]=e=>r.modalLocationCreate()),color:"light",expand:"block"},{default:(0,i.k6)((()=>[(0,i.bF)(u,{src:o.locationOutline},null,8,["src"]),(0,i.eW)(" Добавить адрес ")])),_:1})),s.currentMailing.user_filter.location?((0,i.uX)(),(0,i.Wv)(d,{key:2},{default:(0,i.k6)((()=>[(0,i.bF)(f,{modelValue:s.currentMailing.user_filter.radius,"onUpdate:modelValue":t[9]||(t[9]=e=>s.currentMailing.user_filter.radius=e),name:"user_filter.radius",label:"Радиус вокруг локации км","label-placement":"stacked"},null,8,["modelValue"])])),_:1})):(0,i.Q3)("",!0),(0,i.bF)(d,{lines:"none"},{default:(0,i.k6)((()=>[s.currentMailing.recieverCount.all>0?((0,i.uX)(),(0,i.Wv)(M,{key:0},{default:(0,i.k6)((()=>[(0,i.eW)("Всего "+(0,a.v_)(s.currentMailing.recieverCount.all),1)])),_:1})):(0,i.Q3)("",!0),s.currentMailing.recieverCount.sent>0?((0,i.uX)(),(0,i.Wv)(M,{key:1,color:"success"},{default:(0,i.k6)((()=>[(0,i.eW)("Послано "+(0,a.v_)(s.currentMailing.recieverCount.sent),1)])),_:1})):(0,i.Q3)("",!0),s.currentMailing.recieverCount.failed>0?((0,i.uX)(),(0,i.Wv)(M,{key:2,color:"danger"},{default:(0,i.k6)((()=>[(0,i.eW)("Ошибка "+(0,a.v_)(s.currentMailing.recieverCount.failed),1)])),_:1})):(0,i.Q3)("",!0)])),_:1})])),_:1})])])),_:1}),"push"==s.currentMailing.transport?((0,i.uX)(),(0,i.Wv)(y,{key:0,value:"push_options"},{default:(0,i.k6)((()=>[(0,i.bF)(d,{slot:"header",color:"light"},{default:(0,i.k6)((()=>[(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.eW)("Настройки пуш")])),_:1})])),_:1}),(0,i.bF)(g,{slot:"content"},{default:(0,i.k6)((()=>{var e,l;return[(0,i.bF)(C,{images:null===(e=s.currentMailing)||void 0===e?void 0:e.images,image_holder:"mailing",image_holder_id:null===(l=s.currentMailing)||void 0===l?void 0:l.mailing_id,hide_if_empty:"true",controller:"Admin/Mailing",ref:"mailingImgs"},null,8,["images","image_holder_id"]),(0,i.bF)(d,{lines:"none",onClick:t[10]||(t[10]=e=>this.$refs.mailingImgs.take_photo())},{default:(0,i.k6)((()=>[(0,i.bF)(u,{src:o.addOutline,slot:"start"},null,8,["src"]),(0,i.eW)(" Добавить фото ")])),_:1}),(0,i.bF)(d,null,{default:(0,i.k6)((()=>[(0,i.bF)(f,{modelValue:s.currentMailing.link,"onUpdate:modelValue":t[11]||(t[11]=e=>s.currentMailing.link=e),label:"Link","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,i.bF)(d,null,{default:(0,i.k6)((()=>[(0,i.bF)(F,{onIonChange:t[12]||(t[12]=e=>r.itemSave()),label:"Рингтон","label-placement":"stacked",modelValue:s.currentMailing.sound,"onUpdate:modelValue":t[13]||(t[13]=e=>s.currentMailing.sound=e),value:"default"},{default:(0,i.k6)((()=>[(0,i.bF)(v,{value:""},{default:(0,i.k6)((()=>[(0,i.eW)("-")])),_:1}),(0,i.bF)(v,{value:"default"},{default:(0,i.k6)((()=>[(0,i.eW)("стандарт")])),_:1}),(0,i.bF)(v,{value:"short.wav"},{default:(0,i.k6)((()=>[(0,i.eW)("Короткий")])),_:1}),(0,i.bF)(v,{value:"medium.wav"},{default:(0,i.k6)((()=>[(0,i.eW)("Средний")])),_:1}),(0,i.bF)(v,{value:"long.wav"},{default:(0,i.k6)((()=>[(0,i.eW)("Длинный")])),_:1})])),_:1},8,["modelValue"])])),_:1})]})),_:1})])),_:1})):(0,i.Q3)("",!0)])),_:1},8,["modelValue"]),(0,i.bF)(W,null,{default:(0,i.k6)((()=>[(0,i.bF)(w,null,{default:(0,i.k6)((()=>[(0,i.bF)($,null,{default:(0,i.k6)((()=>[(0,i.bF)(p,{onClick:t[15]||(t[15]=e=>r.itemDelete()),color:"danger",fill:"clear",expand:"block"},{default:(0,i.k6)((()=>[(0,i.eW)("Удалить")])),_:1})])),_:1}),(0,i.bF)($,null,{default:(0,i.k6)((()=>[(0,i.bF)(p,{onClick:t[16]||(t[16]=e=>r.itemStart()),expand:"block",color:"light"},{default:(0,i.k6)((()=>[(0,i.bF)(u,{slot:"start",src:o.playOutline},null,8,["src"]),(0,i.eW)(" Запустить ")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["is-open"])]})),_:1})}l(3110);var s=l(972),r=l(5480),u=l(3201),c=l(2311),d=l.n(c),g=l(1003),m=l(5432),p={components:{ImageTileComp:g.A,IonList:s.nf,IonItem:s.uz,IonLabel:s.he,IonIcon:s.iq,IonModal:s.Sb,IonHeader:s.eU,IonToolbar:s.ai,IonButtons:s.QW,IonTitle:s.BC,IonButton:s.Jm,IonContent:s.W9,IonInput:s.$w,IonTextarea:s.nc,IonSelect:s.Nm,IonSelectOption:s.Ip,IonGrid:s.lO,IonRow:s.ln,IonCol:s.hU,IonAccordionGroup:s.YH,IonAccordion:s.xk,IonChip:s.ZB},setup(){return{addOutline:r.EKF,refreshOutline:r.mVv,imageOutline:r.ETD,closeOutline:r.xfX,playOutline:r.zsx,locationOutline:r.UN$,trash:r.dco}},data(){return{openedAccordion:"message",currentMailing:{},mailingList:null,isMailingOpen:!1,saveClock:null}},computed:{},methods:{async itemCreate(){const e={subject_template:"new mailing"};try{const t=await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemCreate`,e);this.itemGet(t)}catch{}},async itemGet(e){const t={mailing_id:e};try{var l;const e=await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemGet`,t);null!==(l=e.user_filter)&&void 0!==l||(e.user_filter={}),this.currentMailing=e,this.isMailingOpen=!0}catch{}},async itemSave(e){clearTimeout(this.saveClock),this.saveClock=setTimeout((async()=>{var t,l;await this.itemUpdate(),e&&(null===(t=e.target)||void 0===t||null===(l=t.name)||void 0===l?void 0:l.indexOf("user_filter"))>-1&&this.recieverListCreate()}),500)},async itemUpdate(){const e=this.currentMailing;try{await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemUpdate`,JSON.stringify(e)),this.$flash("💾 сохранено")}catch{this.$flash("Ошибка сохранения")}},async itemDelete(){if(!confirm("Вы уверенны?"))return;const e={mailing_id:this.currentMailing.mailing_id};try{await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemDelete`,e),this.isMailingOpen=!1,this.listGet()}catch{}},itemValidate(){if(this.currentMailing.start_at)if(this.currentMailing.user_filter.phones)if(this.currentMailing.subject_template)if(this.currentMailing.text_template){if(this.currentMailing.transport)return!0;alert("Транспорт не заполнен")}else alert("Содержание не заполнено");else alert("Заголовок не заполнен");else alert("Получатели не заполнены");else alert("Начало рассылки не заполнено")},async itemStart(){if(!this.itemValidate()||!confirm(`Запустить рассылку в ${this.currentMailing.start_at}?`))return;const e={mailing_id:this.currentMailing.mailing_id};try{await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemStart`,e),this.listGet()}catch{}},async listGet(){this.mailingList=await u.A.prePost(`${this.$heap.state.hostname}Admin/Mailing/listGet`,{});try{this.mailingList=await u.A.post(`${this.$heap.state.hostname}Admin/Mailing/listGet`,{})}catch(e){console.log(e)}},async modalLocationCreate(){if(!this.$heap.state.user.user_id)return this.$flash("Чтобы добавленные адреса сохранились, пожалуйста войдите в систему"),void this.$go({name:"UserSignIn"});var e="рабочий";const t=await s.OZ.create({component:m.A,showBackdrop:!0,backdropDismiss:!0,componentProps:{location_group_name_low:e}});await t.present();const l=await t.onDidDismiss();l&&(this.currentMailing.user_filter.location=l.data,this.recieverListCreate())},async locationDelete(e){try{this.currentMailing.user_filter.location=null,this.recieverListCreate()}catch{this.$flash("Удалить адрес не удалось")}},async recieverListCreate(){try{const e={mailing_id:this.currentMailing.mailing_id};await this.itemUpdate();const t=await d().post(this.$heap.state.hostname+"Admin/Mailing/recieverListCreate",e);this.$flash(`В список получателей добавлено ${t} запись`),this.itemGet(this.currentMailing.mailing_id)}catch{this.$flash("Создать список получателей не удалось")}}},ionViewDidEnter(){this.listGet()},mounted(){this.listGet()}},h=l(6262);const _=(0,h.A)(p,[["render",o],["__scopeId","data-v-7ae57d46"]]);var k=_}}]);
//# sourceMappingURL=8734.3a6d1da9.js.map