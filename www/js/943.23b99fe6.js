"use strict";(self["webpackChunktezkel"]=self["webpackChunktezkel"]||[]).push([[943],{5265:function(e,t,r){r.d(t,{Z:function(){return y}});var o=r(6252);const i=["src"],n={key:0,style:{position:"fixed",top:"200px",left:"calc( 50% - 50px )"}},a=["src"];function l(e,t,r,l,s,d){const u=(0,o.up)("ion-title"),c=(0,o.up)("ion-icon"),m=(0,o.up)("ion-toolbar"),p=(0,o.up)("ion-header"),_=(0,o.up)("ion-content");return(0,o.wg)(),(0,o.iD)(o.HY,null,[(0,o.Wm)(p,null,{default:(0,o.w5)((()=>[(0,o.Wm)(m,{color:"secondary"},{default:(0,o.w5)((()=>["card_registering"==this.order_data?((0,o.wg)(),(0,o.j4)(u,{key:0},{default:(0,o.w5)((()=>[(0,o.Uk)("Привязка новой карты")])),_:1})):((0,o.wg)(),(0,o.j4)(u,{key:1},{default:(0,o.w5)((()=>[(0,o.Uk)("Оплата картой")])),_:1})),(0,o.Wm)(c,{icon:l.closeOutline,onClick:t[0]||(t[0]=e=>{l.closeModal()}),slot:"end",size:"large"},null,8,["icon"])])),_:1})])),_:1}),(0,o.Wm)(_,null,{default:(0,o.w5)((()=>[(0,o._)("iframe",{src:s.paymentLink,id:"paymentFrame1",style:{width:"100%",height:"calc( 100% - 5px )",border:"none"},onLoad:t[1]||(t[1]=e=>d.onLoad())},null,40,i),s.loadAnimation?((0,o.wg)(),(0,o.iD)("div",n,[(0,o._)("img",{src:l.loading},null,8,a)])):(0,o.kq)("",!0)])),_:1})],64)}var s=r(6964),d=r(8903),u=r(659),c=r(9755),m=r.n(c),p={components:{IonTitle:s.wd,IonIcon:s.gu,IonToolbar:s.sr,IonHeader:s.Gu,IonContent:s.W2},props:["order_data"],setup(){const e=function(){s.Fy.dismiss()};return{closeModal:e,closeOutline:d.fID,cardOutline:d.pvm,loading:u}},data(){return{paymentLink:null,loadAnimation:1}},mounted(){this.listenFrame(),this.postToIframe()},methods:{async postToIframe(){try{if("card_registering"==this.order_data)return void(this.paymentLink=await m().post(this.$heap.state.hostname+"CardAcquirer/cardRegisterLinkGet"));this.paymentLink=await m().post(this.$heap.state.hostname+"CardAcquirer/paymentLinkGet",this.order_data)}catch(r){var e,t;const o=null===r||void 0===r||null===(e=r.responseJSON)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.error;"nocardid"==o?this.$flash("Не удалось добавить карту"):this.$flash("Нет возможности принять оплату картой"),this.closeModal()}},onLoad(){this.loadAnimation=0},listenFrame(){let e=this;window.addEventListener("message",(t=>{"paymentOk"!=t.data&&"paymentNo"!=t.data||e.closeModal()}))}}},_=r(3744);const h=(0,_.Z)(p,[["render",l]]);var y=h},943:function(e,t,r){r.r(t),r.d(t,{default:function(){return ae}});var o=r(6252),i=r(3577);const n=e=>((0,o.dD)("data-v-bf7c232c"),e=e(),(0,o.Cn)(),e),a=n((()=>(0,o._)("label",{for:"store_correction_allow",style:{"font-size":"0.9em"},color:"medium"}," Разрешить изменять заказ ",-1))),l={for:"delivery_by_courier"},s={slot:"end"},d=["checked"],u={for:"delivery_by_store"},c={slot:"end"},m=["checked"],p=n((()=>(0,o._)("label",{for:"pickup_by_customer"},"Самовывоз",-1))),_={slot:"end"},h=["checked"],y=n((()=>(0,o._)("label",{for:"payment_cash"},"Оплата наличными",-1))),k={slot:"end"},v=["checked"],f=n((()=>(0,o._)("label",{for:"payment_cash_store"},"Оплата наличными продавцу",-1))),w={slot:"end"},g=["checked"],C={key:7},b=n((()=>(0,o._)("label",{for:"payment_card"},"Оплата картой без привязки",-1))),$={slot:"end"},W=["checked"],I={for:"use_card_recurrent"},O={slot:"end"},R=["checked"],B={key:8},T={slot:"start"},S={class:"righttop_badge"},U={slot:"start"},L={class:"righttop_badge"},z={key:9},j={slot:"start"};function D(e,t,r,n,D,x){const A=(0,o.up)("order-checkout-address"),q=(0,o.up)("ion-item-divider"),G=(0,o.up)("ion-textarea"),P=(0,o.up)("ion-item"),Z=(0,o.up)("ion-checkbox"),F=(0,o.up)("ion-icon"),N=(0,o.up)("ion-img"),M=(0,o.up)("ion-label"),V=(0,o.up)("ion-text"),H=(0,o.up)("ion-badge"),E=(0,o.up)("router-link"),J=(0,o.up)("ion-list"),Y=(0,o.up)("ion-card-content"),K=(0,o.up)("ion-card"),X=(0,o.up)("ion-button"),Q=(0,o.up)("base-layout");return(0,o.wg)(),(0,o.j4)(Q,{pageTitle:"Оформление заказа",pageDefaultBackLink:"/order/order-list"},{default:(0,o.w5)((()=>[(0,o.Wm)(A,{deliveryTime:D.deliveryTime,deliveryAddressOnly:"1",showComment:"1",nextRoute:`/order/order-checkout-${D.order_id}`},null,8,["deliveryTime","nextRoute"]),D.order?((0,o.wg)(),(0,o.j4)(J,{key:0},{default:(0,o.w5)((()=>{var r;return[(0,o.Wm)(q,null,{default:(0,o.w5)((()=>{var e,t,r;return[(0,o.Uk)("Заказ #"+(0,i.zw)(null===(e=D.order)||void 0===e?void 0:e.order_id)+' из "'+(0,i.zw)(null===(t=D.order)||void 0===t||null===(r=t.store)||void 0===r?void 0:r.store_name)+'"',1)]})),_:1}),(0,o.Wm)(P,null,{default:(0,o.w5)((()=>[(0,o.Wm)(G,{rows:"2",placeholder:"комментарий к заказу",onChange:t[0]||(t[0]=e=>x.orderDescriptionChanged()),modelValue:D.order.order_description,"onUpdate:modelValue":t[1]||(t[1]=e=>D.order.order_description=e)},null,8,["modelValue"])])),_:1}),(0,o.Wm)(P,null,{default:(0,o.w5)((()=>[a,(0,o.Wm)(Z,{slot:"end",id:"store_correction_allow",modelValue:D.storeCorrectionAllow,"onUpdate:modelValue":t[2]||(t[2]=e=>D.storeCorrectionAllow=e)},null,8,["modelValue"])])),_:1}),D.storeIsReady?((0,o.wg)(),(0,o.j4)(q,{key:0},{default:(0,o.w5)((()=>[(0,o.Uk)("Способы доставки")])),_:1})):(0,o.kq)("",!0),x.deliveryByCourierRule?((0,o.wg)(),(0,o.j4)(P,{key:1,button:"",onClick:t[3]||(t[3]=e=>x.tariffRuleSet(x.deliveryByCourierRule))},{default:(0,o.w5)((()=>[(0,o.Wm)(F,{icon:n.rocketOutline,slot:"start",color:"primary"},null,8,["icon"]),(0,o._)("label",l,[(0,o.Uk)("Доставит "),(0,o._)("b",null,(0,i.zw)(e.$heap.state.settings.app_title),1)]),(0,o._)("div",s,[(0,o._)("input",{type:"radio",name:"deliveryBy",id:"delivery_by_courier",value:"courier",checked:x.deliveryByCourierRuleChecked},null,8,d)])])),_:1})):(0,o.kq)("",!0),x.deliveryByStoreRule?((0,o.wg)(),(0,o.j4)(P,{key:2,button:"",onClick:t[4]||(t[4]=e=>x.tariffRuleSet(x.deliveryByStoreRule))},{default:(0,o.w5)((()=>{var e,t;return[(0,o.Wm)(F,{icon:n.rocketOutline,slot:"start"},null,8,["icon"]),(0,o._)("label",u,[(0,o.Uk)("Доставит "),(0,o._)("b",null,(0,i.zw)(null===(e=D.order)||void 0===e||null===(t=e.store)||void 0===t?void 0:t.store_name),1)]),(0,o._)("div",c,[(0,o._)("input",{type:"radio",name:"deliveryBy",id:"delivery_by_store",value:"store",checked:x.deliveryByStoreRuleChecked},null,8,m)])]})),_:1})):(0,o.kq)("",!0),x.pickupByCustomerRule?((0,o.wg)(),(0,o.j4)(P,{key:3,button:"",onClick:t[5]||(t[5]=e=>x.tariffRuleSet(x.pickupByCustomerRule))},{default:(0,o.w5)((()=>[(0,o.Wm)(F,{icon:n.storefrontOutline,slot:"start"},null,8,["icon"]),p,(0,o._)("div",_,[(0,o._)("input",{type:"radio",name:"deliveryBy",id:"pickup_by_customer",value:"store",checked:x.pickupByCustomerRuleChecked},null,8,h)])])),_:1})):(0,o.kq)("",!0),D.storeIsReady?((0,o.wg)(),(0,o.j4)(q,{key:4},{default:(0,o.w5)((()=>[(0,o.Uk)("Способы оплаты")])),_:1})):(0,o.kq)("",!0),1==D.tariffRule.paymentByCash?((0,o.wg)(),(0,o.j4)(P,{key:5,button:"",onClick:t[6]||(t[6]=e=>D.paymentType="use_cash")},{default:(0,o.w5)((()=>[(0,o.Wm)(F,{icon:n.cashOutline,slot:"start",color:"primary"},null,8,["icon"]),y,(0,o._)("div",k,[(0,o._)("input",{type:"radio",name:"paymentType",id:"payment_cash",value:"cash",checked:"use_cash"==D.paymentType},null,8,v)])])),_:1})):(0,o.kq)("",!0),1==D.tariffRule.paymentByCashStore?((0,o.wg)(),(0,o.j4)(P,{key:6,button:"",onClick:t[7]||(t[7]=e=>D.paymentType="use_cash_store")},{default:(0,o.w5)((()=>[(0,o.Wm)(F,{icon:n.cashOutline,slot:"start",color:"primary"},null,8,["icon"]),f,(0,o._)("div",w,[(0,o._)("input",{type:"radio",name:"paymentType",id:"payment_cash_store",value:"cash",checked:"use_cash_store"==D.paymentType},null,8,g)])])),_:1})):(0,o.kq)("",!0),1==D.tariffRule.paymentByCard?((0,o.wg)(),(0,o.iD)("div",C,[(0,o.Wm)(P,{button:"",onClick:t[8]||(t[8]=e=>D.paymentType="use_card")},{default:(0,o.w5)((()=>[(0,o.Wm)(F,{icon:n.cardOutline,slot:"start",color:"primary"},null,8,["icon"]),b,(0,o._)("div",$,[(0,o._)("input",{type:"radio",name:"paymentType",id:"payment_card",value:"card",checked:"use_card"==D.paymentType},null,8,W)])])),_:1}),null!==(r=D.bankCard)&&void 0!==r&&r.card_type?((0,o.wg)(),(0,o.j4)(P,{key:0,button:"",onClick:t[9]||(t[9]=e=>D.paymentType="use_card_recurrent")},{default:(0,o.w5)((()=>{var e;return["mir"==D.bankCard.card_type?((0,o.wg)(),(0,o.j4)(N,{key:0,class:"card_type",src:`/img/icons/card-${D.bankCard.card_type}.svg`,slot:"start"},null,8,["src"])):"visa"==D.bankCard.card_type?((0,o.wg)(),(0,o.j4)(N,{key:1,class:"card_type",src:`/img/icons/card-${D.bankCard.card_type}.svg`,slot:"start"},null,8,["src"])):"mastercard"==D.bankCard.card_type?((0,o.wg)(),(0,o.j4)(N,{key:2,class:"card_type",src:`/img/icons/card-${D.bankCard.card_type}.svg`,slot:"start"},null,8,["src"])):((0,o.wg)(),(0,o.j4)(F,{key:3,src:n.cardOutline,slot:"start",color:"primary"},null,8,["src"])),(0,o._)("label",I,"Оплата картой "+(0,i.zw)(null===(e=D.bankCard)||void 0===e?void 0:e.card_mask),1),(0,o._)("div",O,[(0,o._)("input",{type:"radio",name:"paymentType",id:"use_card_recurrent",value:"registered_card",checked:"use_card_recurrent"==D.paymentType},null,8,R)])]})),_:1})):(0,o.kq)("",!0),D.recurrentPaymentAllow?((0,o.wg)(),(0,o.j4)(P,{key:1,button:"",detail:"",onClick:t[10]||(t[10]=t=>e.$go("/user/user-cards"))},{default:(0,o.w5)((()=>{var e;return[null!==(e=D.bankCard)&&void 0!==e&&e.card_type?((0,o.wg)(),(0,o.j4)(M,{key:0,color:"medium"},{default:(0,o.w5)((()=>[(0,o.Uk)("Выбрать другую карту")])),_:1})):((0,o.wg)(),(0,o.j4)(M,{key:1,color:"medium"},{default:(0,o.w5)((()=>[(0,o.Uk)("Привязать карту")])),_:1}))]})),_:1})):(0,o.kq)("",!0)])):(0,o.kq)("",!0),(0,o.Wm)(q,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Итог")])),_:1}),(0,o.Wm)(P,null,{default:(0,o.w5)((()=>[(0,o.Wm)(F,{icon:n.cubeOutline,slot:"start",color:"primary"},null,8,["icon"]),(0,o.Uk)(" Сумма заказа "),(0,o.Wm)(V,{slot:"end"},{default:(0,o.w5)((()=>[(0,o.Uk)((0,i.zw)(D.order.order_sum_product)+(0,i.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1}),x.deliveryByCourierRuleChecked?((0,o.wg)(),(0,o.iD)("div",B,[D.promo?((0,o.wg)(),(0,o.j4)(P,{key:0,button:"",onClick:t[11]||(t[11]=e=>x.promoPick()),color:"success"},{default:(0,o.w5)((()=>[(0,o._)("div",T,[(0,o.Wm)(F,{icon:n.giftOutline,color:"primary",style:{"font-size":"1.5em"}},null,8,["icon"]),(0,o._)("sup",S,[D.promoCount>0?((0,o.wg)(),(0,o.j4)(H,{key:0,color:"secondary"},{default:(0,o.w5)((()=>[(0,o.Uk)((0,i.zw)(D.promoCount),1)])),_:1})):(0,o.kq)("",!0)])]),(0,o.Uk)(" "+(0,i.zw)(D.promo.promo_name)+" ",1),(0,o.Wm)(V,{slot:"end"},{default:(0,o.w5)((()=>[(0,o.Uk)("-"+(0,i.zw)(D.order.order_sum_promo)+(0,i.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1})):((0,o.wg)(),(0,o.j4)(P,{key:1,button:"",detail:"",onClick:t[12]||(t[12]=e=>x.promoPick())},{default:(0,o.w5)((()=>[(0,o._)("div",U,[(0,o.Wm)(F,{icon:n.giftOutline,color:"primary",style:{"font-size":"1.5em"}},null,8,["icon"]),(0,o._)("sup",L,[D.promoCount>0?((0,o.wg)(),(0,o.j4)(H,{key:0,color:"secondary"},{default:(0,o.w5)((()=>[(0,o.Uk)((0,i.zw)(D.promoCount),1)])),_:1})):(0,o.kq)("",!0)])]),(0,o.Uk)(" Выберите скидку ")])),_:1}))])):((0,o.wg)(),(0,o.iD)("div",z,[(0,o.Wm)(P,null,{default:(0,o.w5)((()=>[(0,o._)("div",j,[(0,o.Wm)(F,{icon:n.giftOutline,color:"medium",style:{"font-size":"1.5em"}},null,8,["icon"])]),(0,o.Wm)(V,{color:"medium"},{default:(0,o.w5)((()=>[(0,o.Uk)(" Скидка доступна при доставке "),(0,o._)("b",null,(0,i.zw)(e.$heap.state.settings.app_title),1)])),_:1})])),_:1})])),D.order_sum_delivery>0?((0,o.wg)(),(0,o.j4)(P,{key:10},{default:(0,o.w5)((()=>[(0,o.Wm)(F,{icon:n.rocketOutline,slot:"start",color:"primary"},null,8,["icon"]),(0,o.Uk)(" Доставка "),(0,o.Wm)(V,{slot:"end"},{default:(0,o.w5)((()=>{var t;return[(0,o.Uk)((0,i.zw)(null!==(t=D.order_sum_delivery)&&void 0!==t?t:0)+(0,i.zw)(e.$heap.state.currencySign),1)]})),_:1})])),_:1})):(0,o.kq)("",!0),x.order_sum_total>0?((0,o.wg)(),(0,o.j4)(P,{key:11},{default:(0,o.w5)((()=>[(0,o.Wm)(F,{icon:n.walletOutline,slot:"start",color:"primary"},null,8,["icon"]),(0,o.Uk)(" Итого к оплате "),(0,o.Wm)(V,{slot:"end"},{default:(0,o.w5)((()=>[(0,o._)("b",null,(0,i.zw)(x.order_sum_total),1),(0,o.Uk)((0,i.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1})):(0,o.kq)("",!0),(0,o.Wm)(P,{lines:"none"},{default:(0,o.w5)((()=>[(0,o.Wm)(V,{style:{"font-size":"0.9em"}},{default:(0,o.w5)((()=>[(0,o.Uk)(" Я согласен(на) с "),(0,o.Wm)(E,{to:"/page/rules-customer"},{default:(0,o.w5)((()=>[(0,o.Uk)("офертой об оказании услуг доставки")])),_:1})])),_:1}),(0,o.Wm)(Z,{slot:"end",modelValue:D.termsAccepted,"onUpdate:modelValue":t[13]||(t[13]=e=>D.termsAccepted=e)},null,8,["modelValue"])])),_:1})]})),_:1})):(0,o.kq)("",!0),x.checkoutError?((0,o.wg)(),(0,o.j4)(K,{key:1,color:"warning"},{default:(0,o.w5)((()=>[(0,o.Wm)(Y,null,{default:(0,o.w5)((()=>[(0,o.Uk)((0,i.zw)(x.checkoutError),1)])),_:1})])),_:1})):(0,o.kq)("",!0),"use_card"==D.paymentType||"use_card_recurrent"==D.paymentType?((0,o.wg)(),(0,o.j4)(X,{key:2,expand:"block",onClick:t[14]||(t[14]=e=>x.proceed()),disabled:x.checkoutError},{default:(0,o.w5)((()=>[(0,o.Uk)("Оплатить картой")])),_:1},8,["disabled"])):((0,o.wg)(),(0,o.j4)(X,{key:3,expand:"block",onClick:t[15]||(t[15]=e=>x.proceed()),disabled:x.checkoutError},{default:(0,o.w5)((()=>[(0,o.Uk)("Послать заказ")])),_:1},8,["disabled"]))])),_:1})}r(5306);var x=r(7782),A=r(4405),q=r(9042),G=r(7288),P=r(9755),Z=r.n(P),F=r(8764),N=r(8903),M=r(6964);function V(e,t,r,n,a,l){const s=(0,o.up)("ion-text"),d=(0,o.up)("ion-icon"),u=(0,o.up)("ion-item"),c=(0,o.up)("ion-img"),m=(0,o.up)("ion-thumbnail"),p=(0,o.up)("ion-chip"),_=(0,o.up)("ion-textarea"),h=(0,o.up)("ion-list");return l.location_delivery?((0,o.wg)(),(0,o.j4)(h,{key:0,onClick:t[1]||(t[1]=e=>l.selectDeliveryAddress())},{default:(0,o.w5)((()=>[(0,o.Wm)(u,{lines:"none"},{default:(0,o.w5)((()=>[(0,o.Wm)(s,{color:"medium"},{default:(0,o.w5)((()=>[(0,o.Uk)("Адрес доставки заказа")])),_:1}),(0,o.Wm)(d,{slot:"end",icon:n.chevronDownOutline},null,8,["icon"])])),_:1}),(0,o.Wm)(u,{lines:"none"},{default:(0,o.w5)((()=>{var t;return[l.location_delivery.image_hash?((0,o.wg)(),(0,o.j4)(m,{key:0,slot:"start",style:{width:"30px",height:"30px"}},{default:(0,o.w5)((()=>[(0,o.Wm)(c,{src:`${e.$heap.state.hostname}/image/get.php/${l.location_delivery.image_hash}.32.32.png`},null,8,["src"])])),_:1})):(0,o.kq)("",!0),(0,o.Wm)(s,{color:"dark"},{default:(0,o.w5)((()=>{var e;return[(0,o.Uk)((0,i.zw)(null===(e=l.location_delivery)||void 0===e?void 0:e.location_address),1)]})),_:1}),(null===(t=r.deliveryTime)||void 0===t?void 0:t.time)>0?((0,o.wg)(),(0,o.j4)(p,{key:1,slot:"end",color:"medium",background:"transparent"},{default:(0,o.w5)((()=>[(0,o.Wm)(d,{src:n.timeOutline},null,8,["src"]),(0,o._)("label",null,(0,i.zw)(r.deliveryTime.time),1)])),_:1})):(0,o.kq)("",!0)]})),_:1}),(0,o.Wm)(u,null,{default:(0,o.w5)((()=>[(0,o.Wm)(_,{rows:"1",placeholder:"комментарий к адресу",onChange:t[0]||(t[0]=e=>l.locationCommentChanged()),value:l.location_delivery.location_comment},null,8,["value"])])),_:1})])),_:1})):((0,o.wg)(),(0,o.j4)(h,{key:1},{default:(0,o.w5)((()=>[(0,o.Wm)(u,{button:"",detail:"true",lines:"none",onClick:t[2]||(t[2]=e=>l.selectDeliveryAddress()),color:"secondary"},{default:(0,o.w5)((()=>[(0,o.Uk)("Добавить адрес доставки заказа")])),_:1})])),_:1}))}var H=r(2008),E={props:["deliveryTime","showComment","nextRoute"],components:{IonImg:M.Xz,IonIcon:M.gu,IonTextarea:M.g2,IonText:M.yW,IonItem:M.Ie,IonList:M.q_,IonThumbnail:M.Bs,IonChip:M.hM},setup(){return{locationOutline:N.Iv7,chevronDownOutline:N.Y$3,timeOutline:N.bdY}},data(){return{}},computed:{location_delivery(){var e,t;return null!==(e=H.Z.state)&&void 0!==e&&null!==(t=e.user)&&void 0!==t&&t.location_main&&1!=H.Z.state.user.location_main.is_default&&"Current"!=H.Z.state.user.location_main.group_name?H.Z.state.user.location_main:null}},methods:{selectDeliveryAddress(){this.nextRoute&&(this.$heap.state.next_route=this.nextRoute),this.$go("/user/user-addresses")},async locationCommentChanged(){const e={location_id:this.location_delivery.location_id,location_comment:this.location_delivery.location_comment};Z().post(this.$heap.state.hostname+"Location/itemUpdate",JSON.stringify(e))}}},J=r(3744);const Y=(0,J.Z)(E,[["render",V],["__scopeId","data-v-0b043145"]]);var K=Y,X=r(5265);const Q={key:0};function ee(e,t,r,n,a,l){const s=(0,o.up)("ion-title"),d=(0,o.up)("ion-icon"),u=(0,o.up)("ion-toolbar"),c=(0,o.up)("ion-header"),m=(0,o.up)("ion-skeleton-text"),p=(0,o.up)("ion-item"),_=(0,o.up)("ion-list"),h=(0,o.up)("ion-text"),y=(0,o.up)("ion-content");return(0,o.wg)(),(0,o.iD)(o.HY,null,[(0,o.Wm)(c,null,{default:(0,o.w5)((()=>[(0,o.Wm)(u,{color:"secondary"},{default:(0,o.w5)((()=>[(0,o.Wm)(s,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Ваши доступные скидки")])),_:1}),(0,o.Wm)(d,{icon:n.closeOutline,onClick:t[0]||(t[0]=t=>e.$topic.publish("dismissModal")),slot:"end",size:"large"},null,8,["icon"])])),_:1})])),_:1}),(0,o.Wm)(y,null,{default:(0,o.w5)((()=>[null==a.promoList?((0,o.wg)(),(0,o.j4)(_,{key:0},{default:(0,o.w5)((()=>[((0,o.wg)(),(0,o.iD)(o.HY,null,(0,o.Ko)([1,2,3],(e=>(0,o.Wm)(p,{lines:"none",key:e},{default:(0,o.w5)((()=>[(0,o.Wm)(d,{slot:"start",icon:n.giftOutline,color:"primary"},null,8,["icon"]),(0,o.Wm)(m,{style:{width:"70%"}}),(0,o.Wm)(m,{slot:"end",style:{width:"50px"}})])),_:2},1024))),64))])),_:1})):(0,o.kq)("",!0),(0,o.Wm)(_,null,{default:(0,o.w5)((()=>{var r;return[null!==(r=a.promoList)&&void 0!==r&&r.length?((0,o.wg)(),(0,o.j4)(p,{key:0,button:"",onClick:t[1]||(t[1]=e=>l.promoPick({}))},{default:(0,o.w5)((()=>[(0,o.Wm)(d,{slot:"start",icon:n.banOutline,color:"danger"},null,8,["icon"]),(0,o.Wm)(h,null,{default:(0,o.w5)((()=>[(0,o.Uk)("Без скидки")])),_:1}),(0,o.Wm)(h,{slot:"end"},{default:(0,o.w5)((()=>[(0,o.Uk)("0"+(0,i.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1})):((0,o.wg)(),(0,o.j4)(p,{key:1},{default:(0,o.w5)((()=>[(0,o.Wm)(d,{slot:"start",icon:n.giftOutline,color:"medium"},null,8,["icon"]),(0,o.Wm)(h,{color:"medium"},{default:(0,o.w5)((()=>[(0,o.Uk)("К сожалению, доступных скидок нет.")])),_:1})])),_:1})),((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(a.promoList,(t=>((0,o.wg)(),(0,o.j4)(p,{key:t.promo_id,button:"",onClick:e=>l.promoPick(t)},{default:(0,o.w5)((()=>[(0,o.Wm)(d,{slot:"start",icon:n.giftOutline,color:"primary"},null,8,["icon"]),(0,o.Wm)(h,null,{default:(0,o.w5)((()=>[(0,o.Uk)((0,i.zw)(t.promo_name),1)])),_:2},1024),(0,o.Wm)(h,{slot:"end",color:"success"},{default:(0,o.w5)((()=>[(0,o.Uk)((0,i.zw)(t.promo_value)+(0,i.zw)(e.$heap.state.currencySign),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128)),(0,o.Wm)(p,{button:"",detail:"",onClick:t[2]||(t[2]=t=>{e.$go("/user/user-promo"),e.$topic.publish("dismissModal")})},{default:(0,o.w5)((()=>[(0,o.Wm)(h,null,{default:(0,o.w5)((()=>{var e;return[(0,o.Uk)("Показать все ваши скидки "),null!==(e=a.promoList)&&void 0!==e&&e.length?(0,o.kq)("",!0):((0,o.wg)(),(0,o.iD)("span",Q,"или получить ещё"))]})),_:1})])),_:1})]})),_:1})])),_:1})],64)}var te={components:{IonIcon:M.gu,IonToolbar:M.sr,IonHeader:M.Gu,IonContent:M.W2,IonTitle:M.wd,IonList:M.q_,IonItem:M.Ie,IonText:M.yW,IonSkeletonText:M.CK},setup(){return{giftOutline:N._$o,closeOutline:N.fID,banOutline:N.L6S}},data(){return{promoList:null}},mounted(){this.listGet()},methods:{async listGet(){try{const e={type:"active",user_id:this.$heap.state.user.user_id};this.promoList=await Z().post(`${this.$heap.state.hostname}Promo/listGet`,e)}catch{}},promoPick(e){M.Fy.dismiss(e)}}};const re=(0,J.Z)(te,[["render",ee]]);var oe=re,ie={components:{OrderCheckoutAddress:K,IonTextarea:M.g2,IonItemDivider:M.rH,IonIcon:M.gu,IonItem:M.Ie,IonList:M.q_,IonText:M.yW,IonButton:M.YG,IonCheckbox:M.nz,IonCard:M.PM,IonCardContent:M.FN,IonBadge:M.yp,IonImg:M.Xz,IonLabel:M.Q$},setup(){return{cardOutline:N.pvm,cashOutline:N.zaw,giftOutline:N._$o,cubeOutline:N.XFf,walletOutline:N.S5P,pieChartOutline:N.qlh,storefrontOutline:N.qRG,ordersIcon:F,rocketOutline:N.G$D,documentTextOutline:N.L82}},data(){var e,t;return{order_id:this.$route.params.id,order:null,order_sum_delivery:0,storeCorrectionAllow:0==localStorage.storeCorrectionAllow?0:1,promo:null,promoCount:0,deliveryTime:{},termsAccepted:1,storeIsReady:0,errNotfound:0,errTooFar:0,paymentType:"use_card",bankCard:null,recurrentPaymentAllow:1==(null===(e=this.$heap.state.settings)||void 0===e||null===(t=e.other)||void 0===t?void 0:t.recurrentPaymentAllow)?1:0,tariffRule:{},tariffRuleList:[]}},computed:{checkoutError(){var e,t,r,o,i,n,a,l,s,d;return!!this.order&&(this.order_sum_total<2*this.order.order_sum_promo?`Сумма к оплате со скидкой ${this.order.order_sum_promo}${this.$heap.state.currencySign} должна быть больше чем ${2*this.order.order_sum_promo}${this.$heap.state.currencySign}`:1*this.order.order_sum_product<1*(null===(e=this.order)||void 0===e||null===(t=e.store)||void 0===t?void 0:t.store_minimal_order)?`Сумма заказа у "${null===(i=this.order)||void 0===i||null===(n=i.store)||void 0===n?void 0:n.store_name}" должна быть больше чем ${null===(a=this.order)||void 0===a||null===(l=a.store)||void 0===l?void 0:l.store_minimal_order}${this.$heap.state.currencySign}`:1*this.order_sum_total<=1*this.order_sum_delivery?`Сумма к оплате должна быть больше чем ${this.order_sum_delivery}${this.$heap.state.currencySign}`:this.order_sum_total<=10?"Сумма к оплате слишком маленькая":1==this.errTooFar?"Адрес доставки заказа вне зоны обслуживания":1==(null===(r=this.$heap.state.user)||void 0===r||null===(o=r.location_main)||void 0===o?void 0:o.is_default)?"Нужно указать адрес, куда доставить заказ":1==this.errNotfound?"Заказ удален":0==this.storeIsReady?`К сожалению, ${(null===(s=this.order)||void 0===s||null===(d=s.store)||void 0===d?void 0:d.store_name)||"продавец"} не готов к заказам`:0==this.termsAccepted?"К сожалению, мы не можем доставить вам заказ, без согласия с условиями":1==this.tariffRule.deliveryByCourier&&0==this.tariffRule.deliveryIsReady&&"К сожалению, нет доступных курьеров")},order_sum_total(){return this.order.order_sum_product-this.order.order_sum_promo+this.order_sum_delivery},deliveryByCourierRule(){var e;return null===(e=this.tariffRuleList)||void 0===e?void 0:e.filter((e=>1==e.deliveryByCourier)).shift()},deliveryByCourierRuleChecked(){return 1==this.tariffRule.deliveryByCourier},deliveryByStoreRule(){var e;return null===(e=this.tariffRuleList)||void 0===e?void 0:e.filter((e=>1==e.deliveryByStore)).shift()},deliveryByStoreRuleChecked(){return 1==this.tariffRule.deliveryByStore},pickupByCustomerRule(){var e;return null===(e=this.tariffRuleList)||void 0===e?void 0:e.filter((e=>1==e.pickupByCustomer)).shift()},pickupByCustomerRuleChecked(){return 1==this.tariffRule.pickupByCustomer}},mounted(){this.checkoutDataGet()},ionViewDidEnter(){this.checkoutDataGet()},methods:{async itemLoad(){try{this.order=await Z().post(`${this.$heap.state.hostname}Order/itemGet`,{order_id:this.order_id}),0==this.order_sum_delivery&&(this.order_sum_delivery,this.order.order_sum_delivery),this.$heap.commit("setCurrentOrder",this.order)}catch(e){}},async checkoutDataGet(){if(this.order=this.$heap.state.currentOrder,this.order||await this.itemLoad(),this.order)if("customer_confirmed"==this.order.stage_current)try{const e=await Z().post(`${this.$heap.state.hostname}Order/itemCheckoutDataGet`,{order_id:this.order.order_id});this.deliveryTime=A.Z.deliveryTimeCalculate(e.Location_distanceHolderGet,null),this.promo=e.Promo_itemLinkGet,this.promoCount=e.Promo_listGet,this.storeIsReady=Array.isArray(e.Store_deliveryOptions)?1:0,this.errTooFar=0,this.bankCard=null===e||void 0===e?void 0:e.bankCard,this.tariffRuleList=e.Store_deliveryOptions,this.tariffRuleSet(this.tariffRuleList[0]||{})}catch(r){var e,t;const o=null===r||void 0===r||null===(e=r.responseJSON)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.error;switch(o){case"too_far":this.errTooFar=1;break;case"not_ready":case"no_tariff":this.storeIsReady=0;break;default:this.errNotfound=1}return!1}else this.$router.replace("order-"+this.order.order_id);else this.$flash("Заказ не найден")},tariffRuleSet(e){var t;this.tariffRule=e,this.order_sum_delivery=e.order_sum_delivery,this.paymentType="use_card",null!==(t=this.bankCard)&&void 0!==t&&t.card_type&&(this.paymentType="use_card_recurrent"),1==e.paymentByCashStore?this.paymentType="use_cash_store":1==e.paymentByCash&&(this.paymentType="use_cash"),1!=e.deliveryByCourier&&null!=this.promo&&(this.promoLink({order_id:this.order_id}),this.promo=null)},async orderDescriptionChanged(){const e={order_id:this.order.order_id,order_description:this.order.order_description};x.Z.api.itemUpdate(e)},async proceed(){if(!await this.deliveryAddressConfirm())return;const e={order_id:this.order.order_id,tariff_id:this.tariffRule.tariff_id,deliveryByStore:this.deliveryByStoreRuleChecked?1:0,deliveryByCourier:this.deliveryByCourierRuleChecked?1:0,pickupByCustomer:this.pickupByCustomerRuleChecked?1:0,paymentByCard:"use_card"==this.paymentType?1:0,paymentByCardRecurrent:"use_card_recurrent"==this.paymentType?1:0,paymentByCash:"use_cash"==this.paymentType?1:0,paymentByCashStore:"use_cash_store"==this.paymentType?1:0,storeCorrectionAllow:this.storeCorrectionAllow?1:0};localStorage.storeCorrectionAllow=this.storeCorrectionAllow?1:0;try{await Z().post(`${this.$heap.state.hostname}Order/itemCheckoutDataSet`,JSON.stringify(e))}catch(o){const e=null===o||void 0===o?void 0:o.responseJSON;if(!e)return!1;e.messages.error;return this.$flash("С заказом возникла проблема"),!1}if(1!=e.paymentByCard){if(1==e.paymentByCardRecurrent){const e={order_id:this.order.order_id,card_id:this.bankCard.card_id};try{await Z().post(`${this.$heap.state.hostname}CardAcquirer/paymentDo`,e)}catch(o){return this.$flash("Оплата привязанной картой не удалась"),!1}}try{await x.Z.api.itemStageCreate(this.order.order_id,"customer_start"),this.$router.replace("/order/order-"+this.order.order_id)}catch(o){var t,r;const e=null===o||void 0===o||null===(t=o.responseJSON)||void 0===t||null===(r=t.messages)||void 0===r?void 0:r.error;switch(e){case"order_is_empty":this.$alert("К сожалению, товара не осталось в наличии &#9785;","Заказ пуст");break;case"address_not_set":this.$flash("Необходимо добавить адрес доставки"),this.$topic.publish("dismissModal"),this.$go("/user/user-addresses");break}return!1}}else this.paymentFormOpen({order_id:this.order.order_id,order_sum_total:this.order_sum_total,user_id:this.order.owner_id})},async cancel(){this.$router.replace("order-"+this.order.order_id)},async paymentFormOpen(e){const t=this,r=await M.Fy.create({component:X.Z,componentProps:{order_data:e},initialBreakpoint:.85,breakpoints:[0,.85,.95]}),o=function(){r.dismiss()};return q.Z.on("dismissModal",o),r.onDidDismiss().then((()=>{t.paymentStatusCheck()})),r.present()},async paymentStatusCheck(){const e={order_id:this.order.order_id};try{const t=await Z().post(this.$heap.state.hostname+"CardAcquirer/statusGet",e);"OK"==t&&G.Z.replace("order-"+this.order.order_id)}catch(o){var t,r;this.$flash("Данный заказ не может быть оплачен");const e=null===(t=o.responseJSON)||void 0===t||null===(r=t.messages)||void 0===r?void 0:r.error;"wrong_status"==e&&G.Z.replace("order-"+this.order.order_id)}},async deliveryAddressConfirm(){const e=await M.Cl.create({header:"Адрес доставки",message:this.$heap.state.user.location_main.location_address,buttons:[{text:"Изменить",role:"cancel"},{text:"Верно",role:"confirm"}]});await e.present();const{role:t}=await e.onDidDismiss();return"confirm"==t||(this.$go("/user/user-addresses"),!1)},async promoPick(){var e;const t=await M.Fy.create({component:oe,showBackdrop:!0,backdropDismiss:!0,initialBreakpoint:.6,breakpoints:[0,.6,.75]});t.present(),this.$topic.on("dismissModal",(()=>{t.dismiss()}));const r=await t.onDidDismiss();this.promoLink(r.data),null!==r&&void 0!==r&&null!==(e=r.data)&&void 0!==e&&e.promo_id?this.promo=r.data:this.promo=null},async promoLink(e){try{const t={promo_id:null===e||void 0===e?void 0:e.promo_id,order_id:this.order.order_id};await Z().post(`${this.$heap.state.hostname}Promo/itemLink`,t),this.itemLoad()}catch(t){}},async promoGet(){try{const e={order_id:this.order.order_id};return await Z().post(`${this.$heap.state.hostname}Promo/itemLinkGet`,e)}catch(e){}},async promoCountGet(){try{const e={mode:"count",type:"active",user_id:this.$heap.state.user.user_id};return await Z().post(`${this.$heap.state.hostname}Promo/listGet`,e)}catch(e){}}}};const ne=(0,J.Z)(ie,[["render",D],["__scopeId","data-v-bf7c232c"]]);var ae=ne},659:function(e,t,r){e.exports=r.p+"img/loading.30880178.svg"},8764:function(e,t,r){e.exports=r.p+"img/orders.ea36eab8.svg"}}]);
//# sourceMappingURL=943.23b99fe6.js.map