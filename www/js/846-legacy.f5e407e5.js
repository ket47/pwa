"use strict";(self["webpackChunktezkel"]=self["webpackChunktezkel"]||[]).push([[846],{5841:function(t,e,a){a.d(e,{Z:function(){return p}});var i=a(6252),l=a(3577);const n={class:"ion-page"};function s(t,e,a,s,o,r){const u=(0,i.up)("ion-title"),d=(0,i.up)("ion-icon"),m=(0,i.up)("ion-toolbar"),c=(0,i.up)("ion-header"),h=(0,i.up)("ion-searchbar"),p=(0,i.up)("ion-skeleton-text"),_=(0,i.up)("ion-item"),g=(0,i.up)("ion-list"),y=(0,i.up)("ion-img"),w=(0,i.up)("ion-avatar"),f=(0,i.up)("ion-content");return(0,i.wg)(),(0,i.iD)("div",n,[(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(m,null,{default:(0,i.w5)((()=>[(0,i.Wm)(u,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Выбрать "+(0,l.zw)(o.itemTypeName),1)])),_:1}),(0,i.Wm)(d,{icon:s.closeOutline,onClick:e[0]||(e[0]=t=>{r.closeModal()}),slot:"end",size:"large"},null,8,["icon"])])),_:1})])),_:1}),(0,i.Wm)(f,null,{default:(0,i.w5)((()=>{var a;return["acc"!=o.itemTypeLabel?((0,i.wg)(),(0,i.j4)(h,{key:0,modelValue:o.query,"onUpdate:modelValue":e[1]||(e[1]=t=>o.query=t),placeholder:"поиск",debounce:100,onIonInput:e[2]||(e[2]=t=>r.listGet())},null,8,["modelValue"])):(0,i.kq)("",!0),o.itemList?null!==(a=o.itemList)&&void 0!==a&&a.length?((0,i.wg)(),(0,i.j4)(g,{key:2},{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(o.itemList,(e=>((0,i.wg)(),(0,i.j4)(_,{key:e.id,button:"",detail:"",onClick:t=>r.itemPick(e)},{default:(0,i.w5)((()=>[(0,i.Wm)(w,{slot:"start"},{default:(0,i.w5)((()=>[e.image_hash?((0,i.wg)(),(0,i.j4)(y,{key:0,src:`${t.$heap.state.hostname}image/get.php/${e.image_hash}.100.100.webp`},null,8,["src"])):(0,i.kq)("",!0)])),_:2},1024),(0,i.Uk)(" "+(0,l.zw)(e.name),1)])),_:2},1032,["onClick"])))),128))])),_:1})):((0,i.wg)(),(0,i.j4)(g,{key:3},{default:(0,i.w5)((()=>[(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Uk)(" Ничего не найдено ")])),_:1})])),_:1})):((0,i.wg)(),(0,i.j4)(g,{key:1},{default:(0,i.w5)((()=>[((0,i.wg)(),(0,i.iD)(i.HY,null,(0,i.Ko)([0,1,2,3,4,5,6,7,8,9],(t=>(0,i.Wm)(_,{key:t,button:"",detail:""},{default:(0,i.w5)((()=>[(0,i.Wm)(p,{style:{height:"35px",width:"40px"},animated:""}),(0,i.Wm)(p,{style:{width:"100%"},animated:""})])),_:2},1024))),64))])),_:1}))]})),_:1})])}var o=a(8903),r=a(6038),u=a(9755),d=a.n(u),m={props:["itemType"],components:{IonContent:r.W2,IonHeader:r.Gu,IonToolbar:r.sr,IonTitle:r.wd,IonIcon:r.gu,IonImg:r.Xz,IonList:r.q_,IonItem:r.Ie,IonSearchbar:r.VI,IonSkeletonText:r.CK,IonAvatar:r.BJ},setup(){return{closeOutline:o.fID}},data(){const t=this.itemType?this.itemType:"order";return{query:null,itemList:null,itemTypeLabel:t,itemTypeName:""}},mounted(){this.listGet()},methods:{async listGet(){"order"==this.itemTypeLabel?(this.itemTypeName="Заказ",this.ordersGet()):"store"==this.itemTypeLabel?(this.itemTypeName="Продавец",this.storesGet()):"courier"==this.itemTypeLabel?(this.itemTypeName="Курьер",this.couriersGet()):"acc"==this.itemTypeLabel?(this.itemTypeName="Счет",this.accountsGet()):this.$flash("unknown item type "+this.itemTypeLabel)},async storesGet(){const t={name_query:this.query,name_query_fields:"store_name",limit:10};try{let e=await d().post(`${this.$heap.state.hostname}Store/listGet`,t);this.itemList=e.map((t=>(t.name=`продавец ${t.store_name}`,t.id=t.store_id,t)))}catch(e){}},async couriersGet(){const t={name_query:this.query,name_query_fields:"user_name,user_phone",limit:10};try{let e=await d().post(`${this.$heap.state.hostname}Courier/listGet`,t);this.itemList=e.map((t=>(t.name=`курьер ${t.user_name} ${t.user_phone}`,t.id=t.courier_id,t.image_hash=t.courier_photo_image_hash,t)))}catch(e){}},async ordersGet(){const t={name_query:this.query,name_query_fields:"store_name,order_id,user_name",limit:10};try{let e=await d().post(`${this.$heap.state.hostname}Order/listGet`,t);this.itemList=e.map((t=>(t.name=`заказ#${t.order_id} ${t.store_name} > ${t.user_name}`,t.id=t.order_id,t)))}catch(e){}},async accountsGet(){const t={group_table:"transaction_account_list"};try{let e=await d().post(`${this.$heap.state.hostname}Admin/GroupManager/listGet`,t);this.itemList=e.map((t=>(t.name=`${t.group_name}`,t.type=t.group_type,t)))}catch(e){}},itemPick(t){r.Fy.dismiss(t)},closeModal(){r.Fy.dismiss()}}},c=a(3744);const h=(0,c.Z)(m,[["render",s]]);var p=h},6846:function(t,e,a){a.d(e,{Z:function(){return k}});var i=a(6252),l=a(3577);const n={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},s={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},o={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},r=["onClick"];function u(t,e,a,u,d,m){const c=(0,i.up)("ion-label"),h=(0,i.up)("ion-text"),p=(0,i.up)("ion-item"),_=(0,i.up)("ion-list"),g=(0,i.up)("ion-icon"),y=(0,i.up)("ion-input"),w=(0,i.up)("ion-accordion"),f=(0,i.up)("ion-chip"),k=(0,i.up)("ion-accordion-group"),v=(0,i.up)("ion-searchbar"),W=(0,i.up)("ion-skeleton-text"),$=(0,i.up)("ion-infinite-scroll-content"),I=(0,i.up)("ion-infinite-scroll");return(0,i.wg)(),(0,i.iD)("div",null,[(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Wm)(p,{lines:"full"},{default:(0,i.w5)((()=>[(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Баланс")])),_:1}),d.balance>0?((0,i.wg)(),(0,i.j4)(h,{key:0,slot:"end",color:"success"},{default:(0,i.w5)((()=>[(0,i._)("b",null,(0,l.zw)(d.balance)+(0,l.zw)(t.$heap.state.currencySign),1)])),_:1})):d.balance<0?((0,i.wg)(),(0,i.j4)(h,{key:1,slot:"end",color:"danger"},{default:(0,i.w5)((()=>[(0,i._)("b",null,(0,l.zw)(d.balance)+(0,l.zw)(t.$heap.state.currencySign),1)])),_:1})):((0,i.wg)(),(0,i.j4)(h,{key:2,slot:"end",color:"medium"},{default:(0,i.w5)((()=>[(0,i._)("b",null,(0,l.zw)(d.balance)+(0,l.zw)(t.$heap.state.currencySign),1)])),_:1}))])),_:1})])),_:1}),(0,i.Wm)(k,{value:d.settingsType},{default:(0,i.w5)((()=>[(0,i.Wm)(w,{value:"period"},{default:(0,i.w5)((()=>[(0,i.Wm)(p,{slot:"header"},{default:(0,i.w5)((()=>[(0,i.Wm)(g,{icon:u.calendarOutline,slot:"start"},null,8,["icon"]),(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Период")])),_:1}),(0,i.Wm)(h,{color:"medium",slot:"end"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,l.zw)(m.start_at_dmy)+" - "+(0,l.zw)(m.finish_at_dmy),1)])),_:1})])),_:1}),(0,i.Wm)(_,{slot:"content"},{default:(0,i.w5)((()=>[(0,i.Wm)(p,null,{default:(0,i.w5)((()=>[(0,i.Wm)(h,{color:"medium"},{default:(0,i.w5)((()=>[(0,i.Uk)("Начальная дата")])),_:1}),(0,i._)("div",n,[(0,i.Wm)(y,{type:"date",modelValue:d.start_at,"onUpdate:modelValue":e[0]||(e[0]=t=>d.start_at=t),onIonInput:e[1]||(e[1]=t=>m.listGet()),debounce:"500"},null,8,["modelValue"]),d.meta.sum_start?((0,i.wg)(),(0,i.j4)(y,{key:0,type:"text",style:{"text-align":"right"},value:`${d.meta.sum_start}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,i.kq)("",!0)])])),_:1}),(0,i.Wm)(p,null,{default:(0,i.w5)((()=>[(0,i.Wm)(h,{color:"medium"},{default:(0,i.w5)((()=>[(0,i.Uk)("Обороты")])),_:1}),(0,i._)("div",s,[d.meta.sum_debit?((0,i.wg)(),(0,i.j4)(y,{key:0,type:"text",style:{"text-align":"right"},value:`+${d.meta.sum_debit}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,i.kq)("",!0),d.meta.sum_credit?((0,i.wg)(),(0,i.j4)(y,{key:1,type:"text",style:{"text-align":"right"},value:`-${d.meta.sum_credit}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,i.kq)("",!0)])])),_:1}),(0,i.Wm)(p,null,{default:(0,i.w5)((()=>[(0,i.Wm)(h,{color:"medium"},{default:(0,i.w5)((()=>[(0,i.Uk)("Конечная дата")])),_:1}),(0,i._)("div",o,[(0,i.Wm)(y,{type:"date",modelValue:d.finish_at,"onUpdate:modelValue":e[2]||(e[2]=t=>d.finish_at=t),onIonInput:e[3]||(e[3]=t=>m.listGet())},null,8,["modelValue"]),d.meta.sum_finish?((0,i.wg)(),(0,i.j4)(y,{key:0,type:"text",style:{"text-align":"right"},value:`${d.meta.sum_finish}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,i.kq)("",!0)])])),_:1})])),_:1})])),_:1}),(0,i.Wm)(w,{value:"tags"},{default:(0,i.w5)((()=>[(0,i.Wm)(p,{slot:"header"},{default:(0,i.w5)((()=>[(0,i.Wm)(g,{icon:u.pricetagOutline,slot:"start"},null,8,["icon"]),(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Фильтр по тегам")])),_:1})])),_:1}),(0,i.Wm)(_,{slot:"content"},{default:(0,i.w5)((()=>[(0,i.Wm)(p,{lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[d.tagDict?(0,i.kq)("",!0):((0,i.wg)(),(0,i.j4)(h,{key:0,color:"medium"},{default:(0,i.w5)((()=>[(0,i.Uk)("нажмите на #тег для фильтрации")])),_:1})),((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(d.tagDict,((t,e)=>((0,i.wg)(),(0,i.j4)(f,{key:e,color:"primary"},{default:(0,i.w5)((()=>[(0,i.Uk)("#"+(0,l.zw)(t)+" ",1),(0,i.Wm)(g,{src:u.closeCircle,onClick:t=>m.itemTagRemove(e)},null,8,["src","onClick"])])),_:2},1024)))),128)),m.is_admin?((0,i.wg)(),(0,i.j4)(f,{key:1,onClick:e[4]||(e[4]=t=>m.itemTagCreate()),color:"medium"},{default:(0,i.w5)((()=>[(0,i.Wm)(g,{src:u.addOutline},null,8,["src"]),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Добавить #тег")])),_:1})])),_:1})):(0,i.kq)("",!0)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["value"]),(0,i.Wm)(v,{modelValue:d.searchQuery,"onUpdate:modelValue":e[5]||(e[5]=t=>d.searchQuery=t),placeholder:"Поиск по сумме или описанию",debounce:"300",onIonInput:e[6]||(e[6]=t=>m.listGet())},null,8,["modelValue"]),null==d.ledger?((0,i.wg)(),(0,i.j4)(_,{key:0},{default:(0,i.w5)((()=>[((0,i.wg)(),(0,i.iD)(i.HY,null,(0,i.Ko)([1,2,3],(t=>(0,i.Wm)(p,{key:t},{default:(0,i.w5)((()=>[(0,i.Wm)(h,{slot:"start"},{default:(0,i.w5)((()=>[(0,i.Wm)(W,{animated:"",style:{width:"50px"}})])),_:1}),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(W,{animated:"",style:{width:"100%"}})])),_:1}),(0,i.Wm)(c,{slot:"end",color:"success"},{default:(0,i.w5)((()=>[(0,i.Wm)(W,{animated:"",style:{width:"50px"}})])),_:1})])),_:2},1024))),64))])),_:1})):d.ledger.length>0?((0,i.wg)(),(0,i.j4)(_,{key:1},{default:(0,i.w5)((()=>[(0,i.Wm)(p,{detail:"false"},{default:(0,i.w5)((()=>[(0,i.Wm)(f,{onClick:e[7]||(e[7]=t=>m.listGet()),color:"medium"},{default:(0,i.w5)((()=>[(0,i.Wm)(g,{src:u.refreshOutline},null,8,["src"]),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Обновить")])),_:1})])),_:1})])),_:1}),((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(m.ledgerCalc,(t=>((0,i.wg)(),(0,i.iD)("div",{key:t.trans_id},[(0,i.Wm)(p,{detail:m.is_admin,lines:"none",onClick:e=>m.itemClick(t.trans_id)},{default:(0,i.w5)((()=>[(0,i.Wm)(h,{slot:"start"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,l.zw)(t.date),1)])),_:2},1024),(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[(0,i.Uk)((0,l.zw)(t.trans_description),1)])),_:2},1024),t.amount_sign*t.trans_amount>0?((0,i.wg)(),(0,i.j4)(c,{key:0,slot:"end",color:"success"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,l.zw)(t.trans_amount),1)])),_:2},1024)):t.amount_sign*t.trans_amount<0?((0,i.wg)(),(0,i.j4)(c,{key:1,slot:"end",color:"danger"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,l.zw)(t.trans_amount),1)])),_:2},1024)):((0,i.wg)(),(0,i.j4)(c,{key:2,slot:"end",color:"medium"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,l.zw)(t.trans_amount),1)])),_:2},1024))])),_:2},1032,["detail","onClick"]),(0,i.Wm)(p,null,{default:(0,i.w5)((()=>[(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(t.tag_list,((t,e)=>((0,i.wg)(),(0,i.iD)("div",{class:"tag",key:e,onClick:e=>m.itemTagAdd(t)},"#"+(0,l.zw)(t[1]),9,r)))),128))])),_:2},1024)])),_:2},1024)])))),128))])),_:1})):((0,i.wg)(),(0,i.j4)(_,{key:2},{default:(0,i.w5)((()=>[(0,i.Wm)(p,null,{default:(0,i.w5)((()=>[(0,i.Uk)(" Нет операций в данном периоде ")])),_:1})])),_:1})),(0,i.Wm)(I,{onIonInfinite:e[8]||(e[8]=t=>m.listLoadMore(t)),id:"moderation-infinite-scroll"},{default:(0,i.w5)((()=>[(0,i.Wm)($,{"loading-spinner":"bubbles","loading-text":"Загрузка..."})])),_:1})])}a(3948),a(7658);var d=a(6038),m=a(8903),c=a(9755),h=a.n(c),p=a(351),_=a(4405),g=a(5841),y={components:{IonIcon:d.gu,IonLabel:d.Q$,IonItem:d.Ie,IonInput:d.pK,IonList:d.q_,IonAccordion:d.We,IonAccordionGroup:d.eh,IonText:d.yW,IonSkeletonText:d.CK,IonSearchbar:d.VI,IonChip:d.hM,IonInfiniteScroll:d.ju,IonInfiniteScrollContent:d.MB},props:["permanentTag"],setup(){return{calendarOutline:m.rom,addOutline:m.s6O,closeCircle:m.XZx,pricetagOutline:m.TuG,refreshOutline:m.D3P,calculatorOutline:m.ABu}},data(){const t=_.Z.date.today(),e=_.Z.date.firstDay(-1);return{balance:"-",start_at:_.Z.date.toIso(e),finish_at:_.Z.date.toIso(t),searchQuery:"",tagQuery:"",tagDict:null,ledger:null,meta:{},today:t,settingsType:null,can_reload_at:0}},computed:{ledgerCalc(){if(null==this.ledger)return null;let t=[];for(let n of this.ledger){var e,a,i,l;n.date=this.toLocDate(n.trans_date),n.tag_list=null===(e=n.tags)||void 0===e||null===(a=e.substring(1))||void 0===a||null===(i=a.toLowerCase())||void 0===i||null===(l=i.split("|"))||void 0===l?void 0:l.map((t=>t.split("#"))),t.push(n)}return t},is_admin(){return p.Z.isAdmin()},start_at_dmy(){return _.Z.date.isoToDmy(this.start_at)},finish_at_dmy(){return _.Z.date.isoToDmy(this.finish_at)}},watch:{query:function(){this.listGet()}},methods:{async listLoadMore(t){await this.listGet("append"),t.target.complete()},async listGet(t){const e=Date.now();if(t||!(this.can_reload_at>e)){this.can_reload_at=e+1e3;try{var a,i,l;const e=null===(a=Object.keys(null!==(i=this.tagDict)&&void 0!==i?i:{}))||void 0===a?void 0:a.join(" "),r={start_at:this.start_at,finish_at:this.finish_at,tagQuery:`${e} ${null!==(l=this.permanentTag)&&void 0!==l?l:""}`,searchQuery:this.searchQuery,limit:10};var n,s;if("append"==t)r.offset=null!==(n=null===(s=this.ledger)||void 0===s?void 0:s.length)&&void 0!==n?n:0,r.limit=10;const u=await h().post(`${this.$heap.state.hostname}Transaction/listGet`,r);var o;if("append"==t)null!==(o=this.ledger)&&void 0!==o||(this.ledger=[]),u.ledger=this.ledger.concat(u.ledger);this.ledger=u.ledger,this.meta=u.meta,this.balance=u.meta.sum_finish}catch(d){var r,u;const t=null===d||void 0===d||null===(r=d.responseJSON)||void 0===r||null===(u=r.messages)||void 0===u?void 0:u.error;switch(t){case"large_interval":this.$flash("Период должен быть не больше 3 месяцев");break;default:this.$flash("Ошибка получения выписки");break}return this.ledger=[],this.balance=0,!1}}},toLocDate(t){const e=new Date(Date.parse(t)),a={month:"short",day:"numeric"};return e.toLocaleDateString(void 0,a)},itemClick(t){p.Z.isAdmin()&&this.$go(`/admin/transaction-edit-${t}`)},async itemTagPick(t){var e,a,i,l;const n=await d.Fy.create({component:g.Z,componentProps:{itemType:t},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});n.present(),this.$topic.on("dismissModal",(()=>{n.dismiss()}));const s=await n.onDidDismiss();s.data&&(null!==(e=s.data.order_id)&&void 0!==e&&e&&this.itemTagAdd([`order:${s.data.order_id}`,`заказ ${s.data.order_id}`]),null!==(a=s.data.store_id)&&void 0!==a&&a&&this.itemTagAdd([`store:${s.data.store_id}`,`продавец ${s.data.store_name}`]),null!==(i=s.data.courier_id)&&void 0!==i&&i&&this.itemTagAdd([`courier:${s.data.courier_id}`,`курьер ${s.data.courier_name}`]),null!==(l=s.data.type)&&void 0!==l&&l&&this.itemTagAdd([`acc::${s.data.type}`,`счет ${s.data.name}`]))},async itemTagCreate(){const t=await d.BO.create({header:"Тип тега",buttons:[{text:"Заказ",data:"order"},{text:"Продавец",data:"store"},{text:"Курьер",data:"courier"},{text:"Счет",data:"acc"}]});await t.present();const e=await t.onDidDismiss();null!==e&&void 0!==e&&e.data&&this.itemTagPick(null===e||void 0===e?void 0:e.data)},itemTagAdd(t){var e;let a=null!==(e=this.tagDict)&&void 0!==e?e:{};a[t[0]]=t[1],this.tagDict=a,this.listGet(),this.settingsType="tags"},itemTagRemove(t){var e;let a=null!==(e=this.tagDict)&&void 0!==e?e:{};a[t]&&delete a[t];const i=Object.keys(a).length;this.tagDict=i?a:null,this.listGet(),this.settingsType="tags"}},mounted(){this.listGet()}},w=a(3744);const f=(0,w.Z)(y,[["render",u]]);var k=f}}]);
//# sourceMappingURL=846-legacy.f5e407e5.js.map