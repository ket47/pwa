"use strict";(self["webpackChunktezkel"]=self["webpackChunktezkel"]||[]).push([[674],{674:function(e,t,i){i.r(t),i.d(t,{default:function(){return g}});var r=i(641),a=i(33),n=i(9240);const l={key:0},o={key:1},d={style:{"font-size":"0.7em",color:"var(--ion-color-medium)"}},s={key:0};function u(e,t,i,u,c,h){const _=(0,r.g2)("ion-item-divider"),m=(0,r.g2)("ion-card-content"),p=(0,r.g2)("ion-card"),y=(0,r.g2)("ion-icon"),f=(0,r.g2)("ion-label"),k=(0,r.g2)("ion-segment-button"),v=(0,r.g2)("ion-segment"),b=(0,r.g2)("ion-item"),g=(0,r.g2)("ion-radio"),C=(0,r.g2)("ion-img"),F=(0,r.g2)("ion-radio-group"),$=(0,r.g2)("ion-text"),S=(0,r.g2)("ion-list"),w=(0,r.g2)("ion-accordion"),P=(0,r.g2)("ion-accordion-group"),W=(0,r.g2)("router-link"),O=(0,r.g2)("ion-checkbox"),A=(0,r.g2)("ion-button"),D=(0,r.g2)("base-layout");return(0,r.uX)(),(0,r.Wv)(D,{pageTitle:"Оформление доставки посылки",pageDefaultBackLink:`/order/shipment-${c.order_id}`,ref:"page"},{default:(0,r.k6)(()=>[(0,r.bF)(S,{lines:"none"},{default:(0,r.k6)(()=>{var i;return[(0,r.bF)(_,{style:{"margin-top":"0px","margin-bottom":"10px","box-shadow":"none"}},{default:(0,r.k6)(()=>t[11]||(t[11]=[(0,r.eW)("Доставка")])),_:1,__:[11]}),"scheduled"==(null===(i=c.tariffRule.routePlan)||void 0===i?void 0:i.start_plan_mode)?((0,r.uX)(),(0,r.Wv)(p,{key:0,color:"light"},{default:(0,r.k6)(()=>[(0,r.bF)(m,null,{default:(0,r.k6)(()=>t[12]||(t[12]=[(0,r.Lk)("div",{style:{display:"grid","grid-template-columns":"30% 70%"}},[(0,r.Lk)("div",null,[(0,r.Lk)("img",{src:n,style:{height:"60px"}})]),(0,r.Lk)("div",null," Курьерская служба сейчас не работает. Доставим, когда Вам будет удобно. ")],-1)])),_:1,__:[12]})]),_:1})):(0,r.Q3)("",!0),(0,r.bF)(b,null,{default:(0,r.k6)(()=>[(0,r.bF)(v,{mode:"ios",modelValue:c.deliveryPlanMode,"onUpdate:modelValue":t[3]||(t[3]=e=>c.deliveryPlanMode=e)},{default:(0,r.k6)(()=>[h.isAtonceEnabled?((0,r.uX)(),(0,r.Wv)(k,{key:0,value:"inited",onClick:t[0]||(t[0]=e=>c.deliveryFinishScheduled=null)},{default:(0,r.k6)(()=>[(0,r.bF)(y,{icon:u.rocketOutline},null,8,["icon"]),(0,r.bF)(f,null,{default:(0,r.k6)(()=>t[13]||(t[13]=[(0,r.eW)("Отвезти сразу")])),_:1,__:[13]}),t[14]||(t[14]=(0,r.Lk)("span",null,"как можно скорее",-1))]),_:1,__:[14]})):((0,r.uX)(),(0,r.Wv)(k,{key:1,value:"awaited",onClick:t[1]||(t[1]=e=>c.deliveryFinishScheduled=null)},{default:(0,r.k6)(()=>[(0,r.bF)(y,{icon:u.timeOutline},null,8,["icon"]),(0,r.bF)(f,null,{default:(0,r.k6)(()=>t[15]||(t[15]=[(0,r.eW)("Подождать")])),_:1,__:[15]}),t[16]||(t[16]=(0,r.Lk)("span",null,"заказ в очереди",-1))]),_:1,__:[16]})),(0,r.bF)(k,{value:"scheduled",onClick:t[2]||(t[2]=e=>h.datetimePick())},{default:(0,r.k6)(()=>[(0,r.bF)(y,{icon:u.alarmOutline},null,8,["icon"]),(0,r.bF)(f,null,{default:(0,r.k6)(()=>t[17]||(t[17]=[(0,r.Lk)("b",null,"Запланировать",-1)])),_:1,__:[17]}),h.deliveryFinishLocal?((0,r.uX)(),(0,r.CE)("span",l,(0,a.v_)(h.deliveryFinishLocal),1)):((0,r.uX)(),(0,r.CE)("span",o,"выберите день и время"))]),_:1})]),_:1},8,["modelValue"])]),_:1}),(0,r.bF)(_,null,{default:(0,r.k6)(()=>t[18]||(t[18]=[(0,r.eW)("Оплата")])),_:1,__:[18]}),(0,r.bF)(F,{modelValue:c.paymentType,"onUpdate:modelValue":t[7]||(t[7]=e=>c.paymentType=e)},{default:(0,r.k6)(()=>{var i,n;return[(0,r.Lk)("div",null,[1==c.tariffRule.paymentByCreditStore?((0,r.uX)(),(0,r.Wv)(b,{key:0,button:"",detail:"false",onClick:t[4]||(t[4]=e=>c.paymentType="use_credit_store")},{default:(0,r.k6)(()=>[(0,r.bF)(y,{icon:u.businessOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,r.bF)(g,{value:"use_credit_store"},{default:(0,r.k6)(()=>[t[19]||(t[19]=(0,r.eW)(" Со счета предприятия ")),(0,r.Lk)("div",d,(0,a.v_)(c.tariffRule.storeCreditName)+" "+(0,a.v_)(c.tariffRule.storeCreditBalance)+(0,a.v_)(e.$heap.state.currencySign),1)]),_:1,__:[19]})]),_:1})):(0,r.Q3)("",!0)]),1==c.tariffRule.paymentByCard?((0,r.uX)(),(0,r.CE)("div",s,[c.sbpPaymentAllow?((0,r.uX)(),(0,r.Wv)(b,{key:0,detail:"false",button:""},{default:(0,r.k6)(()=>[(0,r.bF)(C,{style:{width:"22px",height:"auto"},src:"/img/icons/card-sbp.svg",slot:"start"}),(0,r.bF)(g,{value:"use_card_sbp"},{default:(0,r.k6)(()=>t[20]||(t[20]=[(0,r.eW)(" СБП быстрая оплата ")])),_:1,__:[20]})]),_:1})):(0,r.Q3)("",!0),(0,r.bF)(b,{detail:"false",button:""},{default:(0,r.k6)(()=>[(0,r.bF)(y,{icon:u.cardOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,r.bF)(g,{value:"use_card"},{default:(0,r.k6)(()=>t[21]||(t[21]=[(0,r.eW)(" Банковская карта ")])),_:1,__:[21]})]),_:1}),null!==(i=h.bankCardCalc)&&void 0!==i&&i.card_type?((0,r.uX)(),(0,r.Wv)(b,{key:1,button:"",detail:"false"},{default:(0,r.k6)(()=>[h.bankCardCalc.card_type?((0,r.uX)(),(0,r.Wv)(C,{key:0,style:{width:"22px",height:"auto"},src:`/img/icons/card-${h.bankCardCalc.card_type.toLowerCase()}.svg`,slot:"start"},null,8,["src"])):((0,r.uX)(),(0,r.Wv)(y,{key:1,src:u.cardOutline,slot:"start",color:"medium"},null,8,["src"])),(0,r.bF)(g,{value:"use_card_recurrent"},{default:(0,r.k6)(()=>[(0,r.eW)(" Сохраненная карта "+(0,a.v_)(h.bankCardCalc.label),1)]),_:1})]),_:1})):(0,r.Q3)("",!0),null!==(n=h.bankCardCalc)&&void 0!==n&&n.card_type?((0,r.uX)(),(0,r.Wv)(b,{key:2,button:"",detail:"",onClick:t[5]||(t[5]=t=>e.$go("/user/user-cards"))},{default:(0,r.k6)(()=>[(0,r.bF)(f,{color:"medium"},{default:(0,r.k6)(()=>t[22]||(t[22]=[(0,r.eW)("Выбрать другую карту")])),_:1,__:[22]})]),_:1})):c.recurrentPaymentAllow?((0,r.uX)(),(0,r.Wv)(b,{key:3,button:"",detail:"",onClick:t[6]||(t[6]=t=>e.$go("/user/user-cards"))},{default:(0,r.k6)(()=>[(0,r.bF)(y,{icon:u.addOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,r.bF)(f,{color:"medium"},{default:(0,r.k6)(()=>t[23]||(t[23]=[(0,r.eW)("Добавить карту")])),_:1,__:[23]})]),_:1})):(0,r.Q3)("",!0)])):(0,r.Q3)("",!0)]}),_:1},8,["modelValue"]),(0,r.bF)(_,null,{default:(0,r.k6)(()=>t[24]||(t[24]=[(0,r.eW)("Итог")])),_:1,__:[24]}),(0,r.bF)(P,{value:"total"},{default:(0,r.k6)(()=>[(0,r.bF)(w,{value:"total"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{slot:"header"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{icon:u.walletOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,r.bF)($,{color:"medium"},{default:(0,r.k6)(()=>t[25]||(t[25]=[(0,r.eW)("Итого: ")])),_:1,__:[25]}),(0,r.bF)(f,{slot:"end",color:"primary"},{default:(0,r.k6)(()=>[(0,r.eW)((0,a.v_)(c.tariffRule.deliverySum)+(0,a.v_)(e.$heap.state.currencySign),1)]),_:1})]),_:1}),(0,r.bF)(S,{slot:"content"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{lines:"none"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{icon:u.rocketOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,r.bF)($,{color:"medium"},{default:(0,r.k6)(()=>t[26]||(t[26]=[(0,r.eW)("Вызов курьера")])),_:1,__:[26]}),(0,r.bF)(f,{slot:"end",color:"medium"},{default:(0,r.k6)(()=>[(0,r.eW)((0,a.v_)(c.tariffRule.deliveryCost)+(0,a.v_)(e.$heap.state.currencySign),1)]),_:1})]),_:1}),(0,r.bF)(b,{lines:"none"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{icon:u.mapOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,r.bF)($,{color:"medium"},{default:(0,r.k6)(()=>[(0,r.eW)("Расстояние по карте "+(0,a.v_)(h.deliveryDistanceKm)+"км",1)]),_:1}),(0,r.bF)(f,{slot:"end",color:"medium"},{default:(0,r.k6)(()=>[(0,r.eW)((0,a.v_)(h.deliveryFeeTotal)+(0,a.v_)(e.$heap.state.currencySign),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),(0,r.bF)(b,null,{default:(0,r.k6)(()=>[(0,r.bF)($,{style:{"font-size":"0.9em"}},{default:(0,r.k6)(()=>[t[28]||(t[28]=(0,r.eW)(" Я согласен(на) с ")),(0,r.bF)(W,{to:"/page/rules-customer"},{default:(0,r.k6)(()=>t[27]||(t[27]=[(0,r.eW)("офертой об оказании услуг доставки")])),_:1,__:[27]})]),_:1,__:[28]}),(0,r.bF)(O,{slot:"end",modelValue:c.termsAccepted,"onUpdate:modelValue":t[8]||(t[8]=e=>c.termsAccepted=e),"aria-label":""},null,8,["modelValue"])]),_:1})]}),_:1}),h.checkoutError?((0,r.uX)(),(0,r.Wv)(p,{key:0,color:"warning"},{default:(0,r.k6)(()=>[(0,r.bF)(m,null,{default:(0,r.k6)(()=>[(0,r.eW)((0,a.v_)(h.checkoutError),1)]),_:1})]),_:1})):(0,r.Q3)("",!0),"use_card"==c.paymentType||"use_card_recurrent"==c.paymentType?((0,r.uX)(),(0,r.Wv)(A,{key:1,expand:"block",onClick:t[9]||(t[9]=e=>h.proceed()),disabled:h.checkoutError},{default:(0,r.k6)(()=>t[29]||(t[29]=[(0,r.eW)("Оплатить картой")])),_:1,__:[29]},8,["disabled"])):((0,r.uX)(),(0,r.Wv)(A,{key:2,expand:"block",onClick:t[10]||(t[10]=e=>h.proceed()),disabled:h.checkoutError},{default:(0,r.k6)(()=>t[30]||(t[30]=[(0,r.eW)("Вызвать курьера")])),_:1,__:[30]},8,["disabled"]))]),_:1},8,["pageDefaultBackLink"])}var c=i(5634),h=i(5480),_=i(3201),m=i(2311),p=i.n(m),y=i(6794),f=i(7025),k={components:{IonText:c.IO,IonList:c.nf,IonItem:c.uz,IonIcon:c.iq,IonLabel:c.he,IonSegment:c.Gp,IonSegmentButton:c.eP,IonImg:c.KW,IonCard:c.b_,IonCardContent:c.I9,IonCardHeader:c.ME,IonCardTitle:c.tN,IonButton:c.Jm,IonCheckbox:c.eY,IonItemDivider:c.Dg,IonRadioGroup:c.f0,IonRadio:c.KO,IonAccordion:c.xk,IonAccordionGroup:c.YH},setup(){return{cubeOutline:h.a7r,locationOutline:h.UN$,flagOutline:h.NBP,chevronDown:h.uaq,addOutline:h.EKF,checkmark:h.AIp,cardOutline:h.VR9,cashOutline:h.A3w,businessOutline:h.FL4,walletOutline:h.eF1,alertCircleOutline:h.ndb,mapOutline:h.dG8,rocketOutline:h.hGQ,alarmOutline:h.WYB,timeOutline:h.CVk}},data(){var e,t,i,r;return{order_id:this.$route.params.id,order:null,finishPlanSchedule:null,bankCard:null,routePlan:{start_plan_mode:"inited"},tariffRule:{},tariffRuleList:[],errorCode:null,paymentType:"use_card",shipAutoloadClock:null,termsAccepted:1,iplocation:null,recurrentPaymentAllow:1==(null===(e=this.$heap.state.settings)||void 0===e||null===(t=e.other)||void 0===t?void 0:t.recurrentPaymentAllow)?1:0,sbpPaymentAllow:1==(null===(i=this.$heap.state.settings)||void 0===i||null===(r=i.other)||void 0===r?void 0:r.sbpPaymentAllow)?1:0,deliveryFinishScheduled:null,deliveryPlanMode:"inited",is_checkout_data_loaded:0}},computed:{deliveryFinishLocal(){if(!this.deliveryFinishScheduled)return null;const e={month:"short",day:"numeric",hour:"numeric",minute:"numeric"},t=new Date(Date.parse(this.deliveryFinishScheduled));return t.toLocaleDateString(void 0,e)},deliveryFinishRange(){const e=1*this.routePlan.start_plan+1*this.routePlan.finish_arrival;if(!e)return null;const t=900,i=Math.floor(e/t)*t,r=i+t,a=new Date(1e3*i),n=new Date(1e3*r);try{return`${a.getHours()}:${String(a.getMinutes()).padStart(2,"0")}-${n.getHours()}:${String(n.getMinutes()).padStart(2,"0")}`}catch{}return null},isAtonceEnabled(){return["inited"].includes(this.routePlan.start_plan_mode)},deliveryFeeTotal(){return Math.round(this.tariffRule.deliveryFee*this.deliveryDistanceKm)||0},deliveryDistanceKm(){return Math.round(this.routePlan.deliveryDistance/100)/10||0},checkoutError(){return"no_input"==this.errorCode?"Выберите адрес забора и доставки посылки":"start_center_toofar"==this.errorCode?"Адрес получения посылки слишком удален":"finish_center_toofar"==this.errorCode?"Адрес доставки посылки слишком удален":"start_finish_toofar"==this.errorCode?"Дальность доставки слишком большая":0==this.termsAccepted?"К сожалению, мы не можем доставить вам заказ, без согласия с условиями":"use_credit_store"==this.paymentType&&this.tariffRule.storeCreditBalance<this.tariffRule.deliverySum?"На счету предприятия не достаточно средств":null},isVPNon(){return!(!this.iplocation||["UA","RU","???"].includes(this.iplocation.country_code??"???"))},bankCardCalc(){let e=this.bankCard;return e&&e.card_type&&(e.label=`${e.card_type.toUpperCase()} (**** ${e.card_mask.split("*").pop()})`),e}},methods:{async itemLoad(){this.itemCheckoutDataGet()},async itemCheckoutDataGet(e=0){try{var t;const i={order_id:this.order_id,with_arrival_range:e},r=await _.A.post(`${this.$heap.state.hostname}Shipment/itemCheckoutDataGet`,i);if(!r)return;"customer_confirmed"!==r.order.stage_current&&this.$go(`/order/shipment-${this.order_id}`),this.order=r.order,this.routePlan=r.routePlan,this.bankCard=null===r||void 0===r?void 0:r.bankCard,this.tariffRuleList=r.deliveryOptions,this.tariffRuleSet((null===(t=this.tariffRuleList)||void 0===t?void 0:t[0])||{}),this.deliveryPlanMode=this.routePlan.start_plan_mode,"nocourier"==this.routePlan.start_plan_mode&&(this.deliveryPlanMode="awaited"),r.finishPlanSchedule?(this.finishPlanSchedule=r.finishPlanSchedule,this.deliveryFinishScheduled=r.finishPlanSchedule.nearest):(this.finishPlanSchedule=null,this.deliveryFinishScheduled=null)}catch(a){var i,r;this.errorCode=null===a||void 0===a||null===(i=a.responseJSON)||void 0===i||null===(r=i.messages)||void 0===r?void 0:r.error,"notfound"!=this.errorCode&&"forbidden"!=this.errorCode||(this.$flash("Заказ не найден"),this.$router.go(-1))}this.is_checkout_data_loaded=1},tariffRuleSet(e){var t;this.tariffRule=e,this.paymentType="use_card",null!==(t=this.bankCard)&&void 0!==t&&t.card_type&&(this.paymentType="use_card_recurrent"),1==e.paymentByCreditStore&&this.tariffRule.storeCreditBalance>=this.tariffRule.deliverySum?this.paymentType="use_credit_store":1==e.paymentByCash?this.paymentType="use_cash":1==e.paymentByCard&&(this.paymentType="use_card",this.sbpPaymentAllow&&(this.paymentType="use_card_sbp"))},async datetimePick(){this.finishPlanSchedule||await this.itemCheckoutDataGet(1);const e=await c.OZ.create({component:y.A,presentingElement:this.$refs.page.$el,initialBreakpoint:"0.6",showBackdrop:!0,componentProps:{dateRange:this.finishPlanSchedule.range,defaultDatetime:this.finishPlanSchedule.nearest}});e.present(),this.deliveryPlanMode="scheduled";const t=await e.onDidDismiss();"confirm"==t.role?this.deliveryFinishScheduled=t.data:(this.deliveryFinishScheduled=null,this.deliveryPlanMode=this.routePlan.start_plan_mode)},async proceed(){const e={order_id:this.order.order_id,tariff_id:this.tariffRule.tariff_id,deliveryFinishScheduled:this.deliveryFinishScheduled,paymentByCard:["use_card","use_card_sbp"].includes(this.paymentType),paymentByCardRecurrent:"use_card_recurrent"==this.paymentType?1:0,paymentByCash:"use_cash"==this.paymentType?1:0,paymentByCreditStore:"use_credit_store"==this.paymentType?1:0};try{await p().post(`${this.$heap.state.hostname}Shipment/itemCheckoutDataSet`,JSON.stringify(e))}catch(r){var t,i;const e=null===r||void 0===r||null===(t=r.responseJSON)||void 0===t||null===(i=t.messages)||void 0===i?void 0:i.error;if(!e)return!1;switch(e){case"payment_already_done":return this.$flash("Уже оплачен"),void this.$go(`/order/shipment-${this.order.order_id}`);case"credit_balance_low":return void this.$flash("Не достаточно средств на счету")}return this.$flash("Не удается оформить заказ, обратитесь на горячую линию"),!1}if(1!=e.paymentByCard){if(1==e.paymentByCardRecurrent){const e={order_id:this.order.order_id,card_id:this.bankCard.card_id};try{this.$flash("Оплачиваем привязанной картой..."),await p().post(`${this.$heap.state.hostname}CardAcquirer/paymentDo`,e),this.paymentStatusCheck()}catch(r){return this.$flash("Оплата привязанной картой не удалась"),!1}}1==e.paymentByCreditStore&&this.$router.replace("/order/shipment-"+this.order.order_id)}else this.paymentFormOpen({order_id:`${this.order_id}`,payment_type:this.paymentType})},async heavyLoadInfo(){const e=await c.TN.create({message:"Время приблизительное. Готовность заказа, погода, пробки могут задержать доставку.",buttons:[{text:"Ок",role:"confirm"}]});await e.present();const{role:t}=await e.onDidDismiss();return"confirm"==t},async paymentFormOpen(e){const t=await c.OZ.create({component:f.A,componentProps:{order_data:e},initialBreakpoint:.4,breakpoints:[0,.4]});this.$topic.on("dismissModal",()=>{t&&t.dismiss()}),t.present(),await t.onDidDismiss(),this.paymentStatusCheck()},async paymentStatusCheck(){const e={order_id:`${this.order.order_id}`};try{const t=await p().post(this.$heap.state.hostname+"CardAcquirer/statusGet",e);"OK"==t&&this.$router.replace("/order/shipment-"+this.order.order_id)}catch(r){var t,i;const e=null===(t=r.responseJSON)||void 0===t||null===(i=t.messages)||void 0===i?void 0:i.error;"wrong_status"==e?(this.$flash("Данный заказ не может быть оплачен"),this.$router.replace("/order/shipment-"+this.order.order_id)):"not_authorized"==e?(this.$flash("Оплата не прошла"),this.$router.replace("/order/shipment-"+this.order.order_id)):"waiting"==e?(this.$flash("Ваш платеж на ожидании"),this.$router.replace("/order/shipment-"+this.order.order_id)):this.$flash("Оплата картой не удалась")}}},mounted(){this.itemLoad()},ionViewDidEnter(){this.itemLoad()},created(){this.$topic.on("userMainPaymentMethodSet",()=>{this.can_load_at=0,this.itemLoad()}),this.$topic.on("settingsGet",e=>{var t,i;this.can_load_at=0,this.recurrentPaymentAllow=null===e||void 0===e||null===(t=e.other)||void 0===t?void 0:t.recurrentPaymentAllow,this.sbpPaymentAllow=null===e||void 0===e||null===(i=e.other)||void 0===i?void 0:i.sbpPaymentAllow})}},v=i(6262);const b=(0,v.A)(k,[["render",u],["__scopeId","data-v-38a24c90"]]);var g=b}}]);
//# sourceMappingURL=674.b09d161a.js.map