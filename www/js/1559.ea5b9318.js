"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[1559],{1559:function(t,e,a){a.r(e),a.d(e,{default:function(){return v}});var i=a(641),n=a(33),r=a(3751);function s(t,e,a,s,o,l){const d=(0,i.g2)("ion-input"),c=(0,i.g2)("ion-item"),u=(0,i.g2)("ion-select-option"),_=(0,i.g2)("ion-select"),h=(0,i.g2)("ion-label"),m=(0,i.g2)("ion-icon"),p=(0,i.g2)("ion-chip"),g=(0,i.g2)("ion-text"),f=(0,i.g2)("ion-textarea"),v=(0,i.g2)("ion-toggle"),k=(0,i.g2)("ion-list"),b=(0,i.g2)("ion-button"),$=(0,i.g2)("ion-col"),D=(0,i.g2)("ion-row"),y=(0,i.g2)("ion-grid"),F=(0,i.g2)("base-layout");return(0,i.uX)(),(0,i.Wv)(F,{pageDefaultBackLink:"/user","page-title":"Редактирование проводки"},{default:(0,i.k6)((()=>[o.transaction?((0,i.uX)(),(0,i.Wv)(k,{key:0},{default:(0,i.k6)((()=>[(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.bF)(d,{modelValue:o.transaction.trans_date,"onUpdate:modelValue":e[0]||(e[0]=t=>o.transaction.trans_date=t),label:"Дата",labelPlacement:"floating",placeholder:"дата",type:"date"},null,8,["modelValue"])])),_:1}),(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.bF)(_,{interface:"popover",placeholder:"Выберите тип проводки",modelValue:o.transaction.trans_role,"onUpdate:modelValue":e[1]||(e[1]=t=>o.transaction.trans_role=t),label:"Тип проводки",labelPlacement:"floating",required:"",onIonChange:e[2]||(e[2]=t=>l.itemUpdateRole(1))},{default:(0,i.k6)((()=>[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(o.transTypes,(t=>((0,i.uX)(),(0,i.Wv)(u,{key:t.trans_role,value:t.trans_role},{default:(0,i.k6)((()=>[(0,i.eW)((0,n.v_)(t.trans_name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,i.bF)(c,{lines:"none"},{default:(0,i.k6)((()=>[(0,i.bF)(h,{position:"stacked",color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)("Родительские элементы")])),_:1}),(0,i.bF)(g,null,{default:(0,i.k6)((()=>[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(o.tagDict,((t,e)=>((0,i.uX)(),(0,i.Wv)(p,{key:e,color:"primary"},{default:(0,i.k6)((()=>[(0,i.eW)("#"+(0,n.v_)(t)+" ",1),-1==e.indexOf("acc")?((0,i.uX)(),(0,i.Wv)(m,{key:0,src:s.closeCircle,onClick:t=>l.tagDictRemove(e)},null,8,["src","onClick"])):(0,i.Q3)("",!0)])),_:2},1024)))),128))])),_:1})])),_:1}),(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.bF)(g,null,{default:(0,i.k6)((()=>[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(l.tagMissingNames,(t=>((0,i.uX)(),(0,i.Wv)(p,{key:t,onClick:e=>l.tagDictPick(t),color:"medium"},{default:(0,i.k6)((()=>[(0,i.bF)(m,{src:s.addOutline},null,8,["src"]),(0,i.bF)(h,null,{default:(0,i.k6)((()=>[(0,i.eW)("Добавить #"+(0,n.v_)(o.tagHolderNames[t]),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}),(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.bF)(d,{onKeyup:e[3]||(e[3]=(0,r.jR)((t=>l.itemSave()),["enter"])),modelValue:o.transaction.trans_amount,"onUpdate:modelValue":e[4]||(e[4]=t=>o.transaction.trans_amount=t),label:"Сумма",labelPlacement:"floating",placeholder:"сумма",inputmode:"decimal",autocomplete:"transaction-amount",min:"1"},null,8,["modelValue"])])),_:1}),(0,i.bF)(c,null,{default:(0,i.k6)((()=>[(0,i.bF)(f,{modelValue:o.transaction.trans_description,"onUpdate:modelValue":e[5]||(e[5]=t=>o.transaction.trans_description=t),label:"Комментарий",labelPlacement:"floating"},null,8,["modelValue"])])),_:1}),(0,i.bF)(c,{lines:"full"},{default:(0,i.k6)((()=>[(0,i.bF)(v,{modelValue:o.transaction.is_disabled,"onUpdate:modelValue":e[6]||(e[6]=t=>o.transaction.is_disabled=t)},{default:(0,i.k6)((()=>[(0,i.eW)("Отключена")])),_:1},8,["modelValue"])])),_:1}),o.transaction.created_at?((0,i.uX)(),(0,i.Wv)(c,{key:0,lines:"none"},{default:(0,i.k6)((()=>[(0,i.bF)(h,{color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)("Создано "),(0,i.Lk)("b",null,(0,n.v_)(o.transaction.created_user_name),1)])),_:1}),(0,i.bF)(g,{color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)((0,n.v_)(o.transaction.created_at),1)])),_:1})])),_:1})):(0,i.Q3)("",!0),o.transaction.updated_at?((0,i.uX)(),(0,i.Wv)(c,{key:1,lines:"none"},{default:(0,i.k6)((()=>[(0,i.bF)(h,{color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)("Изменено "),(0,i.Lk)("b",null,(0,n.v_)(o.transaction.updated_user_name),1)])),_:1}),(0,i.bF)(g,{color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)((0,n.v_)(o.transaction.updated_at),1)])),_:1})])),_:1})):(0,i.Q3)("",!0)])),_:1})):(0,i.Q3)("",!0),o.transaction?((0,i.uX)(),(0,i.Wv)(y,{key:1},{default:(0,i.k6)((()=>[(0,i.bF)(D,null,{default:(0,i.k6)((()=>[(0,i.bF)($,null,{default:(0,i.k6)((()=>[(0,i.bF)(b,{color:"danger",onClick:e[7]||(e[7]=t=>l.itemDelete()),expand:"block",fill:"clear"},{default:(0,i.k6)((()=>[(0,i.eW)("Удалить")])),_:1})])),_:1}),(0,i.bF)($,null,{default:(0,i.k6)((()=>[(0,i.bF)(b,{color:"primary",onClick:e[8]||(e[8]=t=>l.itemSave()),expand:"block"},{default:(0,i.k6)((()=>[(0,i.eW)("Сохранить")])),_:1})])),_:1})])),_:1})])),_:1})):(0,i.Q3)("",!0)])),_:1})}var o=a(5654),l=a(5480),d=a(2311),c=a.n(d),u=a(8701),_=a(3201),h=a(2715);const m=[{trans_role:"profit->site",holder:["order","store","courier"],trans_name:"Сайт Доход от доставки",trans_description:"Доход от доставки. Заказ №{{order_id}}"},{trans_role:"site->profit",holder:[],trans_name:"Сайт Списание месячной прибыли",trans_description:"Списание месячной прибыли"},{trans_role:"site->supplier",holder:["store"],trans_name:"Продавец Выплата",trans_description:"Выплата по договору за выполненные заказы"},{trans_role:"site.->supplier",holder:["order","store"],trans_name:"Продавец Штраф",trans_description:"Средства взимаемые с Продавца для воврата оплаты Покупателю. Заказ №{{order_id}}"},{trans_role:"supplier->site",holder:["order","store"],trans_name:"Продавец Отгрузка заказа",trans_description:"Стоимость товара, отгруженного Покупателю. Заказ №{{order_id}}"},{trans_role:"supplier->site.",holder:["store"],trans_name:"Продавец Получение аванса",trans_description:"Аванс за услуги сайта"},{trans_role:"profit->supplier",holder:["order","store"],trans_name:"Продавец Комиссия сайта",trans_description:"Комиссия сайта за предоставленные услуги. Заказ №{{order_id}}"},{trans_role:"supplier->profit",holder:["store"],trans_name:"Продавец Начисление бонуса при регистрации",trans_description:"Начисление бонуса на услуги при регистрации на сайте"},{trans_role:"site->courier",holder:["courier"],trans_name:"Курьер Выплата",trans_description:"Выплата по договору за оказанные услуги"},{trans_role:"courier->profit",holder:["order","courier"],trans_name:"Курьер Начисление бонуса",trans_description:"Начисление бонуса за Заказ №{{order_id}}"},{trans_role:"profit->courier",holder:["order","courier"],trans_name:"Курьер Штраф",trans_description:"Штраф за не выполнение Заказа №{{order_id}}"}];var p={components:{IonInput:o.$w,IonIcon:o.iq,IonList:o.nf,IonItem:o.uz,IonToggle:o.BY,IonLabel:o.he,IonSelect:o.Nm,IonSelectOption:o.Ip,IonTextarea:o.nc,IonButton:o.Jm,IonGrid:o.lO,IonRow:o.ln,IonCol:o.hU,IonChip:o.ZB,IonText:o.IO},setup(){return{trashOutline:l.P1A,searchOutline:l.jBE,addOutline:l.EKF,closeCircle:l.P0k}},data(){return{transactionId:this.$route.params.id,transaction:null,transTypes:m,tagDict:{},tagHolderNames:{order:"заказ",store:"продавец",courier:"курьер",acc:"счет"},tagOptionNames:{debit:"(+)",credit:"(-)"}}},computed:{tagRequired(){var t;return(null===(t=this.transTypeCurrent)||void 0===t?void 0:t.holder)||[]},tagMissingNames(){var t;return(null===(t=this.tagRequired)||void 0===t?void 0:t.filter((t=>!Object.keys(this.tagDict).join(":").includes(t))))||""},transTypeCurrent(){return this.transTypes.find((t=>t.trans_role==this.transaction.trans_role))||[]}},created(){const t=this;this.$topic.on("userGet",(()=>{t.init()})),u.A.isAdmin()&&this.init()},methods:{init(){u.A.isAdmin()||this.$router.replace("/"),this.itemGet()},async itemGet(){if(0==this.transactionId)return void(this.transaction={trans_date:_.A.date.toIso(_.A.date.today())});let t={trans_id:this.transactionId};try{var e,a;if(this.transaction=await _.A.prePost(`${this.$heap.state.hostname}Transaction/itemGet`,t),this.transaction)this.transaction.trans_date=null===(a=this.transaction.trans_date)||void 0===a?void 0:a.substring(0,10),this.transaction.is_disabled=1*this.transaction.is_disabled,this.tagDictFill(this.transaction.tags);this.transaction=await _.A.post(`${this.$heap.state.hostname}Transaction/itemGet`,t),this.transaction.trans_date=null===(e=this.transaction.trans_date)||void 0===e?void 0:e.substring(0,10),this.transaction.is_disabled=1*this.transaction.is_disabled,this.tagDictFill(this.transaction.tags)}catch(r){var i,n;const t=null===r||void 0===r||null===(i=r.responseJSON)||void 0===i||null===(n=i.messages)||void 0===n?void 0:n.error;switch(t){case"forbidden":this.$flash("Не достаточно прав");break;case"notfound":this.$flash("Проводка не найдена");break}return!1}},validate(){return this.tagMissingNames.length>0?(this.$flash("Не выбраны все родительские элементы"),!1):this.transaction.trans_role?this.transaction.trans_date?!!this.transaction.trans_amount||(this.$flash("Сумма должна не равняться нулю"),!1):(this.$flash("Дата не выбрана"),!1):(this.$flash("Тип проводки не выбран"),!1)},async itemSave(){var t;if(!this.validate())return;const e=Object.keys(null!==(t=this.tagDict)&&void 0!==t?t:{}).join(" "),a={tags:e,trans_id:this.transaction.trans_id,trans_date:this.transaction.trans_date,trans_amount:this.transaction.trans_amount,trans_role:this.transaction.trans_role,trans_description:this.transaction.trans_description,is_disabled:this.transaction.is_disabled?1:0};try{const t=a.trans_id?"itemUpdate":"itemCreate";await c().post(`${this.$heap.state.hostname}Transaction/${t}`,a),this.$flash("💾 сохранено"),this.$router.go(-1)}catch(r){var i,n;const t=null===r||void 0===r||null===(i=r.responseJSON)||void 0===i||null===(n=i.messages)||void 0===n?void 0:n.error;switch(t){case"forbidden":this.$flash("Не достаточно прав");break}return this.$flash("Не удалось сохранить проводку"),!1}},async itemUpdateRole(){this.transTypeCurrent?this.tagDictTruncate():this.$flash("Неверный тип проводки")},itemDescriptionRender(){if(!this.transTypeCurrent.trans_description)return;const t=this.transTypeCurrent.trans_description;let e=this.transaction;for(let a in this.tagDict){this.tagDict[a];const t=a.split(":"),i=t[0];e[`${i}_id`]=t[1]}this.transaction.trans_description=_.A.render(t,e)},async itemDelete(){if(confirm("Вы уверены?"))try{await c().post(`${this.$heap.state.hostname}Transaction/itemDelete`,{trans_id:this.transactionId}),this.$router.go(-1)}catch{}},async tagDictPick(t){var e,a,i,n;const r=await o.OZ.create({component:h.A,componentProps:{itemType:t},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});r.present(),this.$topic.on("dismissModal",(()=>{r.dismiss()}));const s=await r.onDidDismiss();if(s.data){if(null!==(e=s.data.order_id)&&void 0!==e&&e){this.tagDictAdd([`order:${s.data.order_id}`,`заказ ${s.data.order_id}`]);const t=await c().post(`${this.$heap.state.hostname}Order/itemGet`,{order_id:s.data.order_id});var l;if(this.tagRequired.includes("store")&&t.order_store_id)this.tagDictNameRemove("store"),s.data.store_id=t.order_store_id,s.data.store_name=null===t||void 0===t||null===(l=t.store)||void 0===l?void 0:l.store_name;if(this.tagRequired.includes("courier")&&t.order_courier_id){const e=await c().post(`${this.$heap.state.hostname}Courier/itemGet`,{courier_id:t.order_courier_id});this.tagDictNameRemove("courier"),s.data.courier_id=e.courier_id,s.data.courier_name=e.courier_name}}var d,u,_;if(null!==(a=s.data.store_id)&&void 0!==a&&a)this.tagDictAdd([`store:${s.data.store_id}`,`продавец ${null!==(d=s.data.store_name)&&void 0!==d?d:"?"}`]);if(null!==(i=s.data.courier_id)&&void 0!==i&&i)this.tagDictAdd([`courier:${s.data.courier_id}`,`курьер ${null!==(u=s.data.courier_name)&&void 0!==u?u:"?"}`]);if(null!==(n=s.data.type)&&void 0!==n&&n)this.tagDictAdd([`acc::${s.data.type}`,`счет ${null!==(_=s.data.name)&&void 0!==_?_:"?"}`])}},tagDictAdd(t){var e;let a=null!==(e=this.tagDict)&&void 0!==e?e:{};a[t[0]]=t[1],this.tagDict=a,this.itemDescriptionRender()},tagDictRemove(t){var e;let a=null!==(e=this.tagDict)&&void 0!==e?e:{};a[t]&&delete a[t];const i=Object.keys(a).length;this.tagDict=i?a:{},this.itemDescriptionRender()},tagDictNameRemove(t){var e,a;let i=null!==(e=this.tagDict)&&void 0!==e?e:{};const n=null===(a=Object.keys(i))||void 0===a?void 0:a.find((e=>e.indexOf(t)>-1));this.tagDictRemove(n)},tagDictTruncate(){this.tagDict={},this.itemDescriptionRender()},tagDictFill(t){let e={};if(t)for(let n of t){var a,i;e[`${n.tag_name}:${n.tag_id}:${n.tag_type}:${n.tag_option}`]=`${this.tagHolderNames[n.tag_name]} ${null!==(a=this.tagOptionNames[n.tag_option])&&void 0!==a?a:""} ${null!==(i=n.tag_label)&&void 0!==i?i:"(?)"}`}this.tagDict=e,this.itemDescriptionRender()}}},g=a(6262);const f=(0,g.A)(p,[["render",s]]);var v=f}}]);
//# sourceMappingURL=1559.ea5b9318.js.map