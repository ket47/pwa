"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[4407],{4407:function(e,t,o){o.r(t),o.d(t,{default:function(){return G}});var r=o(6252);const i={key:0,style:{display:"flex","align-items":"center","justify-content":"center",height:"100%"}},a={style:{width:"max-content","text-align":"center"}},n=(0,r._)("br",null,null,-1),l=(0,r._)("a",{href:"/order/order-list"},"список заказов",-1);function s(e,t,o,s,d,u){var c;const m=(0,r.up)("ion-icon"),h=(0,r.up)("ion-label"),_=(0,r.up)("shipment-comp"),p=(0,r.up)("order-tracking-comp"),w=(0,r.up)("order-info-comp"),f=(0,r.up)("image-tile-comp"),k=(0,r.up)("order-history-comp"),g=(0,r.up)("order-meta-comp"),y=(0,r.up)("ion-item"),W=(0,r.up)("ion-list"),v=(0,r.up)("ion-content"),D=(0,r.up)("ion-popover"),$=(0,r.up)("base-layout");return(0,r.wg)(),(0,r.j4)($,{pageTitle:`Вызов курьера #${d.order_id} ${null!==(c=d.order)&&void 0!==c&&c.deleted_at?"(Удален)":""}`,pageDefaultBackLink:"/order/order-list"},{default:(0,r.w5)((()=>{var e,o,c,$;return["notfound"==d.order?((0,r.wg)(),(0,r.iD)("div",i,[(0,r._)("div",a,[(0,r.Wm)(m,{icon:s.sparklesOutline,size:"large"},null,8,["icon"]),(0,r.Wm)(h,null,{default:(0,r.w5)((()=>[(0,r.Uk)("Заказ не найден")])),_:1}),n,l])])):(0,r.kq)("",!0),(0,r.Wm)(_,{orderData:d.order,onStageCreate:u.onStageCreate,onOrderRefresh:u.itemGet},null,8,["orderData","onStageCreate","onOrderRefresh"]),(0,r.Wm)(p,{orderData:d.order},null,8,["orderData"]),(0,r.Wm)(w,{orderData:d.order},null,8,["orderData"]),null!==(e=d.order)&&void 0!==e&&e.images?((0,r.wg)(),(0,r.j4)(f,{key:1,images:null===(o=d.order)||void 0===o?void 0:o.images,image_holder_id:null===(c=d.order)||void 0===c?void 0:c.order_id,controller:"Order",ref:"orderImgs"},null,8,["images","image_holder_id"])):(0,r.kq)("",!0),(0,r.Wm)(k,{orderData:d.order},null,8,["orderData"]),"system_finish"==(null===($=d.order)||void 0===$?void 0:$.stage_current)?((0,r.wg)(),(0,r.j4)(g,{key:2,orderId:d.order_id},null,8,["orderId"])):(0,r.kq)("",!0),(0,r.Wm)(D,{"is-open":d.isOpenDeliveryRejectionPopover,onDidDismiss:t[4]||(t[4]=e=>d.isOpenDeliveryRejectionPopover=!1)},{default:(0,r.w5)((()=>[(0,r.Wm)(v,null,{default:(0,r.w5)((()=>[(0,r.Wm)(W,null,{default:(0,r.w5)((()=>[(0,r.Wm)(y,{button:!0,detail:!1,onClick:t[0]||(t[0]=e=>u.action_rejected_reason("ОТКАЗ КУРЬЕРА: Отказ клиента"))},{default:(0,r.w5)((()=>[(0,r.Wm)(h,null,{default:(0,r.w5)((()=>[(0,r.Uk)("Отказ клиента")])),_:1})])),_:1}),(0,r.Wm)(y,{button:!0,detail:!1,onClick:t[1]||(t[1]=e=>u.action_rejected_reason("ОТКАЗ КУРЬЕРА: Заказ не готов/не соответствует"))},{default:(0,r.w5)((()=>[(0,r.Wm)(h,null,{default:(0,r.w5)((()=>[(0,r.Uk)("Заказ не готов")])),_:1})])),_:1}),(0,r.Wm)(y,{button:!0,detail:!1,onClick:t[2]||(t[2]=e=>u.action_rejected_reason("ОТКАЗ КУРЬЕРА: Поломка в пути"))},{default:(0,r.w5)((()=>[(0,r.Wm)(h,null,{default:(0,r.w5)((()=>[(0,r.Uk)("Поломка в пути")])),_:1})])),_:1}),(0,r.Wm)(y,{button:!0,detail:!1,onClick:t[3]||(t[3]=e=>u.action_rejected_reason("ОТКАЗ КУРЬЕРА: Заказ испорчен"))},{default:(0,r.w5)((()=>[(0,r.Wm)(h,null,{default:(0,r.w5)((()=>[(0,r.Uk)("Заказ испорчен")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["is-open"])]})),_:1},8,["pageTitle"])}o(6699),o(8862);var d=o(8903),u=o(4929),c=o(3577);const m=e=>((0,r.dD)("data-v-4f1ba8ae"),e=e(),(0,r.Cn)(),e),h={key:0},_=m((()=>(0,r._)("b",null,"Откуда:",-1))),p=m((()=>(0,r._)("b",null,"Куда:",-1))),w={key:1},f=m((()=>(0,r._)("div",{slot:"end",style:{position:"relative",width:"120px","min-height":"48px","background-color":"var(--ion-color-light)"}},null,-1)));function k(e,t,o,i,a,n){const l=(0,r.up)("ion-label"),s=(0,r.up)("ion-icon"),d=(0,r.up)("ion-chip"),u=(0,r.up)("ion-item"),m=(0,r.up)("ion-text"),k=(0,r.up)("ion-item-divider"),g=(0,r.up)("ion-img"),y=(0,r.up)("ion-thumbnail"),W=(0,r.up)("ion-note"),v=(0,r.up)("ion-list"),D=(0,r.up)("ion-accordion"),$=(0,r.up)("ion-accordion-group"),b=(0,r.up)("ion-card-title"),C=(0,r.up)("ion-card-header"),I=(0,r.up)("ion-card-content"),O=(0,r.up)("ion-card"),j=(0,r.up)("ion-button"),S=(0,r.up)("ion-col"),U=(0,r.up)("ion-row"),x=(0,r.up)("ion-grid"),z=(0,r.up)("ion-skeleton-text");return o.orderData?((0,r.wg)(),(0,r.iD)("div",h,[(0,r.Wm)(v,{lines:"none"},{default:(0,r.w5)((()=>[(0,r.Wm)(u,{lines:"full"},{default:(0,r.w5)((()=>[o.orderData.order_id>0?((0,r.wg)(),(0,r.j4)(l,{key:0,color:"medium"},{default:(0,r.w5)((()=>[(0,r.Uk)(" Вызов курьера #"+(0,c.zw)(o.orderData.order_id),1)])),_:1})):((0,r.wg)(),(0,r.j4)(l,{key:1,color:"medium"},{default:(0,r.w5)((()=>[(0,r.Uk)(" Корзина ")])),_:1})),o.orderData.stage_current_name?((0,r.wg)(),(0,r.j4)(d,{key:2,color:"primary",slot:"end"},{default:(0,r.w5)((()=>[(0,r.Wm)(s,{icon:i.checkmarkOutline},null,8,["icon"]),(0,r.Wm)(l,{color:"dark"},{default:(0,r.w5)((()=>[(0,r.Uk)((0,c.zw)(o.orderData.stage_current_name),1)])),_:1})])),_:1})):(0,r.kq)("",!0)])),_:1}),(0,r.Wm)(u,{lines:"none"},{default:(0,r.w5)((()=>[(0,r.Uk)(" Доставка посылки ")])),_:1}),(0,r.Wm)(u,{lines:"none"},{default:(0,r.w5)((()=>[(0,r.Wm)(s,{src:i.cubeOutline,slot:"start",size:"large",color:"medium",style:{"font-size":"2em"}},null,8,["src"]),(0,r.Wm)(m,{color:"primary"},{default:(0,r.w5)((()=>[(0,r.Uk)((0,c.zw)(o.orderData.order_description),1)])),_:1})])),_:1}),(0,r.Wm)(k,null,{default:(0,r.w5)((()=>[(0,r.Uk)("Детали перевозки")])),_:1}),(0,r.Wm)(u,null,{default:(0,r.w5)((()=>{var t;return[null!==(t=o.orderData.locationStart)&&void 0!==t&&t.image_hash?((0,r.wg)(),(0,r.j4)(y,{key:0,slot:"start",style:{"--size":"20px"}},{default:(0,r.w5)((()=>{var t;return[(0,r.Wm)(g,{src:`${e.$heap.state.hostname}image/get.php/${null===(t=o.orderData.locationStart)||void 0===t?void 0:t.image_hash}.150.150.webp`},null,8,["src"])]})),_:1})):((0,r.wg)(),(0,r.j4)(s,{key:1,color:"primary",src:i.locationOutline,slot:"start"},null,8,["src"])),(0,r.Wm)(m,null,{default:(0,r.w5)((()=>[_,(0,r.Uk)(),(0,r.Wm)(W,null,{default:(0,r.w5)((()=>[(0,r.Uk)((0,c.zw)(o.orderData.locationStart.location_address),1)])),_:1})])),_:1})]})),_:1}),(0,r.Wm)(u,null,{default:(0,r.w5)((()=>[(0,r._)("p",null,(0,c.zw)(o.orderData.locationStart.location_comment),1)])),_:1}),(0,r.Wm)(u,null,{default:(0,r.w5)((()=>{var t;return[null!==(t=o.orderData.locationFinish)&&void 0!==t&&t.image_hash?((0,r.wg)(),(0,r.j4)(y,{key:0,slot:"start",style:{"--size":"20px"}},{default:(0,r.w5)((()=>{var t;return[(0,r.Wm)(g,{src:`${e.$heap.state.hostname}image/get.php/${null===(t=o.orderData.locationFinish)||void 0===t?void 0:t.image_hash}.150.150.webp`},null,8,["src"])]})),_:1})):((0,r.wg)(),(0,r.j4)(s,{key:1,color:"primary",src:i.flagOutline,slot:"start"},null,8,["src"])),(0,r.Wm)(m,null,{default:(0,r.w5)((()=>[p,(0,r.Uk)(),(0,r.Wm)(W,null,{default:(0,r.w5)((()=>[(0,r.Uk)((0,c.zw)(o.orderData.locationFinish.location_address),1)])),_:1})])),_:1})]})),_:1}),(0,r.Wm)(u,null,{default:(0,r.w5)((()=>[(0,r._)("p",null,(0,c.zw)(o.orderData.locationFinish.location_comment),1)])),_:1}),(0,r.Wm)(k,null,{default:(0,r.w5)((()=>[(0,r.Uk)("Итог")])),_:1}),(0,r.Wm)($,null,{default:(0,r.w5)((()=>[(0,r.Wm)(D,null,{default:(0,r.w5)((()=>[(0,r.Wm)(u,{slot:"header"},{default:(0,r.w5)((()=>[(0,r.Wm)(s,{icon:i.walletOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,r.Wm)(m,{color:"medium"},{default:(0,r.w5)((()=>[(0,r.Uk)("Итого: ")])),_:1}),(0,r.Wm)(l,{slot:"end",color:"primary"},{default:(0,r.w5)((()=>[(0,r.Uk)((0,c.zw)(o.orderData.order_sum_total)+(0,c.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1}),(0,r.Wm)(v,{slot:"content"},{default:(0,r.w5)((()=>[(0,r.Wm)(u,{lines:"none"},{default:(0,r.w5)((()=>[(0,r.Wm)(m,{color:"medium"},{default:(0,r.w5)((()=>[(0,r.Uk)("Доставка")])),_:1}),(0,r.Wm)(l,{slot:"end",color:"primary"},{default:(0,r.w5)((()=>[(0,r.Uk)((0,c.zw)(o.orderData.order_sum_delivery)+(0,c.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),(0,r.kq)("",!0),o.orderData.order_objection?((0,r.wg)(),(0,r.j4)(O,{key:1,color:"warning"},{default:(0,r.w5)((()=>[(0,r.Wm)(C,null,{default:(0,r.w5)((()=>[(0,r.Wm)(b,null,{default:(0,r.w5)((()=>[(0,r.Uk)("Проблема с заказом")])),_:1})])),_:1}),(0,r.Wm)(I,null,{default:(0,r.w5)((()=>[(0,r.Uk)((0,c.zw)(o.orderData.order_objection),1)])),_:1})])),_:1})):(0,r.kq)("",!0),(0,r.Wm)(x,null,{default:(0,r.w5)((()=>[(0,r.Wm)(U,null,{default:(0,r.w5)((()=>[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(n.nextStageButtons,((e,t)=>((0,r.wg)(),(0,r.j4)(S,{key:t},{default:(0,r.w5)((()=>{var i,a;return[e[0]?((0,r.wg)(),(0,r.j4)(j,{key:0,onClick:r=>n.stageCreate(o.orderData.order_id,t,e[1]),expand:"block",color:null!==(i=e[1])&&void 0!==i?i:"primary",fill:null!==(a=e[2])&&void 0!==a?a:"solid"},{default:(0,r.w5)((()=>[(0,r.Wm)(s,{slot:"start",src:e.icon},null,8,["src"]),(0,r.Uk)(" "+(0,c.zw)(e[0]),1)])),_:2},1032,["onClick","color","fill"])):(0,r.kq)("",!0)]})),_:2},1024)))),128))])),_:1})])),_:1})])):((0,r.wg)(),(0,r.iD)("div",w,[(0,r.Wm)(u,{detail:"",button:"",lines:"none"},{default:(0,r.w5)((()=>[(0,r.Wm)(s,{slot:"start",icon:i.storefrontOutline},null,8,["icon"]),(0,r.Wm)(z,{animated:"",style:{width:"200px"}})])),_:1}),(0,r.Wm)(v,null,{default:(0,r.w5)((()=>[((0,r.wg)(),(0,r.iD)(r.HY,null,(0,r.Ko)([1,2,3],(e=>(0,r.Wm)(u,{key:e},{default:(0,r.w5)((()=>[(0,r.Wm)(y,{style:{"background-color":"var(--ion-color-light)"}}),(0,r.Wm)(x,null,{default:(0,r.w5)((()=>[(0,r.Wm)(S,null,{default:(0,r.w5)((()=>[(0,r.Wm)(U,null,{default:(0,r.w5)((()=>[(0,r.Wm)(z,{animated:"",style:{width:"100%"}})])),_:1}),(0,r.Wm)(U,null,{default:(0,r.w5)((()=>[(0,r.Wm)(l,{color:"primary"},{default:(0,r.w5)((()=>[(0,r.Wm)(z,{animated:"",style:{width:"100px"}})])),_:1})])),_:1})])),_:1})])),_:1}),f])),_:2},1024))),64))])),_:1}),(0,r.Wm)(x,null,{default:(0,r.w5)((()=>[(0,r.Wm)(U,null,{default:(0,r.w5)((()=>[((0,r.wg)(),(0,r.iD)(r.HY,null,(0,r.Ko)([1,2],(e=>(0,r.Wm)(S,{key:e},{default:(0,r.w5)((()=>[(0,r.Wm)(j,{color:"light",style:{width:"100%"}})])),_:2},1024))),64))])),_:1})])),_:1})]))}var g={props:["orderData"],components:{IonIcon:u.gu,IonText:u.yW,IonLabel:u.Q$,IonItem:u.Ie,IonList:u.q_,IonImg:u.Xz,IonThumbnail:u.Bs,IonNote:u.uN,IonButton:u.YG,IonCol:u.wI,IonRow:u.Nd,IonGrid:u.jY,IonSkeletonText:u.CK,IonCard:u.PM,IonCardHeader:u.Zi,IonCardContent:u.FN,IonCardTitle:u.Dq,IonItemDivider:u.rH,IonAccordion:u.We,IonAccordionGroup:u.eh,IonChip:u.hM},setup(){return{add:d.IHx,remove:d.OdJ,trash:d._Ij,rocketOutline:d.G$D,storefrontOutline:d.qRG,checkmarkOutline:d.TjA,cubeOutline:d.XFf,walletOutline:d.S5P,banOutline:d.L6S,giftOutline:d._$o,cardOutline:d.pvm,ribbonOutline:d.Muk,chatboxEllipsesOutline:d._Pt,locationOutline:d.Iv7,flagOutline:d.FMn,chevronDown:d.Dd1,addOutline:d.s6O,checkmark:d.d29,cashOutline:d.zaw,businessOutline:d.c1X,alertCircleOutline:d.nLD,helpCircleOutline:d.Sm}},computed:{nextStageButtons(){let e={};for(let t in this.orderData.stage_next)this.orderData.stage_next[t][0]&&(e[t]=this.orderData.stage_next[t],e[t].icon=d.TjA,t.includes("admin")?e[t].icon=d.Muk:t.includes("delivery")?e[t].icon=d.G$D:t.includes("supplier")&&(e[t].icon=d.qRG));return e}},methods:{stageCreate(e,t,o){("danger"!=o||confirm("Вы уверены?"))&&this.$emit("stageCreate",e,t)}}},y=o(3744);const W=(0,y.Z)(g,[["render",k],["__scopeId","data-v-4f1ba8ae"]]);var v=W,D=o(2253),$=o(1185),b=o(9332),C=o(9873),I=o(9119),O=o(2639),j=o(6852),S=o(4405),U=o(9755),x=o.n(U),z={components:{ShipmentComp:v,OrderHistoryComp:D.Z,OrderMetaComp:b.Z,OrderInfoComp:$.Z,OrderTrackingComp:C.Z,ImageTileComp:O.Z,IonLabel:u.Q$,IonIcon:u.gu,IonContent:u.W2,IonItem:u.Ie,IonList:u.q_,IonPopover:u.d8},setup(){return{sparklesOutline:d.Fcs,chatboxOutline:d.DMF}},data(){return{order_id:this.$route.params.id,order:null,orderAutoloadClock:null,isOpenDeliveryRejectionPopover:!1}},methods:{async itemGet(){try{this.order=await S.Z.prePost(`${this.$heap.state.hostname}Shipment/itemGet`,{order_id:this.order_id}),this.order=await S.Z.post(`${this.$heap.state.hostname}Shipment/itemGet`,{order_id:this.order_id}),this.itemAutoReload()}catch(e){switch(e.status){case 404:this.$flash("Заказ не найден"),this.order=null,this.$go("/order/order-list");break}}},itemAutoReload(){clearTimeout(this.orderAutoloadClock),this.orderAutoloadClock=setTimeout((()=>{}),6e4)},async onStageCreate(e,t){if(t.includes("action")){t=t.split("_").splice(1).join("_");try{this[t](e)}catch(o){console.log("stage handler not found"+t)}}else try{const e={order_id:this.order_id,new_stage:t},o=await x().post(`${this.$heap.state.hostname}Shipment/itemStageCreate`,e);if("ok"==o)return"customer_purged"==t||"customer_deleted"==t?(this.$flash("Заказ удален"),this.order=null,void this.$go("/order/order-list")):(await this.itemGet(),!0)}catch(r){const e=r.responseJSON,t=e.messages.error;switch(t){case"wrong_courier_status":this.$flash("Смена курьера не открыта");break;case"order_is_empty":this.$alert("К сожалению, товара не осталось в наличии &#9785;","Заказ пуст");break;case"photos_must_be_made":this.$flash("Необходимо сфотографировать заказ"),this.action_take_photo();break;case"address_not_set":this.$flash("Необходимо добавить адрес доставки"),this.$go("/modal/user-addresses");break;case"order_sum_exceeded":this.$flash("Сумма заказа должна быть меньше предоплаты");break;case"order_sum_zero":this.$flash("Нельзя завершить пустой заказ, от него можно отказаться.");break;case"forbidden_bycustomer":this.$flash("Запрещено покупателем");break;case"already_payed":this.$flash("Заказ уже оплачен");break;default:this.$flash("Не удалось изменить статус заказа");break}return!1}},async action_checkout(){this.$go(`/modal/orderment-checkout-${this.order_id}`)},async action_objection(){const e=await u.Fy.create({component:I.Z,initialBreakpoint:.5,breakpoints:[.5,1],canDissmiss:!0});e.present();const t=await e.onDidDismiss();if(t.data){const e=`ВОЗРАЖЕНИЕ ПОКУПАТЕЛЯ: ${t.data}`,o={order_id:this.order_id,order_objection:e},r=await x().post(`${this.$heap.state.hostname}Shipment/itemUpdate`,o);if("ok"==r){const e=await this.onStageCreate(this.order_id,"customer_disputed");e&&(this.$flash("Ваше возражение принято и будет рассмотрено администратором."),alert("Необходимо сфотографировать заказ"),this.action_take_photo())}}},action_rejected(){this.isOpenDeliveryRejectionPopover=!0},async action_rejected_reason(e){this.isOpenDeliveryRejectionPopover=!1;const t={order_id:this.order_id,order_objection:e};try{await x().post(`${this.$heap.state.hostname}Shipment/itemUpdate`,JSON.stringify(t));await this.onStageCreate(this.order_id,"delivery_rejected"),this.$flash("Вы отказались от доставки")}catch(o){}},action_take_photo(){this.$refs.orderImgs.take_photo()},async action_courier_assign(){const e="courier",t={status:"ready||busy"},o=await u.Fy.create({component:j.Z,componentProps:{itemType:e,filter:t},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});o.present(),this.$topic.on("dismissModal",(()=>{o.dismiss()}));const r=await o.onDidDismiss();if(r.data)try{const e={order_id:this.order_id,courier_id:r.data.courier_id};await x().post(`${this.$heap.state.hostname}Courier/itemAssign`,e),await this.itemGet(),this.$flash("Курьер назначен")}catch(i){this.$flash("Не удалось назначить курьера")}},async action_customer_start(){this.onStageCreate(this.order_id,"customer_start")},async itemUpdate(e){this.order.deliveryCalculation=await this.itemTotalEstimate()},async itemTotalEstimate(e,t){if(!e||!t)return;const o={start_location_id:e,finish_location_id:t};try{return await x().post(`${this.$heap.state.hostname}Shipment/itemDeliverySumEstimate`,o)}catch(r){}}},ionViewDidEnter(){this.itemGet()},ionViewDidLeave(){clearTimeout(this.orderAutoloadClock)},created(){this.itemGet(),this.$topic.on("orderSumChanged",(()=>this.itemGet("skipCaching"))),this.$topic.on("pushStageChanged",(e=>{var t;(null===(t=this.order)||void 0===t?void 0:t.order_id)==(null===e||void 0===e?void 0:e.order_id)&&this.order.stage_current!=e.stage&&this.itemGet()}))}};const T=(0,y.Z)(z,[["render",s]]);var G=T}}]);
//# sourceMappingURL=4407.1826a62c.js.map