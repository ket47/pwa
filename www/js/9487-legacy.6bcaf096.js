"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[9487],{5236:function(e,t,i){i.d(t,{Z:function(){return g}});var l=i(6252),n=i(3577);const a={style:{position:"absolute",top:"0px",width:"100%","--ion-item-background":"#ffffffdd","border-radius":"10px"}},o={slot:"end",style:{color:"#666"}};function s(e,t,i,s,r,u){const c=(0,l.up)("ymap-marker"),d=(0,l.up)("yandex-map"),m=(0,l.up)("ion-searchbar"),p=(0,l.up)("ion-item"),g=(0,l.up)("ion-content"),h=(0,l.up)("ion-icon"),f=(0,l.up)("ion-button"),_=(0,l.up)("ion-toolbar");return(0,l.wg)(),(0,l.iD)(l.HY,null,[(0,l.Wm)(g,null,{default:(0,l.w5)((()=>[(0,l.Wm)(d,{onClick:t[0]||(t[0]=e=>u.onClick(e)),style:{height:"100%"},coords:r.coords,zoom:16,settings:r.settings,controls:["zoomControl"]},{default:(0,l.w5)((()=>[(0,l.Wm)(c,{coords:r.coords,"marker-id":"1",properties:r.placemarkProperties},null,8,["coords","properties"])])),_:1},8,["coords","settings"]),(0,l._)("div",a,[(0,l.Wm)(m,{debounce:"500",modelValue:r.addressSearchQuery,"onUpdate:modelValue":t[1]||(t[1]=e=>r.addressSearchQuery=e),onIonInput:t[2]||(t[2]=e=>u.suggestionsGet()),placeholder:"поиск адреса",style:{margin:"0px","padding-bottom":"0px"}},null,8,["modelValue"]),((0,l.wg)(!0),(0,l.iD)(l.HY,null,(0,l.Ko)(r.suggestions,((e,t)=>((0,l.wg)(),(0,l.j4)(p,{key:t,onClick:t=>u.suggestionSelect(`${e.subtitle.text}, ${e.title.text}`,e.uri),style:{"margin-right":"10px","margin-left":"10px"}},{default:(0,l.w5)((()=>[(0,l.Uk)((0,n.zw)(e.subtitle.text)+" "+(0,n.zw)(e.title.text)+" ",1),(0,l._)("span",o,(0,n.zw)(e.distance.text),1)])),_:2},1032,["onClick"])))),128))])])),_:1}),(0,l.Wm)(_,null,{default:(0,l.w5)((()=>[(0,l.Wm)(f,{strong:!0,onClick:t[3]||(t[3]=e=>u.pickAddress()),color:"primary",expand:"block"},{default:(0,l.w5)((()=>[(0,l.Wm)(h,{src:s.checkmark,slot:"start"},null,8,["src"]),(0,l.Uk)(" Ок ")])),_:1}),(0,l.Wm)(f,{onClick:t[4]||(t[4]=e=>s.closeModal()),color:"light",expand:"block"},{default:(0,l.w5)((()=>[(0,l.Uk)("Закрыть")])),_:1})])),_:1})],64)}i(3948),i(7658);var r=i(4929),u=i(5836),c=i(8903),d={components:{IonContent:r.W2,IonToolbar:r.sr,IonButton:r.YG,IonSearchbar:r.VI,IonIcon:r.gu,IonItem:r.Ie,yandexMap:u.xR,ymapMarker:u.Jk},setup(){const e=function(){r.Fy.dismiss()};return{closeModal:e,locationOutline:c.Iv7,closeOutline:c.fID,checkmark:c.d29}},props:{location_group_name_low:String,location_group_id:Number},data(){let e=this.location_group_name_low+" адрес",t=this.$heap.state.settings.location,i=JSON.parse(t.mapCenter);return{settings:{apiKey:t.ymapApiKey,lang:"ru_RU",coordorder:"latlong",version:"2.1"},placemarkProperties:{iconCaption:e},suggestions:[],addressSearchQuery:null,locationType:e,locSettings:t,selectedPlacemark:0,selectedAddress:"",selectedCoords:[],coords:i}},methods:{async pickAddress(){try{if(!this.selectedAddress){var e;const t=await window.ymaps.geocode(this.coords);this.selectedAddress=null===(e=t.geoObjects.get(0))||void 0===e?void 0:e.getAddressLine()}}catch(i){}var t={location_address:this.filterAddress(this.selectedAddress),location_latitude:this.coords[0],location_longitude:this.coords[1]};r.Fy.dismiss(t)},filterAddress(e){const t=this.locSettings.addressErase.split(", "),i=e.split(", ");let l=[];for(const n of i)t.find((e=>e==n))||l.push(n);return l.reverse().join(", ")},onClick(e){e&&e.get&&(this.suggestions=[],this.selectedAddress=null,this.coords=e.get("coords"))},async suggestionsGet(){if(this.addressSearchQuery)try{const e=this.$heap.state.settings.location.ymapSuggestionApiKey,t=this.coords.slice().reverse().join(","),i=await fetch(`https://suggest-maps.yandex.ru/v1/suggest?apikey=${e}&lang=ru_RU&ll=${t}&spn=1,1&attrs=uri&types=house&results=5&text=${this.addressSearchQuery}`),l=await i.json();this.suggestions=l.results||[]}catch(e){}else this.suggestions=[]},async suggestionSelect(e,t){this.selectedAddress=e,this.geocode(t)},async geocode(e){try{this.suggestions=[];const t=this.$heap.state.settings.location.ymapApiKey,i=await fetch(`https://geocode-maps.yandex.ru/1.x?apikey=${t}&format=json&results=1&uri=${e}`),l=await i.json(),n=l.response.GeoObjectCollection.featureMember[0].GeoObject;this.coords=n.Point.pos.split(" ").reverse()}catch(t){console.log(t)}}},async mounted(){await(0,u.xk)();let e=window.ymaps;this.$flash("Получаем местоположение устройства"),e.geolocation.get().then((e=>{this.coords=e.geoObjects.position,this.$flash("На карте отмечено ваше местоположение")}))}},m=i(3744);const p=(0,m.Z)(d,[["render",s]]);var g=p},9487:function(e,t,i){i.r(t),i.d(t,{default:function(){return _}});var l=i(6252),n=i(3577);const a={class:"ion-padding",slot:"content"};function o(e,t,i,o,s,r){const u=(0,l.up)("ion-icon"),c=(0,l.up)("ion-label"),d=(0,l.up)("ion-item"),m=(0,l.up)("ion-list"),p=(0,l.up)("ion-title"),g=(0,l.up)("ion-button"),h=(0,l.up)("ion-buttons"),f=(0,l.up)("ion-toolbar"),_=(0,l.up)("ion-header"),w=(0,l.up)("ion-input"),k=(0,l.up)("ion-textarea"),y=(0,l.up)("ion-select-option"),W=(0,l.up)("ion-select"),v=(0,l.up)("ion-accordion"),M=(0,l.up)("ion-chip"),b=(0,l.up)("image-tile-comp"),C=(0,l.up)("ion-accordion-group"),I=(0,l.up)("ion-col"),U=(0,l.up)("ion-row"),$=(0,l.up)("ion-grid"),V=(0,l.up)("ion-content"),x=(0,l.up)("ion-modal"),O=(0,l.up)("base-layout");return(0,l.wg)(),(0,l.j4)(O,{pageDefaultBackLink:"/user","page-title":"Рассылка"},{default:(0,l.w5)((()=>{var e;return[(0,l.Wm)(m,null,{default:(0,l.w5)((()=>[(0,l.Wm)(d,{button:"",onClick:t[0]||(t[0]=e=>r.itemCreate())},{default:(0,l.w5)((()=>[(0,l.Wm)(u,{slot:"start",src:o.addOutline},null,8,["src"]),(0,l.Wm)(c,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Добавить Рассылку")])),_:1})])),_:1})])),_:1}),(null===(e=s.mailingList)||void 0===e?void 0:e.length)>0?((0,l.wg)(),(0,l.j4)(m,{key:0},{default:(0,l.w5)((()=>[((0,l.wg)(!0),(0,l.iD)(l.HY,null,(0,l.Ko)(s.mailingList,(e=>((0,l.wg)(),(0,l.j4)(d,{key:e.mailing_id,onClick:t=>r.itemGet(e.mailing_id)},{default:(0,l.w5)((()=>[(0,l.Wm)(c,null,{default:(0,l.w5)((()=>[(0,l.Uk)("#"+(0,n.zw)(e.mailing_id)+" "+(0,n.zw)(e.subject_template),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):(0,l.kq)("",!0),(0,l.Wm)(x,{ref:"modal",onWillDismiss:t[18]||(t[18]=e=>s.isMailingOpen=!1),"is-open":s.isMailingOpen,"initial-breakpoint":.75,breakpoints:[.75,1]},{default:(0,l.w5)((()=>[(0,l.Wm)(_,null,{default:(0,l.w5)((()=>[(0,l.Wm)(f,null,{default:(0,l.w5)((()=>[(0,l.Wm)(p,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Рассылка #"+(0,n.zw)(s.currentMailing.mailing_id),1)])),_:1}),(0,l.Wm)(h,{slot:"end"},{default:(0,l.w5)((()=>[(0,l.Wm)(g,{onClick:t[1]||(t[1]=e=>s.isMailingOpen=!1)},{default:(0,l.w5)((()=>[(0,l.Wm)(u,{src:o.closeOutline},null,8,["src"])])),_:1})])),_:1})])),_:1})])),_:1}),(0,l.Wm)(V,{class:"ion-padding",onChange:t[17]||(t[17]=e=>r.itemSave(e))},{default:(0,l.w5)((()=>[(0,l.Wm)(C,{modelValue:s.openedAccordion,"onUpdate:modelValue":t[14]||(t[14]=e=>s.openedAccordion=e),style:{overflow:"hidden","border-radius":"10px"}},{default:(0,l.w5)((()=>[(0,l.Wm)(v,{value:"message"},{default:(0,l.w5)((()=>[(0,l.Wm)(d,{slot:"header",color:"light"},{default:(0,l.w5)((()=>[(0,l.Wm)(c,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Сообщение")])),_:1})])),_:1}),(0,l.Wm)(m,{slot:"content"},{default:(0,l.w5)((()=>[(0,l.Wm)(d,null,{default:(0,l.w5)((()=>[(0,l.Wm)(w,{modelValue:s.currentMailing.subject_template,"onUpdate:modelValue":t[2]||(t[2]=e=>s.currentMailing.subject_template=e),label:"Тема","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,l.Wm)(d,null,{default:(0,l.w5)((()=>[(0,l.Wm)(k,{modelValue:s.currentMailing.text_template,"onUpdate:modelValue":t[3]||(t[3]=e=>s.currentMailing.text_template=e),label:"Сообщение","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,l.Wm)(d,null,{default:(0,l.w5)((()=>[(0,l.Wm)(w,{modelValue:s.currentMailing.start_at,"onUpdate:modelValue":t[4]||(t[4]=e=>s.currentMailing.start_at=e),type:"datetime-local",label:"Начало запуска","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,l.Wm)(d,null,{default:(0,l.w5)((()=>[(0,l.Wm)(W,{label:"Транспорт","label-placement":"stacked",modelValue:s.currentMailing.transport,"onUpdate:modelValue":t[5]||(t[5]=e=>s.currentMailing.transport=e)},{default:(0,l.w5)((()=>[(0,l.Wm)(y,{value:"-"},{default:(0,l.w5)((()=>[(0,l.Uk)("-")])),_:1}),(0,l.Wm)(y,{value:"push"},{default:(0,l.w5)((()=>[(0,l.Uk)("Push")])),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),(0,l.Wm)(v,{value:"recievers"},{default:(0,l.w5)((()=>[(0,l.Wm)(d,{slot:"header",color:"light"},{default:(0,l.w5)((()=>[(0,l.Wm)(c,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Получатели ("+(0,n.zw)(s.currentMailing.recieverCount.sent)+"/"+(0,n.zw)(s.currentMailing.recieverCount.all)+")",1)])),_:1})])),_:1}),(0,l._)("div",a,[(0,l.Wm)(m,null,{default:(0,l.w5)((()=>[(0,l.Wm)(d,null,{default:(0,l.w5)((()=>[(0,l.Wm)(w,{modelValue:s.currentMailing.user_filter.phones,"onUpdate:modelValue":t[6]||(t[6]=e=>s.currentMailing.user_filter.phones=e),name:"user_filter.phones",label:"Телефоны получателей","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,l.Wm)(d,{lines:"none"},{default:(0,l.w5)((()=>[(0,l.Wm)(c,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Локация клиентов")])),_:1})])),_:1}),s.currentMailing.user_filter.location?((0,l.wg)(),(0,l.j4)(d,{key:0,lines:"none"},{default:(0,l.w5)((()=>[(0,l.Wm)(u,{slot:"start",src:o.locationOutline},null,8,["src"]),(0,l.Wm)(c,{style:{"white-space":"normal",cursor:"pointer"}},{default:(0,l.w5)((()=>[(0,l.Uk)((0,n.zw)(s.currentMailing.user_filter.location.location_address),1)])),_:1}),(0,l.Wm)(u,{slot:"end",icon:o.trash,onClick:t[7]||(t[7]=e=>r.locationDelete(`${s.currentMailing.user_filter.location.location_id}`))},null,8,["icon"])])),_:1})):((0,l.wg)(),(0,l.j4)(g,{key:1,onClick:t[8]||(t[8]=e=>r.modalLocationCreate()),color:"light",expand:"block"},{default:(0,l.w5)((()=>[(0,l.Wm)(u,{src:o.locationOutline},null,8,["src"]),(0,l.Uk)(" Добавить адрес ")])),_:1})),s.currentMailing.user_filter.location?((0,l.wg)(),(0,l.j4)(d,{key:2},{default:(0,l.w5)((()=>[(0,l.Wm)(w,{modelValue:s.currentMailing.user_filter.radius,"onUpdate:modelValue":t[9]||(t[9]=e=>s.currentMailing.user_filter.radius=e),name:"user_filter.radius",label:"Радиус вокруг локации км","label-placement":"stacked"},null,8,["modelValue"])])),_:1})):(0,l.kq)("",!0),(0,l.Wm)(d,{lines:"none"},{default:(0,l.w5)((()=>[s.currentMailing.recieverCount.all>0?((0,l.wg)(),(0,l.j4)(M,{key:0},{default:(0,l.w5)((()=>[(0,l.Uk)("Всего "+(0,n.zw)(s.currentMailing.recieverCount.all),1)])),_:1})):(0,l.kq)("",!0),s.currentMailing.recieverCount.sent>0?((0,l.wg)(),(0,l.j4)(M,{key:1,color:"success"},{default:(0,l.w5)((()=>[(0,l.Uk)("Послано "+(0,n.zw)(s.currentMailing.recieverCount.sent),1)])),_:1})):(0,l.kq)("",!0),s.currentMailing.recieverCount.failed>0?((0,l.wg)(),(0,l.j4)(M,{key:2,color:"danger"},{default:(0,l.w5)((()=>[(0,l.Uk)("Ошибка "+(0,n.zw)(s.currentMailing.recieverCount.failed),1)])),_:1})):(0,l.kq)("",!0)])),_:1})])),_:1})])])),_:1}),"push"==s.currentMailing.transport?((0,l.wg)(),(0,l.j4)(v,{key:0,value:"push_options"},{default:(0,l.w5)((()=>[(0,l.Wm)(d,{slot:"header",color:"light"},{default:(0,l.w5)((()=>[(0,l.Wm)(c,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Настройки пуш")])),_:1})])),_:1}),(0,l.Wm)(m,{slot:"content"},{default:(0,l.w5)((()=>{var e,i;return[(0,l.Wm)(b,{images:null===(e=s.currentMailing)||void 0===e?void 0:e.images,image_holder:"mailing",image_holder_id:null===(i=s.currentMailing)||void 0===i?void 0:i.mailing_id,hide_if_empty:"true",controller:"Admin/Mailing",ref:"mailingImgs"},null,8,["images","image_holder_id"]),(0,l.Wm)(d,{lines:"none",onClick:t[10]||(t[10]=e=>this.$refs.mailingImgs.take_photo())},{default:(0,l.w5)((()=>[(0,l.Wm)(u,{src:o.addOutline,slot:"start"},null,8,["src"]),(0,l.Uk)(" Добавить фото ")])),_:1}),(0,l.Wm)(d,null,{default:(0,l.w5)((()=>[(0,l.Wm)(w,{modelValue:s.currentMailing.link,"onUpdate:modelValue":t[11]||(t[11]=e=>s.currentMailing.link=e),label:"Link","label-placement":"stacked"},null,8,["modelValue"])])),_:1}),(0,l.Wm)(d,null,{default:(0,l.w5)((()=>[(0,l.Wm)(W,{onIonChange:t[12]||(t[12]=e=>r.itemSave()),label:"Рингтон","label-placement":"stacked",modelValue:s.currentMailing.sound,"onUpdate:modelValue":t[13]||(t[13]=e=>s.currentMailing.sound=e),value:"default"},{default:(0,l.w5)((()=>[(0,l.Wm)(y,{value:""},{default:(0,l.w5)((()=>[(0,l.Uk)("-")])),_:1}),(0,l.Wm)(y,{value:"default"},{default:(0,l.w5)((()=>[(0,l.Uk)("стандарт")])),_:1}),(0,l.Wm)(y,{value:"short.wav"},{default:(0,l.w5)((()=>[(0,l.Uk)("Короткий")])),_:1}),(0,l.Wm)(y,{value:"medium.wav"},{default:(0,l.w5)((()=>[(0,l.Uk)("Средний")])),_:1}),(0,l.Wm)(y,{value:"long.wav"},{default:(0,l.w5)((()=>[(0,l.Uk)("Длинный")])),_:1})])),_:1},8,["modelValue"])])),_:1})]})),_:1})])),_:1})):(0,l.kq)("",!0)])),_:1},8,["modelValue"]),(0,l.Wm)($,null,{default:(0,l.w5)((()=>[(0,l.Wm)(U,null,{default:(0,l.w5)((()=>[(0,l.Wm)(I,null,{default:(0,l.w5)((()=>[(0,l.Wm)(g,{onClick:t[15]||(t[15]=e=>r.itemDelete()),color:"danger",fill:"clear",expand:"block"},{default:(0,l.w5)((()=>[(0,l.Uk)("Удалить")])),_:1})])),_:1}),(0,l.Wm)(I,null,{default:(0,l.w5)((()=>[(0,l.Wm)(g,{onClick:t[16]||(t[16]=e=>r.itemStart()),expand:"block",color:"light"},{default:(0,l.w5)((()=>[(0,l.Wm)(u,{slot:"start",src:o.playOutline},null,8,["src"]),(0,l.Uk)(" Запустить ")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["is-open"])]})),_:1})}i(8862);var s=i(4929),r=i(8903),u=i(4405),c=i(9755),d=i.n(c),m=i(2639),p=i(5236),g={components:{ImageTileComp:m.Z,IonList:s.q_,IonItem:s.Ie,IonLabel:s.Q$,IonIcon:s.gu,IonModal:s.ki,IonHeader:s.Gu,IonToolbar:s.sr,IonButtons:s.Sm,IonTitle:s.wd,IonButton:s.YG,IonContent:s.W2,IonInput:s.pK,IonTextarea:s.g2,IonSelect:s.t9,IonSelectOption:s.n0,IonGrid:s.jY,IonRow:s.Nd,IonCol:s.wI,IonAccordionGroup:s.eh,IonAccordion:s.We,IonChip:s.hM},setup(){return{addOutline:r.s6O,refreshOutline:r.D3P,imageOutline:r.Eu9,closeOutline:r.fID,playOutline:r.AO3,locationOutline:r.Iv7,trash:r._Ij}},data(){return{openedAccordion:"message",currentMailing:{},mailingList:null,isMailingOpen:!1,saveClock:null}},computed:{},methods:{async itemCreate(){const e={subject_template:"new mailing"};try{const t=await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemCreate`,e);this.itemGet(t)}catch(t){}},async itemGet(e){const t={mailing_id:e};try{var i;const e=await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemGet`,t);null!==(i=e.user_filter)&&void 0!==i||(e.user_filter={}),this.currentMailing=e,this.isMailingOpen=!0}catch(l){}},async itemSave(e){clearTimeout(this.saveClock),this.saveClock=setTimeout((async()=>{var t,i;await this.itemUpdate(),e&&(null===(t=e.target)||void 0===t||null===(i=t.name)||void 0===i?void 0:i.indexOf("user_filter"))>-1&&this.recieverListCreate()}),500)},async itemUpdate(){const e=this.currentMailing;try{await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemUpdate`,JSON.stringify(e)),this.$flash("💾 сохранено")}catch(t){this.$flash("Ошибка сохранения")}},async itemDelete(){if(!confirm("Вы уверенны?"))return;const e={mailing_id:this.currentMailing.mailing_id};try{await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemDelete`,e),this.isMailingOpen=!1,this.listGet()}catch(t){}},itemValidate(){if(this.currentMailing.start_at)if(this.currentMailing.user_filter.phones)if(this.currentMailing.subject_template)if(this.currentMailing.text_template){if(this.currentMailing.transport)return!0;alert("Транспорт не заполнен")}else alert("Содержание не заполнено");else alert("Заголовок не заполнен");else alert("Получатели не заполнены");else alert("Начало рассылки не заполнено")},async itemStart(){if(!this.itemValidate()||!confirm(`Запустить рассылку в ${this.currentMailing.start_at}?`))return;const e={mailing_id:this.currentMailing.mailing_id};try{await d().post(`${this.$heap.state.hostname}Admin/Mailing/itemStart`,e),this.listGet()}catch(t){}},async listGet(){this.mailingList=await u.Z.prePost(`${this.$heap.state.hostname}Admin/Mailing/listGet`,{});try{this.mailingList=await u.Z.post(`${this.$heap.state.hostname}Admin/Mailing/listGet`,{})}catch(e){console.log(e)}},async modalLocationCreate(){if(!this.$heap.state.user.user_id)return this.$flash("Чтобы добавленные адреса сохранились, пожалуйста войдите в систему"),void this.$go({name:"UserSignIn"});var e="рабочий";const t=await s.Fy.create({component:p.Z,showBackdrop:!0,backdropDismiss:!0,componentProps:{location_group_name_low:e}});await t.present();const i=await t.onDidDismiss();i&&(this.currentMailing.user_filter.location=i.data,this.recieverListCreate())},async locationDelete(e){try{this.currentMailing.user_filter.location=null,this.recieverListCreate()}catch(t){this.$flash("Удалить адрес не удалось")}},async recieverListCreate(){try{const e={mailing_id:this.currentMailing.mailing_id};await this.itemUpdate();const t=await d().post(this.$heap.state.hostname+"Admin/Mailing/recieverListCreate",e);this.$flash(`В список получателей добавлено ${t} запись`),this.itemGet(this.currentMailing.mailing_id)}catch(e){this.$flash("Создать список получателей не удалось")}}},ionViewDidEnter(){this.listGet()},mounted(){this.listGet()}},h=i(3744);const f=(0,h.Z)(g,[["render",o],["__scopeId","data-v-7ae57d46"]]);var _=f}}]);
//# sourceMappingURL=9487-legacy.6bcaf096.js.map