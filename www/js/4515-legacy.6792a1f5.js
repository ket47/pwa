"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[4515],{4515:function(e,t,i){i.r(t),i.d(t,{default:function(){return P}});var a=i(6252),n=i(3577);const r=e=>((0,a.dD)("data-v-329da2c6"),e=e(),(0,a.Cn)(),e),s=r((()=>(0,a._)("span",null,"отвезти сразу",-1))),o=r((()=>(0,a._)("b",null,"Ко времени",-1))),l={key:0},d={key:1},u={for:"use_credit_store"},c={style:{"font-size":"0.7em",color:"var(--ion-color-medium)"}},p={slot:"end"},m=["checked"],h=r((()=>(0,a._)("label",{for:"payment_cash"},"Оплата наличными",-1))),_={slot:"end"},y=["checked"],v={key:2},k=r((()=>(0,a._)("label",{for:"payment_card"},"Оплата картой без привязки",-1))),f={slot:"end"},w=["checked"],g={for:"use_card_recurrent"},C={slot:"end"},b=["checked"];function D(e,t,i,r,D,T){const I=(0,a.up)("ion-label"),R=(0,a.up)("ion-segment-button"),$=(0,a.up)("ion-segment"),S=(0,a.up)("ion-item"),W=(0,a.up)("ion-item-divider"),O=(0,a.up)("ion-icon"),A=(0,a.up)("ion-img"),U=(0,a.up)("ion-text"),B=(0,a.up)("router-link"),L=(0,a.up)("ion-checkbox"),j=(0,a.up)("ion-list"),z=(0,a.up)("ion-card-content"),V=(0,a.up)("ion-card"),P=(0,a.up)("ion-button"),x=(0,a.up)("base-layout");return(0,a.wg)(),(0,a.j4)(x,{pageTitle:"Оформление вызова курьера",pageDefaultBackLink:"/order/order-list",ref:"page"},{default:(0,a.w5)((()=>[(0,a.Wm)(j,{lines:"none"},{default:(0,a.w5)((()=>{var i;return[(0,a.Wm)(S,null,{default:(0,a.w5)((()=>[(0,a.Wm)($,{mode:"ios",value:"atonce"},{default:(0,a.w5)((()=>[(0,a.Wm)(R,{value:"atonce"},{default:(0,a.w5)((()=>[(0,a.Wm)(I,null,{default:(0,a.w5)((()=>[(0,a.Uk)("Как можно скорее")])),_:1}),s])),_:1}),(0,a.Wm)(R,{value:"schedule",onClick:t[0]||(t[0]=e=>T.datetimePick())},{default:(0,a.w5)((()=>[(0,a.Wm)(I,null,{default:(0,a.w5)((()=>[o])),_:1}),T.deliveryArriveDatetimeLoc?((0,a.wg)(),(0,a.iD)("span",l,(0,n.zw)(T.deliveryArriveDatetimeLoc),1)):((0,a.wg)(),(0,a.iD)("span",d,"выберите день и время"))])),_:1})])),_:1})])),_:1}),(0,a.Wm)(W,null,{default:(0,a.w5)((()=>[(0,a.Uk)("Способы оплаты")])),_:1}),1==D.tariffRule.paymentByCreditStore?((0,a.wg)(),(0,a.j4)(S,{key:0,button:"",detail:"false",onClick:t[1]||(t[1]=e=>D.paymentType="use_credit_store")},{default:(0,a.w5)((()=>[(0,a.Wm)(O,{icon:r.businessOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,a._)("label",u,[(0,a.Uk)(" Со счета предприятия "),(0,a._)("div",c,(0,n.zw)(D.tariffRule.storeCreditName)+" "+(0,n.zw)(D.tariffRule.storeCreditBalance)+(0,n.zw)(e.$heap.state.currencySign),1)]),(0,a._)("div",p,[(0,a._)("input",{type:"radio",name:"paymentType",id:"payment_credit_store",value:"cash",checked:"use_credit_store"==D.paymentType},null,8,m)])])),_:1})):(0,a.kq)("",!0),1==D.tariffRule.paymentByCash?((0,a.wg)(),(0,a.j4)(S,{key:1,button:"",detail:"false",onClick:t[2]||(t[2]=e=>D.paymentType="use_cash")},{default:(0,a.w5)((()=>[(0,a.Wm)(O,{icon:r.cashOutline,slot:"start",color:"medium"},null,8,["icon"]),h,(0,a._)("div",_,[(0,a._)("input",{type:"radio",name:"paymentType",id:"payment_cash",value:"cash",checked:"use_cash"==D.paymentType},null,8,y)])])),_:1})):(0,a.kq)("",!0),1==D.tariffRule.paymentByCard?((0,a.wg)(),(0,a.iD)("div",v,[(0,a.Wm)(S,{detail:"false",button:"",onClick:t[3]||(t[3]=e=>D.paymentType="use_card")},{default:(0,a.w5)((()=>[(0,a.Wm)(O,{icon:r.cardOutline,slot:"start",color:"medium"},null,8,["icon"]),k,(0,a._)("div",f,[(0,a._)("input",{type:"radio",name:"paymentType",id:"payment_card",value:"card",checked:"use_card"==D.paymentType},null,8,w)])])),_:1}),null!==(i=D.bankCard)&&void 0!==i&&i.card_type?((0,a.wg)(),(0,a.j4)(S,{key:0,button:"",detail:"false",onClick:t[4]||(t[4]=e=>D.paymentType="use_card_recurrent")},{default:(0,a.w5)((()=>{var e;return["mir"==D.bankCard.card_type?((0,a.wg)(),(0,a.j4)(A,{key:0,class:"card_type",src:`/img/icons/card-${D.bankCard.card_type}.svg`,slot:"start"},null,8,["src"])):"visa"==D.bankCard.card_type?((0,a.wg)(),(0,a.j4)(A,{key:1,class:"card_type",src:`/img/icons/card-${D.bankCard.card_type}.svg`,slot:"start"},null,8,["src"])):"mastercard"==D.bankCard.card_type?((0,a.wg)(),(0,a.j4)(A,{key:2,class:"card_type",src:`/img/icons/card-${D.bankCard.card_type}.svg`,slot:"start"},null,8,["src"])):((0,a.wg)(),(0,a.j4)(O,{key:3,src:r.cardOutline,slot:"start",color:"medium"},null,8,["src"])),(0,a._)("label",g,"Оплата картой "+(0,n.zw)(null===(e=D.bankCard)||void 0===e?void 0:e.card_mask),1),(0,a._)("div",C,[(0,a._)("input",{type:"radio",name:"paymentType",id:"use_card_recurrent",value:"registered_card",checked:"use_card_recurrent"==D.paymentType},null,8,b)])]})),_:1})):(0,a.kq)("",!0),D.recurrentPaymentAllow?((0,a.wg)(),(0,a.j4)(S,{key:1,button:"",detail:"",onClick:t[5]||(t[5]=t=>e.$go("/user/user-cards"))},{default:(0,a.w5)((()=>{var e;return[null!==(e=D.bankCard)&&void 0!==e&&e.card_type?((0,a.wg)(),(0,a.j4)(I,{key:0,color:"medium"},{default:(0,a.w5)((()=>[(0,a.Uk)("Выбрать другую карту")])),_:1})):((0,a.wg)(),(0,a.j4)(I,{key:1,color:"medium"},{default:(0,a.w5)((()=>[(0,a.Uk)("Привязать карту")])),_:1}))]})),_:1})):(0,a.kq)("",!0)])):(0,a.kq)("",!0),(0,a.Wm)(W,null,{default:(0,a.w5)((()=>[(0,a.Uk)("Итог")])),_:1}),T.ship_sum_total>0?((0,a.wg)(),(0,a.j4)(S,{key:3},{default:(0,a.w5)((()=>[(0,a.Wm)(O,{icon:r.walletOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,a.Uk)(" Итого к оплате "),(0,a.Wm)(U,{slot:"end"},{default:(0,a.w5)((()=>[(0,a._)("b",null,(0,n.zw)(T.ship_sum_total),1),(0,a.Uk)((0,n.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1})):(0,a.kq)("",!0),(0,a.Wm)(S,null,{default:(0,a.w5)((()=>[(0,a.Wm)(U,{style:{"font-size":"0.9em"}},{default:(0,a.w5)((()=>[(0,a.Uk)(" Я согласен(на) с "),(0,a.Wm)(B,{to:"/page/rules-customer"},{default:(0,a.w5)((()=>[(0,a.Uk)("офертой об оказании услуг доставки")])),_:1})])),_:1}),(0,a.Wm)(L,{slot:"end",modelValue:D.termsAccepted,"onUpdate:modelValue":t[6]||(t[6]=e=>D.termsAccepted=e),"aria-label":""},null,8,["modelValue"])])),_:1})]})),_:1}),T.checkoutError?((0,a.wg)(),(0,a.j4)(V,{key:0,color:"warning"},{default:(0,a.w5)((()=>[(0,a.Wm)(z,null,{default:(0,a.w5)((()=>[(0,a.Uk)((0,n.zw)(T.checkoutError),1)])),_:1})])),_:1})):(0,a.kq)("",!0),!T.isVPNon||"use_card"!=D.paymentType&&"use_card_recurrent"!=D.paymentType?(0,a.kq)("",!0):((0,a.wg)(),(0,a.j4)(V,{key:1,color:"light"},{default:(0,a.w5)((()=>[(0,a.Wm)(z,null,{default:(0,a.w5)((()=>[(0,a.Uk)("Возможно включен VPN. Банк часто блокирует платежи через VPN.")])),_:1})])),_:1})),"use_card"==D.paymentType||"use_card_recurrent"==D.paymentType?((0,a.wg)(),(0,a.j4)(P,{key:2,expand:"block",onClick:t[7]||(t[7]=e=>T.proceed()),disabled:T.checkoutError},{default:(0,a.w5)((()=>[(0,a.Uk)("Оплатить картой")])),_:1},8,["disabled"])):((0,a.wg)(),(0,a.j4)(P,{key:3,expand:"block",onClick:t[8]||(t[8]=e=>T.proceed()),disabled:T.checkoutError},{default:(0,a.w5)((()=>[(0,a.Uk)("Вызвать курьера")])),_:1},8,["disabled"]))])),_:1},512)}i(6699),i(8862);var T=i(4929),I=i(8903),R=i(5836),$=i(4405),S=i(9755),W=i.n(S);const O={style:{height:"100%"}};function A(e,t,i,n,r,s){const o=(0,a.up)("ion-title"),l=(0,a.up)("ion-icon"),d=(0,a.up)("ion-item"),u=(0,a.up)("ion-toolbar"),c=(0,a.up)("ion-header"),p=(0,a.up)("ion-datetime"),m=(0,a.up)("ion-button"),h=(0,a.up)("ion-content");return(0,a.wg)(),(0,a.iD)("div",O,[(0,a.Wm)(c,null,{default:(0,a.w5)((()=>[(0,a.Wm)(u,null,{default:(0,a.w5)((()=>[(0,a.Wm)(d,{lines:"none"},{default:(0,a.w5)((()=>[(0,a.Wm)(o,null,{default:(0,a.w5)((()=>[(0,a.Uk)("Выбрать день и час")])),_:1}),(0,a.Wm)(l,{slot:"end",onClick:t[0]||(t[0]=e=>{s.cancel()}),icon:n.closeOutline,size:"large"},null,8,["icon"])])),_:1})])),_:1})])),_:1}),(0,a.Wm)(h,{class:"ion-padding"},{default:(0,a.w5)((()=>{var e,n;return[(0,a.Wm)(p,{style:{"max-width":"100%","border-radius":"10px"},presentation:"date-time",modelValue:r.datetime,"onUpdate:modelValue":t[1]||(t[1]=e=>r.datetime=e),"prefer-wheel":!0,"first-day-of-week":1,min:null===(e=i.dateRange)||void 0===e?void 0:e.dayFirst,max:null===(n=i.dateRange)||void 0===n?void 0:n.dayLast,"hour-values":s.hourValues,"minute-values":0},null,8,["modelValue","min","max","hour-values"]),(0,a.Wm)(m,{color:"primary",onClick:t[2]||(t[2]=e=>s.confirm()),expand:"block"},{default:(0,a.w5)((()=>[(0,a.Uk)("Ок")])),_:1})]})),_:1})])}i(3948);var U={props:["dateRange"],components:{IonTitle:T.wd,IonDatetime:T.x4,IonToolbar:T.sr,IonContent:T.W2,IonHeader:T.Gu,IonIcon:T.gu,IonItem:T.Ie,IonButton:T.YG},setup(){return{closeOutline:I.fID}},data(){var e;const t=this.dateRange.dayHours[this.dateRange.dayFirst][0];let i=`${this.dateRange.dayFirst}T${t}:00:00`;return null!==(e=this.dateRange)&&void 0!==e&&e.defaultValue&&(i=this.dateRange.defaultValue),{datetime:i}},computed:{hourValues(){if(this.dateRange&&this.dateRange.dayHours&&this.datetime){const[e]=this.datetime.split("T");return this.dateRange.dayHours[e]}return null}},methods:{confirm(){T.Fy.dismiss(this.datetime,"confirm")},cancel(){T.Fy.dismiss(null,"cancel")}}},B=i(3744);const L=(0,B.Z)(U,[["render",A],["__scopeId","data-v-2e4aab34"]]);var j=L,z={components:{yandexMap:R.xR,ymapMarker:R.Jk,IonText:T.yW,IonList:T.q_,IonItem:T.Ie,IonIcon:T.gu,IonLabel:T.Q$,IonSegment:T.cJ,IonSegmentButton:T.GO,IonImg:T.Xz,IonCard:T.PM,IonCardContent:T.FN,IonButton:T.YG,IonCheckbox:T.nz,IonItemDivider:T.rH},setup(){return{cubeOutline:I.XFf,locationOutline:I.Iv7,flagOutline:I.FMn,chevronDown:I.Dd1,addOutline:I.s6O,checkmark:I.d29,cardOutline:I.pvm,cashOutline:I.zaw,businessOutline:I.c1X,walletOutline:I.S5P,alertCircleOutline:I.nLD}},data(){var e,t;return{presentingElement:null,isDatePickerOpen:!1,deliveryArriveRange:{},deliveryArriveRangeHours:[],deliveryArriveDatetime:null,ship_id:this.$route.params.id,ship:null,shipAutoloadClock:null,ship_sum_delivery:0,termsAccepted:1,iplocation:null,paymentType:"use_card",bankCard:null,recurrentPaymentAllow:1==(null===(e=this.$heap.state.settings)||void 0===e||null===(t=e.other)||void 0===t?void 0:t.recurrentPaymentAllow)?1:0,tariffRule:{},tariffRuleList:[],errorCode:null,mapsettings:null,placemarkCoords:null,placemarkProperties:{},placemarkIcon:{layout:"default#imageWithContent",content:"some content here",contentLayout:'<div class="placemarkBaloon">$[properties.iconContent]</div>',contentOffset:[45,10],imageHref:"/img/tezkel-placemark.png",imageSize:[50,50],imageOffset:[-25,-50]}}},computed:{deliveryArriveDatetimeLoc(){if(!this.deliveryArriveDatetime)return null;const e=new Date(Date.parse(this.deliveryArriveDatetime)),t={month:"short",day:"numeric",hour:"numeric",minute:"numeric"};return e.toLocaleDateString(void 0,t)},checkoutError(){return"no_input"==this.errorCode?"Выберите адрес забора и доставки посылки":"no_courier"==this.errorCode?"Нет доступных курьеров":0==this.termsAccepted?"К сожалению, мы не можем доставить вам заказ, без согласия с условиями":null},isVPNon(){var e;return!(!this.iplocation||["UA","RU","???"].includes(null!==(e=this.iplocation.country_code)&&void 0!==e?e:"???"))},ship_sum_total(){return this.ship_sum_delivery}},methods:{deliveryTimeAllowed(e){const t=new Date(e);t.getUTCDay();return!0},async itemLoad(){this.itemCheckoutDataGet()},async itemCheckoutDataGet(){try{let e=await $.Z.prePost(`${this.$heap.state.hostname}Shipment/itemCheckoutDataGet`,{ship_id:this.ship_id});this.itemCheckoutDataUse(e),e=await $.Z.post(`${this.$heap.state.hostname}Shipment/itemCheckoutDataGet`,{ship_id:this.ship_id}),this.ship=e.ship,this.itemCheckoutDataUse(e)}catch(i){var e,t;return this.is_checkout_data_loaded=1,this.errorCode=null===i||void 0===i||null===(e=i.responseJSON)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.error,"notfound"!=this.errorCode&&"forbidden"!=this.errorCode||(this.$flash("Заказ не найден"),this.$router.go(-1)),console.log(this.errorCode,i),!1}},async itemCheckoutDataUse(e){var t;e&&(e.Location_distanceGet||(this.errorCode="no_input"),this.deliveryTime=$.Z.deliveryTimeCalculate(e.Location_distanceGet,0),this.deliveryArriveRange=e.deliveryArriveRange,this.locationStart=e.Ship_locationStart,this.locationFinish=e.Ship_locationFinish,this.bankCard=null===e||void 0===e?void 0:e.bankCard,this.tariffRuleList=e.Ship_deliveryOptions,this.tariffRuleSet((null===(t=this.tariffRuleList)||void 0===t?void 0:t[0])||{}),this.is_checkout_data_loaded=1)},async itemCheckoutDataSet(){var e,t;const i={ship_id:this.ship_id,ship_start_location_id:null===(e=this.locationStart)||void 0===e?void 0:e.location_id,ship_finish_location_id:null===(t=this.locationFinish)||void 0===t?void 0:t.location_id,ship_arrive_time:this.deliveryArriveDatetime,ship_description:this.ship.ship_description};try{await W().post(`${this.$heap.state.hostname}Shipment/itemCheckoutDataSet`,JSON.stringify(i))}catch(a){console.log(a)}},tariffRuleSet(e){var t;this.tariffRule=e,this.ship_sum_delivery=e.ship_sum_delivery,this.paymentType="use_card",null!==(t=this.bankCard)&&void 0!==t&&t.card_type&&(this.paymentType="use_card_recurrent"),1==e.paymentByCreditStore?this.paymentType="use_credit_store":1==e.paymentByCash&&(this.paymentType="use_cash")},async datetimePick(){var e;this.deliveryArriveRange.defaultValue=null!==(e=this.deliveryArriveDatetime)&&void 0!==e?e:null;const t=await T.Fy.create({component:j,initialBreakpoint:"0.5",showBackdrop:!0,componentProps:{dateRange:this.deliveryArriveRange}});t.present();const i=await t.onDidDismiss();"confirm"==i.role&&(this.deliveryArriveDatetime=i.data)},async customerIpLocationGet(){try{const e=await fetch("https://geolocation-db.com/json/");this.iplocation=await e.json()}catch(e){}},async proceed(){const e={ship_id:this.ship.ship_id,tariff_id:this.tariffRule.tariff_id,paymentByCard:"use_card"==this.paymentType?1:0,paymentByCardRecurrent:"use_card_recurrent"==this.paymentType?1:0,paymentByCash:"use_cash"==this.paymentType?1:0,paymentByCreditStore:"use_credit_store"==this.paymentType?1:0};try{await W().post(`${this.$heap.state.hostname}Shipment/itemCheckoutDataSet`,JSON.stringify(e))}catch(r){var t,i;const e=null===r||void 0===r||null===(t=r.responseJSON)||void 0===t||null===(i=t.messages)||void 0===i?void 0:i.error;return!!e&&(this.$flash("Не удается оформить заказ, обратитесь на горячую линию"),!1)}if(1!=e.paymentByCard){if(1==e.paymentByCardRecurrent){const e={ship_id:this.ship.ship_id,card_id:this.bankCard.card_id};try{await W().post(`${this.$heap.state.hostname}CardAcquirer/paymentDo`,e)}catch(r){return this.$flash("Оплата привязанной картой не удалась"),!1}}try{const e={ship_id:this.ship.ship_id,new_stage:"customer_start"};await W().post(`${this.$heap.state.hostname}Shipment/itemStageCreate`,e)}catch(r){var a,n;const e=null===r||void 0===r||null===(a=r.responseJSON)||void 0===a||null===(n=a.messages)||void 0===n?void 0:n.error;switch(e){case"address_not_set":this.$flash("Необходимо добавить адрес доставки"),this.$topic.publish("dismissModal"),this.$go("/modal/user-addresses");break}return!1}}else this.paymentFormOpen({ship_id:this.ship.ship_id,ship_sum_total:this.ship_sum_total,user_id:this.ship.owner_id})}},mounted(){this.itemLoad();this.$heap.state.settings;this.presentingElement=this.$refs.page.$el},ionViewDidEnter(){this.itemLoad()}};const V=(0,B.Z)(z,[["render",D],["__scopeId","data-v-329da2c6"]]);var P=V}}]);
//# sourceMappingURL=4515-legacy.6792a1f5.js.map