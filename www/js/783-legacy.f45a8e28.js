"use strict";(self["webpackChunktezkel"]=self["webpackChunktezkel"]||[]).push([[783],{7208:function(e,t,a){a.d(t,{Z:function(){return g}});var l=a(6252),n=a(3577);const i={class:"ion-page"};function o(e,t,a,o,r,s){const u=(0,l.up)("ion-title"),d=(0,l.up)("ion-icon"),m=(0,l.up)("ion-toolbar"),c=(0,l.up)("ion-header"),p=(0,l.up)("ion-searchbar"),_=(0,l.up)("ion-skeleton-text"),g=(0,l.up)("ion-item"),y=(0,l.up)("ion-list"),h=(0,l.up)("ion-img"),w=(0,l.up)("ion-avatar"),f=(0,l.up)("ion-content");return(0,l.wg)(),(0,l.iD)("div",i,[(0,l.Wm)(c,null,{default:(0,l.w5)((()=>[(0,l.Wm)(m,{color:"secondary"},{default:(0,l.w5)((()=>[(0,l.Wm)(u,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Выбрать "+(0,n.zw)(r.itemTypeName),1)])),_:1}),(0,l.Wm)(d,{icon:o.closeOutline,onClick:t[0]||(t[0]=e=>{s.closeModal()}),slot:"end",size:"large"},null,8,["icon"])])),_:1})])),_:1}),(0,l.Wm)(f,null,{default:(0,l.w5)((()=>{var a;return["acc"!=r.itemTypeLabel?((0,l.wg)(),(0,l.j4)(p,{key:0,modelValue:r.query,"onUpdate:modelValue":t[1]||(t[1]=e=>r.query=e),placeholder:"поиск",debounce:100,onIonInput:t[2]||(t[2]=e=>s.listGet())},null,8,["modelValue"])):(0,l.kq)("",!0),r.itemList?null!==(a=r.itemList)&&void 0!==a&&a.length?((0,l.wg)(),(0,l.j4)(y,{key:2},{default:(0,l.w5)((()=>[((0,l.wg)(!0),(0,l.iD)(l.HY,null,(0,l.Ko)(r.itemList,(t=>((0,l.wg)(),(0,l.j4)(g,{key:t.id,button:"",detail:"",onClick:e=>s.itemPick(t)},{default:(0,l.w5)((()=>[(0,l.Wm)(w,{slot:"start"},{default:(0,l.w5)((()=>[t.image_hash?((0,l.wg)(),(0,l.j4)(h,{key:0,src:`${e.$heap.state.hostname}image/get.php/${t.image_hash}.50.50.webp`},null,8,["src"])):(0,l.kq)("",!0)])),_:2},1024),(0,l.Uk)(" "+(0,n.zw)(t.name),1)])),_:2},1032,["onClick"])))),128))])),_:1})):((0,l.wg)(),(0,l.j4)(y,{key:3},{default:(0,l.w5)((()=>[(0,l.Wm)(g,null,{default:(0,l.w5)((()=>[(0,l.Uk)(" Ничего не найдено ")])),_:1})])),_:1})):((0,l.wg)(),(0,l.j4)(y,{key:1},{default:(0,l.w5)((()=>[((0,l.wg)(),(0,l.iD)(l.HY,null,(0,l.Ko)([0,1,2,3,4,5,6,7,8,9],(e=>(0,l.Wm)(g,{key:e,button:"",detail:""},{default:(0,l.w5)((()=>[(0,l.Wm)(_,{style:{height:"35px",width:"40px"},animated:""}),(0,l.Wm)(_,{style:{width:"100%"},animated:""})])),_:2},1024))),64))])),_:1}))]})),_:1})])}var r=a(8534),s=a(8903),u=a(1632),d=a(9755),m=a.n(d),c={props:["itemType"],components:{IonContent:u.W2,IonHeader:u.Gu,IonToolbar:u.sr,IonTitle:u.wd,IonIcon:u.gu,IonImg:u.Xz,IonList:u.q_,IonItem:u.Ie,IonSearchbar:u.VI,IonSkeletonText:u.CK,IonAvatar:u.BJ},setup(){return{closeOutline:s.fID}},data(){const e=this.itemType?this.itemType:"order";return{query:null,itemList:null,itemTypeLabel:e,itemTypeName:""}},mounted(){this.listGet()},methods:{listGet(){var e=this;return(0,r.Z)((function*(){"order"==e.itemTypeLabel?(e.itemTypeName="Заказ",e.ordersGet()):"store"==e.itemTypeLabel?(e.itemTypeName="Продавец",e.storesGet()):"courier"==e.itemTypeLabel?(e.itemTypeName="Курьер",e.couriersGet()):"acc"==e.itemTypeLabel?(e.itemTypeName="Счет",e.accountsGet()):e.$flash("unknown item type "+e.itemTypeLabel)}))()},storesGet(){var e=this;return(0,r.Z)((function*(){const t={name_query:e.query,name_query_fields:"store_name",limit:10};try{let a=yield m().post(`${e.$heap.state.hostname}Store/listGet`,t);e.itemList=a.map((e=>(e.name=`продавец ${e.store_name}`,e.id=e.store_id,e)))}catch(a){}}))()},couriersGet(){var e=this;return(0,r.Z)((function*(){const t={name_query:e.query,name_query_fields:"user_name,user_phone",limit:10};try{let a=yield m().post(`${e.$heap.state.hostname}Courier/listGet`,t);e.itemList=a.map((e=>(e.name=`курьер ${e.user_name} ${e.user_phone}`,e.id=e.courier_id,e.image_hash=e.courier_photo_image_hash,e)))}catch(a){}}))()},ordersGet(){var e=this;return(0,r.Z)((function*(){const t={name_query:e.query,name_query_fields:"store_name,order_id,user_name",limit:10};try{let a=yield m().post(`${e.$heap.state.hostname}Order/listGet`,t);e.itemList=a.map((e=>(e.name=`заказ#${e.order_id} ${e.store_name} > ${e.user_name}`,e.id=e.order_id,e)))}catch(a){}}))()},accountsGet(){var e=this;return(0,r.Z)((function*(){const t={group_table:"transaction_account_list"};try{let a=yield m().post(`${e.$heap.state.hostname}Admin/GroupManager/listGet`,t);e.itemList=a.map((e=>(e.name=`${e.group_name}`,e.type=e.group_type,e)))}catch(a){}}))()},itemPick(e){u.Fy.dismiss(e)},closeModal(){u.Fy.dismiss()}}},p=a(3744);const _=(0,p.Z)(c,[["render",o]]);var g=_},6783:function(e,t,a){a.d(t,{Z:function(){return k}});var l=a(6252),n=a(3577);const i={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},o={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},r={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},s=["onClick"];function u(e,t,a,u,d,m){const c=(0,l.up)("ion-title"),p=(0,l.up)("ion-text"),_=(0,l.up)("ion-item"),g=(0,l.up)("ion-list"),y=(0,l.up)("ion-icon"),h=(0,l.up)("ion-input"),w=(0,l.up)("ion-accordion"),f=(0,l.up)("ion-chip"),k=(0,l.up)("ion-label"),v=(0,l.up)("ion-accordion-group"),W=(0,l.up)("ion-searchbar"),$=(0,l.up)("ion-skeleton-text"),I=(0,l.up)("ion-infinite-scroll-content"),T=(0,l.up)("ion-infinite-scroll");return(0,l.wg)(),(0,l.iD)("div",null,[(0,l.Wm)(g,null,{default:(0,l.w5)((()=>[(0,l.Wm)(_,null,{default:(0,l.w5)((()=>[(0,l.Wm)(c,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Баланс")])),_:1}),d.balance>0?((0,l.wg)(),(0,l.j4)(p,{key:0,slot:"end",color:"success"},{default:(0,l.w5)((()=>[(0,l.Uk)((0,n.zw)(d.balance)+(0,n.zw)(e.$heap.state.currencySign),1)])),_:1})):((0,l.wg)(),(0,l.j4)(p,{key:1,slot:"end"},{default:(0,l.w5)((()=>[(0,l.Uk)((0,n.zw)(d.balance)+(0,n.zw)(e.$heap.state.currencySign),1)])),_:1}))])),_:1})])),_:1}),(0,l.Wm)(v,{value:d.settingsType},{default:(0,l.w5)((()=>[(0,l.Wm)(w,{value:"period"},{default:(0,l.w5)((()=>[(0,l.Wm)(_,{slot:"header"},{default:(0,l.w5)((()=>[(0,l.Wm)(y,{icon:u.calendarOutline,slot:"start"},null,8,["icon"]),(0,l.Wm)(p,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Период")])),_:1})])),_:1}),(0,l.Wm)(g,{slot:"content"},{default:(0,l.w5)((()=>[(0,l.Wm)(_,null,{default:(0,l.w5)((()=>[(0,l.Wm)(p,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Начальная дата")])),_:1}),(0,l._)("div",i,[(0,l.Wm)(h,{type:"date",modelValue:d.start_at,"onUpdate:modelValue":t[0]||(t[0]=e=>d.start_at=e),onIonChange:t[1]||(t[1]=e=>m.listGet())},null,8,["modelValue"]),d.meta.sum_start?((0,l.wg)(),(0,l.j4)(h,{key:0,type:"text",style:{"text-align":"right"},color:"medium",value:`${d.meta.sum_start}${e.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.kq)("",!0)])])),_:1}),(0,l.Wm)(_,null,{default:(0,l.w5)((()=>[(0,l.Wm)(p,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Обороты")])),_:1}),(0,l._)("div",o,[d.meta.sum_debit?((0,l.wg)(),(0,l.j4)(h,{key:0,type:"text",style:{"text-align":"right"},color:"medium",value:`+${d.meta.sum_debit}${e.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.kq)("",!0),d.meta.sum_credit?((0,l.wg)(),(0,l.j4)(h,{key:1,type:"text",style:{"text-align":"right"},color:"medium",value:`-${d.meta.sum_credit}${e.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.kq)("",!0)])])),_:1}),(0,l.Wm)(_,null,{default:(0,l.w5)((()=>[(0,l.Wm)(p,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Конечная дата")])),_:1}),(0,l._)("div",r,[(0,l.Wm)(h,{type:"date",modelValue:d.finish_at,"onUpdate:modelValue":t[2]||(t[2]=e=>d.finish_at=e),onIonChange:t[3]||(t[3]=e=>m.listGet())},null,8,["modelValue"]),d.meta.sum_finish?((0,l.wg)(),(0,l.j4)(h,{key:0,type:"text",style:{"text-align":"right"},color:"medium",value:`${d.meta.sum_finish}${e.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.kq)("",!0)])])),_:1})])),_:1})])),_:1}),(0,l.Wm)(w,{value:"tags"},{default:(0,l.w5)((()=>[(0,l.Wm)(_,{slot:"header"},{default:(0,l.w5)((()=>[(0,l.Wm)(y,{icon:u.pricetagOutline,slot:"start"},null,8,["icon"]),(0,l.Wm)(p,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Фильтр по тегам")])),_:1})])),_:1}),(0,l.Wm)(g,{slot:"content"},{default:(0,l.w5)((()=>[(0,l.Wm)(_,{lines:"none"},{default:(0,l.w5)((()=>[(0,l.Wm)(p,null,{default:(0,l.w5)((()=>[((0,l.wg)(!0),(0,l.iD)(l.HY,null,(0,l.Ko)(d.tagDict,((e,t)=>((0,l.wg)(),(0,l.j4)(f,{key:t,color:"primary"},{default:(0,l.w5)((()=>[(0,l.Uk)("#"+(0,n.zw)(e)+" ",1),(0,l.Wm)(y,{src:u.closeCircle,onClick:e=>m.itemTagRemove(t)},null,8,["src","onClick"])])),_:2},1024)))),128)),m.is_admin?((0,l.wg)(),(0,l.j4)(f,{key:0,onClick:t[4]||(t[4]=e=>m.itemTagCreate()),color:"medium"},{default:(0,l.w5)((()=>[(0,l.Wm)(y,{src:u.addOutline},null,8,["src"]),(0,l.Wm)(k,null,{default:(0,l.w5)((()=>[(0,l.Uk)("Добавить #тег")])),_:1})])),_:1})):(0,l.kq)("",!0)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["value"]),(0,l.Wm)(W,{modelValue:d.searchQuery,"onUpdate:modelValue":t[5]||(t[5]=e=>d.searchQuery=e),placeholder:"Поиск по сумме или описанию",debounce:"300",onIonInput:t[6]||(t[6]=e=>m.listGet())},null,8,["modelValue"]),null==d.ledger?((0,l.wg)(),(0,l.j4)(g,{key:0},{default:(0,l.w5)((()=>[((0,l.wg)(),(0,l.iD)(l.HY,null,(0,l.Ko)([1,2,3],(e=>(0,l.Wm)(_,{key:e},{default:(0,l.w5)((()=>[(0,l.Wm)(p,{slot:"start"},{default:(0,l.w5)((()=>[(0,l.Wm)($,{animated:"",style:{width:"50px"}})])),_:1}),(0,l.Wm)(k,null,{default:(0,l.w5)((()=>[(0,l.Wm)($,{animated:"",style:{width:"100%"}})])),_:1}),(0,l.Wm)(k,{slot:"end",color:"success"},{default:(0,l.w5)((()=>[(0,l.Wm)($,{animated:"",style:{width:"50px"}})])),_:1})])),_:2},1024))),64))])),_:1})):d.ledger.length>0?((0,l.wg)(),(0,l.j4)(g,{key:1},{default:(0,l.w5)((()=>[((0,l.wg)(!0),(0,l.iD)(l.HY,null,(0,l.Ko)(m.ledgerCalc,(e=>((0,l.wg)(),(0,l.iD)("div",{key:e.trans_id},[(0,l.Wm)(_,{detail:m.is_admin,lines:"none",onClick:t=>m.itemClick(e.trans_id)},{default:(0,l.w5)((()=>[(0,l.Wm)(p,{slot:"start"},{default:(0,l.w5)((()=>[(0,l.Uk)((0,n.zw)(e.date),1)])),_:2},1024),(0,l.Wm)(p,null,{default:(0,l.w5)((()=>[(0,l.Uk)((0,n.zw)(e.trans_description),1)])),_:2},1024),e.amount_sign*e.trans_amount>0?((0,l.wg)(),(0,l.j4)(k,{key:0,slot:"end",color:"success"},{default:(0,l.w5)((()=>[(0,l.Uk)((0,n.zw)(e.trans_amount),1)])),_:2},1024)):e.amount_sign*e.trans_amount<0?((0,l.wg)(),(0,l.j4)(k,{key:1,slot:"end",color:"danger"},{default:(0,l.w5)((()=>[(0,l.Uk)((0,n.zw)(e.trans_amount),1)])),_:2},1024)):((0,l.wg)(),(0,l.j4)(k,{key:2,slot:"end",color:"medium"},{default:(0,l.w5)((()=>[(0,l.Uk)((0,n.zw)(e.trans_amount),1)])),_:2},1024))])),_:2},1032,["detail","onClick"]),(0,l.Wm)(_,null,{default:(0,l.w5)((()=>[(0,l.Wm)(p,null,{default:(0,l.w5)((()=>[((0,l.wg)(!0),(0,l.iD)(l.HY,null,(0,l.Ko)(e.tag_list,((e,t)=>((0,l.wg)(),(0,l.iD)("div",{class:"tag",key:t,onClick:t=>m.itemTagAdd(e)},"#"+(0,n.zw)(e[1]),9,s)))),128))])),_:2},1024)])),_:2},1024)])))),128))])),_:1})):((0,l.wg)(),(0,l.j4)(g,{key:2},{default:(0,l.w5)((()=>[(0,l.Wm)(_,null,{default:(0,l.w5)((()=>[(0,l.Uk)(" Нет операций в данном периоде ")])),_:1})])),_:1})),(0,l.Wm)(T,{onIonInfinite:t[7]||(t[7]=e=>m.listLoadMore(e)),id:"moderation-infinite-scroll"},{default:(0,l.w5)((()=>[(0,l.Wm)(I,{"loading-spinner":"bubbles","loading-text":"Загрузка..."})])),_:1})])}var d=a(8534),m=(a(3948),a(4916),a(3123),a(1632)),c=a(8903),p=a(9755),_=a.n(p),g=a(351),y=a(7208),h={components:{IonIcon:m.gu,IonTitle:m.wd,IonLabel:m.Q$,IonItem:m.Ie,IonInput:m.pK,IonList:m.q_,IonAccordion:m.We,IonAccordionGroup:m.eh,IonText:m.yW,IonSkeletonText:m.CK,IonSearchbar:m.VI,IonChip:m.hM,IonInfiniteScroll:m.ju,IonInfiniteScrollContent:m.MB},props:["permanentTag"],setup(){return{calendarOutline:c.rom,addOutline:c.s6O,closeCircle:c.XZx,pricetagOutline:c.TuG}},data(){console.log(this.query);const e=new Date,t=new Date(Date.parse(`${e.getFullYear()}-${e.getMonth()+1}-1`));return{balance:"-",start_at:t.toISOString().slice(0,10),finish_at:e.toISOString().slice(0,10),searchQuery:"",tagQuery:"",tagDict:null,ledger:null,meta:{},today:e,settingsType:null,can_reload_at:0}},computed:{ledgerCalc(){if(null==this.ledger)return null;let e=[];for(let i of this.ledger){var t,a,l,n;i.date=this.toLocDate(i.trans_date),i.tag_list=null===(t=i.tags)||void 0===t||null===(a=t.substring(1))||void 0===a||null===(l=a.toLowerCase())||void 0===l||null===(n=l.split("|"))||void 0===n?void 0:n.map((e=>e.split("#"))),e.push(i)}return e},is_admin(){return g.Z.isAdmin()}},watch:{query:function(){this.listGet()}},methods:{listLoadMore(e){var t=this;return(0,d.Z)((function*(){yield t.listGet("append"),e.target.complete()}))()},listGet(e){var t=this;return(0,d.Z)((function*(){const a=Date.now();if(e||!(t.can_reload_at>a)){t.can_reload_at=a+1e3;try{var l,n,i;const a=null===(l=Object.keys(null!==(n=t.tagDict)&&void 0!==n?n:{}))||void 0===l?void 0:l.join(" "),u={start_at:t.start_at,finish_at:t.finish_at,tagQuery:`${a} ${null!==(i=t.permanentTag)&&void 0!==i?i:""}`,searchQuery:t.searchQuery,limit:10};var o,r;if("append"==e)u.offset=null!==(o=null===(r=t.ledger)||void 0===r?void 0:r.length)&&void 0!==o?o:0,u.limit=10;const d=yield _().post(`${t.$heap.state.hostname}Transaction/listGet`,u);var s;if("append"==e)null!==(s=t.ledger)&&void 0!==s||(t.ledger=[]),d.ledger=t.ledger.concat(d.ledger);t.ledger=d.ledger,t.meta=d.meta,t.finish_at==t.today.toISOString().slice(0,10)&&(t.balance=d.meta.sum_finish)}catch(m){var u,d;const e=null===m||void 0===m||null===(u=m.responseJSON)||void 0===u||null===(d=u.messages)||void 0===d?void 0:d.error;switch(e){case"large_interval":t.$flash("Период должен быть не больше 3 месяцев");break;default:t.$flash("Ошибка получения выписки");break}return t.ledger=[],t.balance=0,!1}}}))()},toLocDate(e){const t=new Date(Date.parse(e)),a={month:"short",day:"numeric"};return t.toLocaleDateString(void 0,a)},itemClick(e){g.Z.isAdmin()&&this.$go(`/admin/transaction-edit-${e}`)},itemTagPick(e){var t=this;return(0,d.Z)((function*(){var a,l,n,i;const o=yield m.Fy.create({component:y.Z,componentProps:{itemType:e},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});o.present(),t.$topic.on("dismissModal",(()=>{o.dismiss()}));const r=yield o.onDidDismiss();r.data&&(null!==(a=r.data.order_id)&&void 0!==a&&a&&t.itemTagAdd([`order:${r.data.order_id}`,`заказ ${r.data.order_id}`]),null!==(l=r.data.store_id)&&void 0!==l&&l&&t.itemTagAdd([`store:${r.data.store_id}`,`продавец ${r.data.store_name}`]),null!==(n=r.data.courier_id)&&void 0!==n&&n&&t.itemTagAdd([`courier:${r.data.courier_id}`,`курьер ${r.data.courier_name}`]),null!==(i=r.data.type)&&void 0!==i&&i&&t.itemTagAdd([`acc::${r.data.type}`,`счет ${r.data.name}`]))}))()},itemTagCreate(){var e=this;return(0,d.Z)((function*(){const t=yield m.BO.create({header:"Тип тега",buttons:[{text:"Заказ",role:"destructive",data:"order"},{text:"Продавец",role:"destructive",data:"store"},{text:"Курьер",role:"destructive",data:"courier"},{text:"Счет",role:"destructive",data:"acc"}]});yield t.present();const a=yield t.onDidDismiss();null!==a&&void 0!==a&&a.data&&e.itemTagPick(null===a||void 0===a?void 0:a.data)}))()},itemTagAdd(e){var t;let a=null!==(t=this.tagDict)&&void 0!==t?t:{};a[e[0]]=e[1],this.tagDict=a,this.listGet(),this.settingsType="tags"},itemTagRemove(e){var t;let a=null!==(t=this.tagDict)&&void 0!==t?t:{};a[e]&&delete a[e];const l=Object.keys(a).length;this.tagDict=l?a:null,this.listGet(),this.settingsType="tags"}},mounted(){this.listGet()}},w=a(3744);const f=(0,w.Z)(h,[["render",u]]);var k=f}}]);
//# sourceMappingURL=783-legacy.f45a8e28.js.map