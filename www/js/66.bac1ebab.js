"use strict";(self["webpackChunktezkel"]=self["webpackChunktezkel"]||[]).push([[66],{4405:function(e,t,o){var i=o(2008);const n={deliveryCalculate(e){if(!e.locations||!e.locations[0]||!e.locations[0].distance)return null;const t=e.locations[0].distance,o=e.store_time_preparation||0;return n.deliveryTimeCalculate(t,o)},deliveryTimeCalculate(e,t){var o;t=parseInt(null!==(o=t)&&void 0!==o?o:i.Z.getters.settings.delivery.timePreparationDefault);const n=parseInt(i.Z.getters.settings.delivery.timeDelta),r=parseInt(i.Z.getters.settings.delivery.speed),a=5*Math.round(e/r*60/5)+t,s=a>n?a-n:a,l=s+n;return{time:a,timeMin:s,timeMax:l}}};t["Z"]=n},7327:function(e,t,o){o.d(t,{Z:function(){return m}});var i=o(6252),n=o(3577);const r=(0,i.Uk)("Просмотр фотографии");function a(e,t,o,a,s,l){const d=(0,i.up)("ion-title"),c=(0,i.up)("ion-icon"),u=(0,i.up)("ion-toolbar"),m=(0,i.up)("ion-header"),p=(0,i.up)("ion-button"),_=(0,i.up)("ion-col"),h=(0,i.up)("ion-row"),g=(0,i.up)("ion-grid"),f=(0,i.up)("ion-img"),w=(0,i.up)("ion-content");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i.Wm)(m,null,{default:(0,i.w5)((()=>[(0,i.Wm)(u,{color:"secondary"},{default:(0,i.w5)((()=>[(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[r])),_:1}),(0,i.Wm)(c,{icon:a.closeOutline,onClick:t[0]||(t[0]=e=>{a.closeModal()}),slot:"end",size:"large"},null,8,["icon"])])),_:1})])),_:1}),(0,i.Wm)(w,null,{default:(0,i.w5)((()=>[o.actions?((0,i.wg)(),(0,i.j4)(g,{key:0},{default:(0,i.w5)((()=>[(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(o.actions,((e,t)=>((0,i.wg)(),(0,i.j4)(_,{key:t},{default:(0,i.w5)((()=>{var o;return[e[0]?((0,i.wg)(),(0,i.j4)(p,{key:0,onClick:o=>l.actionCreate(t,e[1]),expand:"block",color:null!==(o=e[1])&&void 0!==o?o:"primary"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,n.zw)(e[0]),1)])),_:2},1032,["onClick","color"])):(0,i.kq)("",!0)]})),_:2},1024)))),128))])),_:1})])),_:1})):(0,i.kq)("",!0),(0,i.Wm)(f,{src:e.$heap.state.hostname+"image/get.php/"+o.image_hash+".1000.1000.webp"},null,8,["src"])])),_:1})],64)}var s=o(8903),l=o(3741),d={props:["image_hash","actions"],components:{IonIcon:l.gu,IonToolbar:l.sr,IonHeader:l.Gu,IonImg:l.Xz,IonContent:l.W2,IonTitle:l.wd,IonButton:l.YG,IonCol:l.wI,IonRow:l.Nd,IonGrid:l.jY},setup(){const e=function(){l.Fy.dismiss()};return{closeModal:e,closeOutline:s.fID}},methods:{actionCreate(e,t){("danger"!=t||confirm("Вы уверены?"))&&l.Fy.dismiss(null,e)}}},c=o(3744);const u=(0,c.Z)(d,[["render",a]]);var m=u},6076:function(e,t,o){o.d(t,{Z:function(){return b}});var i=o(6252),n=o(3577);const r=(0,i.Uk)("Фотографии"),a={key:0,class:"image_grid"},s=["onClick"],l={key:0},d={key:1},c={key:0,class:"image_controls"},u=["id"];function m(e,t,o,m,p,_){var h;const g=(0,i.up)("ion-label"),f=(0,i.up)("ion-icon"),w=(0,i.up)("ion-item"),k=(0,i.up)("ion-img"),y=(0,i.up)("ion-avatar");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i._)("div",null,[(0,i.Wm)(w,{lines:"none",onClick:t[0]||(t[0]=e=>{p.editMode=!p.editMode,p.editMode&&_.load()})},{default:(0,i.w5)((()=>[(0,i.Wm)(g,{color:"imageList?.length?'':medium"},{default:(0,i.w5)((()=>[r])),_:1}),p.editMode?((0,i.wg)(),(0,i.j4)(f,{key:0,slot:"end",icon:m.settingsSharp,color:"primary"},null,8,["icon"])):((0,i.wg)(),(0,i.j4)(f,{key:1,slot:"end",icon:m.settingsOutline},null,8,["icon"]))])),_:1}),null!==(h=_.imageList)&&void 0!==h&&h.length?((0,i.wg)(),(0,i.iD)("div",a,[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(_.imageList,(t=>((0,i.wg)(),(0,i.iD)("div",{key:t.image_id,style:{position:"relative"}},[(0,i._)("div",{style:{position:"absolute",top:"0px","background-color":"#fffc","font-size":"0.75em"},onClick:e=>_.imagePreview(t.image_hash)},[t.deleted_at?((0,i.wg)(),(0,i.iD)("div",l,"будет удалено")):1==t.is_disabled?((0,i.wg)(),(0,i.iD)("div",d,"на модерации")):(0,i.kq)("",!0)],8,s),(0,i.Wm)(y,{onClick:e=>_.imagePreview(t.image_hash),class:(0,n.C_)(t.class)},{default:(0,i.w5)((()=>[(0,i.Wm)(k,{src:e.$heap.state.hostname+"image/get.php/"+t.image_hash+".100.100.webp"},null,8,["src"])])),_:2},1032,["onClick","class"]),p.editMode?((0,i.wg)(),(0,i.iD)("div",c,[(0,i.Wm)(f,{icon:m.chevronBackCircleOutline,onClick:e=>_.back(t)},null,8,["icon","onClick"]),_.isAdmin&&1==t.is_disabled?((0,i.wg)(),(0,i.j4)(f,{key:0,icon:m.checkmarkCircle,color:"success",onClick:e=>_.enable(t)},null,8,["icon","onClick"])):(0,i.kq)("",!0),t.deleted_at?((0,i.wg)(),(0,i.j4)(f,{key:1,icon:m.addCircle,color:"success",onClick:e=>_.restore(t)},null,8,["icon","onClick"])):((0,i.wg)(),(0,i.j4)(f,{key:2,icon:m.trash,color:"danger",onClick:e=>_.remove(t)},null,8,["icon","onClick"])),(0,i.Wm)(f,{icon:m.chevronForwardCircleOutline,onClick:e=>_.forward(t)},null,8,["icon","onClick"])])):(0,i.kq)("",!0)])))),128))])):(0,i.kq)("",!0)]),(0,i._)("input",{type:"file",id:p.fileUploaderId,accept:".png, .jpg, .jpeg, .webp, .gif",onChange:t[1]||(t[1]=e=>_.uploadImage(e)),style:{display:"none"}},null,40,u)],64)}var p=o(8903),_=o(3741),h=o(7327),g=o(9755),f=o.n(g),w=o(9042),k=o(351),y={props:["images","image_holder_id","controller"],components:{IonLabel:_.Q$,IonIcon:_.gu,IonItem:_.Ie,IonImg:_.Xz,IonAvatar:_.BJ},setup(){return{settingsOutline:p.C$N,settingsSharp:p.kiF,chevronBackCircleOutline:p.CK0,chevronForwardCircleOutline:p.esm,trash:p._Ij,addCircle:p.ZWo,checkmarkCircle:p.I1A}},data(){return{images_loaded:null,editMode:!1,fileUploaderId:this.controller+this.image_holder_id}},computed:{imageList(){let e=this.images_loaded||this.images,t=[];for(let o in e)e[o].deleted_at?(e[o].class=" deleted",this.editMode&&t.push(e[o])):1==e[o].is_disabled?(e[o].class=" disabled",this.editMode&&t.push(e[o])):t.push(e[o]);return t},isAdmin(){return k.Z.isAdmin()}},methods:{async back(e){try{await f().post(this.$heap.state.hostname+"Image/itemUpdateOrder",{image_id:e.image_id,dir:"up"}),this.load()}catch(t){}},async forward(e){try{await f().post(this.$heap.state.hostname+"Image/itemUpdateOrder",{image_id:e.image_id,dir:"down"}),this.load()}catch(t){}},async remove(e){try{await f().post(this.$heap.state.hostname+"Image/itemDelete",{image_id:e.image_id}),this.load(),this.$flash("Фото перемещено в корзину и будет удалено")}catch(t){}},async restore(e){try{await f().post(this.$heap.state.hostname+"Image/itemUnDelete",{image_id:e.image_id}),this.load(),this.$flash("Фото перемещено извлечено из корзины")}catch(t){}},async enable(e){try{await f().post(this.$heap.state.hostname+"Image/itemDisable",{image_id:e.image_id,is_disabled:0}),this.load()}catch(t){}},async load(){const e={image_holder_id:this.image_holder_id,image_holder:this.controller,is_disabled:1,is_deleted:1,is_active:1};this.images_loaded=await f().post(this.$heap.state.hostname+"Image/listGet",e)},async imagePreview(e){const t=await _.Fy.create({component:h.Z,componentProps:{image_hash:e},initialBreakpoint:.5,breakpoints:[.5,1]}),o=function(){t.dismiss()};return w.Z.on("dismissModal",o),t.present()},async uploadImage(e){let t=new FormData;t.append("files[]",e.target.files[0]),t.set("image_holder_id",this.image_holder_id);const o={url:this.$heap.state.hostname+this.controller+"/fileUpload",type:"POST",data:t,processData:!1,contentType:!1};try{await f().ajax(o),this.load()}catch(s){var i,n,r,a;if("limit_exeeded"==(null===s||void 0===s||null===(i=s.responseJSON)||void 0===i||null===(n=i.messages)||void 0===n?void 0:n.error))return void this.$flash("Уже загружено максимальное количество фото");if("no_valid_images"==(null===s||void 0===s||null===(r=s.responseJSON)||void 0===r||null===(a=r.messages)||void 0===a?void 0:a.error))return void this.$flash("Формат файла не поддерживается");this.$flash("Не удалось загрузить фото")}},take_photo(){f()(`#${this.fileUploaderId}`).trigger("click"),this.editMode=!0}}},v=o(3744);const I=(0,v.Z)(y,[["render",m],["__scopeId","data-v-49da551a"]]);var b=I},132:function(e,t,o){o.d(t,{Z:function(){return h}});var i=o(6252);const n=(0,i.Uk)("Фискальный чек"),r=["src"],a={key:0,style:{position:"fixed",top:"200px",left:"calc( 50% - 50px )"}},s=["src"];function l(e,t,o,l,d,c){const u=(0,i.up)("ion-icon"),m=(0,i.up)("ion-title"),p=(0,i.up)("ion-toolbar"),_=(0,i.up)("ion-header"),h=(0,i.up)("ion-content");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Wm)(p,{color:"secondary"},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{icon:l.receiptOutline,slot:"start"},null,8,["icon"]),(0,i.Wm)(m,{slot:"start"},{default:(0,i.w5)((()=>[n])),_:1}),(0,i.Wm)(u,{icon:l.closeOutline,onClick:t[0]||(t[0]=e=>{l.closeModal()}),slot:"end",size:"large"},null,8,["icon"])])),_:1})])),_:1})])),_:1}),(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[(0,i._)("iframe",{src:o.billLink,style:{width:"100%",height:"85%",border:"none"},onLoad:t[1]||(t[1]=e=>c.onLoad())},null,40,r),d.loadAnimation?((0,i.wg)(),(0,i.iD)("div",a,[(0,i._)("img",{src:l.loading},null,8,s)])):(0,i.kq)("",!0)])),_:1})],64)}var d=o(3741),c=o(659),u=o(8903),m={components:{IonTitle:d.wd,IonIcon:d.gu,IonToolbar:d.sr,IonHeader:d.Gu,IonContent:d.W2},props:["billLink"],setup(){const e=function(){d.Fy.dismiss()};return{closeModal:e,closeOutline:u.fID,receiptOutline:u.d71,loading:c}},data(){return{loadAnimation:1}},methods:{onLoad(){this.loadAnimation=0}}},p=o(3744);const _=(0,p.Z)(m,[["render",l]]);var h=_},826:function(e,t,o){o.d(t,{Z:function(){return m}});var i=o(6252);const n=(0,i.Uk)(" Чтобы вовремя узнавать об изменениях статусов заказов, подпишитесь на уведомления "),r=(0,i.Uk)("Подписаться");function a(e,t,o,a,s,l){const d=(0,i.up)("ion-button"),c=(0,i.up)("ion-card-content"),u=(0,i.up)("ion-card");return"default"!=s.permission||s.wasRejected?(0,i.kq)("",!0):((0,i.wg)(),(0,i.j4)(u,{key:0,color:"light"},{default:(0,i.w5)((()=>[(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[n,(0,i._)("p",null,[(0,i.Wm)(d,{onClick:t[0]||(t[0]=e=>l.subscribe()),expand:"block"},{default:(0,i.w5)((()=>[r])),_:1})])])),_:1})])),_:1}))}var s=o(351),l=o(3741),d={components:{IonButton:l.YG,IonCard:l.PM,IonCardContent:l.FN},data(){let e="Notification"in window?Notification.permission:"notsupported";return{permission:e,wasRejected:0}},methods:{async subscribe(){if("Notification"in window)try{this.permission=await Notification.requestPermission(),"granted"==this.permission&&s.Z.firebase.saveNotificationToken()}catch(e){this.$flash("Вы не разрешили уведомлять вас")}else this.$flash("Ваше устройство не поддерживает уведомления")},reject(){localStorage.pushNotificationsWasRejected=this.wasRejected=1}}},c=o(3744);const u=(0,c.Z)(d,[["render",a]]);var m=u},1066:function(e,t,o){o.r(t),o.d(t,{default:function(){return re}});var i=o(6252);const n={key:0,style:{display:"flex","align-items":"center","justify-content":"center",height:"100%"}},r={style:{width:"max-content","text-align":"center"}},a=(0,i.Uk)("Заказ не найден"),s=(0,i._)("br",null,null,-1),l=(0,i._)("a",{href:"/order/order-list"},"список заказов",-1),d=(0,i.Uk)("Отказ клиента"),c=(0,i.Uk)("Заказ не готов/не соответствует"),u=(0,i.Uk)("Поломка в пути"),m=(0,i.Uk)("Заказ испорчен");function p(e,t,o,p,_,h){const g=(0,i.up)("ion-icon"),f=(0,i.up)("ion-label"),w=(0,i.up)("order-comp"),k=(0,i.up)("order-tracking-comp"),y=(0,i.up)("image-tile-comp"),v=(0,i.up)("order-history-comp"),I=(0,i.up)("msg-subscription-comp"),b=(0,i.up)("order-meta-comp"),W=(0,i.up)("ion-item"),C=(0,i.up)("ion-list"),D=(0,i.up)("ion-content"),j=(0,i.up)("ion-popover"),$=(0,i.up)("base-layout");return(0,i.wg)(),(0,i.j4)($,{pageTitle:`Заказ #${_.order_id}`,pageDefaultBackLink:"/order/order-list"},{default:(0,i.w5)((()=>{var e,o,$;return["notfound"==_.order?((0,i.wg)(),(0,i.iD)("div",n,[(0,i._)("div",r,[(0,i.Wm)(g,{icon:p.sparklesOutline,size:"large"},null,8,["icon"]),(0,i.Wm)(f,null,{default:(0,i.w5)((()=>[a])),_:1}),s,l])])):(0,i.kq)("",!0),(0,i.Wm)(w,{orderData:_.order,onStageCreate:h.onStageCreate},null,8,["orderData","onStageCreate"]),(0,i.Wm)(k,{orderData:_.order},null,8,["orderData"]),_.order?((0,i.wg)(),(0,i.j4)(y,{key:1,images:null===(e=_.order)||void 0===e?void 0:e.images,image_holder_id:null===(o=_.order)||void 0===o?void 0:o.order_id,controller:"Order",ref:"orderImgs"},null,8,["images","image_holder_id"])):(0,i.kq)("",!0),(0,i.Wm)(v,{orderData:_.order},null,8,["orderData"]),(0,i.Wm)(I),"system_finish"==(null===($=_.order)||void 0===$?void 0:$.stage_current)?((0,i.wg)(),(0,i.j4)(b,{key:2,orderId:_.order_id},null,8,["orderId"])):(0,i.kq)("",!0),(0,i.Wm)(j,{"is-open":_.isOpenDeliveryRejectionPopover,onDidDismiss:t[4]||(t[4]=e=>_.isOpenDeliveryRejectionPopover=!1)},{default:(0,i.w5)((()=>[(0,i.Wm)(D,null,{default:(0,i.w5)((()=>[(0,i.Wm)(C,null,{default:(0,i.w5)((()=>[(0,i.Wm)(W,{button:!0,detail:!1,onClick:t[0]||(t[0]=e=>h.action_rejected_reason("ОТКАЗ КУРЬЕРА: Отказ клиента"))},{default:(0,i.w5)((()=>[(0,i.Wm)(f,null,{default:(0,i.w5)((()=>[d])),_:1})])),_:1}),(0,i.Wm)(W,{button:!0,detail:!1,onClick:t[1]||(t[1]=e=>h.action_rejected_reason("ОТКАЗ КУРЬЕРА: Заказ не готов/не соответствует"))},{default:(0,i.w5)((()=>[(0,i.Wm)(f,null,{default:(0,i.w5)((()=>[c])),_:1})])),_:1}),(0,i.Wm)(W,{button:!0,detail:!1,onClick:t[2]||(t[2]=e=>h.action_rejected_reason("ОТКАЗ КУРЬЕРА: Поломка в пути"))},{default:(0,i.w5)((()=>[(0,i.Wm)(f,null,{default:(0,i.w5)((()=>[u])),_:1})])),_:1}),(0,i.Wm)(W,{button:!0,detail:!1,onClick:t[3]||(t[3]=e=>h.action_rejected_reason("ОТКАЗ КУРЬЕРА: Заказ испорчен"))},{default:(0,i.w5)((()=>[(0,i.Wm)(f,null,{default:(0,i.w5)((()=>[m])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["is-open"])]})),_:1},8,["pageTitle"])}o(6699),o(4916),o(3948);var _=o(8903),h=o(3741),g=o(7782),f=o(2630),w=o(3577);const k=(0,i.Uk)("История заказа");function y(e,t,o,n,r,a){var s;const l=(0,i.up)("ion-label"),d=(0,i.up)("ion-item"),c=(0,i.up)("ion-icon"),u=(0,i.up)("ion-text"),m=(0,i.up)("ion-note"),p=(0,i.up)("ion-list"),_=(0,i.up)("ion-accordion"),h=(0,i.up)("ion-accordion-group");return null!==(s=o.orderData)&&void 0!==s&&s.stages?((0,i.wg)(),(0,i.j4)(h,{key:0},{default:(0,i.w5)((()=>[(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Wm)(d,{slot:"header"},{default:(0,i.w5)((()=>[(0,i.Wm)(l,null,{default:(0,i.w5)((()=>[k])),_:1})])),_:1}),(0,i.Wm)(p,{slot:"content"},{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(o.orderData.stages,(e=>((0,i.wg)(),(0,i.j4)(d,{key:e.group_id},{default:(0,i.w5)((()=>[(0,i.Wm)(c,{slot:"start",icon:n.checkmarkOutline,size:"small",color:"success"},null,8,["icon"]),(0,i.Wm)(u,null,{default:(0,i.w5)((()=>[(0,i.Uk)((0,w.zw)(e.group_name),1)])),_:2},1024),(0,i.Wm)(m,{slot:"end",style:{width:"80px"}},{default:(0,i.w5)((()=>[(0,i.Uk)((0,w.zw)(e.created_at),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1})):(0,i.kq)("",!0)}var v={props:["orderData"],components:{IonIcon:h.gu,IonText:h.yW,IonLabel:h.Q$,IonItem:h.Ie,IonList:h.q_,IonNote:h.uN,IonAccordion:h.We,IonAccordionGroup:h.eh},setup(){return{checkmarkOutline:_.TjA}}},I=o(3744);const b=(0,I.Z)(v,[["render",y]]);var W=b;const C=(0,i.Uk)("Дополнительно"),D={slot:"content",class:"ion-padding"},j={key:0},$={key:1},O={key:2};function U(e,t,o,n,r,a){const s=(0,i.up)("ion-label"),l=(0,i.up)("ion-item"),d=(0,i.up)("ion-icon"),c=(0,i.up)("ion-text"),u=(0,i.up)("ion-chip"),m=(0,i.up)("ion-button"),p=(0,i.up)("ion-list"),_=(0,i.up)("ion-accordion"),h=(0,i.up)("ion-accordion-group");return(0,i.wg)(),(0,i.j4)(h,null,{default:(0,i.w5)((()=>[(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Wm)(l,{slot:"header",onClick:t[0]||(t[0]=e=>a.itemMetaGet())},{default:(0,i.w5)((()=>[(0,i.Wm)(s,null,{default:(0,i.w5)((()=>[C])),_:1})])),_:1}),(0,i._)("div",D,[r.meta.payment_card_fixate_sum>0?((0,i.wg)(),(0,i.j4)(u,{key:0},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{src:n.cardOutline},null,8,["src"]),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Блок "+(0,w.zw)(r.meta.payment_card_fixate_sum)+(0,w.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1})):(0,i.kq)("",!0),r.meta.payment_card_refund_sum>0?((0,i.wg)(),(0,i.j4)(u,{key:1},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{src:n.cardOutline},null,8,["src"]),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Разблокировано "+(0,w.zw)(r.meta.payment_card_refund_sum)+(0,w.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1})):(0,i.kq)("",!0),r.meta.payment_card_confirm_sum>0?((0,i.wg)(),(0,i.j4)(u,{key:2},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{src:n.cardOutline},null,8,["src"]),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Оплачено "+(0,w.zw)(r.meta.payment_card_confirm_sum)+(0,w.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1})):(0,i.kq)("",!0),r.meta.delivery_by_courier||r.meta.delivery_by_store||r.meta.pickup_by_customer?((0,i.wg)(),(0,i.j4)(u,{key:3},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{src:n.rocketOutline},null,8,["src"]),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[r.meta.delivery_by_courier?((0,i.wg)(),(0,i.iD)("span",j,"Курьер")):(0,i.kq)("",!0),r.meta.delivery_by_store?((0,i.wg)(),(0,i.iD)("span",$,"Продавец")):(0,i.kq)("",!0),r.meta.pickup_by_customer?((0,i.wg)(),(0,i.iD)("span",O,"Самовывоз")):(0,i.kq)("",!0)])),_:1})])),_:1})):(0,i.kq)("",!0),r.meta.invoice_link?((0,i.wg)(),(0,i.j4)(m,{key:4,color:"light",onClick:t[1]||(t[1]=e=>a.billOpen(r.meta.invoice_link)),expand:"block"},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{src:n.receiptOutline,slot:"start"},null,8,["src"]),(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Uk)("Открыть чек на "+(0,w.zw)(r.meta.invoice_sum)+(0,w.zw)(e.$heap.state.currencySign),1)])),_:1})])),_:1})):(0,i.kq)("",!0),a.ledgerCalc.length>0?((0,i.wg)(),(0,i.j4)(p,{key:5},{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(a.ledgerCalc,(e=>((0,i.wg)(),(0,i.j4)(l,{key:e.trans_id},{default:(0,i.w5)((()=>[(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Uk)((0,w.zw)(e.trans_description),1)])),_:2},1024),(0,i.Wm)(c,{slot:"end"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,w.zw)(e.trans_amount),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(0,i.kq)("",!0)])])),_:1})])),_:1})}var x=o(132),G=o(9755),q=o.n(G),L={props:["orderId"],components:{IonIcon:h.gu,IonText:h.yW,IonLabel:h.Q$,IonButton:h.YG,IonItem:h.Ie,IonList:h.q_,IonAccordion:h.We,IonAccordionGroup:h.eh,IonChip:h.hM},setup(){return{cardOutline:_.pvm,rocketOutline:_.G$D,receiptOutline:_.d71}},data(){return{meta:{}}},computed:{ledgerCalc(){if(!this.meta.transactions)return[];let e=[];for(let t of this.meta.transactions)t.date=this.toLocDate(t.trans_date),e.push(t);return e}},methods:{async itemMetaGet(){try{this.meta=await q().post(`${this.$heap.state.hostname}Order/itemMetaGet`,{order_id:this.orderId})}catch(o){var e,t;const i=null===o||void 0===o||null===(e=o.responseJSON)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.error;switch(i){case"forbidden":case"notfound":default:this.meta={}}return!1}},toLocDate(e){const t=new Date(Date.parse(e)),o={month:"short",day:"numeric"};return t.toLocaleDateString(void 0,o)},async billOpen(e){if(!e)return void this.$flash("Невозможно открыть чек");const t=await h.Fy.create({component:x.Z,componentProps:{billLink:e},initialBreakpoint:.85,breakpoints:[0,.85,1]}),o=function(){t.dismiss()};return this.$topic.on("dismissModal",o),t.present()}}};const Z=(0,I.Z)(L,[["render",U]]);var z=Z;const M=(0,i.Uk)("Отслеживание заказа");function S(e,t,o,n,r,a){const s=(0,i.up)("ion-label"),l=(0,i.up)("ion-item"),d=(0,i.up)("ion-icon"),c=(0,i.up)("ion-chip"),u=(0,i.up)("ion-progress-bar"),m=(0,i.up)("ion-list"),p=(0,i.up)("ion-accordion"),_=(0,i.up)("ion-accordion-group");return a.isDelivering()?((0,i.wg)(),(0,i.j4)(_,{key:0,value:"tracking",color:"primary"},{default:(0,i.w5)((()=>[(0,i.Wm)(p,{value:"tracking"},{default:(0,i.w5)((()=>[(0,i.Wm)(l,{slot:"header"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,null,{default:(0,i.w5)((()=>[M])),_:1})])),_:1}),(0,i.Wm)(m,{slot:"content"},{default:(0,i.w5)((()=>[(0,i.Wm)(l,{lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{color:"primary",slot:"start",icon:n.locationOutline,style:{"font-size":"30px"}},null,8,["icon"]),(0,i.Wm)(s,null,{default:(0,i.w5)((()=>{var e;return[(0,i.Uk)("Курьер, "+(0,w.zw)(null===(e=r.job)||void 0===e?void 0:e.courier_name),1)]})),_:1})])),_:1}),a.courier_finish_distance_km?((0,i.wg)(),(0,i.j4)(l,{key:0,lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(c,{slot:"start",color:"success"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,w.zw)(a.courier_finish_distance_km),1)])),_:1}),(0,i.Wm)(c,{slot:"end",color:"primary"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,w.zw)(a.courier_finish_time_min.timeMin)+"-"+(0,w.zw)(a.courier_finish_time_min.timeMax)+"мин ",1)])),_:1})])),_:1})):(0,i.kq)("",!0),a.courier_finish_distance_km?((0,i.wg)(),(0,i.j4)(l,{key:1,lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{color:"secondary",value:a.courier_progress,reversed:"true"},null,8,["value"])])),_:1})):(0,i.kq)("",!0),(0,i.Wm)(l,{lines:"none"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,{style:{"text-align":"right"}},{default:(0,i.w5)((()=>[(0,i.Uk)("Клиент, "+(0,w.zw)(e.$heap.state.user.user_name),1)])),_:1}),(0,i.Wm)(d,{color:"primary",slot:"end",icon:n.flagOutline,style:{"font-size":"30px"}},null,8,["icon"])])),_:1})])),_:1})])),_:1})])),_:1})):(0,i.kq)("",!0)}var T=o(4405),P={props:["orderData"],components:{IonList:h.q_,IonChip:h.hM,IonItem:h.Ie,IonLabel:h.Q$,IonIcon:h.gu,IonAccordionGroup:h.eh,IonAccordion:h.We,IonProgressBar:h.X7},setup(){return{storefrontOutline:_.qRG,locationOutline:_.Iv7,flagOutline:_.FMn}},data(){return{job:null,refreshInterval:6e4,clock:null}},computed:{courier_finish_distance_km(){var e,t;return null!==(e=this.job)&&void 0!==e&&e.courier_finish_distance?Math.round((null===(t=this.job)||void 0===t?void 0:t.courier_finish_distance)/100)/10+"км":"-"},courier_finish_time_min(){var e;return T.Z.deliveryTimeCalculate(null===(e=this.job)||void 0===e?void 0:e.courier_finish_distance,0)},courier_progress(){var e,t;return(null===(e=this.job)||void 0===e?void 0:e.courier_finish_distance)/(null===(t=this.job)||void 0===t?void 0:t.start_finish_distance)}},methods:{async jobGet(){if(this.isDelivering())try{if(this.job=await g.Z.api.itemJobTrack(this.orderData.order_id),"delivery_start"==this.job.group_type){clearTimeout(this.clock);const e=this;this.clock=setTimeout((()=>{e.jobGet()}),this.refreshInterval)}}catch(o){var e,t;const i=null===(e=o.responseJSON)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.error;if("notfound"==i)return void this.$flash("Задание не найдено");if("notready"==i)return void this.$flash("Смена курьера не открыта")}},isDelivering(){var e;return"delivery_start"==(null===(e=this.orderData)||void 0===e?void 0:e.stage_current)}},watch:{orderData:function(){this.jobGet()}}};const F=(0,I.Z)(P,[["render",S],["__scopeId","data-v-3b3e367b"]]);var N=F;const A=(0,i.Uk)("Возражение"),H=(0,i.Uk)("Сохранить возражение"),Y=(0,i.Uk)("Закрыть без возражения");function B(e,t,o,n,r,a){const s=(0,i.up)("ion-title"),l=(0,i.up)("ion-toolbar"),d=(0,i.up)("ion-header"),c=(0,i.up)("ion-label"),u=(0,i.up)("ion-textarea"),m=(0,i.up)("ion-item"),p=(0,i.up)("ion-list"),_=(0,i.up)("ion-button"),h=(0,i.up)("ion-content");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[(0,i.Wm)(l,{color:"secondary"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,null,{default:(0,i.w5)((()=>[A])),_:1})])),_:1})])),_:1}),(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[(0,i.Wm)(p,null,{default:(0,i.w5)((()=>[(0,i.Wm)(m,null,{default:(0,i.w5)((()=>[(0,i.Wm)(c,{position:"stacked"}),(0,i.Wm)(u,{rows:"6",modelValue:r.objection_text,"onUpdate:modelValue":t[0]||(t[0]=e=>r.objection_text=e),placeholder:"опишите суть возражения к исполнению заказа (минимум 10 букв)"},null,8,["modelValue"])])),_:1})])),_:1}),(0,i.Wm)(_,{onClick:t[1]||(t[1]=e=>a.save()),color:"primary",disabled:!r.objection_text||r.objection_text.length<10,expand:"full"},{default:(0,i.w5)((()=>[H])),_:1},8,["disabled"]),(0,i.Wm)(_,{onClick:t[2]||(t[2]=e=>a.close()),color:"light",expand:"full"},{default:(0,i.w5)((()=>[Y])),_:1})])),_:1})],64)}var R={components:{IonTextarea:h.g2,IonButton:h.YG,IonHeader:h.Gu,IonToolbar:h.sr,IonTitle:h.wd,IonContent:h.W2,IonList:h.q_,IonItem:h.Ie,IonLabel:h.Q$},data(){return{objection_text:null}},methods:{close(){h.Fy.dismiss()},save(){h.Fy.dismiss(this.objection_text)}}};const J=(0,I.Z)(R,[["render",B]]);var Q=J;const K=(0,i.Uk)("Добавить товар");function V(e,t,o,n,r,a){const s=(0,i.up)("ion-title"),l=(0,i.up)("ion-toolbar"),d=(0,i.up)("ion-header"),c=(0,i.up)("ion-searchbar"),u=(0,i.up)("ion-img"),m=(0,i.up)("ion-label"),p=(0,i.up)("ion-item"),_=(0,i.up)("ion-list"),h=(0,i.up)("ion-content");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i.Wm)(d,null,{default:(0,i.w5)((()=>[(0,i.Wm)(l,{color:"secondary"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,null,{default:(0,i.w5)((()=>[K])),_:1})])),_:1})])),_:1}),(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[(0,i.Wm)(c,{onInput:t[0]||(t[0]=e=>a.listGet({name_query:e.target.value,name_query_fields:"product_name,product_code"})),style:{"border-radius":"10px",color:"black"},placeholder:"Поиск в этом предприятии"}),(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(r.productList,(t=>((0,i.wg)(),(0,i.j4)(p,{key:t.product_id,onClick:e=>a.itemCreate(t.product_id)},{default:(0,i.w5)((()=>[(0,i.Wm)(u,{slot:"start",src:e.$heap.state.hostname+"image/get.php/"+t.image_hash+".50.50.webp"},null,8,["src"]),(0,i.Wm)(m,null,{default:(0,i.w5)((()=>[(0,i.Uk)((0,w.zw)(t.product_name),1)])),_:2},1024),(0,i.Wm)(m,{slot:"end",color:"primary"},{default:(0,i.w5)((()=>[(0,i.Uk)((0,w.zw)(t.product_final_price)+(0,w.zw)(e.$heap.state.currencySign),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})],64)}var X={components:{IonHeader:h.Gu,IonToolbar:h.sr,IonTitle:h.wd,IonContent:h.W2,IonSearchbar:h.VI,IonList:h.q_,IonItem:h.Ie,IonLabel:h.Q$,IonImg:h.Xz},props:["store_id","order_id"],data(){return{productList:[]}},mounted(){this.listGet()},methods:{async listGet(e={}){e.store_id=this.store_id,e.is_active=1,e.limit=5;let t={};try{t=await q().post(`${this.$heap.state.hostname}Product/listGet`,e)}catch(o){}this.productList=t.product_list},async itemCreate(e){let t={order_id:this.order_id,product_id:e,product_quantity:prompt("Введите количество",1)||1};try{await q().post(`${this.$heap.state.hostname}Entry/itemCreate`,t)}catch(o){this.$flash("Не удалось добавить товар")}h.Fy.dismiss()}}};const E=(0,I.Z)(X,[["render",V]]);var ee=E,te=o(6076),oe=o(826),ie={components:{OrderComp:f.Z,OrderHistoryComp:W,OrderMetaComp:z,OrderTrackingComp:N,MsgSubscriptionComp:oe.Z,ImageTileComp:te.Z,IonLabel:h.Q$,IonIcon:h.gu,IonContent:h.W2,IonItem:h.Ie,IonList:h.q_,IonPopover:h.d8},setup(){return{sparklesOutline:_.Fcs}},data(){return{order_id:this.$route.params.id,order:null,orderIsLoading:!1,isOpenDeliveryRejectionPopover:!1}},methods:{async itemGet(){if(!this.orderIsLoading){try{this.orderIsLoading=!0,this.order=await g.Z.api.itemGet(this.order_id),this.itemDetailsGet()}catch(e){switch(e.status){case 404:this.$flash("Заказ не найден"),this.order="notfound",this.$router.push("/order/order-list");break}}this.orderIsLoading=!1}},itemDetailsGet(){"supplier_corrected"==this.order.stage_current&&this.itemDetailsPrepaymentGet()},async itemDetailsPrepaymentGet(){try{const e=await q().post(this.$heap.state.hostname+"Order/itemDetailsPrepaymentGet",{order_id:this.order_id});this.order.order_sum_prepayed=e.order_sum_prepayed}catch(e){}},async onStageCreate(e,t){if(t.includes("action")){t=t.split("_").splice(1).join("_");try{this[t](e)}catch(o){console.log("stage handler not found"+t)}}else try{const o=await g.Z.api.itemStageCreate(e,t);if("ok"==o){if("customer_purged"==t)return this.$flash("Заказ удален"),this.order=null,this.$router.push("/order/order-list"),void g.Z.cart.itemDelete(e);if(await this.itemGet(),"customer_cart"==t){let e={order_store_id:this.order.order_store_id,order_id:this.order.order_id,entries:this.order.entries,stage_current_name:this.order.stage_current_name,stage_next:this.order.stage_next,store:{store_name:this.order.store.store_name}};g.Z.cart.itemSet(e)}return!0}}catch(i){const e=i.responseJSON,t=e.messages.error;switch(t){case"wrong_courier_status":this.$flash("Смена курьера не открыта");break;case"order_is_empty":this.$alert("К сожалению, товара не осталось в наличии &#9785;","Заказ пуст");break;case"photos_must_be_made":this.$flash("Необходимо сфотографировать заказ"),this.action_take_photo();break;case"address_not_set":this.$flash("Необходимо добавить адрес доставки"),this.$router.push("/user/user-addresses");break;case"order_sum_exceeded":this.$flash("Сумма заказа должна быть меньше предоплаты");break;case"order_sum_zero":this.$flash("Нельзя завершить пустой заказ, от него можно отказаться.");break;default:this.$flash("Не удалось изменить статус заказа");break}return!1}},async action_confirm(e){const t=await this.onStageCreate(e,"customer_confirmed");t&&this.action_checkout()},async action_checkout(){this.$heap.commit("setCurrentOrder",this.order),this.$router.push(`/order/order-checkout-${this.order_id}`)},async action_add(){const e=await h.Fy.create({component:ee,componentProps:{store_id:this.order.order_store_id,order_id:this.order_id},initialBreakpoint:.5,breakpoints:[.5,1],canDissmiss:!0});e.present();await e.onDidDismiss();this.itemGet()},async action_objection(){const e=await h.Fy.create({component:Q,initialBreakpoint:.5,breakpoints:[.5,1],canDissmiss:!0});e.present();const t=await e.onDidDismiss();if(t.data){const e=`ВОЗРАЖЕНИЕ ПОКУПАТЕЛЯ: ${t.data}`,o=await g.Z.api.itemUpdate({order_id:this.order_id,order_objection:e});if("ok"==o){const e=await this.onStageCreate(this.order_id,"customer_disputed");e&&(this.$flash("Ваше возражение принято и будет рассмотрено администратором."),alert("Необходимо сфотографировать заказ"),this.action_take_photo())}}},action_rejected(){this.isOpenDeliveryRejectionPopover=!0},async action_rejected_reason(e){this.isOpenDeliveryRejectionPopover=!1;try{await g.Z.api.itemUpdate({order_id:this.order_id,order_objection:e}),await this.onStageCreate(this.order_id,"delivery_rejected"),this.$flash("Вы отказались от доставки")}catch(t){}},action_take_photo(){this.$refs.orderImgs.take_photo()},action_call_customer(){location.href=`tel:+${this.order.customer.user_phone}`}},ionViewDidEnter(){null==this.order&&this.itemGet()},ionViewDidLeave(){this.order=null},created(){const e=this;e.itemGet(),this.$topic.on("orderSumChanged",(()=>{e.itemGet()})),this.$topic.on("pushStageChanged",(t=>{var o;(null===(o=e.order)||void 0===o?void 0:o.order_id)==(null===t||void 0===t?void 0:t.order_id)&&e.order.stage_current!=t.stage&&e.itemGet()}))}};const ne=(0,I.Z)(ie,[["render",p]]);var re=ne},659:function(e,t,o){e.exports=o.p+"img/loading.30880178.svg"}}]);
//# sourceMappingURL=66.bac1ebab.js.map