"use strict";(self["webpackChunkblank"]=self["webpackChunkblank"]||[]).push([[840],{4548:function(e,t,o){o.d(t,{Z:function(){return v}});var n=o(6252),a=o(3577);const i={class:"center"},r={key:0,class:"rightend"},s=(0,n.Uk)("мин"),l={key:1,class:"rightend"},d=(0,n.Uk)(" Выбрать адрес доставки ");function c(e,t,o,c,u,m){const p=(0,n.up)("ion-img"),h=(0,n.up)("ion-text"),_=(0,n.up)("ion-note"),y=(0,n.up)("ion-icon"),w=(0,n.up)("ion-label"),f=(0,n.up)("ion-item"),k=(0,n.up)("ion-textarea");return(0,n.wg)(),(0,n.iD)(n.HY,null,[m.isMainLocationSet?((0,n.wg)(),(0,n.iD)("div",{key:0,onClick:t[0]||(t[0]=e=>m.selectDeliveryAddress()),class:"selector"},[(0,n._)("div",i,[u.location_main.image_hash?((0,n.wg)(),(0,n.j4)(p,{key:0,src:e.$heap.state.hostname+"image/get.php/"+u.location_main.image_hash+".32.32.webp"},null,8,["src"])):(0,n.kq)("",!0),(0,n.Wm)(h,{style:{margin:"5px"},color:"primary"},{default:(0,n.w5)((()=>[(0,n.Uk)((0,a.zw)(e.$heap.state.user?.location_main?.location_address),1)])),_:1})]),o.deliveryTime?((0,n.wg)(),(0,n.iD)("div",r,[(0,n.Wm)(h,{style:{"font-size":"24px"}},{default:(0,n.w5)((()=>[(0,n.Uk)((0,a.zw)(o.deliveryTime.time),1)])),_:1}),(0,n.Wm)(_,{style:{"font-size":"10px"}},{default:(0,n.w5)((()=>[s])),_:1})])):((0,n.wg)(),(0,n.iD)("div",l))])):((0,n.wg)(),(0,n.j4)(f,{key:1,detail:"",button:"",onClick:t[1]||(t[1]=e=>m.selectDeliveryAddress())},{default:(0,n.w5)((()=>[(0,n.Wm)(y,{slot:"start",style:{color:"var(--ion-color-primary)"},icon:c.location},null,8,["icon"]),(0,n.Wm)(w,null,{default:(0,n.w5)((()=>[d])),_:1})])),_:1})),o.showComment?((0,n.wg)(),(0,n.j4)(f,{key:2},{default:(0,n.w5)((()=>[(0,n.Wm)(k,{placeholder:"комментарий к адресу",onChange:t[2]||(t[2]=e=>m.locationCommentChanged()),modelValue:e.$heap.state.user.location_main.location_comment,"onUpdate:modelValue":t[3]||(t[3]=t=>e.$heap.state.user.location_main.location_comment=t)},null,8,["modelValue"])])),_:1})):(0,n.kq)("",!0)],64)}var u=o(3455),m=o(8903),p=o(2008),h=o(9127),_=o(9042),y=o(9755),w=o.n(y),f={props:["deliveryTime","showComment"],components:{IonIcon:u.gu,IonTextarea:u.g2},setup(){return{location:m.xhW}},data(){return{location_main:p.Z.state.user.location_main}},created(){let e=this;_.Z.on("userMainLocationSet",(t=>{e.location_main=t}))},methods:{selectDeliveryAddress(){h.Z.push({name:"UserAddresses"})},async locationCommentChanged(){const e={location_id:p.Z.state.user.location_main.location_id,location_comment:p.Z.state.user.location_main.location_comment};w().post(this.$heap.state.hostname+"Location/itemUpdate",JSON.stringify(e))}},computed:{isSignedIn(){return p.Z.state.user.user_id&&p.Z.state.user.user_id>-1},isMainLocationSet(){return this.location_main?1:0}}},k=o(3744);const g=(0,k.Z)(f,[["render",c],["__scopeId","data-v-b676decc"]]);var v=g},6840:function(e,t,o){o.r(t),o.d(t,{default:function(){return V}});var n=o(6252),a=o(3577);const i=e=>((0,n.dD)("data-v-1ae109a4"),e=e(),(0,n.Cn)(),e),r=(0,n.Uk)("Способы оплаты"),s=i((()=>(0,n._)("label",{for:"payment_card"},"Оплата картой",-1))),l={slot:"end"},d=["checked"],c=i((()=>(0,n._)("label",{for:"payment_cash"},"Оплата наличными",-1))),u={slot:"end"},m=["checked"],p=(0,n.Uk)("Итого к оплате"),h=(0,n.Uk)(" Налоги "),_=(0,n.Uk)(" Доставка "),y=(0,n.Uk)(" Итого "),w=(0,n.Uk)("Вернуться"),f=(0,n.Uk)("Продолжить");function k(e,t,o,i,k,g){const v=(0,n.up)("user-address-widget"),W=(0,n.up)("ion-item-divider"),C=(0,n.up)("ion-icon"),T=(0,n.up)("ion-item"),Z=(0,n.up)("ion-list"),b=(0,n.up)("ion-text"),U=(0,n.up)("ion-item-group"),x=(0,n.up)("ion-textarea"),O=(0,n.up)("ion-button"),D=(0,n.up)("ion-col"),$=(0,n.up)("ion-row"),L=(0,n.up)("ion-grid"),S=(0,n.up)("base-layout");return(0,n.wg)(),(0,n.j4)(S,{pageTitle:"Оформление заказа"},{default:(0,n.w5)((()=>[(0,n.Wm)(v,{deliveryTime:k.deliveryTime,showComment:"1"},null,8,["deliveryTime"]),(0,n.Wm)(W),(0,n.Wm)(Z,null,{default:(0,n.w5)((()=>[(0,n._)("form",null,[(0,n.Wm)(W,null,{default:(0,n.w5)((()=>[r])),_:1}),(0,n.Wm)(T,{button:"",onClick:t[0]||(t[0]=e=>k.paymentType="payment_card")},{default:(0,n.w5)((()=>[(0,n.Wm)(C,{icon:i.cardOutline,slot:"start",color:"primary"},null,8,["icon"]),s,(0,n._)("div",l,[(0,n._)("input",{type:"radio",name:"paymentType",id:"payment_card",value:"card",checked:"payment_card"==k.paymentType},null,8,d)])])),_:1}),(0,n.Wm)(T,{button:"",onClick:t[1]||(t[1]=e=>k.paymentType="payment_cash")},{default:(0,n.w5)((()=>[(0,n.Wm)(C,{icon:i.cashOutline,slot:"start",color:"primary"},null,8,["icon"]),c,(0,n._)("div",u,[(0,n._)("input",{type:"radio",name:"paymentType",id:"payment_cash",value:"cash",checked:"payment_cash"==k.paymentType},null,8,m)])])),_:1})])])),_:1}),(0,n.Wm)(W),(0,n.Wm)(Z,null,{default:(0,n.w5)((()=>[(0,n.Wm)(U,null,{default:(0,n.w5)((()=>[(0,n.Wm)(W,null,{default:(0,n.w5)((()=>[p])),_:1}),k.order?.order_sum_tax?((0,n.wg)(),(0,n.j4)(T,{key:0},{default:(0,n.w5)((()=>[(0,n.Wm)(C,{icon:i.pieChartOutline,slot:"start",color:"primary"},null,8,["icon"]),h,(0,n.Wm)(b,{slot:"end"},{default:(0,n.w5)((()=>[(0,n.Uk)((0,a.zw)(k.order?.order_sum_tax),1)])),_:1})])),_:1})):(0,n.kq)("",!0),(0,n.Wm)(T,null,{default:(0,n.w5)((()=>[(0,n.Wm)(C,{src:"./assets/icon/box-delivery.svg",slot:"start",style:{color:"var(--ion-color-primary)"}}),_,(0,n.Wm)(b,{slot:"end"},{default:(0,n.w5)((()=>[(0,n.Uk)((0,a.zw)(k.order?.order_sum_shipping??0),1)])),_:1})])),_:1}),(0,n.Wm)(T,null,{default:(0,n.w5)((()=>[(0,n.Wm)(C,{icon:i.walletOutline,slot:"start",color:"primary"},null,8,["icon"]),y,(0,n.Wm)(b,{slot:"end"},{default:(0,n.w5)((()=>[(0,n.Uk)((0,a.zw)(k.order?.order_sum_total),1)])),_:1})])),_:1})])),_:1})])),_:1}),(0,n.Wm)(W),k.order?((0,n.wg)(),(0,n.j4)(Z,{key:0},{default:(0,n.w5)((()=>[(0,n.Wm)(T,null,{default:(0,n.w5)((()=>[(0,n.Wm)(x,{placeholder:"комментарий к заказу",onChange:t[2]||(t[2]=e=>g.orderDescriptionChanged()),modelValue:k.order.order_description,"onUpdate:modelValue":t[3]||(t[3]=e=>k.order.order_description=e)},null,8,["modelValue"])])),_:1})])),_:1})):(0,n.kq)("",!0),(0,n.Wm)(L,null,{default:(0,n.w5)((()=>[(0,n.Wm)($,null,{default:(0,n.w5)((()=>[(0,n.Wm)(D,null,{default:(0,n.w5)((()=>[(0,n.Wm)(O,{expand:"block",color:"medium",onClick:t[4]||(t[4]=e=>g.cancel())},{default:(0,n.w5)((()=>[w])),_:1})])),_:1}),(0,n.Wm)(D,null,{default:(0,n.w5)((()=>[(0,n.Wm)(O,{expand:"block",onClick:t[5]||(t[5]=e=>g.proceed())},{default:(0,n.w5)((()=>[f])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})}var g=o(7782),v=o(4405),W=o(9042),C=o(9127),T=o(9755),Z=o.n(T),b=o(8903),U=o(3455),x=o(4548);const O=(0,n.Uk)("Оплата картой"),D=["src"],$={key:0,style:{position:"fixed",top:"200px",left:"calc( 50% - 50px )"}},L=["src"];function S(e,t,o,a,i,r){const s=(0,n.up)("ion-title"),l=(0,n.up)("ion-icon"),d=(0,n.up)("ion-toolbar"),c=(0,n.up)("ion-header"),u=(0,n.up)("ion-content");return(0,n.wg)(),(0,n.iD)(n.HY,null,[(0,n.Wm)(c,null,{default:(0,n.w5)((()=>[(0,n.Wm)(d,{color:"light"},{default:(0,n.w5)((()=>[(0,n.Wm)(s,{slot:"start",style:{color:"black"}},{default:(0,n.w5)((()=>[O])),_:1}),(0,n.Wm)(l,{icon:a.closeOutline,onClick:t[0]||(t[0]=e=>{a.closeModal()}),slot:"end",size:"large"},null,8,["icon"])])),_:1})])),_:1}),(0,n.Wm)(u,null,{default:(0,n.w5)((()=>[(0,n._)("iframe",{src:i.paymentLink,id:"paymentFrame1",style:{width:"100%",height:"600px",border:"none"},onLoad:t[1]||(t[1]=e=>r.onLoad())},null,40,D),i.loadAnimation?((0,n.wg)(),(0,n.iD)("div",$,[(0,n._)("img",{src:a.loading},null,8,L)])):(0,n.kq)("",!0)])),_:1})],64)}var I=o(659),M={components:{},props:["order_data"],setup(){const e=function(){U.Fy.dismiss()};return{closeModal:e,closeOutline:b.fID,loading:I}},data(){return{paymentLink:null,loadAnimation:1}},mounted(){this.listenFrame(),this.postToIframe()},methods:{async postToIframe(){try{this.paymentLink=await Z().post(this.$heap.state.hostname+"UniPayments/paymentLinkGet",this.order_data)}catch(e){this.$flash("Нет возможности принять оплату картой"),this.closeModal()}},onLoad(){this.loadAnimation=0},listenFrame(){let e=this;window.addEventListener("message",(t=>{"paymentOk"!=t.data&&"paymentNo"!=t.data||e.closeModal()}))}}},z=o(3744);const G=(0,z.Z)(M,[["render",S]]);var A=G,F={components:{UserAddressWidget:x.Z,IonTextarea:U.g2},setup(){return{cardOutline:b.pvm,cashOutline:b.zaw,giftOutline:b._$o,cubeOutline:b.XFf,walletOutline:b.S5P,pieChartOutline:b.qlh}},data(){return{order_id:0,order:null,deliveryTime:{},paymentType:"payment_card"}},mounted(){this.checkoutDataGet()},methods:{async checkoutDataGet(){if(this.order_id=this.$route.params.id,this.order=this.$heap.state.currentOrder,this.order||await this.orderGet(),"customer_confirmed"!=this.order.stage_current)return void C.Z.push("order-"+this.order.order_id);const e=null;this.distance=await this.distanceGet(),this.distance&&(this.deliveryTime=v.Z.deliveryTimeCalculate(this.distance,e))},async orderGet(){try{this.order=await g.Z.api.itemGet(this.order_id)}catch(e){switch(e.status){case 404:this.$flash("Заказ не найден"),this.order="notfound",C.Z.go(-1);break}}},async distanceGet(){const e={start_holder:"store",start_holder_id:this.order.order_store_id,finish_holder:"user",finish_holder_id:this.order.owner_id};try{return await Z().post(this.$heap.state.hostname+"Location/distanceHolderGet",e)}catch(t){}},async orderDescriptionChanged(){const e={order_id:this.order.order_id,order_description:this.order.order_description};g.Z.api.itemUpdate(e)},async proceed(){this.paymentType,"payment_card"==this.paymentType&&this.paymentFormOpen({order_id:this.order.order_id,order_sum_total:this.order.order_sum_total,user_id:this.order.owner_id})},async cancel(){this.$router.push("order-"+this.order.order_id)},async paymentFormOpen(e){const t=this,o=await U.Fy.create({component:A,componentProps:{order_data:e},initialBreakpoint:.85,breakpoints:[0,.85,.95]}),n=function(){o.dismiss()};return W.Z.on("dismissModal",n),o.onDidDismiss().then((()=>{t.paymentStatusCheck()})),o.present()},async paymentStatusCheck(){const e={order_id:this.order.order_id};try{const t=await Z().post(this.$heap.state.hostname+"UniPayments/paymentStatusRequest",e);"OK"==t&&C.Z.push("order-"+this.order.order_id)}catch(t){this.$flash("Данный заказ не может быть оплачен");const e=t.responseJSON?.messages?.error;"wrong_status"==e&&C.Z.push("order-"+this.order.order_id)}}}};const q=(0,z.Z)(F,[["render",k],["__scopeId","data-v-1ae109a4"]]);var V=q},4405:function(e,t,o){var n=o(2008);const a={deliveryCalculate(e){if(!e.locations||!e.locations[0]||!e.locations[0].distance)return null;const t=e.locations[0].distance,o=e.store_time_preparation||0;return a.deliveryTimeCalculate(t,o)},deliveryTimeCalculate(e,t){t=t??n.Z.state.deliverySettings.defaultPreparationTime;const o=n.Z.state.deliverySettings.deliveryTimeDelta,a=5*Math.round(e/n.Z.state.deliverySettings.courierVelocity*60/5)+parseInt(t),i=a>o?a-o:a,r=i+o;return{time:a,timeMin:i,timeMax:r}}};t["Z"]=a},659:function(e,t,o){e.exports=o.p+"img/loading.30880178.svg"}}]);
//# sourceMappingURL=840.ba0254c2.js.map