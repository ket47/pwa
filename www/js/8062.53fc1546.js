"use strict";(self["webpackChunktezkel"]=self["webpackChunktezkel"]||[]).push([[8062],{8062:function(t,e,a){a.d(e,{A:function(){return b}});var l=a(641),n=a(33);const i={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},s={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},o={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},d=["onClick"];function u(t,e,a,u,r,c){const _=(0,l.g2)("ion-label"),m=(0,l.g2)("ion-text"),g=(0,l.g2)("ion-item"),k=(0,l.g2)("ion-list"),h=(0,l.g2)("ion-icon"),p=(0,l.g2)("ion-input"),f=(0,l.g2)("ion-accordion"),y=(0,l.g2)("ion-chip"),b=(0,l.g2)("ion-accordion-group"),v=(0,l.g2)("ion-searchbar"),F=(0,l.g2)("ion-skeleton-text"),I=(0,l.g2)("ion-infinite-scroll-content"),W=(0,l.g2)("ion-infinite-scroll");return(0,l.uX)(),(0,l.CE)("div",null,[(0,l.bF)(k,null,{default:(0,l.k6)(()=>[(0,l.bF)(g,{lines:"full"},{default:(0,l.k6)(()=>[(0,l.bF)(_,null,{default:(0,l.k6)(()=>e[9]||(e[9]=[(0,l.eW)("Баланс")])),_:1,__:[9]}),r.balance>0?((0,l.uX)(),(0,l.Wv)(m,{key:0,slot:"end",color:"success"},{default:(0,l.k6)(()=>[(0,l.Lk)("b",null,(0,n.v_)(r.balance)+(0,n.v_)(t.$heap.state.currencySign),1)]),_:1})):r.balance<0?((0,l.uX)(),(0,l.Wv)(m,{key:1,slot:"end",color:"danger"},{default:(0,l.k6)(()=>[(0,l.Lk)("b",null,(0,n.v_)(r.balance)+(0,n.v_)(t.$heap.state.currencySign),1)]),_:1})):((0,l.uX)(),(0,l.Wv)(m,{key:2,slot:"end",color:"medium"},{default:(0,l.k6)(()=>[(0,l.Lk)("b",null,(0,n.v_)(r.balance)+(0,n.v_)(t.$heap.state.currencySign),1)]),_:1}))]),_:1})]),_:1}),(0,l.bF)(b,{value:r.settingsType},{default:(0,l.k6)(()=>[(0,l.bF)(f,{value:"period"},{default:(0,l.k6)(()=>[(0,l.bF)(g,{slot:"header"},{default:(0,l.k6)(()=>[(0,l.bF)(h,{icon:u.calendarOutline,slot:"start"},null,8,["icon"]),(0,l.bF)(m,null,{default:(0,l.k6)(()=>e[10]||(e[10]=[(0,l.eW)("Период")])),_:1,__:[10]}),(0,l.bF)(m,{color:"medium",slot:"end"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(c.start_at_dmy)+" - "+(0,n.v_)(c.finish_at_dmy),1)]),_:1})]),_:1}),(0,l.bF)(k,{slot:"content"},{default:(0,l.k6)(()=>[(0,l.bF)(g,null,{default:(0,l.k6)(()=>[(0,l.bF)(m,{color:"medium"},{default:(0,l.k6)(()=>e[11]||(e[11]=[(0,l.eW)("Начальная дата")])),_:1,__:[11]}),(0,l.Lk)("div",i,[(0,l.bF)(p,{type:"date",modelValue:r.start_at,"onUpdate:modelValue":e[0]||(e[0]=t=>r.start_at=t),onIonInput:e[1]||(e[1]=t=>c.listGet()),debounce:"500"},null,8,["modelValue"]),r.meta.sum_start?((0,l.uX)(),(0,l.Wv)(p,{key:0,type:"text",style:{"text-align":"right"},value:`${r.meta.sum_start}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.Q3)("",!0)])]),_:1}),(0,l.bF)(g,null,{default:(0,l.k6)(()=>[(0,l.bF)(m,{color:"medium"},{default:(0,l.k6)(()=>e[12]||(e[12]=[(0,l.eW)("Обороты")])),_:1,__:[12]}),(0,l.Lk)("div",s,[r.meta.sum_debit?((0,l.uX)(),(0,l.Wv)(p,{key:0,type:"text",style:{"text-align":"right"},value:`+${r.meta.sum_debit}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.Q3)("",!0),r.meta.sum_credit?((0,l.uX)(),(0,l.Wv)(p,{key:1,type:"text",style:{"text-align":"right"},value:`-${r.meta.sum_credit}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.Q3)("",!0)])]),_:1}),(0,l.bF)(g,null,{default:(0,l.k6)(()=>[(0,l.bF)(m,{color:"medium"},{default:(0,l.k6)(()=>e[13]||(e[13]=[(0,l.eW)("Конечная дата")])),_:1,__:[13]}),(0,l.Lk)("div",o,[(0,l.bF)(p,{type:"date",modelValue:r.finish_at,"onUpdate:modelValue":e[2]||(e[2]=t=>r.finish_at=t),onIonInput:e[3]||(e[3]=t=>c.listGet())},null,8,["modelValue"]),r.meta.sum_finish?((0,l.uX)(),(0,l.Wv)(p,{key:0,type:"text",style:{"text-align":"right"},value:`${r.meta.sum_finish}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.Q3)("",!0)])]),_:1})]),_:1})]),_:1}),(0,l.bF)(f,{value:"tags"},{default:(0,l.k6)(()=>[(0,l.bF)(g,{slot:"header"},{default:(0,l.k6)(()=>[(0,l.bF)(h,{icon:u.pricetagOutline,slot:"start"},null,8,["icon"]),(0,l.bF)(m,null,{default:(0,l.k6)(()=>e[14]||(e[14]=[(0,l.eW)("Фильтр по тегам")])),_:1,__:[14]})]),_:1}),(0,l.bF)(k,{slot:"content"},{default:(0,l.k6)(()=>[(0,l.bF)(g,{lines:"none"},{default:(0,l.k6)(()=>[(0,l.bF)(m,null,{default:(0,l.k6)(()=>[r.tagDict?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.Wv)(m,{key:0,color:"medium"},{default:(0,l.k6)(()=>e[15]||(e[15]=[(0,l.eW)("нажмите на #тег для фильтрации")])),_:1,__:[15]})),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.tagDict,(t,e)=>((0,l.uX)(),(0,l.Wv)(y,{key:e,color:"primary"},{default:(0,l.k6)(()=>[(0,l.eW)("#"+(0,n.v_)(t)+" ",1),(0,l.bF)(h,{src:u.closeCircle,onClick:t=>c.itemTagRemove(e)},null,8,["src","onClick"])]),_:2},1024))),128)),c.is_admin?((0,l.uX)(),(0,l.Wv)(y,{key:1,onClick:e[4]||(e[4]=t=>c.itemTagCreate()),color:"medium"},{default:(0,l.k6)(()=>[(0,l.bF)(h,{src:u.addOutline},null,8,["src"]),(0,l.bF)(_,null,{default:(0,l.k6)(()=>e[16]||(e[16]=[(0,l.eW)("Добавить #тег")])),_:1,__:[16]})]),_:1})):(0,l.Q3)("",!0)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["value"]),(0,l.bF)(v,{modelValue:r.searchQuery,"onUpdate:modelValue":e[5]||(e[5]=t=>r.searchQuery=t),placeholder:"Поиск по сумме или описанию",debounce:"300",onIonInput:e[6]||(e[6]=t=>c.listGet())},null,8,["modelValue"]),null==r.ledger?((0,l.uX)(),(0,l.Wv)(k,{key:0},{default:(0,l.k6)(()=>[((0,l.uX)(),(0,l.CE)(l.FK,null,(0,l.pI)([1,2,3],t=>(0,l.bF)(g,{key:t},{default:(0,l.k6)(()=>[(0,l.bF)(m,{slot:"start"},{default:(0,l.k6)(()=>[(0,l.bF)(F,{animated:"",style:{width:"50px"}})]),_:1}),(0,l.bF)(_,null,{default:(0,l.k6)(()=>[(0,l.bF)(F,{animated:"",style:{width:"100%"}})]),_:1}),(0,l.bF)(_,{slot:"end",color:"success"},{default:(0,l.k6)(()=>[(0,l.bF)(F,{animated:"",style:{width:"50px"}})]),_:1})]),_:2},1024)),64))]),_:1})):r.ledger.length>0?((0,l.uX)(),(0,l.Wv)(k,{key:1},{default:(0,l.k6)(()=>[(0,l.bF)(g,{detail:"false"},{default:(0,l.k6)(()=>[(0,l.bF)(y,{onClick:e[7]||(e[7]=t=>c.listGet()),color:"medium"},{default:(0,l.k6)(()=>[(0,l.bF)(h,{src:u.refreshOutline},null,8,["src"]),(0,l.bF)(_,null,{default:(0,l.k6)(()=>e[17]||(e[17]=[(0,l.eW)("Обновить")])),_:1,__:[17]})]),_:1})]),_:1}),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(c.ledgerCalc,t=>((0,l.uX)(),(0,l.CE)("div",{key:t.trans_id},[(0,l.bF)(g,{detail:c.is_admin,lines:"none",onClick:e=>c.itemClick(t.trans_id)},{default:(0,l.k6)(()=>[(0,l.bF)(m,{slot:"start"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(t.date),1)]),_:2},1024),(0,l.bF)(m,null,{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(t.trans_description),1)]),_:2},1024),t.amount_sign*t.trans_amount>0?((0,l.uX)(),(0,l.Wv)(_,{key:0,slot:"end",color:"success"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(t.trans_amount),1)]),_:2},1024)):t.amount_sign*t.trans_amount<0?((0,l.uX)(),(0,l.Wv)(_,{key:1,slot:"end",color:"danger"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(t.trans_amount),1)]),_:2},1024)):((0,l.uX)(),(0,l.Wv)(_,{key:2,slot:"end",color:"medium"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(t.trans_amount),1)]),_:2},1024))]),_:2},1032,["detail","onClick"]),(0,l.bF)(g,null,{default:(0,l.k6)(()=>[(0,l.bF)(m,null,{default:(0,l.k6)(()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(t.tag_list,(t,e)=>((0,l.uX)(),(0,l.CE)("div",{class:"tag",key:e,onClick:e=>c.itemTagAdd(t)},"#"+(0,n.v_)(t[1]),9,d))),128))]),_:2},1024)]),_:2},1024)]))),128))]),_:1})):((0,l.uX)(),(0,l.Wv)(k,{key:2},{default:(0,l.k6)(()=>[(0,l.bF)(g,null,{default:(0,l.k6)(()=>e[18]||(e[18]=[(0,l.eW)(" Нет операций в данном периоде ")])),_:1,__:[18]})]),_:1})),(0,l.bF)(W,{onIonInfinite:e[8]||(e[8]=t=>c.listLoadMore(t)),id:"moderation-infinite-scroll"},{default:(0,l.k6)(()=>[(0,l.bF)(I,{"loading-spinner":"bubbles","loading-text":"Загрузка..."})]),_:1})])}a(4114),a(8111),a(1701);var r=a(5634),c=a(5480),_=a(2311),m=a.n(_),g=a(8701),k=a(3201),h=a(6383),p={components:{IonIcon:r.iq,IonLabel:r.he,IonItem:r.uz,IonInput:r.$w,IonList:r.nf,IonAccordion:r.xk,IonAccordionGroup:r.YH,IonText:r.IO,IonSkeletonText:r.ds,IonSearchbar:r.S1,IonChip:r.ZB,IonInfiniteScroll:r.Ax,IonInfiniteScrollContent:r.Hp},props:["permanentTag"],setup(){return{calendarOutline:c.RXF,addOutline:c.EKF,closeCircle:c.P0k,pricetagOutline:c.eOv,refreshOutline:c.mVv,calculatorOutline:c.N0h}},data(){const t=k.A.date.today(),e=k.A.date.firstDay(-1);return{balance:"-",start_at:k.A.date.toIso(e),finish_at:k.A.date.toIso(t),searchQuery:"",tagQuery:"",tagDict:null,ledger:null,meta:{},today:t,settingsType:null,can_reload_at:0}},computed:{ledgerCalc(){if(null==this.ledger)return null;let t=[];for(let i of this.ledger){var e,a,l,n;i.date=this.toLocDate(i.trans_date),i.tag_list=null===(e=i.tags)||void 0===e||null===(a=e.substring(1))||void 0===a||null===(l=a.toLowerCase())||void 0===l||null===(n=l.split("|"))||void 0===n?void 0:n.map(t=>t.split("#")),t.push(i)}return t},is_admin(){return g.A.isAdmin()},start_at_dmy(){return k.A.date.isoToDmy(this.start_at)},finish_at_dmy(){return k.A.date.isoToDmy(this.finish_at)}},watch:{query:function(){this.listGet()}},methods:{async listLoadMore(t){await this.listGet("append"),t.target.complete()},async listGet(t){const e=Date.now();if(t||!(this.can_reload_at>e)){this.can_reload_at=e+1e3;try{var a;const e=null===(a=Object.keys(this.tagDict??{}))||void 0===a?void 0:a.join(" "),n={start_at:this.start_at,finish_at:this.finish_at,tagQuery:`${e} ${this.permanentTag??""}`,searchQuery:this.searchQuery,limit:10};var l;if("append"==t)n.offset=(null===(l=this.ledger)||void 0===l?void 0:l.length)??0,n.limit=10;const i=await m().post(`${this.$heap.state.hostname}Transaction/listGet`,n);"append"==t&&(this.ledger??=[],i.ledger=this.ledger.concat(i.ledger)),this.ledger=i.ledger,this.meta=i.meta,this.balance=i.meta.sum_finish}catch(s){var n,i;const t=null===s||void 0===s||null===(n=s.responseJSON)||void 0===n||null===(i=n.messages)||void 0===i?void 0:i.error;switch(t){case"large_interval":this.$flash("Период должен быть не больше 3 месяцев");break;default:this.$flash("Ошибка получения выписки");break}return this.ledger=[],this.balance=0,!1}}},toLocDate(t){const e=new Date(Date.parse(t)),a={month:"short",day:"numeric"};return e.toLocaleDateString(void 0,a)},itemClick(t){g.A.isAdmin()&&this.$go(`/admin/transaction-edit-${t}`)},async itemTagPick(t){const e=await r.OZ.create({component:h.A,componentProps:{itemType:t},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});e.present(),this.$topic.on("dismissModal",()=>{e.dismiss()});const a=await e.onDidDismiss();a.data&&(a.data.order_id&&this.itemTagAdd([`order:${a.data.order_id}`,`заказ ${a.data.order_id}`]),a.data.store_id&&this.itemTagAdd([`store:${a.data.store_id}`,`продавец ${a.data.store_name}`]),a.data.courier_id&&this.itemTagAdd([`courier:${a.data.courier_id}`,`курьер ${a.data.courier_name}`]),a.data.type&&this.itemTagAdd([`acc::${a.data.type}`,`счет ${a.data.name}`]))},async itemTagCreate(){const t=await r.k_.create({header:"Тип тега",buttons:[{text:"Заказ",data:"order"},{text:"Продавец",data:"store"},{text:"Курьер",data:"courier"},{text:"Счет",data:"acc"}]});await t.present();const e=await t.onDidDismiss();null!==e&&void 0!==e&&e.data&&this.itemTagPick(null===e||void 0===e?void 0:e.data)},itemTagAdd(t){let e=this.tagDict??{};e[t[0]]=t[1],this.tagDict=e,this.listGet(),this.settingsType="tags"},itemTagRemove(t){let e=this.tagDict??{};e[t]&&delete e[t];const a=Object.keys(e).length;this.tagDict=a?e:null,this.listGet(),this.settingsType="tags"}},mounted(){this.listGet()}},f=a(6262);const y=(0,f.A)(p,[["render",u]]);var b=y}}]);
//# sourceMappingURL=8062.53fc1546.js.map