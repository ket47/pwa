"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[8062],{8062:function(t,e,a){a.d(e,{A:function(){return y}});var l=a(641),n=a(33);const i={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},s={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},o={slot:"end",style:{display:"grid","grid-template-columns":"120px 100px"}},d=["onClick"];function u(t,e,a,u,r,c){const _=(0,l.g2)("ion-label"),m=(0,l.g2)("ion-text"),g=(0,l.g2)("ion-item"),k=(0,l.g2)("ion-list"),h=(0,l.g2)("ion-icon"),v=(0,l.g2)("ion-input"),p=(0,l.g2)("ion-accordion"),f=(0,l.g2)("ion-chip"),y=(0,l.g2)("ion-accordion-group"),b=(0,l.g2)("ion-searchbar"),F=(0,l.g2)("ion-skeleton-text"),I=(0,l.g2)("ion-infinite-scroll-content"),W=(0,l.g2)("ion-infinite-scroll");return(0,l.uX)(),(0,l.CE)("div",null,[(0,l.bF)(k,null,{default:(0,l.k6)((()=>[(0,l.bF)(g,{lines:"full"},{default:(0,l.k6)((()=>[(0,l.bF)(_,null,{default:(0,l.k6)((()=>[(0,l.eW)("Баланс")])),_:1}),r.balance>0?((0,l.uX)(),(0,l.Wv)(m,{key:0,slot:"end",color:"success"},{default:(0,l.k6)((()=>[(0,l.Lk)("b",null,(0,n.v_)(r.balance)+(0,n.v_)(t.$heap.state.currencySign),1)])),_:1})):r.balance<0?((0,l.uX)(),(0,l.Wv)(m,{key:1,slot:"end",color:"danger"},{default:(0,l.k6)((()=>[(0,l.Lk)("b",null,(0,n.v_)(r.balance)+(0,n.v_)(t.$heap.state.currencySign),1)])),_:1})):((0,l.uX)(),(0,l.Wv)(m,{key:2,slot:"end",color:"medium"},{default:(0,l.k6)((()=>[(0,l.Lk)("b",null,(0,n.v_)(r.balance)+(0,n.v_)(t.$heap.state.currencySign),1)])),_:1}))])),_:1})])),_:1}),(0,l.bF)(y,{value:r.settingsType},{default:(0,l.k6)((()=>[(0,l.bF)(p,{value:"period"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{slot:"header"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{icon:u.calendarOutline,slot:"start"},null,8,["icon"]),(0,l.bF)(m,null,{default:(0,l.k6)((()=>[(0,l.eW)("Период")])),_:1}),(0,l.bF)(m,{color:"medium",slot:"end"},{default:(0,l.k6)((()=>[(0,l.eW)((0,n.v_)(c.start_at_dmy)+" - "+(0,n.v_)(c.finish_at_dmy),1)])),_:1})])),_:1}),(0,l.bF)(k,{slot:"content"},{default:(0,l.k6)((()=>[(0,l.bF)(g,null,{default:(0,l.k6)((()=>[(0,l.bF)(m,{color:"medium"},{default:(0,l.k6)((()=>[(0,l.eW)("Начальная дата")])),_:1}),(0,l.Lk)("div",i,[(0,l.bF)(v,{type:"date",modelValue:r.start_at,"onUpdate:modelValue":e[0]||(e[0]=t=>r.start_at=t),onIonInput:e[1]||(e[1]=t=>c.listGet()),debounce:"500"},null,8,["modelValue"]),r.meta.sum_start?((0,l.uX)(),(0,l.Wv)(v,{key:0,type:"text",style:{"text-align":"right"},value:`${r.meta.sum_start}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.Q3)("",!0)])])),_:1}),(0,l.bF)(g,null,{default:(0,l.k6)((()=>[(0,l.bF)(m,{color:"medium"},{default:(0,l.k6)((()=>[(0,l.eW)("Обороты")])),_:1}),(0,l.Lk)("div",s,[r.meta.sum_debit?((0,l.uX)(),(0,l.Wv)(v,{key:0,type:"text",style:{"text-align":"right"},value:`+${r.meta.sum_debit}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.Q3)("",!0),r.meta.sum_credit?((0,l.uX)(),(0,l.Wv)(v,{key:1,type:"text",style:{"text-align":"right"},value:`-${r.meta.sum_credit}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.Q3)("",!0)])])),_:1}),(0,l.bF)(g,null,{default:(0,l.k6)((()=>[(0,l.bF)(m,{color:"medium"},{default:(0,l.k6)((()=>[(0,l.eW)("Конечная дата")])),_:1}),(0,l.Lk)("div",o,[(0,l.bF)(v,{type:"date",modelValue:r.finish_at,"onUpdate:modelValue":e[2]||(e[2]=t=>r.finish_at=t),onIonInput:e[3]||(e[3]=t=>c.listGet())},null,8,["modelValue"]),r.meta.sum_finish?((0,l.uX)(),(0,l.Wv)(v,{key:0,type:"text",style:{"text-align":"right"},value:`${r.meta.sum_finish}${t.$heap.state.currencySign}`,readonly:""},null,8,["value"])):(0,l.Q3)("",!0)])])),_:1})])),_:1})])),_:1}),(0,l.bF)(p,{value:"tags"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{slot:"header"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{icon:u.pricetagOutline,slot:"start"},null,8,["icon"]),(0,l.bF)(m,null,{default:(0,l.k6)((()=>[(0,l.eW)("Фильтр по тегам")])),_:1})])),_:1}),(0,l.bF)(k,{slot:"content"},{default:(0,l.k6)((()=>[(0,l.bF)(g,{lines:"none"},{default:(0,l.k6)((()=>[(0,l.bF)(m,null,{default:(0,l.k6)((()=>[r.tagDict?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.Wv)(m,{key:0,color:"medium"},{default:(0,l.k6)((()=>[(0,l.eW)("нажмите на #тег для фильтрации")])),_:1})),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.tagDict,((t,e)=>((0,l.uX)(),(0,l.Wv)(f,{key:e,color:"primary"},{default:(0,l.k6)((()=>[(0,l.eW)("#"+(0,n.v_)(t)+" ",1),(0,l.bF)(h,{src:u.closeCircle,onClick:t=>c.itemTagRemove(e)},null,8,["src","onClick"])])),_:2},1024)))),128)),c.is_admin?((0,l.uX)(),(0,l.Wv)(f,{key:1,onClick:e[4]||(e[4]=t=>c.itemTagCreate()),color:"medium"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{src:u.addOutline},null,8,["src"]),(0,l.bF)(_,null,{default:(0,l.k6)((()=>[(0,l.eW)("Добавить #тег")])),_:1})])),_:1})):(0,l.Q3)("",!0)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["value"]),(0,l.bF)(b,{modelValue:r.searchQuery,"onUpdate:modelValue":e[5]||(e[5]=t=>r.searchQuery=t),placeholder:"Поиск по сумме или описанию",debounce:"300",onIonInput:e[6]||(e[6]=t=>c.listGet())},null,8,["modelValue"]),null==r.ledger?((0,l.uX)(),(0,l.Wv)(k,{key:0},{default:(0,l.k6)((()=>[((0,l.uX)(),(0,l.CE)(l.FK,null,(0,l.pI)([1,2,3],(t=>(0,l.bF)(g,{key:t},{default:(0,l.k6)((()=>[(0,l.bF)(m,{slot:"start"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{animated:"",style:{width:"50px"}})])),_:1}),(0,l.bF)(_,null,{default:(0,l.k6)((()=>[(0,l.bF)(F,{animated:"",style:{width:"100%"}})])),_:1}),(0,l.bF)(_,{slot:"end",color:"success"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{animated:"",style:{width:"50px"}})])),_:1})])),_:2},1024))),64))])),_:1})):r.ledger.length>0?((0,l.uX)(),(0,l.Wv)(k,{key:1},{default:(0,l.k6)((()=>[(0,l.bF)(g,{detail:"false"},{default:(0,l.k6)((()=>[(0,l.bF)(f,{onClick:e[7]||(e[7]=t=>c.listGet()),color:"medium"},{default:(0,l.k6)((()=>[(0,l.bF)(h,{src:u.refreshOutline},null,8,["src"]),(0,l.bF)(_,null,{default:(0,l.k6)((()=>[(0,l.eW)("Обновить")])),_:1})])),_:1})])),_:1}),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(c.ledgerCalc,(t=>((0,l.uX)(),(0,l.CE)("div",{key:t.trans_id},[(0,l.bF)(g,{detail:c.is_admin,lines:"none",onClick:e=>c.itemClick(t.trans_id)},{default:(0,l.k6)((()=>[(0,l.bF)(m,{slot:"start"},{default:(0,l.k6)((()=>[(0,l.eW)((0,n.v_)(t.date),1)])),_:2},1024),(0,l.bF)(m,null,{default:(0,l.k6)((()=>[(0,l.eW)((0,n.v_)(t.trans_description),1)])),_:2},1024),t.amount_sign*t.trans_amount>0?((0,l.uX)(),(0,l.Wv)(_,{key:0,slot:"end",color:"success"},{default:(0,l.k6)((()=>[(0,l.eW)((0,n.v_)(t.trans_amount),1)])),_:2},1024)):t.amount_sign*t.trans_amount<0?((0,l.uX)(),(0,l.Wv)(_,{key:1,slot:"end",color:"danger"},{default:(0,l.k6)((()=>[(0,l.eW)((0,n.v_)(t.trans_amount),1)])),_:2},1024)):((0,l.uX)(),(0,l.Wv)(_,{key:2,slot:"end",color:"medium"},{default:(0,l.k6)((()=>[(0,l.eW)((0,n.v_)(t.trans_amount),1)])),_:2},1024))])),_:2},1032,["detail","onClick"]),(0,l.bF)(g,null,{default:(0,l.k6)((()=>[(0,l.bF)(m,null,{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(t.tag_list,((t,e)=>((0,l.uX)(),(0,l.CE)("div",{class:"tag",key:e,onClick:e=>c.itemTagAdd(t)},"#"+(0,n.v_)(t[1]),9,d)))),128))])),_:2},1024)])),_:2},1024)])))),128))])),_:1})):((0,l.uX)(),(0,l.Wv)(k,{key:2},{default:(0,l.k6)((()=>[(0,l.bF)(g,null,{default:(0,l.k6)((()=>[(0,l.eW)(" Нет операций в данном периоде ")])),_:1})])),_:1})),(0,l.bF)(W,{onIonInfinite:e[8]||(e[8]=t=>c.listLoadMore(t)),id:"moderation-infinite-scroll"},{default:(0,l.k6)((()=>[(0,l.bF)(I,{"loading-spinner":"bubbles","loading-text":"Загрузка..."})])),_:1})])}a(4114);var r=a(972),c=a(5480),_=a(2311),m=a.n(_),g=a(8701),k=a(3201),h=a(2715),v={components:{IonIcon:r.iq,IonLabel:r.he,IonItem:r.uz,IonInput:r.$w,IonList:r.nf,IonAccordion:r.xk,IonAccordionGroup:r.YH,IonText:r.IO,IonSkeletonText:r.ds,IonSearchbar:r.S1,IonChip:r.ZB,IonInfiniteScroll:r.Ax,IonInfiniteScrollContent:r.Hp},props:["permanentTag"],setup(){return{calendarOutline:c.RXF,addOutline:c.EKF,closeCircle:c.P0k,pricetagOutline:c.eOv,refreshOutline:c.mVv,calculatorOutline:c.N0h}},data(){const t=k.A.date.today(),e=k.A.date.firstDay(-1);return{balance:"-",start_at:k.A.date.toIso(e),finish_at:k.A.date.toIso(t),searchQuery:"",tagQuery:"",tagDict:null,ledger:null,meta:{},today:t,settingsType:null,can_reload_at:0}},computed:{ledgerCalc(){if(null==this.ledger)return null;let t=[];for(let i of this.ledger){var e,a,l,n;i.date=this.toLocDate(i.trans_date),i.tag_list=null===(e=i.tags)||void 0===e||null===(a=e.substring(1))||void 0===a||null===(l=a.toLowerCase())||void 0===l||null===(n=l.split("|"))||void 0===n?void 0:n.map((t=>t.split("#"))),t.push(i)}return t},is_admin(){return g.A.isAdmin()},start_at_dmy(){return k.A.date.isoToDmy(this.start_at)},finish_at_dmy(){return k.A.date.isoToDmy(this.finish_at)}},watch:{query:function(){this.listGet()}},methods:{async listLoadMore(t){await this.listGet("append"),t.target.complete()},async listGet(t){const e=Date.now();if(t||!(this.can_reload_at>e)){this.can_reload_at=e+1e3;try{var a,l,n;const e=null===(a=Object.keys(null!==(l=this.tagDict)&&void 0!==l?l:{}))||void 0===a?void 0:a.join(" "),d={start_at:this.start_at,finish_at:this.finish_at,tagQuery:`${e} ${null!==(n=this.permanentTag)&&void 0!==n?n:""}`,searchQuery:this.searchQuery,limit:10};var i,s;if("append"==t)d.offset=null!==(i=null===(s=this.ledger)||void 0===s?void 0:s.length)&&void 0!==i?i:0,d.limit=10;const u=await m().post(`${this.$heap.state.hostname}Transaction/listGet`,d);var o;if("append"==t)null!==(o=this.ledger)&&void 0!==o||(this.ledger=[]),u.ledger=this.ledger.concat(u.ledger);this.ledger=u.ledger,this.meta=u.meta,this.balance=u.meta.sum_finish}catch(r){var d,u;const t=null===r||void 0===r||null===(d=r.responseJSON)||void 0===d||null===(u=d.messages)||void 0===u?void 0:u.error;switch(t){case"large_interval":this.$flash("Период должен быть не больше 3 месяцев");break;default:this.$flash("Ошибка получения выписки");break}return this.ledger=[],this.balance=0,!1}}},toLocDate(t){const e=new Date(Date.parse(t)),a={month:"short",day:"numeric"};return e.toLocaleDateString(void 0,a)},itemClick(t){g.A.isAdmin()&&this.$go(`/admin/transaction-edit-${t}`)},async itemTagPick(t){var e,a,l,n;const i=await r.OZ.create({component:h.A,componentProps:{itemType:t},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});i.present(),this.$topic.on("dismissModal",(()=>{i.dismiss()}));const s=await i.onDidDismiss();s.data&&(null!==(e=s.data.order_id)&&void 0!==e&&e&&this.itemTagAdd([`order:${s.data.order_id}`,`заказ ${s.data.order_id}`]),null!==(a=s.data.store_id)&&void 0!==a&&a&&this.itemTagAdd([`store:${s.data.store_id}`,`продавец ${s.data.store_name}`]),null!==(l=s.data.courier_id)&&void 0!==l&&l&&this.itemTagAdd([`courier:${s.data.courier_id}`,`курьер ${s.data.courier_name}`]),null!==(n=s.data.type)&&void 0!==n&&n&&this.itemTagAdd([`acc::${s.data.type}`,`счет ${s.data.name}`]))},async itemTagCreate(){const t=await r.k_.create({header:"Тип тега",buttons:[{text:"Заказ",data:"order"},{text:"Продавец",data:"store"},{text:"Курьер",data:"courier"},{text:"Счет",data:"acc"}]});await t.present();const e=await t.onDidDismiss();null!==e&&void 0!==e&&e.data&&this.itemTagPick(null===e||void 0===e?void 0:e.data)},itemTagAdd(t){var e;let a=null!==(e=this.tagDict)&&void 0!==e?e:{};a[t[0]]=t[1],this.tagDict=a,this.listGet(),this.settingsType="tags"},itemTagRemove(t){var e;let a=null!==(e=this.tagDict)&&void 0!==e?e:{};a[t]&&delete a[t];const l=Object.keys(a).length;this.tagDict=l?a:null,this.listGet(),this.settingsType="tags"}},mounted(){this.listGet()}},p=a(6262);const f=(0,p.A)(v,[["render",u]]);var y=f}}]);
//# sourceMappingURL=8062.0fc2f2ae.js.map