"use strict";(self["webpackChunktezkel"]=self["webpackChunktezkel"]||[]).push([[5256],{6452:function(e,t,o){o.r(t),o.d(t,{default:function(){return Q}});var r=o(641);const i={key:0,style:{display:"flex","align-items":"center","justify-content":"center",height:"100%"}},a={style:{width:"max-content","text-align":"center"}},n={key:1},l={key:2};function s(e,t,o,s,d,c){var u;const _=(0,r.g2)("ion-icon"),h=(0,r.g2)("ion-label"),m=(0,r.g2)("shipment-draft-comp"),p=(0,r.g2)("shipment-comp"),f=(0,r.g2)("order-tracking-comp"),k=(0,r.g2)("order-info-comp"),g=(0,r.g2)("image-tile-comp"),b=(0,r.g2)("order-history-comp"),v=(0,r.g2)("order-meta-comp"),y=(0,r.g2)("ion-item"),F=(0,r.g2)("ion-list"),D=(0,r.g2)("ion-content"),C=(0,r.g2)("ion-popover"),$=(0,r.g2)("base-layout");return(0,r.uX)(),(0,r.Wv)($,{pageTitle:"Вызов курьера "+(null!==(u=d.order)&&void 0!==u&&u.deleted_at?"(Удален)":""),pageDefaultBackLink:"/order/order-list"},{default:(0,r.k6)(()=>{var e,o,u,$;return["notfound"==d.order?((0,r.uX)(),(0,r.CE)("div",i,[(0,r.Lk)("div",a,[(0,r.bF)(_,{icon:s.sparklesOutline,size:"large"},null,8,["icon"]),(0,r.bF)(h,null,{default:(0,r.k6)(()=>t[7]||(t[7]=[(0,r.eW)("Заказ не найден")])),_:1,__:[7]}),t[8]||(t[8]=(0,r.Lk)("br",null,null,-1)),t[9]||(t[9]=(0,r.Lk)("a",{href:"/order/order-list"},"список заказов",-1))])])):(0,r.Q3)("",!0),1==d.is_draft?((0,r.uX)(),(0,r.CE)("div",n,[(0,r.bF)(m,{orderData:d.order,onStageCreate:c.onStageCreate,onOrderUpdate:c.itemUpdate,onLocationUpdate:c.locationUpdate},null,8,["orderData","onStageCreate","onOrderUpdate","onLocationUpdate"])])):(0,r.Q3)("",!0),0==d.is_draft?((0,r.uX)(),(0,r.CE)("div",l,[(0,r.bF)(p,{orderData:d.order,onStageCreate:c.onStageCreate,onOrderRefresh:c.itemGet},null,8,["orderData","onStageCreate","onOrderRefresh"]),(0,r.bF)(f,{orderData:d.order},null,8,["orderData"]),(0,r.bF)(k,{orderData:d.order},null,8,["orderData"]),null!==(e=d.order)&&void 0!==e&&e.images?((0,r.uX)(),(0,r.Wv)(g,{key:0,images:null===(o=d.order)||void 0===o?void 0:o.images,image_holder_id:null===(u=d.order)||void 0===u?void 0:u.order_id,controller:"Order",ref:"orderImgs"},null,8,["images","image_holder_id"])):(0,r.Q3)("",!0),(0,r.bF)(b,{orderData:d.order},null,8,["orderData"]),"system_finish"==(null===($=d.order)||void 0===$?void 0:$.stage_current)?((0,r.uX)(),(0,r.Wv)(v,{key:1,orderId:d.order_id},null,8,["orderId"])):(0,r.Q3)("",!0),(0,r.bF)(C,{"is-open":d.isOpenDeliveryRejectionPopover,onDidDismiss:t[6]||(t[6]=e=>d.isOpenDeliveryRejectionPopover=!1)},{default:(0,r.k6)(()=>[(0,r.bF)(D,null,{default:(0,r.k6)(()=>[(0,r.bF)(F,null,{default:(0,r.k6)(()=>[(0,r.bF)(y,{button:!0,detail:!1,onClick:t[0]||(t[0]=e=>c.action_rejected_reason("Посылка не готова к отправке, к приезду курьера"))},{default:(0,r.k6)(()=>[(0,r.bF)(h,null,{default:(0,r.k6)(()=>t[10]||(t[10]=[(0,r.eW)("Посылка не готова")])),_:1,__:[10]})]),_:1}),(0,r.bF)(y,{button:!0,detail:!1,onClick:t[1]||(t[1]=e=>c.action_rejected_reason("Посылка больше или тяжелее чем предусмотрено условиями"))},{default:(0,r.k6)(()=>[(0,r.bF)(h,null,{default:(0,r.k6)(()=>t[11]||(t[11]=[(0,r.eW)("Посылка большая или тяжелая")])),_:1,__:[11]})]),_:1}),(0,r.bF)(y,{button:!0,detail:!1,onClick:t[2]||(t[2]=e=>c.action_rejected_reason("ДОСТАВКА НЕ УДАЛАСЬ: Получатель не принял посылку"))},{default:(0,r.k6)(()=>[(0,r.bF)(h,null,{default:(0,r.k6)(()=>t[12]||(t[12]=[(0,r.eW)("Отказ получателя")])),_:1,__:[12]})]),_:1}),(0,r.bF)(y,{button:!0,detail:!1,onClick:t[3]||(t[3]=e=>c.action_rejected_reason("ДОСТАВКА НЕ УДАЛАСЬ: Поломка в пути"))},{default:(0,r.k6)(()=>[(0,r.bF)(h,null,{default:(0,r.k6)(()=>t[13]||(t[13]=[(0,r.eW)("Поломка в пути")])),_:1,__:[13]})]),_:1}),(0,r.bF)(y,{button:!0,detail:!1,onClick:t[4]||(t[4]=e=>c.action_rejected_reason("ДОСТАВКА НЕ УДАЛАСЬ: Заказ испорчен"))},{default:(0,r.k6)(()=>[(0,r.bF)(h,null,{default:(0,r.k6)(()=>t[14]||(t[14]=[(0,r.eW)("Заказ испорчен")])),_:1,__:[14]})]),_:1}),(0,r.bF)(y,{button:!0,detail:!1,onClick:t[5]||(t[5]=e=>c.action_objection())},{default:(0,r.k6)(()=>[(0,r.bF)(h,null,{default:(0,r.k6)(()=>t[15]||(t[15]=[(0,r.eW)("Другая причина")])),_:1,__:[15]})]),_:1})]),_:1})]),_:1})]),_:1},8,["is-open"])])):(0,r.Q3)("",!0)]}),_:1},8,["pageTitle"])}o(4114);var d=o(5480),c=o(5634),u=o(1723),_=o(33);const h={key:0},m=["href"],p={key:0,style:{padding:"10px","background-color":"var(--ion-color-light)",color:"#666","border-radius":"10px",display:"inline-block"}},f=["href"],k=["href"],g={key:0,style:{padding:"10px","background-color":"var(--ion-color-light)",color:"#333","border-radius":"10px",display:"inline-block"}},b=["href"],v={key:1};function y(e,t,o,i,a,n){var l,s;const d=(0,r.g2)("ion-icon"),c=(0,r.g2)("ion-label"),u=(0,r.g2)("ion-chip"),y=(0,r.g2)("ion-item"),F=(0,r.g2)("ion-text"),D=(0,r.g2)("ion-item-divider"),C=(0,r.g2)("ion-card-content"),$=(0,r.g2)("ion-card"),O=(0,r.g2)("ion-img"),S=(0,r.g2)("ion-thumbnail"),w=(0,r.g2)("ion-list"),I=(0,r.g2)("ion-accordion"),W=(0,r.g2)("ion-accordion-group"),x=(0,r.g2)("ion-card-title"),L=(0,r.g2)("ion-card-header"),X=(0,r.g2)("ion-button"),j=(0,r.g2)("ion-col"),A=(0,r.g2)("ion-row"),T=(0,r.g2)("ion-grid"),E=(0,r.g2)("ion-skeleton-text");return o.orderData?((0,r.uX)(),(0,r.CE)("div",h,[(0,r.bF)(w,{lines:"none"},{default:(0,r.k6)(()=>{var a;return[(0,r.bF)(y,null,{default:(0,r.k6)(()=>[o.orderData.stage_current_name?((0,r.uX)(),(0,r.Wv)(u,{key:0,color:"primary",slot:"end"},{default:(0,r.k6)(()=>[(0,r.bF)(d,{icon:i.checkmarkOutline},null,8,["icon"]),(0,r.bF)(c,{color:"dark"},{default:(0,r.k6)(()=>[(0,r.eW)((0,_.v_)(o.orderData.stage_current_name),1)]),_:1})]),_:1})):(0,r.Q3)("",!0)]),_:1}),(0,r.bF)(y,null,{default:(0,r.k6)(()=>t[1]||(t[1]=[(0,r.eW)(" Посылка ")])),_:1,__:[1]}),(0,r.bF)(y,null,{default:(0,r.k6)(()=>[(0,r.bF)(d,{src:i.cubeOutline,slot:"start",size:"large",color:"medium",style:{"font-size":"2em"}},null,8,["src"]),(0,r.bF)(F,{color:"dark"},{default:(0,r.k6)(()=>[(0,r.Lk)("b",null,(0,_.v_)(o.orderData.order_description),1)]),_:1})]),_:1}),(0,r.bF)(D,null,{default:(0,r.k6)(()=>t[2]||(t[2]=[(0,r.eW)("Доставка")])),_:1,__:[2]}),null!==(a=o.orderData)&&void 0!==a&&a.finish_plan_scheduled?((0,r.uX)(),(0,r.Wv)($,{key:0,color:"primary",onClick:t[0]||(t[0]=e=>n.timePlanInfo())},{default:(0,r.k6)(()=>[(0,r.bF)(C,null,{default:(0,r.k6)(()=>{var e;return[t[3]||(t[3]=(0,r.Lk)("small",null,"Запланированое время доставки",-1)),t[4]||(t[4]=(0,r.eW)()),(0,r.Lk)("b",null,(0,_.v_)(null===(e=o.orderData)||void 0===e?void 0:e.finish_plan_scheduled),1)]}),_:1,__:[3,4]})]),_:1})):(0,r.Q3)("",!0),(0,r.bF)(y,null,{default:(0,r.k6)(()=>[(0,r.bF)(d,{color:"medium",src:i.locationOutline,slot:"start"},null,8,["src"]),t[5]||(t[5]=(0,r.eW)(" Откуда "))]),_:1,__:[5]}),(0,r.bF)(y,null,{default:(0,r.k6)(()=>{var t;return[null!==(t=o.orderData.locationStart)&&void 0!==t&&t.image_hash?((0,r.uX)(),(0,r.Wv)(S,{key:0,slot:"start",style:{"--size":"20px"}},{default:(0,r.k6)(()=>{var t;return[(0,r.bF)(O,{src:`${e.$heap.state.hostname}image/get.php/${null===(t=o.orderData.locationStart)||void 0===t?void 0:t.image_hash}.150.150.webp`},null,8,["src"])]}),_:1})):((0,r.uX)(),(0,r.Wv)(d,{key:1,color:"primary",src:i.locationOutline,slot:"start"},null,8,["src"])),(0,r.bF)(F,null,{default:(0,r.k6)(()=>[(0,r.Lk)("a",{href:`https://yandex.ru/maps/?pt=${o.orderData.locationStart.location_longitude},${o.orderData.locationStart.location_latitude}&z=19&l=map,trf`,target:"_new"},(0,_.v_)(o.orderData.locationStart.location_address),9,m)]),_:1})]}),_:1}),o.orderData.locationStart.location_comment||o.orderData.locationStart.location_phone>0?((0,r.uX)(),(0,r.Wv)(y,{key:1},{default:(0,r.k6)(()=>[(0,r.Lk)("div",null,[o.orderData.locationStart.location_comment?((0,r.uX)(),(0,r.CE)("div",p,(0,_.v_)(o.orderData.locationStart.location_comment),1)):(0,r.Q3)("",!0),o.orderData.locationStart.location_phone>0?((0,r.uX)(),(0,r.Wv)(u,{key:1,color:"medium"},{default:(0,r.k6)(()=>[(0,r.bF)(d,{src:i.callOutline},null,8,["src"]),(0,r.Lk)("a",{href:"tel:+"+o.orderData.locationStart.location_phone},"+"+(0,_.v_)(o.orderData.locationStart.location_phone),9,f)]),_:1})):(0,r.Q3)("",!0)])]),_:1})):(0,r.Q3)("",!0),(0,r.bF)(y,null,{default:(0,r.k6)(()=>[(0,r.bF)(d,{color:"medium",src:i.flagOutline,slot:"start"},null,8,["src"]),t[6]||(t[6]=(0,r.eW)(" Куда "))]),_:1,__:[6]}),(0,r.bF)(y,null,{default:(0,r.k6)(()=>{var t;return[null!==(t=o.orderData.locationFinish)&&void 0!==t&&t.image_hash?((0,r.uX)(),(0,r.Wv)(S,{key:0,slot:"start",style:{"--size":"20px"}},{default:(0,r.k6)(()=>{var t;return[(0,r.bF)(O,{src:`${e.$heap.state.hostname}image/get.php/${null===(t=o.orderData.locationFinish)||void 0===t?void 0:t.image_hash}.150.150.webp`},null,8,["src"])]}),_:1})):((0,r.uX)(),(0,r.Wv)(d,{key:1,color:"primary",src:i.flagOutline,slot:"start"},null,8,["src"])),(0,r.bF)(F,null,{default:(0,r.k6)(()=>[(0,r.Lk)("a",{href:`https://yandex.ru/maps/?pt=${o.orderData.locationFinish.location_longitude},${o.orderData.locationFinish.location_latitude}&z=19&l=map,trf`,target:"_new"},(0,_.v_)(o.orderData.locationFinish.location_address),9,k)]),_:1})]}),_:1}),o.orderData.locationFinish.location_comment||o.orderData.locationFinish.location_phone>0?((0,r.uX)(),(0,r.Wv)(y,{key:2},{default:(0,r.k6)(()=>[(0,r.Lk)("div",null,[o.orderData.locationFinish.location_comment?((0,r.uX)(),(0,r.CE)("div",g,(0,_.v_)(o.orderData.locationFinish.location_comment),1)):(0,r.Q3)("",!0),o.orderData.locationFinish.location_phone>0?((0,r.uX)(),(0,r.Wv)(u,{key:1,color:"medium"},{default:(0,r.k6)(()=>[(0,r.bF)(d,{src:i.callOutline},null,8,["src"]),(0,r.Lk)("a",{href:"tel:+"+o.orderData.locationFinish.location_phone},"+"+(0,_.v_)(o.orderData.locationFinish.location_phone),9,b)]),_:1})):(0,r.Q3)("",!0)])]),_:1})):(0,r.Q3)("",!0),(0,r.bF)(D,null,{default:(0,r.k6)(()=>t[7]||(t[7]=[(0,r.eW)("Итог")])),_:1,__:[7]}),(0,r.bF)(W,null,{default:(0,r.k6)(()=>[(0,r.bF)(I,null,{default:(0,r.k6)(()=>[(0,r.bF)(y,{slot:"header"},{default:(0,r.k6)(()=>[(0,r.bF)(d,{icon:i.walletOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,r.bF)(F,{color:"medium"},{default:(0,r.k6)(()=>t[8]||(t[8]=[(0,r.eW)("Итого: ")])),_:1,__:[8]}),(0,r.bF)(c,{slot:"end",color:"primary"},{default:(0,r.k6)(()=>[(0,r.eW)((0,_.v_)(o.orderData.order_sum_total)+(0,_.v_)(e.$heap.state.currencySign),1)]),_:1})]),_:1}),(0,r.bF)(w,{slot:"content"},{default:(0,r.k6)(()=>[(0,r.bF)(y,{lines:"none"},{default:(0,r.k6)(()=>[(0,r.bF)(F,{color:"medium"},{default:(0,r.k6)(()=>t[9]||(t[9]=[(0,r.eW)("Доставка")])),_:1,__:[9]}),(0,r.bF)(c,{slot:"end",color:"primary"},{default:(0,r.k6)(()=>[(0,r.eW)((0,_.v_)(o.orderData.order_sum_delivery)+(0,_.v_)(e.$heap.state.currencySign),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]}),_:1}),(0,r.Q3)("",!0),o.orderData.order_objection?((0,r.uX)(),(0,r.Wv)($,{key:1,color:"warning"},{default:(0,r.k6)(()=>[(0,r.bF)(L,null,{default:(0,r.k6)(()=>[(0,r.bF)(x,null,{default:(0,r.k6)(()=>t[11]||(t[11]=[(0,r.eW)("Проблема с заказом")])),_:1,__:[11]})]),_:1}),(0,r.bF)(C,null,{default:(0,r.k6)(()=>[(0,r.eW)((0,_.v_)(o.orderData.order_objection),1)]),_:1})]),_:1})):(0,r.Q3)("",!0),null!==(l=o.orderData)&&void 0!==l&&null!==(s=l.info)&&void 0!==s&&s.tariff_info?((0,r.uX)(),(0,r.Wv)($,{key:2,color:"light"},{default:(0,r.k6)(()=>[(0,r.bF)(C,null,{default:(0,r.k6)(()=>[(0,r.bF)(F,{innerHTML:o.orderData.info.tariff_info},null,8,["innerHTML"])]),_:1})]),_:1})):(0,r.Q3)("",!0),(0,r.bF)(T,null,{default:(0,r.k6)(()=>[(0,r.bF)(A,null,{default:(0,r.k6)(()=>[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(n.nextStageButtons,(e,t)=>((0,r.uX)(),(0,r.Wv)(j,{key:t},{default:(0,r.k6)(()=>[e[0]?((0,r.uX)(),(0,r.Wv)(X,{key:0,onClick:r=>n.stageCreate(o.orderData.order_id,t,e[1]),expand:"block",color:e[1]??"primary",fill:e[2]??"solid"},{default:(0,r.k6)(()=>[(0,r.bF)(d,{slot:"start",src:e.icon},null,8,["src"]),(0,r.eW)(" "+(0,_.v_)(e[0]),1)]),_:2},1032,["onClick","color","fill"])):(0,r.Q3)("",!0)]),_:2},1024))),128))]),_:1})]),_:1})])):((0,r.uX)(),(0,r.CE)("div",v,[(0,r.bF)(y,{detail:"",button:"",lines:"none"},{default:(0,r.k6)(()=>[(0,r.bF)(d,{slot:"start",icon:i.storefrontOutline},null,8,["icon"]),(0,r.bF)(E,{animated:"",style:{width:"200px"}})]),_:1}),(0,r.bF)(w,null,{default:(0,r.k6)(()=>[((0,r.uX)(),(0,r.CE)(r.FK,null,(0,r.pI)([1,2,3],e=>(0,r.bF)(y,{key:e},{default:(0,r.k6)(()=>[(0,r.bF)(S,{style:{"background-color":"var(--ion-color-light)"}}),(0,r.bF)(T,null,{default:(0,r.k6)(()=>[(0,r.bF)(j,null,{default:(0,r.k6)(()=>[(0,r.bF)(A,null,{default:(0,r.k6)(()=>[(0,r.bF)(E,{animated:"",style:{width:"100%"}})]),_:1}),(0,r.bF)(A,null,{default:(0,r.k6)(()=>[(0,r.bF)(c,{color:"primary"},{default:(0,r.k6)(()=>[(0,r.bF)(E,{animated:"",style:{width:"100px"}})]),_:1})]),_:1})]),_:1})]),_:1}),t[12]||(t[12]=(0,r.Lk)("div",{slot:"end",style:{position:"relative",width:"120px","min-height":"48px","background-color":"var(--ion-color-light)"}},null,-1))]),_:2,__:[12]},1024)),64))]),_:1}),(0,r.bF)(T,null,{default:(0,r.k6)(()=>[(0,r.bF)(A,null,{default:(0,r.k6)(()=>[((0,r.uX)(),(0,r.CE)(r.FK,null,(0,r.pI)([1,2],e=>(0,r.bF)(j,{key:e},{default:(0,r.k6)(()=>[(0,r.bF)(X,{color:"light",style:{width:"100%"}})]),_:2},1024)),64))]),_:1})]),_:1})]))}var F={props:["orderData"],components:{IonIcon:c.iq,IonText:c.IO,IonLabel:c.he,IonItem:c.uz,IonList:c.nf,IonImg:c.KW,IonThumbnail:c.Zx,IonButton:c.Jm,IonCol:c.hU,IonRow:c.ln,IonGrid:c.lO,IonSkeletonText:c.ds,IonCard:c.b_,IonCardHeader:c.ME,IonCardContent:c.I9,IonCardTitle:c.tN,IonItemDivider:c.Dg,IonAccordion:c.xk,IonAccordionGroup:c.YH,IonChip:c.ZB},setup(){return{add:d.WQq,remove:d.TFI,trash:d.dco,rocketOutline:d.hGQ,storefrontOutline:d.te8,checkmarkOutline:d.g1L,cubeOutline:d.a7r,walletOutline:d.eF1,banOutline:d.Av6,giftOutline:d.Lsq,cardOutline:d.VR9,ribbonOutline:d.rp8,chatboxEllipsesOutline:d.Pkp,locationOutline:d.UN$,flagOutline:d.NBP,chevronDown:d.uaq,addOutline:d.EKF,checkmark:d.AIp,cashOutline:d.A3w,businessOutline:d.FL4,alertCircleOutline:d.ndb,helpCircleOutline:d.W2C,callOutline:d.bNN}},computed:{nextStageButtons(){let e={};for(let t in this.orderData.stage_next)this.orderData.stage_next[t][0]&&(e[t]=this.orderData.stage_next[t],e[t].icon=d.g1L,t.includes("admin")?e[t].icon=d.rp8:t.includes("delivery")?e[t].icon=d.hGQ:t.includes("supplier")&&(e[t].icon=d.te8));return e}},methods:{stageCreate(e,t,o){("danger"!=o||confirm("Вы уверены?"))&&this.$emit("stageCreate",e,t)},async timePlanInfo(){const e=await c.TN.create({header:"Время доставки",message:"Указано приблизительное время. На него влияют длительность приготовления заказа, пробки и другие факторы.",buttons:[{text:"Ок",role:"confirm"}]});await e.present();const{role:t}=await e.onDidDismiss();return"confirm"==t}}},D=o(6262);const C=(0,D.A)(F,[["render",y],["__scopeId","data-v-01103bd8"]]);var $=C,O=o(3545),S=o(5251),w=o(3954),I=o(3919),W=o(2943),x=o(4933),L=o(6383),X=o(3201),j=o(2311),A=o.n(j),T={components:{ShipmentDraftComp:u.A,ShipmentComp:$,OrderHistoryComp:O.A,OrderMetaComp:w.A,OrderInfoComp:S.A,OrderTrackingComp:I.A,ImageTileComp:x.A,IonLabel:c.he,IonIcon:c.iq,IonContent:c.W9,IonItem:c.uz,IonList:c.nf,IonPopover:c.CF},setup(){return{sparklesOutline:d.isq,chatboxOutline:d.ml_}},data(){return{is_draft:null,order_id:this.$route.params.id,order:null,orderAutoloadClock:null,isOpenDeliveryRejectionPopover:!1}},methods:{async itemCreate(){const e=new Date,t={order_store_id:null,order_id:0,entries:[],created_at:e.toISOString().replace(/[T]/g," ").replace(/.\d\d\dZ/,""),stage_next:{customer_confirmed:["Перейти к оформлению"],customer_deleted:["Удалить","danger","clear"]},stage_current:"customer_cart",user_role:"customer"};this.itemSave(t)},async itemGet(){if(this.order_id&&0!=this.order_id)try{this.order=await X.A.prePost(`${this.$heap.state.hostname}Shipment/itemGet`,{order_id:this.order_id}),this.order=await X.A.post(`${this.$heap.state.hostname}Shipment/itemGet`,{order_id:this.order_id}),"customer_cart"==this.order.stage_current?(this.order.deliveryCalculation=await this.itemTotalEstimate(this.order.order_start_location_id,this.order.order_finish_location_id),this.is_draft=1):this.is_draft=0,this.itemAutoReload()}catch(e){switch(e.status){case 404:this.$flash("Заказ не найден"),this.order=null,this.$go("/order/order-list");break}}else this.itemLoad()},async itemLoad(){try{const e=JSON.parse(localStorage.shipmentDraft);if(e)return e.deliveryCalculation=await this.itemTotalEstimate(e.order_start_location_id,e.order_finish_location_id),this.order=e,void(this.is_draft=1)}catch{}this.itemCreate()},itemSave(e){this.order=e,localStorage.shipmentDraft=JSON.stringify(Object.assign({},e,{order_id:0}))},async itemSync(){try{const e={is_shopping:0,order_id:this.order.order_id??null,order_description:this.order.order_description,order_start_location_id:this.order.order_start_location_id,order_finish_location_id:this.order.order_finish_location_id,order_sum_delivery:this.order.deliveryCalculation.sum},t=await A().post(`${this.$heap.state.hostname}Shipment/itemSync`,JSON.stringify(e));t>0&&this.$router.push(`/modal/shipment-checkout-${t}`)}catch(o){var e,t;const r=null===o||void 0===o||null===(e=o.responseJSON)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.error;if(!r)return!1;switch(r){case"address_not_set":this.$flash("Необходимо добавить адрес доставки"),this.$topic.publish("dismissModal"),this.$go("/modal/user-addresses"),this.$heap.state.next_route="/order/shipment-"+this.order_id;break}return!1}},itemAutoReload(){clearTimeout(this.orderAutoloadClock),this.orderAutoloadClock=setTimeout(()=>{this.itemGet()},6e4)},async onStageCreate(e,t){if(1==this.is_draft){if("customer_confirmed"==t)return void this.itemSync();if(("customer_purged"==t||"customer_deleted"==t)&&(localStorage.removeItem("shipmentDraft"),0==e))return this.$router.replace("/order/order-list"),void this.$flash("Заказ удален")}if(t.includes("action")){t=t.split("_").splice(1).join("_");try{this[t](e)}catch(o){console.log("stage handler not found "+t+": ",o)}}else try{const e={order_id:this.order_id,new_stage:t},o=await A().post(`${this.$heap.state.hostname}Shipment/itemStageCreate`,e);if("ok"==o)return"customer_purged"==t||"customer_deleted"==t?(this.order=null,void this.$go("/order/order-list")):(await this.itemGet(),!0)}catch(o){const e=o.responseJSON,t=e.messages.error;switch(t){case"wrong_courier_status":this.$flash("Смена курьера не открыта");break;case"photos_must_be_made":this.$flash("Необходимо сфотографировать заказ"),this.action_take_photo();break;case"address_not_set":this.$flash("Необходимо добавить адрес доставки"),this.$go("/modal/user-addresses");break;case"order_sum_zero":this.$flash("Нельзя завершить пустой заказ, от него можно отказаться.");break;case"already_payed":this.$flash("Заказ уже оплачен");break;default:this.$flash("Не удалось изменить статус заказа");break}return!1}},async action_confirm(e){const t=await this.onStageCreate(e,"customer_confirmed");t&&this.action_checkout()},async action_checkout(){this.$go(`/modal/shipment-checkout-${this.order_id}`)},async action_objection(){const e=await c.OZ.create({component:W.A,initialBreakpoint:.5,breakpoints:[.5,1],canDissmiss:!0});e.present();const t=await e.onDidDismiss();if(t.data){const e=`${t.data}`,o={order_id:this.order_id,order_objection:e},r=await A().post(`${this.$heap.state.hostname}Shipment/itemUpdate`,JSON.stringify(o));if("ok"==r){const e=await this.onStageCreate(this.order_id,"delivery_rejected");e&&this.$flash("Ваше возражение принято и будет рассмотрено администратором.")}}},action_rejected(){this.isOpenDeliveryRejectionPopover=!0},async action_rejected_reason(e){this.isOpenDeliveryRejectionPopover=!1;const t={order_id:this.order_id,order_objection:e};try{await A().post(`${this.$heap.state.hostname}Shipment/itemUpdate`,JSON.stringify(t)),await this.onStageCreate(this.order_id,"delivery_rejected"),this.$flash("Вы отказались от доставки")}catch{}},action_take_photo(){this.$refs.orderImgs.take_photo()},async action_courier_assign(){const e="courier",t={status:"ready||busy"},o=await c.OZ.create({component:L.A,componentProps:{itemType:e,filter:t},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});o.present(),this.$topic.on("dismissModal",()=>{o.dismiss()});const r=await o.onDidDismiss();if(r.data)try{const e={order_id:this.order_id,courier_id:r.data.courier_id};await A().post(`${this.$heap.state.hostname}DeliveryJob/itemAssign`,e),await this.itemGet(),this.$flash("Курьер назначен")}catch{this.$flash("Не удалось назначить курьера")}},async action_customer_start(){this.onStageCreate(this.order_id,"customer_start")},async itemUpdate(e){"refreshTotalEstimates"==e.mode&&(e.deliveryCalculation=await this.itemTotalEstimate(e.order_start_location_id,e.order_finish_location_id)),this.itemSave(Object.assign({},this.order,e))},async itemTotalEstimate(e,t){if(!e||!t)return;const o={start_location_id:e,finish_location_id:t};try{return await A().post(`${this.$heap.state.hostname}Shipment/itemDeliverySumEstimate`,o)}catch(r){}},async locationUpdate(e){try{await A().post(`${this.$heap.state.hostname}Location/itemUpdate`,JSON.stringify(e)),this.$flash("💾 Сохранено")}catch{}}},ionViewDidEnter(){this.itemGet()},ionViewDidLeave(){clearTimeout(this.orderAutoloadClock)},created(){this.itemGet(),this.$topic.on("orderSumChanged",()=>this.itemGet("skipCaching")),this.$topic.on("pushStageChanged",e=>{var t;(null===(t=this.order)||void 0===t?void 0:t.order_id)==(null===e||void 0===e?void 0:e.order_id)&&this.order.stage_current!=e.stage&&this.itemGet()})}};const E=(0,D.A)(T,[["render",s]]);var Q=E}}]);
//# sourceMappingURL=5256.d9ace4ba.js.map