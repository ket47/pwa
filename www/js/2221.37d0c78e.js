"use strict";(self["webpackChunkTezkel"]=self["webpackChunkTezkel"]||[]).push([[2221],{2221:function(e,t,r){r.r(t),r.d(t,{default:function(){return w}});var i=r(641),a=r(33);const n=e=>((0,i.Qi)("data-v-513f9c99"),e=e(),(0,i.jt)(),e),l=n((()=>(0,i.Lk)("p",null,"Сегодня доставить уже не сможем",-1))),o=n((()=>(0,i.Lk)("span",null,"как можно скорее",-1))),d=n((()=>(0,i.Lk)("span",null,"заказ в очереди",-1))),s=n((()=>(0,i.Lk)("b",null,"Запланировать",-1))),u={key:0},c={key:1},h={style:{"font-size":"0.7em",color:"var(--ion-color-medium)"}},m={key:2},p={key:0};function _(e,t,r,n,_,f){const y=(0,i.g2)("ion-item-divider"),k=(0,i.g2)("ion-item"),v=(0,i.g2)("ion-card-title"),b=(0,i.g2)("ion-card-header"),C=(0,i.g2)("ion-card-content"),g=(0,i.g2)("ion-card"),F=(0,i.g2)("ion-label"),S=(0,i.g2)("ion-segment-button"),$=(0,i.g2)("ion-segment"),w=(0,i.g2)("ion-icon"),W=(0,i.g2)("ion-radio"),P=(0,i.g2)("ion-img"),O=(0,i.g2)("ion-radio-group"),I=(0,i.g2)("ion-text"),R=(0,i.g2)("ion-list"),D=(0,i.g2)("ion-accordion"),L=(0,i.g2)("ion-accordion-group"),T=(0,i.g2)("router-link"),A=(0,i.g2)("ion-checkbox"),B=(0,i.g2)("ion-button"),X=(0,i.g2)("base-layout");return(0,i.uX)(),(0,i.Wv)(X,{pageTitle:"Оформление доставки посылки",pageDefaultBackLink:`/order/shipment-${_.order_id}`,ref:"page"},{default:(0,i.k6)((()=>[(0,i.bF)(R,{lines:"none"},{default:(0,i.k6)((()=>[(0,i.bF)(y,{style:{"margin-top":"0px","box-shadow":"none"}},{default:(0,i.k6)((()=>[(0,i.eW)("Доставка")])),_:1}),(0,i.bF)(k),"scheduled"==this.routePlan.start_plan_mode?((0,i.uX)(),(0,i.Wv)(g,{key:0,color:"light"},{default:(0,i.k6)((()=>[(0,i.bF)(b,null,{default:(0,i.k6)((()=>[(0,i.bF)(v,null,{default:(0,i.k6)((()=>[(0,i.eW)(" Запланировать заказ ")])),_:1})])),_:1}),(0,i.bF)(C,null,{default:(0,i.k6)((()=>[l])),_:1})])),_:1})):(0,i.Q3)("",!0),(0,i.bF)(k,null,{default:(0,i.k6)((()=>[(0,i.bF)($,{mode:"ios",modelValue:_.deliveryPlanMode,"onUpdate:modelValue":t[3]||(t[3]=e=>_.deliveryPlanMode=e)},{default:(0,i.k6)((()=>[f.isAtonceEnabled?((0,i.uX)(),(0,i.Wv)(S,{key:0,value:"inited",onClick:t[0]||(t[0]=e=>_.deliveryFinishScheduled=null)},{default:(0,i.k6)((()=>[(0,i.bF)(F,null,{default:(0,i.k6)((()=>[(0,i.eW)("Отвезти сразу")])),_:1}),o])),_:1})):((0,i.uX)(),(0,i.Wv)(S,{key:1,value:"awaited",onClick:t[1]||(t[1]=e=>_.deliveryFinishScheduled=null)},{default:(0,i.k6)((()=>[(0,i.bF)(F,null,{default:(0,i.k6)((()=>[(0,i.eW)("Подождать")])),_:1}),d])),_:1})),(0,i.bF)(S,{value:"scheduled",onClick:t[2]||(t[2]=e=>f.datetimePick())},{default:(0,i.k6)((()=>[(0,i.bF)(F,null,{default:(0,i.k6)((()=>[s])),_:1}),f.deliveryFinishLocal?((0,i.uX)(),(0,i.CE)("span",u,(0,a.v_)(f.deliveryFinishLocal),1)):((0,i.uX)(),(0,i.CE)("span",c,"выберите день и время"))])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,i.bF)(y,null,{default:(0,i.k6)((()=>[(0,i.eW)("Оплата")])),_:1}),(0,i.bF)(O,{modelValue:_.paymentType,"onUpdate:modelValue":t[8]||(t[8]=e=>_.paymentType=e)},{default:(0,i.k6)((()=>{var r,l;return[1==_.tariffRule.paymentByCreditStore?((0,i.uX)(),(0,i.Wv)(k,{key:0,button:"",detail:"false",onClick:t[4]||(t[4]=e=>_.paymentType="use_credit_store")},{default:(0,i.k6)((()=>[(0,i.bF)(w,{icon:n.businessOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,i.bF)(W,{value:"use_credit_store"},{default:(0,i.k6)((()=>[(0,i.eW)(" Со счета предприятия "),(0,i.Lk)("div",h,(0,a.v_)(_.tariffRule.storeCreditName)+" "+(0,a.v_)(_.tariffRule.storeCreditBalance)+(0,a.v_)(e.$heap.state.currencySign),1)])),_:1})])),_:1})):(0,i.Q3)("",!0),1==_.tariffRule.paymentByCash?((0,i.uX)(),(0,i.Wv)(k,{key:1,button:"",detail:"false",onClick:t[5]||(t[5]=e=>_.paymentType="use_cash")},{default:(0,i.k6)((()=>[(0,i.bF)(w,{icon:n.cashOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,i.bF)(W,{value:"use_cash"},{default:(0,i.k6)((()=>[(0,i.eW)(" Оплата наличными ")])),_:1})])),_:1})):(0,i.Q3)("",!0),1==_.tariffRule.paymentByCard?((0,i.uX)(),(0,i.CE)("div",m,[(0,i.bF)(k,{detail:"false",button:""},{default:(0,i.k6)((()=>[(0,i.bF)(w,{icon:n.cardOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,i.bF)(W,{value:"use_card"},{default:(0,i.k6)((()=>[(0,i.eW)(" Банковская карта ")])),_:1})])),_:1}),null!==(r=f.bankCardCalc)&&void 0!==r&&r.card_type?((0,i.uX)(),(0,i.Wv)(k,{key:0,button:"",detail:"false"},{default:(0,i.k6)((()=>[f.bankCardCalc.card_type?((0,i.uX)(),(0,i.Wv)(P,{key:0,style:{width:"22px",height:"auto"},src:`/img/icons/card-${f.bankCardCalc.card_type.toLowerCase()}.svg`,slot:"start"},null,8,["src"])):((0,i.uX)(),(0,i.Wv)(w,{key:1,src:n.cardOutline,slot:"start",color:"medium"},null,8,["src"])),(0,i.bF)(W,{value:"use_card_recurrent"},{default:(0,i.k6)((()=>[(0,i.eW)(" Сохраненная карта "+(0,a.v_)(f.bankCardCalc.label),1)])),_:1})])),_:1})):(0,i.Q3)("",!0),null!==(l=f.bankCardCalc)&&void 0!==l&&l.card_type?((0,i.uX)(),(0,i.Wv)(k,{key:1,button:"",detail:"",onClick:t[6]||(t[6]=t=>e.$go("/user/user-cards"))},{default:(0,i.k6)((()=>[(0,i.bF)(F,{color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)("Выбрать другую карту")])),_:1})])),_:1})):_.recurrentPaymentAllow?((0,i.uX)(),(0,i.Wv)(k,{key:2,button:"",detail:"",onClick:t[7]||(t[7]=t=>e.$go("/user/user-cards"))},{default:(0,i.k6)((()=>[(0,i.bF)(w,{icon:n.addOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,i.bF)(F,{color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)("Добавить карту")])),_:1})])),_:1})):(0,i.Q3)("",!0)])):(0,i.Q3)("",!0)]})),_:1},8,["modelValue"]),(0,i.bF)(y,null,{default:(0,i.k6)((()=>[(0,i.eW)("Итог")])),_:1}),(0,i.bF)(L,{value:"total"},{default:(0,i.k6)((()=>[(0,i.bF)(D,{value:"total"},{default:(0,i.k6)((()=>[(0,i.bF)(k,{slot:"header"},{default:(0,i.k6)((()=>[(0,i.bF)(w,{icon:n.walletOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,i.bF)(I,{color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)("Итого: ")])),_:1}),(0,i.bF)(F,{slot:"end",color:"primary"},{default:(0,i.k6)((()=>[(0,i.eW)((0,a.v_)(_.tariffRule.deliverySum)+(0,a.v_)(e.$heap.state.currencySign),1)])),_:1})])),_:1}),(0,i.bF)(R,{slot:"content"},{default:(0,i.k6)((()=>[(0,i.bF)(k,{lines:"none"},{default:(0,i.k6)((()=>[(0,i.bF)(w,{icon:n.rocketOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,i.bF)(I,{color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)("Вызов курьера")])),_:1}),(0,i.bF)(F,{slot:"end",color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)((0,a.v_)(_.tariffRule.deliveryCost)+(0,a.v_)(e.$heap.state.currencySign),1)])),_:1})])),_:1}),(0,i.bF)(k,{lines:"none"},{default:(0,i.k6)((()=>[(0,i.bF)(w,{icon:n.mapOutline,slot:"start",color:"medium"},null,8,["icon"]),(0,i.bF)(I,{color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)("Расстояние по карте "+(0,a.v_)(f.deliveryDistanceKm)+"км",1)])),_:1}),(0,i.bF)(F,{slot:"end",color:"medium"},{default:(0,i.k6)((()=>[(0,i.eW)((0,a.v_)(f.deliveryFeeTotal)+(0,a.v_)(e.$heap.state.currencySign),1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),(0,i.bF)(k,null,{default:(0,i.k6)((()=>[(0,i.bF)(I,{style:{"font-size":"0.9em"}},{default:(0,i.k6)((()=>[(0,i.eW)(" Я согласен(на) с "),(0,i.bF)(T,{to:"/page/rules-customer"},{default:(0,i.k6)((()=>[(0,i.eW)("офертой об оказании услуг доставки")])),_:1})])),_:1}),(0,i.bF)(A,{slot:"end",modelValue:_.termsAccepted,"onUpdate:modelValue":t[9]||(t[9]=e=>_.termsAccepted=e),"aria-label":""},null,8,["modelValue"])])),_:1})])),_:1}),f.checkoutError?((0,i.uX)(),(0,i.Wv)(g,{key:0,color:"warning"},{default:(0,i.k6)((()=>[(0,i.bF)(C,null,{default:(0,i.k6)((()=>[(0,i.eW)((0,a.v_)(f.checkoutError),1)])),_:1})])),_:1})):"awaited"==_.deliveryPlanMode?((0,i.uX)(),(0,i.Wv)(g,{key:1,color:"light",onClick:t[10]||(t[10]=e=>f.heavyLoadInfo())},{default:(0,i.k6)((()=>[(0,i.bF)(C,null,{default:(0,i.k6)((()=>["awaited"==_.deliveryPlanMode?((0,i.uX)(),(0,i.CE)("p",p,"Высокая загруженность")):(0,i.Q3)("",!0),(0,i.eW)(" Планируемое время доставки "+(0,a.v_)(f.deliveryFinishRange)+" ",1),(0,i.bF)(w,{src:n.alertCircleOutline,color:"warning"},null,8,["src"]),(0,i.eW)(". ")])),_:1})])),_:1})):(0,i.Q3)("",!0),"use_card"==_.paymentType||"use_card_recurrent"==_.paymentType?((0,i.uX)(),(0,i.Wv)(B,{key:2,expand:"block",onClick:t[11]||(t[11]=e=>f.proceed()),disabled:f.checkoutError},{default:(0,i.k6)((()=>[(0,i.eW)("Оплатить картой")])),_:1},8,["disabled"])):((0,i.uX)(),(0,i.Wv)(B,{key:3,expand:"block",onClick:t[12]||(t[12]=e=>f.proceed()),disabled:f.checkoutError},{default:(0,i.k6)((()=>[(0,i.eW)("Вызвать курьера")])),_:1},8,["disabled"]))])),_:1},8,["pageDefaultBackLink"])}var f=r(5654),y=r(5480),k=r(3201),v=r(2311),b=r.n(v),C=r(6794),g=r(9369),F={components:{IonText:f.IO,IonList:f.nf,IonItem:f.uz,IonIcon:f.iq,IonLabel:f.he,IonSegment:f.Gp,IonSegmentButton:f.eP,IonImg:f.KW,IonCard:f.b_,IonCardContent:f.I9,IonCardHeader:f.ME,IonCardTitle:f.tN,IonButton:f.Jm,IonCheckbox:f.eY,IonItemDivider:f.Dg,IonRadioGroup:f.f0,IonRadio:f.KO,IonAccordion:f.xk,IonAccordionGroup:f.YH},setup(){return{cubeOutline:y.a7r,locationOutline:y.UN$,flagOutline:y.NBP,chevronDown:y.uaq,addOutline:y.EKF,checkmark:y.AIp,cardOutline:y.VR9,cashOutline:y.A3w,businessOutline:y.FL4,walletOutline:y.eF1,alertCircleOutline:y.ndb,mapOutline:y.dG8,rocketOutline:y.hGQ}},data(){var e,t;return{order_id:this.$route.params.id,order:null,finishPlanSchedule:null,bankCard:null,routePlan:{start_plan_mode:"inited"},tariffRule:{},tariffRuleList:[],errorCode:null,paymentType:"use_card",shipAutoloadClock:null,termsAccepted:1,iplocation:null,recurrentPaymentAllow:1==(null===(e=this.$heap.state.settings)||void 0===e||null===(t=e.other)||void 0===t?void 0:t.recurrentPaymentAllow)?1:0,deliveryFinishScheduled:null,deliveryPlanMode:"inited"}},computed:{deliveryFinishLocal(){if(!this.deliveryFinishScheduled)return null;const e={month:"short",day:"numeric",hour:"numeric",minute:"numeric"},t=new Date(Date.parse(this.deliveryFinishScheduled));return t.toLocaleDateString(void 0,e)},deliveryFinishRange(){const e=1*this.routePlan.start_plan+1*this.routePlan.finish_arrival;if(!e)return null;const t=900,r=Math.floor(e/t)*t,i=r+t,a=new Date(1e3*r),n=new Date(1e3*i);try{return`${a.getHours()}:${String(a.getMinutes()).padStart(2,"0")}-${n.getHours()}:${String(n.getMinutes()).padStart(2,"0")}`}catch{}return null},isAtonceEnabled(){return["inited"].includes(this.routePlan.start_plan_mode)},deliveryFeeTotal(){return Math.round(this.tariffRule.deliveryFee*this.deliveryDistanceKm)||0},deliveryDistanceKm(){return Math.round(this.routePlan.deliveryDistance/100)/10||0},checkoutError(){return"no_input"==this.errorCode?"Выберите адрес забора и доставки посылки":"start_center_toofar"==this.errorCode?"Адрес получения посылки слишком удален":"finish_center_toofar"==this.errorCode?"Адрес доставки посылки слишком удален":"start_finish_toofar"==this.errorCode?"Дальность доставки слишком большая":0==this.termsAccepted?"К сожалению, мы не можем доставить вам заказ, без согласия с условиями":"use_credit_store"==this.paymentType&&this.tariffRule.storeCreditBalance<this.tariffRule.deliverySum?"На счету предприятия не достаточно средств":null},isVPNon(){var e;return!(!this.iplocation||["UA","RU","???"].includes(null!==(e=this.iplocation.country_code)&&void 0!==e?e:"???"))},bankCardCalc(){let e=this.bankCard;return e&&e.card_type&&(e.label=`${e.card_type.toUpperCase()} (**** ${e.card_mask.split("*").pop()})`),e}},methods:{async itemLoad(){this.itemCheckoutDataGet()},async itemCheckoutDataGet(e=0){try{var t;const r={order_id:this.order_id,with_arrival_range:e},i=await k.A.post(`${this.$heap.state.hostname}Shipment/itemCheckoutDataGet`,r);if(!i)return;"customer_confirmed"!==i.order.stage_current&&this.$go(`/order/shipment-${this.order_id}`),this.order=i.order,this.routePlan=i.routePlan,this.bankCard=null===i||void 0===i?void 0:i.bankCard,this.tariffRuleList=i.deliveryOptions,this.tariffRuleSet((null===(t=this.tariffRuleList)||void 0===t?void 0:t[0])||{}),this.deliveryPlanMode=this.routePlan.start_plan_mode,i.finishPlanSchedule?(this.finishPlanSchedule=i.finishPlanSchedule,this.deliveryFinishScheduled=i.finishPlanSchedule.nearest):(this.finishPlanSchedule=null,this.deliveryFinishScheduled=null)}catch(a){var r,i;return this.errorCode=null===a||void 0===a||null===(r=a.responseJSON)||void 0===r||null===(i=r.messages)||void 0===i?void 0:i.error,"notfound"!=this.errorCode&&"forbidden"!=this.errorCode||(this.$flash("Заказ не найден"),this.$router.go(-1)),console.log(a),!1}},tariffRuleSet(e){var t;this.tariffRule=e,this.paymentType="use_card",null!==(t=this.bankCard)&&void 0!==t&&t.card_type&&(this.paymentType="use_card_recurrent"),1==e.paymentByCreditStore&&this.tariffRule.storeCreditBalance>=this.tariffRule.deliverySum?this.paymentType="use_credit_store":1==e.paymentByCash&&(this.paymentType="use_cash")},async datetimePick(){this.finishPlanSchedule||await this.itemCheckoutDataGet(1);const e=await f.OZ.create({component:C.A,presentingElement:this.$refs.page.$el,initialBreakpoint:"0.6",showBackdrop:!0,componentProps:{dateRange:this.finishPlanSchedule.range,defaultDatetime:this.finishPlanSchedule.nearest}});e.present(),this.deliveryPlanMode="scheduled";const t=await e.onDidDismiss();"confirm"==t.role?this.deliveryFinishScheduled=t.data:(this.deliveryFinishScheduled=null,this.deliveryPlanMode=this.routePlan.start_plan_mode)},async proceed(){const e={order_id:this.order.order_id,tariff_id:this.tariffRule.tariff_id,deliveryFinishScheduled:this.deliveryFinishScheduled,paymentByCard:"use_card"==this.paymentType?1:0,paymentByCardRecurrent:"use_card_recurrent"==this.paymentType?1:0,paymentByCash:"use_cash"==this.paymentType?1:0,paymentByCreditStore:"use_credit_store"==this.paymentType?1:0};try{await b().post(`${this.$heap.state.hostname}Shipment/itemCheckoutDataSet`,JSON.stringify(e))}catch(i){var t,r;const e=null===i||void 0===i||null===(t=i.responseJSON)||void 0===t||null===(r=t.messages)||void 0===r?void 0:r.error;if(!e)return!1;switch(e){case"payment_already_done":return this.$flash("Уже оплачен"),void this.$go(`/order/shipment-${this.order.order_id}`);case"credit_balance_low":return void this.$flash("Не достаточно средств на счету")}return this.$flash("Не удается оформить заказ, обратитесь на горячую линию"),!1}if(1!=e.paymentByCard){if(1==e.paymentByCardRecurrent){const e={order_id:this.order.order_id,card_id:this.bankCard.card_id};try{this.$flash("Оплачиваем привязанной картой..."),await b().post(`${this.$heap.state.hostname}CardAcquirer/paymentDo`,e),this.paymentStatusCheck()}catch(i){return this.$flash("Оплата привязанной картой не удалась"),!1}}1==e.paymentByCreditStore&&this.$router.replace("/order/shipment-"+this.order.order_id)}else this.paymentFormOpen({order_id:`${this.order_id}`})},async heavyLoadInfo(){const e=await f.TN.create({message:"Время приблизительное. Готовность заказа, погода, пробки могут задержать доставку.",buttons:[{text:"Ок",role:"confirm"}]});await e.present();const{role:t}=await e.onDidDismiss();return"confirm"==t},async paymentFormOpen(e){const t=await f.OZ.create({component:g.A,componentProps:{order_data:e},initialBreakpoint:.85,breakpoints:[0,.85,.95]});this.$topic.on("dismissModal",(()=>{t&&t.dismiss()})),t.present(),await t.onDidDismiss(),this.paymentStatusCheck()},async paymentStatusCheck(){const e={order_id:`${this.order.order_id}`};try{const t=await b().post(this.$heap.state.hostname+"CardAcquirer/statusGet",e);"OK"==t&&this.$router.replace("/order/shipment-"+this.order.order_id)}catch(i){var t,r;const e=null===(t=i.responseJSON)||void 0===t||null===(r=t.messages)||void 0===r?void 0:r.error;"wrong_status"==e?(this.$flash("Данный заказ не может быть оплачен"),this.$router.replace("/order/shipment-"+this.order.order_id)):"not_authorized"==e?(this.$flash("Оплата не прошла"),this.$router.replace("/order/shipment-"+this.order.order_id)):"waiting"==e?(this.$flash("Ваш платеж на ожидании"),this.$router.replace("/order/shipment-"+this.order.order_id)):this.$flash("Оплата картой не удалась")}}},mounted(){this.itemLoad()},ionViewDidEnter(){this.itemLoad()},created(){this.$topic.on("userMainPaymentMethodSet",(()=>{this.can_load_at=0,this.itemLoad()})),this.$topic.on("settingsGet",(e=>{var t;this.can_load_at=0,this.recurrentPaymentAllow=null===e||void 0===e||null===(t=e.other)||void 0===t?void 0:t.recurrentPaymentAllow}))}},S=r(6262);const $=(0,S.A)(F,[["render",_],["__scopeId","data-v-513f9c99"]]);var w=$}}]);
//# sourceMappingURL=2221.37d0c78e.js.map