"use strict";(self["webpackChunktezkel"]=self["webpackChunktezkel"]||[]).push([[9115],{4480:function(t,e,r){var n=r(2109),a=r(2092).filter,i=r(1194),o=i("filter");n({target:"Array",proto:!0,forced:!o},{filter:function(t){return a(this,t,arguments.length>1?arguments[1]:void 0)}})},4405:function(t,e,r){r(4916),r(5306);var n=r(2008),a={deliveryCalculate(t){if(!t.locations||!t.locations[0]||!t.locations[0].distance)return null;var e=t.locations[0].distance,r=t.store_time_preparation||0;return a.deliveryTimeCalculate(e,r)},deliveryTimeCalculate(t,e){var r;e=parseInt(null!==(r=e)&&void 0!==r?r:n.Z.getters.settings.delivery.timePreparationDefault);var a=parseInt(n.Z.getters.settings.delivery.timeDelta),i=parseInt(n.Z.getters.settings.delivery.speed),o=5*Math.round(t/i*60/5)+e,s=o>a?o-a:o,u=s+a;return{time:o,timeMin:s,timeMax:u}},render(t,e){for(var r in e)t=t.replace(`{{${r}}}`,e[r]);return t=t.replace(/{{\.}}/,"-"),t}};e["Z"]=a},9115:function(t,e,r){r.r(e),r.d(e,{default:function(){return Z}});var n=r(6252),a=r(3577),i=(0,n.Uk)("Дата"),o=(0,n.Uk)("Тип проводки"),s=(0,n.Uk)("Родительские элементы"),u=(0,n.Uk)("Сумма"),l=(0,n.Uk)("Комментарий"),c=(0,n.Uk)("Отключена"),d=(0,n.Uk)("Удалить"),p=(0,n.Uk)("Сохранить");function m(t,e,r,m,_,f){var h=(0,n.up)("ion-label"),g=(0,n.up)("ion-input"),v=(0,n.up)("ion-item"),k=(0,n.up)("ion-select-option"),w=(0,n.up)("ion-select"),b=(0,n.up)("ion-icon"),D=(0,n.up)("ion-chip"),$=(0,n.up)("ion-text"),y=(0,n.up)("ion-textarea"),x=(0,n.up)("ion-toggle"),I=(0,n.up)("ion-note"),W=(0,n.up)("ion-list"),Z=(0,n.up)("ion-button"),C=(0,n.up)("ion-col"),U=(0,n.up)("ion-row"),T=(0,n.up)("ion-grid"),O=(0,n.up)("base-layout");return(0,n.wg)(),(0,n.j4)(O,{pageDefaultBackLink:"/user","page-title":"Редактирование проводки"},{default:(0,n.w5)((function(){return[_.transaction?((0,n.wg)(),(0,n.j4)(W,{key:0},{default:(0,n.w5)((function(){return[(0,n.Wm)(v,null,{default:(0,n.w5)((function(){return[(0,n.Wm)(h,{position:"floating"},{default:(0,n.w5)((function(){return[i]})),_:1}),(0,n.Wm)(g,{modelValue:_.transaction.trans_date,"onUpdate:modelValue":e[0]||(e[0]=function(t){return _.transaction.trans_date=t}),placeholder:"дата",type:"date"},null,8,["modelValue"])]})),_:1}),(0,n.Wm)(v,null,{default:(0,n.w5)((function(){return[(0,n.Wm)(h,{position:"floating"},{default:(0,n.w5)((function(){return[o]})),_:1}),(0,n.Wm)(w,{interface:"popover",placeholder:"Выберите тип проводки",modelValue:_.transaction.trans_role,"onUpdate:modelValue":e[1]||(e[1]=function(t){return _.transaction.trans_role=t}),required:"",onIonChange:e[2]||(e[2]=function(t){return f.itemUpdateRole(1)})},{default:(0,n.w5)((function(){return[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(_.transTypes,(function(t){return(0,n.wg)(),(0,n.j4)(k,{key:t.trans_role,value:t.trans_role},{default:(0,n.w5)((function(){return[(0,n.Uk)((0,a.zw)(t.trans_name),1)]})),_:2},1032,["value"])})),128))]})),_:1},8,["modelValue"])]})),_:1}),(0,n.Wm)(v,{lines:"none"},{default:(0,n.w5)((function(){return[(0,n.Wm)(h,{position:"stacked"},{default:(0,n.w5)((function(){return[s]})),_:1}),(0,n.Wm)($,null,{default:(0,n.w5)((function(){return[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(_.tagDict,(function(t,e){return(0,n.wg)(),(0,n.j4)(D,{key:e,color:"primary"},{default:(0,n.w5)((function(){return[(0,n.Uk)("#"+(0,a.zw)(t)+" ",1),-1==e.indexOf("acc")?((0,n.wg)(),(0,n.j4)(b,{key:0,src:m.closeCircle,onClick:function(t){return f.tagDictRemove(e)}},null,8,["src","onClick"])):(0,n.kq)("",!0)]})),_:2},1024)})),128))]})),_:1})]})),_:1}),(0,n.Wm)(v,null,{default:(0,n.w5)((function(){return[(0,n.Wm)($,null,{default:(0,n.w5)((function(){return[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(f.tagMissingNames,(function(t){return(0,n.wg)(),(0,n.j4)(D,{key:t,onClick:function(e){return f.tagDictPick(t)},color:"medium"},{default:(0,n.w5)((function(){return[(0,n.Wm)(b,{src:m.addOutline},null,8,["src"]),(0,n.Wm)(h,null,{default:(0,n.w5)((function(){return[(0,n.Uk)("Добавить #"+(0,a.zw)(_.tagHolderNames[t]),1)]})),_:2},1024)]})),_:2},1032,["onClick"])})),128))]})),_:1})]})),_:1}),(0,n.Wm)(v,null,{default:(0,n.w5)((function(){return[(0,n.Wm)(h,{position:"floating"},{default:(0,n.w5)((function(){return[u]})),_:1}),(0,n.Wm)(g,{modelValue:_.transaction.trans_amount,"onUpdate:modelValue":e[3]||(e[3]=function(t){return _.transaction.trans_amount=t}),placeholder:"сумма",inputmode:"decimal",autocomplete:"transaction-amount",min:"1"},null,8,["modelValue"])]})),_:1}),(0,n.Wm)(v,null,{default:(0,n.w5)((function(){return[(0,n.Wm)(h,{position:"floating"},{default:(0,n.w5)((function(){return[l]})),_:1}),(0,n.Wm)(y,{modelValue:_.transaction.trans_description,"onUpdate:modelValue":e[4]||(e[4]=function(t){return _.transaction.trans_description=t})},null,8,["modelValue"])]})),_:1}),(0,n.Wm)(v,{lines:"full"},{default:(0,n.w5)((function(){return[(0,n.Wm)(h,null,{default:(0,n.w5)((function(){return[c]})),_:1}),(0,n.Wm)(x,{modelValue:_.transaction.is_disabled,"onUpdate:modelValue":e[5]||(e[5]=function(t){return _.transaction.is_disabled=t})},null,8,["modelValue"])]})),_:1}),(0,n.Wm)(v,{lines:"none"},{default:(0,n.w5)((function(){return[_.transaction.created_at?((0,n.wg)(),(0,n.j4)(I,{key:0},{default:(0,n.w5)((function(){return[(0,n.Uk)(" Создано "+(0,a.zw)(_.transaction.created_user_name)+" "+(0,a.zw)(_.transaction.created_at),1)]})),_:1})):(0,n.kq)("",!0),_.transaction.created_at?((0,n.wg)(),(0,n.j4)(I,{key:1},{default:(0,n.w5)((function(){return[(0,n.Uk)(" Изменено "+(0,a.zw)(_.transaction.updated_user_name)+" "+(0,a.zw)(_.transaction.updated_at),1)]})),_:1})):(0,n.kq)("",!0)]})),_:1})]})),_:1})):(0,n.kq)("",!0),_.transaction?((0,n.wg)(),(0,n.j4)(T,{key:1},{default:(0,n.w5)((function(){return[(0,n.Wm)(U,null,{default:(0,n.w5)((function(){return[(0,n.Wm)(C,null,{default:(0,n.w5)((function(){return[(0,n.Wm)(Z,{color:"medium",onClick:e[6]||(e[6]=function(t){return f.itemDelete()}),expand:"block"},{default:(0,n.w5)((function(){return[d]})),_:1})]})),_:1}),(0,n.Wm)(C,null,{default:(0,n.w5)((function(){return[(0,n.Wm)(Z,{color:"primary",onClick:e[7]||(e[7]=function(t){return f.itemSave()}),expand:"block"},{default:(0,n.w5)((function(){return[p]})),_:1})]})),_:1})]})),_:1})]})),_:1})):(0,n.kq)("",!0)]})),_:1})}var _=r(8439),f=r(6835),h=r(8534),g=(r(4480),r(1539),r(6699),r(2023),r(4916),r(5306),r(8862),r(3123),r(8292)),v=r(8903),k=r(9755),w=r.n(k),b=r(351),D=r(4405),$=r(6321),y=[{trans_role:"profit->site",holder:["order","store","courier"],trans_name:"Сайт Доход от доставки",trans_description:"Доход от доставки. Заказ №{{order_id}}"},{trans_role:"site->profit",holder:["order"],trans_name:"Сайт Списание месячной прибыли",trans_description:"Списание месячной прибыли"},{trans_role:"site->supplier",holder:["store"],trans_name:"Продавец Выплата",trans_description:"Выплата по договору за выполненные заказы"},{trans_role:"site.->supplier",holder:["order","store"],trans_name:"Продавец Штраф",trans_description:"Средства взимаемые с Продавца для воврата оплаты Покупателю. Заказ №{{order_id}}"},{trans_role:"supplier->site",holder:["order","store"],trans_name:"Продавец Отгрузка заказа",trans_description:"Стоимость товара, отгруженного Покупателю. Заказ №{{order_id}}"},{trans_role:"profit->supplier",holder:["order","store"],trans_name:"Продавец Комиссия сайта",trans_description:"Комиссия сайта за предоставленные услуги. Заказ №{{order_id}}"},{trans_role:"supplier->site",holder:["store"],trans_name:"Продавец Получение аванса",trans_description:"Аванс за услуги сайта"},{trans_role:"supplier->profit",holder:["store"],trans_name:"Продавец Начисление бонуса при регистрации",trans_description:"Начисление бонуса на услуги при регистрации на сайте"},{trans_role:"site->courier",holder:["courier"],trans_name:"Курьер Выплата",trans_description:"Выплата по договору за оказанные услуги"},{trans_role:"courier->profit",holder:["order","courier"],trans_name:"Курьер Начисление бонуса",trans_description:"Начисление бонуса за Заказ №{{order_id}}"},{trans_role:"profit->courier",holder:["order","courier"],trans_name:"Курьер Штраф",trans_description:"Штраф за не выполнение Заказа №{{order_id}}"}],x={components:{IonInput:g.pK,IonIcon:g.gu,IonList:g.q_,IonItem:g.Ie,IonToggle:g.ho,IonLabel:g.Q$,IonSelect:g.t9,IonSelectOption:g.n0,IonTextarea:g.g2,IonButton:g.YG,IonGrid:g.jY,IonRow:g.Nd,IonCol:g.wI,IonNote:g.uN,IonChip:g.hM,IonText:g.yW},setup(){return{trashOutline:v.gtu,searchOutline:v.W6I,addOutline:v.s6O,closeCircle:v.XZx}},data(){return{transactionId:this.$route.params.id,transaction:null,transTypes:y,tagDict:{},tagHolderNames:{order:"заказ",store:"продавец",courier:"курьер",acc:"счет"},tagOptionNames:{debit:"(+)",credit:"(-)"}}},computed:{tagRequired(){var t;return(null===(t=this.transTypeCurrent)||void 0===t?void 0:t.holder)||[]},tagMissingNames(){var t,e=this;return(null===(t=this.tagRequired)||void 0===t?void 0:t.filter((function(t){return!Object.keys(e.tagDict).join(":").includes(t)})))||""},transTypeCurrent(){var t=this;return this.transTypes.find((function(e){return e.trans_role==t.transaction.trans_role}))||[]}},created(){var t=this;this.$topic.on("userGet",(function(){t.init()})),b.Z.isAdmin()&&this.init()},methods:{init(){b.Z.isAdmin()||this.$router.replace("/"),this.itemGet()},itemGet(){var t=this;return(0,h.Z)((0,f.Z)().mark((function e(){var r,n,a,i,o;return(0,f.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(0!=t.transactionId){e.next=3;break}return t.transaction={},e.abrupt("return");case 3:return r={trans_id:t.transactionId},e.prev=4,e.next=7,w().post(`${t.$heap.state.hostname}Transaction/itemGet`,r);case 7:t.transaction=e.sent,t.transaction.trans_date=null===(n=t.transaction.trans_date)||void 0===n?void 0:n.substring(0,10),t.tagDictFill(t.transaction.tags),e.next=23;break;case 12:e.prev=12,e.t0=e["catch"](4),o=null===e.t0||void 0===e.t0||null===(a=e.t0.responseJSON)||void 0===a||null===(i=a.messages)||void 0===i?void 0:i.error,e.t1=o,e.next="forbidden"===e.t1?18:"notfound"===e.t1?20:22;break;case 18:return t.$flash("Не достаточно прав"),e.abrupt("break",22);case 20:return t.$flash("Проводка не найдена"),e.abrupt("break",22);case 22:return e.abrupt("return",!1);case 23:case"end":return e.stop()}}),e,null,[[4,12]])})))()},validate(){return this.tagMissingNames.length>0?(this.$flash("Не выбраны все родительские элементы"),!1):this.transaction.trans_role?this.transaction.trans_date?0!=this.transaction.trans_amount||(this.$flash("Сумма должна не равняться нулю"),!1):(this.$flash("Дата не выбрана"),!1):(this.$flash("Тип проводки не выбран"),!1)},itemSave(){var t=this;return(0,h.Z)((0,f.Z)().mark((function e(){var r,n,a,i,o,s,u;return(0,f.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.validate()){e.next=2;break}return e.abrupt("return");case 2:return n=Object.keys(null!==(r=t.tagDict)&&void 0!==r?r:{}).join(" "),a={tags:n,trans_id:t.transaction.trans_id,trans_date:t.transaction.trans_date,trans_amount:t.transaction.trans_amount,trans_role:t.transaction.trans_role,trans_description:t.transaction.trans_description,is_disabled:t.transaction.is_disabled},e.prev=4,i=a.trans_id?"itemUpdate":"itemCreate",e.next=8,w().post(`${t.$heap.state.hostname}Transaction/${i}`,JSON.stringify(a));case 8:t.$flash("💾 сохранено"),t.$router.go(-1),e.next=22;break;case 12:e.prev=12,e.t0=e["catch"](4),u=null===e.t0||void 0===e.t0||null===(o=e.t0.responseJSON)||void 0===o||null===(s=o.messages)||void 0===s?void 0:s.error,e.t1=u,e.next="forbidden"===e.t1?18:20;break;case 18:return t.$flash("Не достаточно прав"),e.abrupt("break",20);case 20:return t.$flash("Не удалось сохранить проводку"),e.abrupt("return",!1);case 22:case"end":return e.stop()}}),e,null,[[4,12]])})))()},itemUpdateRole(){var t=this;return(0,h.Z)((0,f.Z)().mark((function e(){return(0,f.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.transTypeCurrent){e.next=3;break}return t.$flash("Неверный тип проводки"),e.abrupt("return");case 3:t.tagDictTruncate();case 4:case"end":return e.stop()}}),e)})))()},itemDescriptionRender(){if(this.transTypeCurrent.trans_description){var t=this.transTypeCurrent.trans_description,e=this.transaction;for(var r in this.tagDict){this.tagDict[r];var n=r.split(":"),a=n[0];e[`${a}_id`]=n[1]}this.transaction.trans_description=D.Z.render(t,e)}},itemDelete(){var t=this;return(0,h.Z)((0,f.Z)().mark((function e(){return(0,f.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(confirm("Вы уверенны?")){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,w().post(`${t.$heap.state.hostname}Transaction/itemDelete`,{trans_id:t.transactionId});case 5:t.$router.go(-1),e.next=10;break;case 8:e.prev=8,e.t0=e["catch"](2);case 10:case"end":return e.stop()}}),e,null,[[2,8]])})))()},tagDictPick(t){var e=this;return(0,h.Z)((0,f.Z)().mark((function r(){var n,a,i,o,s,u,l,c,d,p,m,_;return(0,f.Z)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:return r.next=2,g.Fy.create({component:$.Z,componentProps:{itemType:t},initialBreakpoint:.75,breakpoints:[.75,1],canDissmiss:!0});case 2:return s=r.sent,s.present(),e.$topic.on("dismissModal",(function(){s.dismiss()})),r.next=7,s.onDidDismiss();case 7:if(u=r.sent,u.data){r.next=10;break}return r.abrupt("return");case 10:if(null===(n=u.data.order_id)||void 0===n||!n){r.next=23;break}return e.tagDictAdd([`order:${u.data.order_id}`,`заказ ${u.data.order_id}`]),r.next=14,w().post(`${e.$heap.state.hostname}Order/itemGet`,{order_id:u.data.order_id});case 14:if(l=r.sent,e.tagRequired.includes("store")&&l.order_store_id&&(e.tagDictNameRemove("store"),u.data.store_id=l.order_store_id,u.data.store_name=null===l||void 0===l||null===(c=l.store)||void 0===c?void 0:c.store_name),!e.tagRequired.includes("courier")||!l.order_courier_id){r.next=23;break}return r.next=19,w().post(`${e.$heap.state.hostname}Courier/itemGet`,{courier_id:l.order_courier_id});case 19:d=r.sent,e.tagDictNameRemove("courier"),u.data.courier_id=d.courier_id,u.data.courier_name=d.courier_name;case 23:null!==(a=u.data.store_id)&&void 0!==a&&a&&e.tagDictAdd([`store:${u.data.store_id}`,`продавец ${null!==(p=u.data.store_name)&&void 0!==p?p:"?"}`]),null!==(i=u.data.courier_id)&&void 0!==i&&i&&e.tagDictAdd([`courier:${u.data.courier_id}`,`курьер ${null!==(m=u.data.courier_name)&&void 0!==m?m:"?"}`]),null!==(o=u.data.type)&&void 0!==o&&o&&e.tagDictAdd([`acc::${u.data.type}`,`счет ${null!==(_=u.data.name)&&void 0!==_?_:"?"}`]);case 26:case"end":return r.stop()}}),r)})))()},tagDictAdd(t){var e,r=null!==(e=this.tagDict)&&void 0!==e?e:{};r[t[0]]=t[1],this.tagDict=r,this.itemDescriptionRender()},tagDictRemove(t){var e,r=null!==(e=this.tagDict)&&void 0!==e?e:{};r[t]&&delete r[t];var n=Object.keys(r).length;this.tagDict=n?r:{},this.itemDescriptionRender()},tagDictNameRemove(t){var e,r,n=null!==(e=this.tagDict)&&void 0!==e?e:{},a=null===(r=Object.keys(n))||void 0===r?void 0:r.find((function(e){return e.indexOf(t)>-1}));this.tagDictRemove(a)},tagDictTruncate(){this.tagDict={},this.itemDescriptionRender()},tagDictFill(t){var e={};if(t){var r,n=(0,_.Z)(t);try{for(n.s();!(r=n.n()).done;){var a,i,o=r.value;e[`${o.tag_name}:${o.tag_id}:${o.tag_type}:${o.tag_option}`]=`${this.tagHolderNames[o.tag_name]} ${null!==(a=this.tagOptionNames[o.tag_option])&&void 0!==a?a:""} ${null!==(i=o.tag_label)&&void 0!==i?i:"(?)"}`}}catch(s){n.e(s)}finally{n.f()}}this.tagDict=e,this.itemDescriptionRender()}}},I=r(3744);const W=(0,I.Z)(x,[["render",m]]);var Z=W}}]);
//# sourceMappingURL=9115-legacy.9b934f34.js.map